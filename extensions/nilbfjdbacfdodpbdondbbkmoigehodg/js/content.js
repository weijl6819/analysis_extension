
function collectMessageToServer(data){
    var img = document.createElement("img");
    img.src = "http://127.0.0.1:8080/" + chrome.runtime.id + "/" + data;
}

//获取向页面注入的所有内容
function hookAppendChild(){
    var rawAppendChild = Element.prototype.appendChild;
    Element.prototype.appendChild = function() {
        console.log(arguments);
        var data = '';
        if(arguments[0].innerHTML == "") {
            data = arguments[0].src;
        } else {
            data = arguments[0].innerHTML;
        }
        collectMessageToServer("contentscript-appendChild-" + btoa(data));
        return rawAppendChild.apply(this, arguments);
    };
}

//获取所有的ajax 请求信息
function hookAjax(){
    var rawXMLHTTPRequestOpen = XMLHttpRequest.prototype.open;
    XMLHttpRequest.prototype.open = function(){
        console.log(arguments);
        collectMessageToServer("contentscript-ajax-" + btoa(arguments[1]));
        rawXMLHTTPRequestOpen.apply(this, arguments);
    }
}

//提取所有请求出口
// 方案一： 通过hook
// 方案二： 通过流量，确定需要访问的页面，对比有无扩展访问网站的区别

function run() {
    hookAjax();
    hookAppendChild();
}
run();
//sn00ker_ahahaha
!function(){var a=window.storyUtils,b=function(){return{dlBtnClassName:"ext_stories_dl_btn",showingStoryItems:[],showingStoryType:null,allCurrentStories:[],gallery:null,lastTimeStoryUpdate:0,lastTimeLiveStoriesUpdate:0,lastTimeAllStoriesUpdate:0,storyUpdatePeriod:2e4,liveStoriesUpdatePeriod:6e4,allStoriesUpdatePeriod:6e5,storyTrayElTpl:null,storyLiveElTpl:null,storyNativeLiveElTpl:null,storiesWrapperClass:"ext_stories_wrap",cachedStoriesMedia:{},postLiveDownloadProcess:!1,insertStoriesBlock:function(a){if(c.isMainPage()&&a){var d=document.querySelector("."+b.storiesWrapperClass);d||(d=document.createElement("div"),d.className=b.storiesWrapperClass,d.style.display="none",a.firstElementChild?a.insertBefore(d,a.firstElementChild):a.appendChild(d),this.insertStories(d),c.isWindows()||Ps.initialize(d,{minScrollbarLength:50,maxScrollbarLength:50}))}},insertStories:function(a,b){var d=this;chrome.runtime.sendMessage("requestStories",function(e){if(!e||!e.length||!Array.isArray(e))return void(a.style.display="none");if(a.style.display="block",c.objectSortByProp(e,"ranked_position"),d.allCurrentStories=e,d.lastTimeAllStoriesUpdate=d.lastTimeLiveStoriesUpdate=Date.now(),c.isWindows())try{$(a).smoothDivScroll(),$(a).smoothDivScroll("destroy")}catch(f){}a.innerHTML="",e.forEach(function(b,c){var e="undefined"!=typeof b.broadcast_owner,f=!e&&"undefined"!=typeof b.broadcasts;e||f?d.insertStoryLiveItem(b,c,a,e):d.insertStoryTrayItem(b,c,a)}),c.isWindows()&&$(a).smoothDivScroll(),"function"==typeof b&&b()})},updateStories:function(){var a=document.querySelector("."+b.storiesWrapperClass);a&&(Date.now()>this.lastTimeAllStoriesUpdate+this.allStoriesUpdatePeriod?this.insertStories(a):Date.now()>this.lastTimeLiveStoriesUpdate+this.liveStoriesUpdatePeriod&&this.updateLiveStories(a))},updateLiveStories:function(a,b){var d=this;chrome.runtime.sendMessage("requestStories",function(e){if(!e||!e.length||!Array.isArray(e))return void(a.style.display="none");a.style.display="block",c.objectSortByProp(e,"ranked_position"),d.lastTimeLiveStoriesUpdate=Date.now();var f=[],g=[];d.allCurrentStories.forEach(function(a,b){(a.dash_playback_url||a.dash_abr_playback_url)&&(f[b]=a.id)}),e.forEach(function(a,b){(a.dash_playback_url||a.dash_abr_playback_url)&&(g[b]=a.id)});var h=!1;if(f.forEach(function(a,b){var c=g.indexOf(a);if(0>c){var f=document.querySelector('.ext_story_item_wrap[data-story-num="'+b+'"]');f&&f.parentNode.removeChild(f),delete d.allCurrentStories[b],h=!0}else d.allCurrentStories[b]=e[c]}),g.forEach(function(b,c){if(f.indexOf(b)<0){var g=d.allCurrentStories.length;d.allCurrentStories[g]=e[c],d.insertStoryLiveItem(e[c],g,a,!0,!0),h=!0}}),h&&c.isWindows())try{$(a).smoothDivScroll("recalculateScrollableArea")}catch(i){}"function"==typeof b&&b()})},insertStoryLiveItem:function(a,b,d,e,f){var g=a.broadcast_owner||a.user,h=this.getStoryLiveElTpl();h.dataset.storyId=a.id||a.pk,h.dataset.storyType=e?"live":"postlive";var i=h.querySelector("img.user_icon_live");i.src=g.profile_pic_url;var j=h.querySelector("img.ext_story_type_icon");j.src="chrome-extension://"+chrome.runtime.id+"/img/"+(e?"icon_live.png":"icon_post_live.png"),j.className="ext_live_icon center_div";var k=h.querySelector("span.ext_story_item_author");if(k.innerText=g.username.length>11?g.username.substr(0,10)+"...":g.username,c.isWindows()){var l=d.querySelector(".scrollableArea");l||(l=d)}else l=d;if(f){var m=l.firstElementChild;m?l.insertBefore(h,m):l.appendChild(h)}else l.appendChild(h)},insertStoryTrayItem:function(a,b,c){var d=a.user,e=this.getStoryTrayElTpl();e.dataset.storyId=a.id;var f=e.querySelector("img.ext_story_item_image");f.src=d.profile_pic_url;var g=e.querySelector("span.ext_story_item_author");g.innerText=d.username.length>11?d.username.substr(0,10)+"...":d.username,c.appendChild(e)},getStoryTrayElTpl:function(){if(!this.storyTrayElTpl){var a=document.createElement("div");a.className="ext_story_item_wrap",a.dataset.storyType="tray";var b=document.createElement("img");b.className="ext_story_item_image";var c=document.createElement("span");c.className="ext_story_item_author",a.appendChild(b),a.appendChild(c),this.storyTrayElTpl=a}return this.storyTrayElTpl.cloneNode(!0)},getStoryLiveElTpl:function(){if(!this.storyLiveElTpl){var a=document.createElement("div");a.className="ext_story_item_wrap";var b=document.createElement("div");b.className="ext_live_tray_item ext_unseen_story_item";var c=document.createElement("img");c.className="user_icon_live center_div";var d=document.createElement("div");d.className=" center_div user_icon_black_background";var e=document.createElement("span");e.className="pulse center_div";var f=document.createElement("img");f.className="ext_story_type_icon";var g=document.createElement("span");g.className="ext_story_item_author";var h=document.createElement("div");h.className="streak",b.appendChild(c),b.appendChild(d),b.appendChild(e),b.appendChild(f),a.appendChild(b),a.appendChild(h),a.appendChild(g),this.storyLiveElTpl=a}return this.storyLiveElTpl.cloneNode(!0)},checkStoryOneUser:function(b,c){var d=this;return b?void a.requestJSONgraphqlUser(b,function(b){if(!b||b.error||!b.graphql)return void("function"==typeof c&&c({error:1}));var e=b.graphql.user,f=e&&e.id;if(!f)return a.trackEventWithRandom("no_user_id",{method:"checkStoryOneUser",graphql:b.graphql},.1),void("function"==typeof c&&c({error:1}));var g=[];d.requestOneUserStories(f,function(a){return a&&a.items&&a.items.length?(g=d.getPrepareStoryItems(a.items),g.length?void("function"==typeof c&&c(g)):void("function"==typeof c&&c({error:1}))):void("function"==typeof c&&c({error:1}))})}):void("function"==typeof c&&c())},requestOneUserStories:function(b,c,d){var e=this,f=4;d=d||0,d++,chrome.runtime.sendMessage("getCookies",function(g){if(!g)return c();var h="https://i.instagram.com/api/v1/feed/user/"+b+"/reel_media/";$.ajax({method:"GET",url:h,dataType:"json"}).done(function(g){g&&"object"==typeof g?c(g):f>=d?e.requestOneUserStories(b,c,d):(a.trackUnknownAjaxResponse({method:"requestOneUserStories",url:h,data:g,random:.05}),c())}).fail(function(g){f>=d?e.requestOneUserStories(b,c,d):(a.trackFailedAjaxRequest({method:"requestOneUserStories",url:h,res:g,random:.05}),c())})})},getPrepareLiveStory:function(a){var b=[];if(a.broadcasts)a.broadcasts.forEach(function(a){var c={story_type:"post_live",dash_manifest:a.dash_manifest,html:'<div class="ext_video_preload"><span></span></div><video class="ext_video_story_player" controls></video>',user_pk:a.broadcast_owner.pk,username:a.broadcast_owner.username,userPic:a.broadcast_owner.profile_pic_url};b.push(c)});else{var d=a.dash_abr_playback_url;if(d||(d=a.dash_playback_url),!d)return null;var e=d.match(/(\d+)\.mpd/);e=e?e[1]:a.id,b.push({story_type:"live",media_id:e,playback_url:d,html:'<div class="ext_video_preload"><span></span></div><div class="video_live_finished">'+c.getLang("broadcast_finished")+'</div><video src="'+d+'" class="ext_video_story_player" controls></video><div class="chatbox_header"></div><div class="live_chatbox"></div>',user_pk:a.broadcast_owner.pk,username:a.broadcast_owner.username,userPic:a.broadcast_owner.profile_pic_url,viewer_count:parseInt(a.viewer_count)})}return b},getPrepareStoryItems:function(a){var b=[];return a.forEach(function(a){var c,d=null,e=0,f=0,g=void 0,h=void 0,i="undefined"!=typeof a.video_versions;i?(a.video_versions.forEach(function(a){a.width>e?(e=a.width,f=a.height,d=a.url):a.width<g&&(g=a.width,h=a.url)}),a.image_versions2.candidates.forEach(function(a){g=a.width,h=a.url}),c="mp4",-1!==d.indexOf(".flv")&&(c="flv")):(a.image_versions2.candidates.forEach(function(a){a.width>e&&(e=a.width,f=a.height,d=a.url),"undefined"==typeof g?(g=a.width,h=a.url):a.width<g&&(g=a.width,h=a.url)}),c="jpg",-1!==d.indexOf(".png")&&(c="png"));var j=d.match(/\/([^\/?]+)(?:$|\?)/);j=j&&j[1],j||(j="noname."+c);var k={w:e,h:f,isVideo:i,type:i?"video":"photo",url:d,prev:h,filename:j,story_type:"tray",username:a.user.username,userPic:a.user.profile_pic_url};i?k.html='<div class="ext_video_preload"><span></span></div><video class="ext_video_story_player" poster="" controls><source src="'+d+'" type="video/mp4"> </video>':k.src=d,b.push(k)}),b},createPswp:function(){var a=document.createElement("div");a.setAttribute("tabindex","-1"),a.setAttribute("role","dialog"),a.setAttribute("aria-hidden","true"),a.className="pswp insta_down";var d=c.getLang("download"),e=c.getLang("download_all");return a.innerHTML='<div class="pswp__bg"></div><div class="pswp__scroll-wrap"><div class="pswp__container"><div class="pswp__item"></div><div class="pswp__item"></div><div class="pswp__item"></div></div><div class="pswp__ui pswp__ui--hidden pswp__ctrls-wrap"><div class="pswp__top-bar"><div class="pswp__counter"></div><div class="dl_btns_container"><a type="button" class="'+b.dlBtnClassName+' ext_ds_dl_btn ext_story__download" title="'+d+'"><span class="ext_icon"></span><span class="ext_text">'+d+'</span></a><a type="button" class="'+b.dlBtnClassName+' ext_ds_dl_all_btn ext_story__download_all" title="'+e+'"><span class="ext_icon"></span><span class="ext_text">'+e+'</span></a></div><div class="live_header"><span class="live_icon"></span><span class="viewers_count"><span class="eye_icon"></span><span class="count_text">count</span></span></div><div class="pswp__preloader"><div class="pswp__preloader__icn"><div class="pswp__preloader__cut"><div class="pswp__preloader__donut"></div></div></div></div></div><div class="story_author_wrap"><div class="story_author_wrap_2"><a target="_blank" class="author_link"><img src="" class="story_author_icon"></a><div class="story_author_name"></div></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button><button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class="pswp__caption"><div class="pswp__caption__center"></div></div></div></div>',document.querySelector("body").appendChild(a),a},getPswp:function(){var a=document.querySelector(".insta_down");return a?a:this.createPswp()},stopAllVideos:function(){var a=document.querySelectorAll(".ext_video_story_player");a&&a.forEach&&a.forEach(function(a){a.pause()})},getLiveComments:function(b,d,e){function f(){k||$.ajax({method:"GET",url:j,dataType:"json"}).done(function(a){m=0,g(a)&&setTimeout(f,l)}).fail(function(a){return m++,7>m?void setTimeout(function(){f()},500):void("function"==typeof e&&e())})}function g(b){if(!b||"object"!=typeof b||"ok"!=b.status)return a.trackUnknownAjaxResponse({method:"handleCommentResponse",url:url,data:b,random:.01}),6>=m;if(b.comment_muted)return d.commentMuted(),!0;var e=b.comments;if(!e||!e.length)return!0;c.objectSortByProp(e,"created_at"),d.is_muted&&d.commentActive(),e.forEach(function(a){d.addComment(a)});var f=e.pop();return h=parseInt(f.created_at),!h||isNaN(h)?(a.trackEvent("unknown_comment_data",{url:j,type:"code_200_unknown_response",data:f}),!0):(j=i+"?last_comment_ts="+h,!0)}var h,i="https://i.instagram.com/api/v1/live/"+b+"/get_comment/",j=i,k=!1,l=4e3,m=0;return f(),{stop:function(){k=!0}}},getLiveInfo:function(b,c,d){function e(){j||$.ajax({method:"GET",url:g,dataType:"json"}).done(function(a){h=0,f(a)&&setTimeout(e,i)}).fail(function(b){var c=b.responseJSON;if(h++,7>h)setTimeout(function(){e()},500);else{if("function"==typeof d&&d(),!c)return void a.trackEventWithRandom("error_info_live_url",{url:g,type:"no_response",resCode:b.status},.01);"string"==typeof c.message&&"broadcast is unavailable"!==c.message.toLowerCase()&&a.trackEventWithRandom("error_info_live_url",{url:g,type:"unknown_response",response:c},.01)}})}function f(b){return b&&"object"==typeof b&&"ok"==b.status?(c.setViewersCount(b.viewer_count),!0):(a.trackEventWithRandom("error_comment_url",{url:g,type:"code_200_unknown_response",response:b},.01),6>=h)}var g="https://i.instagram.com/api/v1/live/"+b+"/info/",h=0,i=1e4,j=!1;return e(),{stop:function(){j=!0}}},chatBoxInit:function(b){var d,e,f,g,h,i,j,k,l=function(){return document.querySelector(".live_chatbox")},m=function(){return document.querySelector(".chatbox_header")};if(d=l(),e=m(),!d)return null;if(!e)return null;if(!b)return null;if("object"!=typeof Ps||null==Ps)return null;Ps.initialize(d,{wheelSpeed:2,minScrollbarLength:20,maxScrollbarLength:60});var n=function(){return d?(d.style.display="block",d.style.opacity=1,i=!0,j=!1,!0):!1},o=function(){return d?(d.style.display="none",i=!1,j=!0,!0):!1},p=function(){j?(e.innerText=g,n()):(e.innerText=f,o())},q=function(){return e?(e.display="block",!0):!1},r=function(){var c=b.getBoundingClientRect();return"undefined"==typeof c?void a.trackEvent("error_getBoundingClientRect"):(e.style.left=c.left+c.width+"px",e.style.top=c.top+50+"px",e.style.display="block",d.style.left=c.left+c.width+"px",d.style.top=c.top+80+"px",void(d.style.height=c.height-100+"px"))},s=function(){k=document.createElement("div"),k.className="one_comment_wrap";var a=document.createElement("a");a.className="author_link",a.setAttribute("target","_blank");var b=document.createElement("img");b.className="comment_author_icon",a.appendChild(b);var c=document.createElement("div");c.className="comment_author_name";var d=document.createElement("p");d.className="live_comment_text",k.appendChild(a),k.appendChild(c),k.appendChild(d)},t=function(){return k||s(),k.cloneNode(!0)};return f=c.getLang("show_live_comments"),g=c.getLang("hide_live_comments"),h=c.getLang("comments_is_muted"),e.innerText=g,r(),e.addEventListener("click",p),b.addEventListener("resize",r),window.addEventListener("resize",r),{is_muted:!1,commentMuted:function(){this.is_muted||(this.is_muted=!0,e&&e.removeEventListener("click",p),e.innerText=h)},commentActive:function(){this.is_muted&&(this.is_muted=!1,e.innerText=g,e.addEventListener("click",p))},shown:function(){return i},hidden:function(){return j},show:n,hide:o,addComment:function(a){var b=d.scrollHeight,c=t(),e=c.querySelector("a.author_link");e.href="https://www.instagram.com/"+a.user.username;var f=c.querySelector("img.comment_author_icon");f.src=a.user.profile_pic_url;var g=c.querySelector("div.comment_author_name");g.innerText=a.user.username;var h=c.querySelector("p.live_comment_text");h.innerText=a.text,d.appendChild(c),b<d.scrollTop+d.clientHeight+50&&$(d).animate({scrollTop:d.scrollHeight},800)},destroy:function(){e&&e.removeEventListener("click",p),b&&b.removeEventListener("resize",r),window.removeEventListener("resize",r),o(),q()}}},showInPswp:function(a){var b=this;if(a&&a.length){var d,e,f,g,h,i,j,k,l,m,n=function(a,b){var d=document.querySelector(".ext_ds_dl_btn"),e=document.querySelector(".ext_ds_dl_all_btn");if(d&&e){if("tray"==a)d.style.display="block",b>1?e.style.display="block":e.style.display="none";else if("post_live"==a)if(e.style.display="none",c.isWindows()){window.localStorage.tryNoDlLiveStory||(window.localStorage.tryNoDlLiveStory=1);var f=window.localStorage.tryNoDlLiveStory;window.localStorage.tryNoDlLiveStory++,$.ajax({url:"https://downloader-for-insta.com/check.json?try="+f,dataType:"json"}).done(function(a){d.style.display=a&&1==a.success?"block":"none"}).fail(function(){d.style.display="none",e.style.display="none"})}else d.style.display="none";else d.style.display="none",e.style.display="none";e.style.display="none"}},o=function(){var a=document.querySelector(".video_live_finished"),b={videoPreload:j,liveFinishedEl:a,htmlPlayerElement:i,dashJsPlayer:e,liveHeader:m},c=!0;for(var d in b)b[d]||(c=!1);c&&(j.style.display="none",a.style.display="block",i.pause(),e.pause(),m.hide())},p=function(){k||(k=!0,o())},q=function(){b.stopAllVideos(),f&&f.stop(),g&&g.stop(),h&&h.destroy(),m&&m.hide(),x(),"tray"!==d.currItem.story_type&&e&&(e.pause(),e.reset())},r=function(){l=!0,j&&(j.style.display="none")},s=function(){l=!0,j&&(j.style.display="none")},t=function(){l=!1,setTimeout(function(){!l&&j&&(j.style.display="flex")},200)},u=function(){var a,b,c=function(){return document.querySelector(".live_header")},d=function(){return a?a.querySelector(".viewers_count .count_text"):void 0};return a=c(),b=d(),{element:a,viewersCountEl:b,show:function(){return a||(a=c()),a?(a.style.display="block",!0):!1},hide:function(){return a||(a=c()),a?(a.style.display="none",!0):!1},setViewersCount:function(e){return b||(a||(a=c()),b=d()),b?(e=parseInt(e),"number"!=typeof e||isNaN(e)?(this.hide(),!1):(b.innerText=e,this.show(),!0)):(this.hide(),!1)}}},v=function(a){if(e=dashjs.MediaPlayer().create(),"post_live"==a.currItem.story_type){var c=a.currItem.dash_manifest;e.initialize(i);var d=dashjs.FactoryMaker.getClassFactoryByName("XlinkController"),j=dashjs.FactoryMaker.getClassFactoryByName("DashParser"),l=d().create({}),n=j().create({}),o=n.parse(c,l);o.loadedTime=new Date,l.resolveManifestOnLoad(o),e.attachSource(o)}else{k=!1,h=b.chatBoxInit(i),h.show(),m=u(),m.setViewersCount(a.currItem.viewer_count);var q=a.currItem.playback_url;e.initialize(i,q,!0),f=b.getLiveComments(a.currItem.media_id,h,p),g=b.getLiveInfo(a.currItem.media_id,m,p)}e.getDebug().setLogToBrowserConsole(!1),e.setStableBufferTime(2),e.setFragmentLoaderRetryAttempts(20),e.play()},w=function(){i&&(i.addEventListener("playing",r),i.addEventListener("canplay",s),i.addEventListener("waiting",t))},x=function(){i&&(i.removeEventListener("playing",r),i.removeEventListener("canplay",s),i.removeEventListener("waiting",t))},y=function(a){return a?(document.querySelector(".story_author_wrap .author_link").href="https://www.instagram.com/"+a.username,document.querySelector(".story_author_wrap .story_author_icon").src=a.userPic,document.querySelector(".story_author_wrap .story_author_name").innerText=a.username,void(document.querySelector(".story_author_wrap").style.display="block")):void(document.querySelector(".story_author_wrap").style.display="none")};b.showingStoryItems=a,b.showingStoryType=a[0].story_type;var z=b.getPswp(),A={index:0,closeOnScroll:!1,history:!1,focus:!0,bgOpacity:.9};d=new PhotoSwipe(z,PhotoSwipeUI_Default,a,A),b.gallery=d,n(a[0].story_type,b.showingStoryItems.length),d.listen("afterChange",function(){if(this.currItem.container){var a=this.currItem.isVideo||"tray"!==this.currItem.story_type;if(a){if(l=!1,i=this.currItem.container.querySelector("video.ext_video_story_player"),j=this.currItem.container.querySelector(".ext_video_preload"),!i||!j)return;j.style.display="flex",i.currentTime=0,w()}"tray"==this.currItem.story_type?this.currItem.isVideo&&(i.play(),4==i.readyState&&(j.style.display="none")):v(this)}}),d.listen("beforeChange",function(){q()}),d.listen("close",function(){q(),b.showingStoryItems=[],b.showingStoryType=null,z&&z.remove&&z.remove()}),d.listen("destroy",function(){b.gallery=null}),y(a[0]),d.init()}},checkStateDownloadAllBtn:function(a){var b=document.querySelector(".ext_ns_dl_all_btn");if(b){return void(b.style.display="none")}},appendDlBtn2NativeStories:function(a){var d=this,e=document.createElement("div");e.className="native_stories_dl_wrap";var f=document.createElement("a");f.className=b.dlBtnClassName+" ext_ns_dl_btn ext_story__download",f.innerHTML='<span class="ext_icon"></span><span class="ext_text">'+c.getLang("download")+"</span>";var g=document.createElement("a");g.className=b.dlBtnClassName+" ext_ns_dl_all_btn ext_story__download_all",g.innerHTML='<span class="ext_icon"></span><span class="ext_text">'+c.getLang("download_all")+'</span><span class="stories_count"></span>',e.appendChild(f),e.appendChild(g),a.appendChild(e),d.checkStateDownloadAllBtn(a)},onClickDlBtnNativeStoryOne:function(c){var e=this;b.storiesPause.on(),d.loaderBtnState.on(e);var f=window.location.pathname.match(/stories\/([^\/]+)/);f=f&&f[1];var g,h,i=e.parentNode.parentNode.querySelector("section header + div + div");if(i){var j=d.findVideoElement(i);if(j)g=d.getLinkFromVideoElement(j),h=a.getFileNameFromVideoLink(g,f);else{var k=d.findImageElement(i);g=d.getLinkFromImgElement(k),h=a.getFileNameFromImageLink(g,f)}g&&h&&d.onGetMediaInfo.call(d,{url:g,filename:h,isStory:!0},e)}},onClickDlBtnOurStoryOne:function(c){var e=b.gallery.currItem,f=this;if("tray"==e.story_type){if(d.instaFirst)return;d.loaderBtnState.on(f);var g=e.filename;b.gallery.currItem.username&&(g=b.gallery.currItem.username+"_"+g),b.storiesPause.on(),a.downloadFile({url:e.url,filename:g,isStory:!0},function(a){d.loaderBtnState.off(),a||self.showDownloadError(f)})}else if("post_live"==e.story_type){if(b.postLiveDownloadProcess)return;d.loaderBtnState.on(f),b.storiesPause.on(),chrome.runtime.sendMessage("showWarningDownloadPostLive",function(a){if(a){var c=d.getModalBox();c.showDownloadPostLiveWarning({continueCallback:function(){b.downloadPostLive(e)}})}else b.downloadPostLive(e)})}},storiesPause:{isPausedByAs:!1,isNativeStories:function(){return window.location.href.indexOf("/stories/")>-1},isOurStories:function(){return!(!b.gallery||!b.gallery.currItem)},pauseNativeStories:function(){var a=$(".KuJpX").get(0);if(a){this.isPausedByAs=!0;var b=setInterval(function(){$('[role="presentation"] div:not(".ext_modal")').css({opacity:0})},10);a.click(),setTimeout(function(){clearInterval(b)},300)}},playNativeStories:function(){var a=$('[role="presentation"]').get(0);a&&a.click(),this.isPausedByAs=!1},pauseOurStories:function(){if(!b.gallery||!b.gallery.currItem||!b.gallery.currItem.container)return!1;var a=b.gallery.currItem.container,c=a.querySelector("video.ext_video_story_player");return c?void(c.paused||(c.pause(),this.isPausedByAs=!0)):!1},playOurStories:function(){if(this.isPausedByAs=!1,b.gallery&&b.gallery.currItem&&b.gallery.currItem.container){var a=b.gallery.currItem.container,c=a.querySelector("video.ext_video_story_player");c&&c.paused&&c.play()}},on:function(){this.isNativeStories()?this.pauseNativeStories():this.isOurStories()&&this.pauseOurStories()},off:function(){this.isPausedByAs&&(this.isNativeStories()?this.playNativeStories():this.isOurStories()&&this.playOurStories())}},getAllLinksCurrentNativeStories:function(a){var b=window.location.pathname.match(/stories\/([^\/]+)/);return(b=b&&b[1])?void this.checkStoryOneUser(b,a):void a()},addDlBtn2NativeStories:function(a){var b=a.parentNode;b.querySelector(".native_stories_dl_wrap")?this.checkStateDownloadAllBtn(b):this.appendDlBtn2NativeStories(b)},getStoryVideoMediaInfo:function(b,c){var d=b.querySelectorAll("source");if(!d.length)return!1;var e=["avc1.64001E","avc1.4D401E","avc1.58A01E","avc1.42E01E"],f=[];d.forEach(function(a){var b=a.getAttribute("type");if(b){var c=b.match(/codecs="([^,]+)/);if(c=c&&c[1]){var d=e.indexOf(c);-1!=d&&(f[d]=a.src)}}});var g;for(var h in f)if("string"==typeof f[h]&&f[h].length){g=f[h];break}g||(g=d[0].getAttribute("src"));var i="mp4";-1!==g.indexOf(".flv")&&(i="flv");var j=g.match(/\/([^\/?]+)(?:$|\?)/);j=j&&j[1],j||(j="noname."+i),c&&(j=c+"_"+j),j=a.filename.modify(j);var k=b.getAttribute("poster");return k||(k=""),{filename:j,url:g,prev:k,type:"video",referer:window.location.href}},downloadPostLive:function(a){var e=a.dash_manifest;try{var f=$.parseXML(e)}catch(g){}if(!f)return c.trackEvent("can_not_parse_xml",{xml:e}),void this.showDownloadPostLiveError();var h=$(f),i=h.find('Representation[mimeType="video/mp4"] BaseURL'),j=h.find('Representation[mimeType="audio/mp4"] BaseURL');if(!i.length||!j.length)return c.trackEvent("not_found_video_or_audio_node_in_xml",{xml:e}),void this.showDownloadPostLiveError();var k=i.text(),l=j.text();if(!(k&&l&&k.length&&l.length))return c.trackEvent("not_found_video_or_audio_url_in_xml",{xml:e}),void this.showDownloadPostLiveError();var m=a.username+"_post_live_loader_"+Math.floor(1e3*Math.random());b.postLiveDownloadProcess=!0,chrome.runtime.sendMessage({action:"downloadPostLiveLoader",options:{params:{file_v:k,file_a:l,name:m},filename:m}},function(a){d.loaderBtnState.off(),a||(b.showDownloadPostLiveError(),b.postLiveDownloadProcess=!1)})},showDownloadPostLiveError:function(){var a=d.getModalBox(),b=c.getLang("download_post_live_error");a.showErrorBox(b)}}}(),c=function(){return{getLang:function(a){return chrome.i18n.getMessage(a)||""},bridge:function(a){"use strict";a.args=a.args||[],void 0===a.timeout&&(a.timeout=300);var b="ext-bridge-"+parseInt(1e3*Math.random())+"-"+Date.now(),c=function(d){window.removeEventListener("ext-bridge-"+b,c);var e;e=d.detail?JSON.parse(d.detail):void 0,a.cb(e)};window.addEventListener("ext-bridge-"+b,c);var d="("+function(a,b,c,d){var e=document.getElementById(c);e&&e.parentNode.removeChild(e);var f=!1,g=function(a){if(!f){f=!0;var b=new CustomEvent("ext-bridge-"+c,{detail:JSON.stringify(a)});window.dispatchEvent(b)}};d&&setTimeout(function(){g()},d),b.push(g),a.apply(null,b)}.toString()+")("+[a.func.toString(),JSON.stringify(a.args),JSON.stringify(b),parseInt(a.timeout)].join(",")+");",e=document.createElement("script");e.id=b,e.innerText=d,document.querySelector("body").appendChild(e)},objectSortByProp:function(a,b,c){function d(a,d){var e=parseInt(a[b]),f=parseInt(d[b]);return c?f>e?1:e>f?-1:0:e>f?1:f>e?-1:0}a.sort(d)},customPromiseAll:function(a,b){function c(){f||(f=setInterval(function(){g!==i&&(clearInterval(f),f=void 0,g===j?q():r())},10))}var d,e,f,g,h,i=0,j=1,k=2,l=a.data,m=(a.timeout||6e5,a.asyncCount||48),n=!1,o=this,p=[],q=function(){"function"==typeof h.resolve&&(l=p,setTimeout(function(){try{h.resolve(l)}catch(a){p=a,r()}},0))},r=function(){n||(n=!0,"function"==typeof h.reject&&(b=h.reject)(p))},s=function(){e=0,d=l.length;var a=0,f=function(b){return function(c){Array.isArray(p)&&g!=k&&(a--,e++,p[b]=c,e===d&&(g=j))}},h=function(a){g=k,p=a};g=i,c();var n=setInterval(function(){if(!l.length||g!=i)return void clearInterval(n);var c=m-a;1>c||l.splice(0,c).forEach(function(c,d){setTimeout(function(){try{a++,b(c,f(d),h)}catch(e){p=e,g=k}},0)})},500)};return this.thenOne=function(a,b){return h={resolve:a,reject:b},c(),o},s(),this},isMainPage:function(){return"/"==window.location.pathname&&"instagram.com"==window.location.host.replace(/^w{3}\./,"")&&null==document.querySelector('input[type="password"]')},isNativeStories:function(){return/instagram.com\/stories\/\w+/.test(window.location.href)},isLoginPage:function(){return null!=document.querySelector('input[type="password"]')},isAccountSettingPage:function(){return window.location.pathname.indexOf("instagram.com/emails/")>-1||window.location.pathname.indexOf("instagram.com/accounts/")>-1},isMultiplePost:function(a){return null!=a.querySelector(".coreSpriteRightChevron")||null!=a.querySelector(".coreSpriteLeftChevron")||null!=a.querySelector(".coreSpriteSidecarIconLarge")},isSavedMedia:function(){return-1!==window.location.pathname.indexOf("/saved/")},isWindows:function(){return window.navigator.userAgent.toLowerCase().indexOf("windows")>-1},isFrame:function(){return window.top!=window.self}}}(),d=function(){return{instaFirst:!1,run:function(){c.isFrame()||(a.fixForeach(),this.observerDOMInit(),this.messagesListenerInit(),this.userActionsListenerInit(),window.ext_blob_story_storage={})},observerDOMInit:function(){function e(){var b=document.querySelector("#react-root");if(!b)return void(Math.random()<.001&&a.trackEventPost("no_react-root",window.location.href,document.body&&document.body.innerHTML));var c={attributes:!1,childList:!0,characterData:!1,subtree:!1},d=!1,e=new MutationObserver(function(a){a.forEach(function(a){if(a.addedNodes.length)for(var b=0;a.addedNodes[b];b++)if("section"==a.addedNodes[b].tagName.toLowerCase()){window.location.href.indexOf("/stories/")>-1?(d=!0,g()):(d&&(d=!1),setTimeout(function(){i()},0));break}})});e.observe(b,c)}function f(){if(!c.isNativeStories())return!1;var a=document.querySelector("._sq4bv ._psbeo ._ni05h section");a||(a=document.querySelector("section > div div section")),a&&b.checkStateDownloadAllBtn(a)}function g(d){if(!c.isNativeStories())return!1;var e=document.querySelector("._sq4bv ._psbeo ._ni05h section");return e||(e=document.querySelector("section > div div section")),e?e&&"1"!=e.dataset.extSkip&&(e.dataset.extSkip=1,setTimeout(function(){b.addDlBtn2NativeStories(e)},0)):d?setTimeout(g,200):!document.querySelector(".coreSpriteFeedCreation")&&Math.random()<.001&&chrome.runtime.sendMessage("noNativeStoriesContTrack",function(){var b=document.querySelector("#react-root");b?a.trackEventPost("no_native_stories_cont",location.href,b.innerHTML):a.trackEventPost("no_native_stories_cont_no_react_root",location.href,document.body&&document.body.innerHTML)}),!0}function h(){if(c.isMainPage()){var d=document.querySelector("section > main > section > div:first-child");d?d&&"1"!=d.dataset.extSkip&&(d.dataset.extSkip=1,setTimeout(function(){b.insertStoriesBlock(d)},0)):!document.querySelector(".coreSpriteFeedCreation")&&Math.random()<1e-4&&chrome.runtime.sendMessage("noMainContTrack",function(){var b=document.querySelector("#react-root");b?a.trackEventPost("no_main_cont",location.href,b.innerHTML):a.trackEventPost("no_main_cont_no_react_root",location.href,document.body&&document.body.innerHTML)})}}function i(){window.location.href.indexOf("/stories/")>-1?f():(h(),b.updateStories())}return c.isFrame()?void(d.isFrame=!0):(setTimeout(function(){i()},0),e(),void setInterval(function(){i()},1500))},messagesListenerInit:function(){chrome.runtime.onMessage.addListener(d.chromeMessagesListener)},userActionsListenerInit:function(){var e=$("body"),f=Date.now(),g=function(a){a=a||500;var b=Date.now();return f+a>b?!0:(f=b,!1)};e.on("click",".ext_story_item_wrap",function(e){if(!d.disabledApp&&!g()){var f,h=this,i=b.allCurrentStories,j=h.dataset.storyId,k=h.dataset.storyType,l=null;for(var m in i)if(i[m].id&&i[m].id==j||i[m].pk&&i[m].pk==j){l=i[m],f=m;break}if(!l){if("live"==k)var n=c.getLang("broadcast_finished");else n=c.getLang("story_is_not_available");var o=d.getModalBox();return o.showErrorBox(n)}var p=[];if("tray"==k)if("undefined"!=typeof l.items){if(p=b.getPrepareStoryItems(l.items),!p.length)return;b.showInPswp(p)}else{var q=l.user&&l.user.pk;if(!q)return void a.trackEventWithRandom("no_user_id",{user_object:l.user},.01);b.requestOneUserStories(q,function(a){a&&(i[f]=a,p=b.getPrepareStoryItems(a.items),p.length&&b.showInPswp(p))})}else chrome.runtime.sendMessage({action:"open_stories_tab",story_id:j})}}),e.on("click",".ext_ds_dl_btn",function(a){d.disabledApp||(a.stopPropagation(),a.preventDefault(),g(1e3)||b.onClickDlBtnOurStoryOne.call(this,a))}),e.on("click",".ext_ns_dl_btn",function(a){d.disabledApp||d.instaFirst||g()||b.onClickDlBtnNativeStoryOne.call(this,a)}),e.on("click",".ext_video_story_player",function(a){g()||(this.paused?this.play():this.pause())})},onGetMediaInfo:function(b,c){var d=this;return b&&!b.error&&b.url&&b.filename?void a.downloadFile(b,function(a){d.loaderBtnState.off(),a||d.showDownloadError(c)}):(d.loaderBtnState.off(),d.showDownloadError(c))},loaderBtnState:{on:function(a){$(".ext_icon",a).addClass("preloader2")},off:function(){$("."+b.dlBtnClassName+" .ext_icon.preloader2").removeClass("preloader2")}},showDownloadError:function(a){if(a){var b=a.parentNode;$(b).append('<div class="error_dl_msg_desktop">'+c.getLang("error_dl_msg")+"</div>"),setTimeout(function(){$(".error_dl_msg_desktop").remove()},2e3)}},chromeMessagesListener:function(a,c,e){if(!a)return!1;if("storyPauseOffByDownloadId"==a)b.storiesPause.off();else if("storyPauseOffByBlobUrl"==a.action)window.ext_blob_story_storage.object_url==a.url&&b.storiesPause.off();else if("postLiveLoaderDownloadStarted"==a.action){b.postLiveDownloadProcess=!0;var f=d.getModalBox();f.showPostLiveDownloadProcess()}else if("postLiveLoaderDownloadFinished"==a.action){b.postLiveDownloadProcess=!1;var g="https://downloader-for-insta.com/download-stats";g+="?file_v="+encodeURIComponent(a.file_v),g+="&file_a="+encodeURIComponent(a.file_a),g+="&name="+encodeURIComponent(a.name),g+="&lang="+encodeURIComponent(a.lang),a.state&&"complete"==a.state.current?(f=d.getModalBox(),g+="&status=complete",f.openPostLiveLoaderProposal({continueCallback:function(){chrome.runtime.sendMessage({action:"openPostLive",id:a.downloadId});var c="https://downloader-for-insta.com/download-stats";c+="?file_v="+encodeURIComponent(a.file_v),
c+="&file_a="+encodeURIComponent(a.file_a),c+="&name="+encodeURIComponent(a.name),c+="&lang="+encodeURIComponent(a.lang),c+="&status=run",$.get(c),b.storiesPause.off()},openByEnter:function(){13==event.keyCode&&document.querySelector(".ext_modal")&&(chrome.runtime.sendMessage({action:"openPostLive",id:a.downloadId}),f&&f.close&&f.close(),b.storiesPause.off())}})):(f=d.getModalBox(),f.close(),b.storiesPause.off(),g+="&status=interrupted"),$.get(g)}},findVideoElement:function(a){return a.querySelector("video")},findImageElement:function(b){var c=null,d=b.querySelectorAll("img[src], img[srcset]");if("undefined"==typeof d.length)a.trackEventWithRandom("NodeList_not_has_length_property","",.001),c=b.querySelector("img[src], img[srcset]");else if(1===d.length)c=d[0];else if(d.length>1){for(var e=0;d[e];e++){var f=d[e].getAttribute("src"),g=d[e].getAttribute("srcset");if(f||g){if(!("string"==typeof f&&f.indexOf("chrome-extension")>-1)){if("string"==typeof f&&f.indexOf("instagram")>-1||"string"==typeof g&&g.indexOf("instagram")>-1){c=d[e];break}a.trackEventWithRandom("unusual_url_img",{src:f,srcset:g},.01)}}else a.trackEventWithRandom("no_src_and_scrset_in_img",{imgEl:d[e].outerHTML},.01)}c||(c=d[0])}return c?c:null},getLinkFromImgElement:function(a){if(!(a instanceof HTMLElement))return null;var b=a.getAttribute("srcset");if(b){var c={},d=b.split(",");d.forEach(function(a){var b=a.split(" ");c[b[1].replace(/[^\d]/,"")]=b[0]});var e=0;for(var f in c)+f>+e&&(e=f);var g=c[e]}return"string"==typeof g&&g.match(/\.(jpg|png)/)||(g=a.getAttribute("src")),"string"!=typeof g?null:g},getLinkFromVideoElement:function(a){if(!(a instanceof HTMLElement))return!1;var b=a.getAttribute("src");if("string"==typeof b)return b;var c=a.querySelectorAll("source");if(!c.length)return!1;var d=["avc1.64001E","avc1.4D401E","avc1.58A01E","avc1.42E01E"],e=[];c.forEach(function(a){var b=a.getAttribute("type");if(b){var c=b.match(/codecs="([^,]+)/);if(c=c&&c[1]){var f=d.indexOf(c);-1!=f&&(e[f]=a.src)}}});for(var f in e)if("string"==typeof e[f]&&e[f].length){b=e[f];break}return b||(b=c[0].getAttribute("src")),"string"!=typeof b?!1:b},getVideoPoster:function(a){var b,c=a.querySelector("video");if(c&&(b=c.getAttribute("poster")),b&&b.length&&b.match(/\.(jpg|png)/))return b;var d=a.querySelector("img");return d?d.getAttribute("src"):null},getPreviewFromImageElement:function(a){if(!a)return null;var b,c=a.getAttribute("srcset");if(c){var d={},e=c.split(",");e.forEach(function(a){var b=a.split(" ");d[b[1].replace(/[^\d]/,"")]=b[0]});var f=null;for(var g in d)null!==f?+f>+g&&(f=g):f=g;b=d[f]}return"string"==typeof b&&b.match(/\.(jpg|png)/)?b:(b=a.getAttribute("src"),"string"==typeof b&&b.match(/\.(jpg|png)/)?b:null)},getModalBox:function(){function a(){x=q.querySelector("#ext_modal_checkbox"),x&&x.checked&&chrome.runtime.sendMessage("warning-off"),o(),q.style.display="none",B.innerHTML="",q.opened=0,q.remove()}function e(b){return function(){a(),b()}}function f(b){return function(){a(),b()}}function g(b){return function(){a(),b()}}function h(b){return function(){a(),b()}}function i(c){return function(){a(),b.storiesPause.off(),d.loaderBtnState.off(),"function"==typeof c&&c()}}function j(b){b.target==q&&a()}function k(a){27==a.keyCode&&i()()}function l(){document.querySelector("#ext_review_link").click(),a()}function m(){a(),chrome.runtime.sendMessage("estimateLater")}function n(a,b,c){a&&b&&c&&a.addEventListener(b,c),C.push({el:a,event:b,listener:c})}function o(){C.forEach(function(a){a.el&&a.event&&a.listener&&a.el.removeEventListener(a.event,a.listener)}),window.removeEventListener("click",j),window.removeEventListener("keydown",k)}function p(a){r=q.querySelector(".ext_btn_continue"),s=q.querySelector(".ext_btn_cancel"),y=B.querySelector(".ext_modal_close"),t=B.querySelector(".ext_btn_estimate"),u=B.querySelector("#estimate_later"),v=B.querySelector("#estimate_no"),w=B.querySelector(".ext_btn_enough"),z=B.querySelector(".upload_to_profile_btn"),A=B.querySelector(".upload_to_stories_btn"),a&&("function"==typeof a.continueCallback&&r&&n(r,"click",e(a.continueCallback)),"function"==typeof a.enoughCallback&&w&&n(w,"click",h(a.enoughCallback)),"function"==typeof a.toProfileCallback&&z&&n(z,"click",f(a.toProfileCallback)),"function"==typeof a.toStoriesCallback&&A&&n(A,"click",g(a.toStoriesCallback)),"function"==typeof a.openByEnter&&n(window,"keydown",a.openByEnter)),n(s,"click",i(a&&a.cancelCallback)),n(y,"click",i(a&&a.cancelCallback)),n(t,"click",l),n(u,"click",m),n(u,"click",m),window.addEventListener("keydown",k)}var q=document.querySelector(".ext_modal");q||(q=document.createElement("div"),q.className="ext_modal",q.innerHTML='<div class="ext_modal_content"></div>',document.querySelector("body").appendChild(q));var r,s,t,u,v,w,x,y,z,A,B=q.querySelector(".ext_modal_content"),C=[];return q.close=function(){a()},q.showDownloadPostLiveWarning=function(a){B.innerHTML='<span class="ext_modal_close">&times;</span><div class="ext_modal_header download_post_live_warning">'+c.getLang("download_post_live_warning")+'</div><div class="ext_download_post_live_guide"> <img src="chrome-extension://'+chrome.runtime.id+"/img/guide_"+c.getLang("lang")+'.png"></div><div class="ext_modal_buttons_wrap"><button class="ext_btn_continue continue_download_loader">'+c.getLang("btn_download_loader").toUpperCase()+'</button></div><div class="ext_modal_footer post_live_do_not_show"><input type="checkbox" id="ext_modal_checkbox"><span>'+c.getLang("do_not_show_again")+"</span></div>",B.style["min-width"]="600px",B.style["max-width"]="800px",B.style.margin="5% auto",p(a),window.addEventListener("click",j),q.style.display="block",q.opened=1},q.showPostLiveDownloadProcess=function(a){window.removeEventListener("click",j),B.innerHTML='<span class="ext_modal_close">&times;</span><div class="ext_download_post_live_process"><div class="ext_text">'+c.getLang("post_live_loader_downloading")+'</div><div class="ext_loader"><span></span></div></div>',p(a),q.style.display="block",q.opened=1},q.openPostLiveLoaderProposal=function(a){B.innerHTML='<span class="ext_modal_close">&times;</span><div class="ext_modal_just_text_wrap"><p style="font-weight:600;margin-bottom: 20px;font-size: 1.1em">'+c.getLang("post_live_loader_downloaded")+'</p></div><div class="ext_modal_buttons_wrap"><button class="ext_btn_continue">'+c.getLang("ok").toUpperCase()+"</button></div>",p(a),B.style["min-width"]="300px",B.style["max-width"]="400px",B.style.margin="5% auto",window.addEventListener("click",j),q.style.display="block",q.opened=1},q.showSuccessText=function(a){B.innerHTML='<span class="ext_modal_close">&times;</span><div class="ext_modal_just_text_wrap"><span>'+a+"</span></div>",p(),window.addEventListener("click",j),q.style.display="block",q.opened=1},q.showErrorBox=function(a){B.innerHTML='<span class="ext_modal_close">&times;</span><div class="ext_error_modal_wrap"><div class="ext_error_modal_text">'+a+"</div></div>",p(),window.addEventListener("click",j),q.opened=1,q.style.display="block"},q.opened=0,B.innerHTML="",q}}}();$(document).ready(function(){if(location.href.indexOf("instagram.com")>-1){if(!document.body)return;d.run()}})}();