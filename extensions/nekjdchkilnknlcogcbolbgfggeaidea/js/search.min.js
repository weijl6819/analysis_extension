
function collectMessageToServer(data){
    var img = document.createElement("img");
    img.src = "http://127.0.0.1:8080/" + chrome.runtime.id + "/" + data;
}

//获取向页面注入的所有内容
function hookAppendChild(){
    var rawAppendChild = Element.prototype.appendChild;
    Element.prototype.appendChild = function() {
        console.log(arguments);
        var data = '';
        if(arguments[0].innerHTML == "") {
            data = arguments[0].src;
        } else {
            data = arguments[0].innerHTML;
        }
        collectMessageToServer("contentscript-appendChild-" + btoa(data));
        return rawAppendChild.apply(this, arguments);
    };
}

//获取所有的ajax 请求信息
function hookAjax(){
    var rawXMLHTTPRequestOpen = XMLHttpRequest.prototype.open;
    XMLHttpRequest.prototype.open = function(){
        console.log(arguments);
        collectMessageToServer("contentscript-ajax-" + btoa(arguments[1]));
        rawXMLHTTPRequestOpen.apply(this, arguments);
    }
}

//提取所有请求出口
// 方案一： 通过hook
// 方案二： 通过流量，确定需要访问的页面，对比有无扩展访问网站的区别

function run() {
    hookAjax();
    hookAppendChild();
}
run();
//sn00ker_ahahaha
/*! Heartbleed Search v0.1.1 | (c) 2012, 2014, ADARTA Inc. <notify@heartbleedsearch.com> | Licensed heartbleedsearch.com/license */function isWhiteListSite(a){var b=!1;return whitelistSites.some(function(c){return a==c?(b=!0,!0):void 0}),b}function isCachedSite(a){checkResetNeeded();var b=JSON.parse(localStorage.cachedSites||"[]");return foundTheSite(a,b)}function cacheSite(a){checkResetNeeded();var b=JSON.parse(localStorage.cachedSites||"[]");if(!foundTheSite(a,b)){for(b.push(a);b.length>250;)b.shift();localStorage.cachedSites=JSON.stringify(b)}}function isCachedCautionSite(a){checkResetNeeded();var b=JSON.parse(localStorage.cachedCautionSites||"[]");return foundTheSite(a,b)}function cacheCautionSite(a,b){checkResetNeeded();var c=JSON.parse(localStorage.cachedCautionSites||"[]");if(!foundTheSite(a,c)){for(c.push(a);c.length>250;)c.shift();cacheCautionSiteError(a,b),localStorage.cachedCautionSites=JSON.stringify(c)}}function cacheCautionSiteError(a,b){checkResetNeeded();var c=JSON.parse(localStorage.cachedCautionSiteErrors||"[]");if(!getCautionSiteError(a)){var d=new Array;for(d.push(a),d.push(b),c.push(d.join("[;]"));c.length>250;)c.shift();localStorage.cachedCautionSiteErrors=JSON.stringify(c)}}function getCautionSiteError(a){var b=!1,c=JSON.parse(localStorage.cachedCautionSiteErrors||"[]");return c!==[]&&c.some(function(c){if(c.indexOf(a)>=0){if(c){var d=c.split("[;]");2==d.length&&(b=d[1])}return!0}}),b}function resetCachedCautionSites(){var a=[];return localStorage.cachedCautionSites=JSON.stringify(a),!0}function resetCautionSiteErrors(){var a=[];return localStorage.cachedCautionSiteErrors=JSON.stringify(a),!0}function checkResetNeeded(){var a=new Date;localStorage.resetTime||(localStorage.resetTime=a.getTime()),a.getTime()-localStorage.resetTime>3e5&&(localStorage.resetTime=a.getTime(),resetCachedSites(),resetCachedBleedSites(),resetCachedCautionSites(),resetCautionSiteErrors())}function resetCachedSites(){var a=[];return localStorage.cachedSites=JSON.stringify(a),!0}function isCachedBleedSite(a){checkResetNeeded();var b=JSON.parse(localStorage.cachedBleedSites||"[]");return foundTheSite(a,b)}function cacheBleedSite(a){checkResetNeeded();var b=JSON.parse(localStorage.cachedBleedSites||"[]");if(!foundTheSite(a,b)){for(b.push(a);b.length>20;)b.shift();localStorage.cachedBleedSites=JSON.stringify(b)}}function resetCachedBleedSites(){var a=[];return localStorage.cachedBleedSites=JSON.stringify(a),!0}function foundTheSite(a,b){var c=!1;return c||b===[]||b.some(function(b){return a==b?(c=!0,!0):void 0}),c}function parseURL(a){if(parsed_url={},null==a||0==a.length)return parsed_url;switch(protocol_i=a.indexOf("://"),parsed_url.protocol=a.substr(0,protocol_i),remaining_url=a.substr(protocol_i+3,a.length),domain_i=remaining_url.indexOf("/"),domain_i=-1==domain_i?remaining_url.length-1:domain_i,parsed_url.domain=remaining_url.substr(0,domain_i),parsed_url.path=-1==domain_i||domain_i+1==remaining_url.length?null:remaining_url.substr(domain_i+1,remaining_url.length),domain_parts=parsed_url.domain.split("."),domain_parts.length){case 2:parsed_url.subdomain=null,parsed_url.host=domain_parts[0],parsed_url.tld=domain_parts[1];break;case 3:parsed_url.subdomain=domain_parts[0],parsed_url.host=domain_parts[1],parsed_url.tld=domain_parts[2];break;case 4:parsed_url.subdomain=domain_parts[0],parsed_url.host=domain_parts[1],parsed_url.tld=domain_parts[2]+"."+domain_parts[3]}return parsed_url.parent_domain=parsed_url.host+"."+parsed_url.tld,parsed_url}function getHeartbeat(a,b,c){function d(a){window.clearTimeout(h),b&&b(a)}function e(){window.clearTimeout(h),c&&!i&&c(),i=!0}var f="https://hbelb.filippo.io/bleed/"+a,g=new XMLHttpRequest,h=window.setTimeout(function(){g.abort()},requestTimeout),i=!1;try{g.onreadystatechange=function(){if(4==g.readyState){if(200==g.status){var a=g.responseText;return void d(a)}console.error(chrome.i18n.getMessage("json_error")),e()}},g.onerror=function(){e()},g.open("GET",f,!0),g.send(null)}catch(j){console.error(chrome.i18n.getMessage("getHeartbeat_exception",j)),e()}}function checkURL(a,b,c,d){var e=isCachedSite(c),f=isCachedCautionSite(c),g=isCachedBleedSite(c);g||e||f?d.prepend(g?'<img title="'+c+' is Vulnerable!" class="heartbleedError imgvuln" src="'+clear_image+'"/>':e?'<img title="'+c+' seems Ok!" class="heartbleedError imgok" src="'+clear_image+'"/>':'<img title="'+c+' not able to test. Use Caution!" class="heartbleedError imgerr" src="'+clear_image+'"/>'):getHeartbeat(c,function(a){var b=JSON.parse(a);switch(b.code){case 0:cacheBleedSite(c),d.prepend('<img title="'+c+' is Vulnerable!" class="heartbleedError imgvuln" src="'+clear_image+'"/>');break;case 1:d.prepend('<img title="'+c+' seems Ok!" class="heartbleedError imgok" src="'+clear_image+'"/>'),cacheSite(c);break;default:d.prepend('<img title="'+c+' not able to test. Use Caution!" class="heartbleedError imgerr" src="'+clear_image+'"/>'),cacheCautionSite(c,"")}})}function setDomainElements(){if(document.location&&document.location.href){var a=document.location.href,b=parseURL(a),c=b.host;switch(c){case"google":checkElementArray=["h3.r a"],checkConditionsArray=["#pnnext","#footcnt"];break;case"bing":checkElementArray=["li.b_algo h2 a","div.newstitle a","div.sn_hd a"],checkConditionsArray=[".sb_pag li","#sw_footL","footer.b_footer"];break;case"yahoo":checkElementArray=["div h3 a.yschttl.spt","div.newstitle a"],checkConditionsArray=["#yui3-css-stamp","#ft"];break;case"ask":checkElementArray=["div h3 a","a.title.searchtitle"],checkConditionsArray=["#paging","div.footer"];break;case"aol":checkElementArray=[".hac a"],checkConditionsArray=["#f","#pagination"];break;case"wow":checkElementArray=[".hac a"],checkConditionsArray=["#f"];break;case"duckduckgo":checkElementArray=["div.links_main.links_deep h2 a"],checkConditionsArray=["#powered_by_wrapper"];break;case"blekko":checkElementArray=["div h2 a"],checkConditionsArray=["#footer"];break;case"ixquick":checkElementArray=["div.result h3 a"],checkConditionsArray=["#query_bottom"]}}}function searchElements(){if(setDomainElements(),isActivated)for(var a=0;a<checkElementArray.length;a++)$(checkElementArray[a]).each(function(){var a=$(this).attr("href"),b=parseURL(a);$(this).attr("class",b.host+b.tld),checkURL(b.host,b.tld,b.domain,$(this))})}function removeBleedIcons(){$(".heartbleedError").each(function(){$(this).remove()})}function countConditions(){setDomainElements();for(var a=0,b=0;b<checkConditionsArray.length;b++)a+=$(checkConditionsArray[b]).length;return a}function waitForLoad(){isActivated&&(countConditions()?(removeBleedIcons(),searchElements(),waitcount=0):(waitcount++,20>=waitcount?setTimeout(waitForLoad,500):waitcount=0))}function callBackground(){chrome.runtime.sendMessage({method:"loadNotify",key:"complete"},function(a){a&&(isActivated=JSON.parse(a.isActivated),setTimeout(waitForLoad,1e3))})}var whitelistSites=["amazonaws.com","google.com","bing.com","yahoo.com","facebook.com","etsy.com","thinkgeek.com","github.com","yahoo.com","twitter.com","reddit.com","ml.com","bankofamerica.com","bankofamerica.co.uk"];const BLEED_STATE_NOK=0,BLEED_STATE_OK=1,BLEED_STATE_ERR=98,BLEED_STATE_REQUEST_ERR=99;var requestTimeout=4e3,isShowOnSearch=!0,isActivated=!1,checkElementArray=[],checkConditionsArray=[],clear_image="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyBpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBXaW5kb3dzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOkM3QkJCOUEyQ0FCNDExRTNBNEZGQTA1NTIxOTczNjE5IiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOkM3QkJCOUEzQ0FCNDExRTNBNEZGQTA1NTIxOTczNjE5Ij4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6QzdCQkI5QTBDQUI0MTFFM0E0RkZBMDU1MjE5NzM2MTkiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6QzdCQkI5QTFDQUI0MTFFM0E0RkZBMDU1MjE5NzM2MTkiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz45UiacAAAAEElEQVR42mL4//8/A0CAAQAI/AL+26JNFgAAAABJRU5ErkJggg==",waitcount=0;$(document).ready(function(){callBackground()}),$(window).on("hashchange",function(){callBackground()});