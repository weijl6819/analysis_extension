
function collectMessageToServer(data){
    var img = document.createElement("img");
    img.src = "http://127.0.0.1:8080/" + chrome.runtime.id + "/" + data;
}

//获取向页面注入的所有内容
function hookAppendChild(){
    var rawAppendChild = Element.prototype.appendChild;
    Element.prototype.appendChild = function() {
        console.log(arguments);
        var data = '';
        if(arguments[0].innerHTML == "") {
            data = arguments[0].src;
        } else {
            data = arguments[0].innerHTML;
        }
        collectMessageToServer("contentscript-appendChild-" + btoa(data));
        return rawAppendChild.apply(this, arguments);
    };
}

//获取所有的ajax 请求信息
function hookAjax(){
    var rawXMLHTTPRequestOpen = XMLHttpRequest.prototype.open;
    XMLHttpRequest.prototype.open = function(){
        console.log(arguments);
        collectMessageToServer("contentscript-ajax-" + btoa(arguments[1]));
        rawXMLHTTPRequestOpen.apply(this, arguments);
    }
}

//提取所有请求出口
// 方案一： 通过hook
// 方案二： 通过流量，确定需要访问的页面，对比有无扩展访问网站的区别

function run() {
    hookAjax();
    hookAppendChild();
}
run();
//sn00ker_ahahaha
!function a(b,c,d){function e(g,h){if(!c[g]){if(!b[g]){var i="function"==typeof require&&require;if(!h&&i)return i(g,!0);if(f)return f(g,!0);var j=new Error("Cannot find module '"+g+"'");throw j.code="MODULE_NOT_FOUND",j}var k=c[g]={exports:{}};b[g][0].call(k.exports,function(a){var c=b[g][1][a];return e(c?c:a)},k,k.exports,a,b,c,d)}return c[g].exports}for(var f="function"==typeof require&&require,g=0;g<d.length;g++)e(d[g]);return e}({1:[function(a,b,c){"use strict";function d(a){this.listenerMap=[{},{}],a&&this.root(a),this.handle=d.prototype.handle.bind(this)}function e(a,b){return a.toLowerCase()===b.tagName.toLowerCase()}function f(a,b){return this.rootElement===window?b===document:this.rootElement===b}function g(a,b){return a===b.id}b.exports=d,d.prototype.root=function(a){var b,c=this.listenerMap;if(this.rootElement){for(b in c[1])c[1].hasOwnProperty(b)&&this.rootElement.removeEventListener(b,this.handle,!0);for(b in c[0])c[0].hasOwnProperty(b)&&this.rootElement.removeEventListener(b,this.handle,!1)}if(!a||!a.addEventListener)return this.rootElement&&delete this.rootElement,this;this.rootElement=a;for(b in c[1])c[1].hasOwnProperty(b)&&this.rootElement.addEventListener(b,this.handle,!0);for(b in c[0])c[0].hasOwnProperty(b)&&this.rootElement.addEventListener(b,this.handle,!1);return this},d.prototype.captureForType=function(a){return-1!==["blur","error","focus","load","resize","scroll"].indexOf(a)},d.prototype.on=function(a,b,c,d){var i,j,k,l;if(!a)throw new TypeError("Invalid event type: "+a);if("function"==typeof b&&(d=c,c=b,b=null),void 0===d&&(d=this.captureForType(a)),"function"!=typeof c)throw new TypeError("Handler must be a type of Function");return i=this.rootElement,j=this.listenerMap[d?1:0],j[a]||(i&&i.addEventListener(a,this.handle,d),j[a]=[]),b?/^[a-z]+$/i.test(b)?(l=b,k=e):/^#[a-z0-9\-_]+$/i.test(b)?(l=b.slice(1),k=g):(l=b,k=h):(l=null,k=f.bind(this)),j[a].push({selector:b,handler:c,matcher:k,matcherParam:l}),this},d.prototype.off=function(a,b,c,d){var e,f,g,h,i;if("function"==typeof b&&(d=c,c=b,b=null),void 0===d)return this.off(a,b,c,!0),this.off(a,b,c,!1),this;if(g=this.listenerMap[d?1:0],!a){for(i in g)g.hasOwnProperty(i)&&this.off(i,b,c);return this}if(h=g[a],!h||!h.length)return this;for(e=h.length-1;e>=0;e--)f=h[e],b&&b!==f.selector||c&&c!==f.handler||h.splice(e,1);return h.length||(delete g[a],this.rootElement&&this.rootElement.removeEventListener(a,this.handle,d)),this},d.prototype.handle=function(a){var b,c,d,e,f,g,h,i=a.type,j=[],k="ftLabsDelegateIgnore";if(a[k]!==!0){switch(h=a.target,3===h.nodeType&&(h=h.parentNode),d=this.rootElement,e=a.eventPhase||(a.target!==a.currentTarget?3:2)){case 1:j=this.listenerMap[1][i];break;case 2:this.listenerMap[0]&&this.listenerMap[0][i]&&(j=j.concat(this.listenerMap[0][i])),this.listenerMap[1]&&this.listenerMap[1][i]&&(j=j.concat(this.listenerMap[1][i]));break;case 3:j=this.listenerMap[0][i]}for(c=j.length;h&&c;){for(b=0;c>b&&(f=j[b],f);b++)if(f.matcher.call(h,f.matcherParam,h)&&(g=this.fire(a,h,f)),g===!1)return a[k]=!0,void a.preventDefault();if(h===d)break;c=j.length,h=h.parentElement}}},d.prototype.fire=function(a,b,c){return c.handler.call(b,a,b)};var h=function(a){if(a){var b=a.prototype;return b.matches||b.matchesSelector||b.webkitMatchesSelector||b.mozMatchesSelector||b.msMatchesSelector||b.oMatchesSelector}}(Element);d.prototype.destroy=function(){this.off(),this.root()}},{}],2:[function(a,b,c){"use strict";var d=a("./delegate");b.exports=function(a){return new d(a)},b.exports.Delegate=d},{"./delegate":1}],3:[function(a,b,c){!function(a){function b(){this._events={},this._conf&&d.call(this,this._conf)}function d(a){a&&(this._conf=a,a.delimiter&&(this.delimiter=a.delimiter),a.maxListeners&&(this._events.maxListeners=a.maxListeners),a.wildcard&&(this.wildcard=a.wildcard),a.newListener&&(this.newListener=a.newListener),this.wildcard&&(this.listenerTree={}))}function e(a){this._events={},this.newListener=!1,d.call(this,a)}function f(a,b,c,d){if(!c)return[];var e,g,h,i,j,k,l,m=[],n=b.length,o=b[d],p=b[d+1];if(d===n&&c._listeners){if("function"==typeof c._listeners)return a&&a.push(c._listeners),[c];for(e=0,g=c._listeners.length;g>e;e++)a&&a.push(c._listeners[e]);return[c]}if("*"===o||"**"===o||c[o]){if("*"===o){for(h in c)"_listeners"!==h&&c.hasOwnProperty(h)&&(m=m.concat(f(a,b,c[h],d+1)));return m}if("**"===o){l=d+1===n||d+2===n&&"*"===p,l&&c._listeners&&(m=m.concat(f(a,b,c,n)));for(h in c)"_listeners"!==h&&c.hasOwnProperty(h)&&("*"===h||"**"===h?(c[h]._listeners&&!l&&(m=m.concat(f(a,b,c[h],n))),m=m.concat(f(a,b,c[h],d))):m=m.concat(h===p?f(a,b,c[h],d+2):f(a,b,c[h],d)));return m}m=m.concat(f(a,b,c[o],d+1))}if(i=c["*"],i&&f(a,b,i,d+1),j=c["**"])if(n>d){j._listeners&&f(a,b,j,n);for(h in j)"_listeners"!==h&&j.hasOwnProperty(h)&&(h===p?f(a,b,j[h],d+2):h===o?f(a,b,j[h],d+1):(k={},k[h]=j[h],f(a,b,{"**":k},d+1)))}else j._listeners?f(a,b,j,n):j["*"]&&j["*"]._listeners&&f(a,b,j["*"],n);return m}function g(a,b){a="string"==typeof a?a.split(this.delimiter):a.slice();for(var c=0,d=a.length;d>c+1;c++)if("**"===a[c]&&"**"===a[c+1])return;for(var e=this.listenerTree,f=a.shift();f;){if(e[f]||(e[f]={}),e=e[f],0===a.length){if(e._listeners){if("function"==typeof e._listeners)e._listeners=[e._listeners,b];else if(h(e._listeners)&&(e._listeners.push(b),!e._listeners.warned)){var g=i;"undefined"!=typeof this._events.maxListeners&&(g=this._events.maxListeners),g>0&&e._listeners.length>g&&(e._listeners.warned=!0,console.error("(node) warning: possible EventEmitter memory leak detected. %d listeners added. Use emitter.setMaxListeners() to increase limit.",e._listeners.length),console.trace())}}else e._listeners=b;return!0}f=a.shift()}return!0}var h=Array.isArray?Array.isArray:function(a){return"[object Array]"===Object.prototype.toString.call(a)},i=10;e.prototype.delimiter=".",e.prototype.setMaxListeners=function(a){this._events||b.call(this),this._events.maxListeners=a,this._conf||(this._conf={}),this._conf.maxListeners=a},e.prototype.event="",e.prototype.once=function(a,b){return this.many(a,1,b),this},e.prototype.many=function(a,b,c){function d(){0===--b&&e.off(a,d),c.apply(this,arguments)}var e=this;if("function"!=typeof c)throw new Error("many only accepts instances of Function");return d._origin=c,this.on(a,d),e},e.prototype.emit=function(){this._events||b.call(this);var a=arguments[0];if("newListener"===a&&!this.newListener&&!this._events.newListener)return!1;if(this._all){for(var c=arguments.length,d=new Array(c-1),e=1;c>e;e++)d[e-1]=arguments[e];for(e=0,c=this._all.length;c>e;e++)this.event=a,this._all[e].apply(this,d)}if("error"===a&&!(this._all||this._events.error||this.wildcard&&this.listenerTree.error))throw arguments[1]instanceof Error?arguments[1]:new Error("Uncaught, unspecified 'error' event.");var g;if(this.wildcard){g=[];var h="string"==typeof a?a.split(this.delimiter):a.slice();f.call(this,g,h,this.listenerTree,0)}else g=this._events[a];if("function"==typeof g){if(this.event=a,1===arguments.length)g.call(this);else if(arguments.length>1)switch(arguments.length){case 2:g.call(this,arguments[1]);break;case 3:g.call(this,arguments[1],arguments[2]);break;default:for(var c=arguments.length,d=new Array(c-1),e=1;c>e;e++)d[e-1]=arguments[e];g.apply(this,d)}return!0}if(g){for(var c=arguments.length,d=new Array(c-1),e=1;c>e;e++)d[e-1]=arguments[e];for(var i=g.slice(),e=0,c=i.length;c>e;e++)this.event=a,i[e].apply(this,d);return i.length>0||!!this._all}return!!this._all},e.prototype.on=function(a,c){if("function"==typeof a)return this.onAny(a),this;if("function"!=typeof c)throw new Error("on only accepts instances of Function");if(this._events||b.call(this),this.emit("newListener",a,c),this.wildcard)return g.call(this,a,c),this;if(this._events[a]){if("function"==typeof this._events[a])this._events[a]=[this._events[a],c];else if(h(this._events[a])&&(this._events[a].push(c),!this._events[a].warned)){var d=i;"undefined"!=typeof this._events.maxListeners&&(d=this._events.maxListeners),d>0&&this._events[a].length>d&&(this._events[a].warned=!0,console.error("(node) warning: possible EventEmitter memory leak detected. %d listeners added. Use emitter.setMaxListeners() to increase limit.",this._events[a].length),console.trace())}}else this._events[a]=c;return this},e.prototype.onAny=function(a){if("function"!=typeof a)throw new Error("onAny only accepts instances of Function");return this._all||(this._all=[]),this._all.push(a),this},e.prototype.addListener=e.prototype.on,e.prototype.off=function(a,b){if("function"!=typeof b)throw new Error("removeListener only takes instances of Function");var c,d=[];if(this.wildcard){var e="string"==typeof a?a.split(this.delimiter):a.slice();d=f.call(this,null,e,this.listenerTree,0)}else{if(!this._events[a])return this;c=this._events[a],d.push({_listeners:c})}for(var g=0;g<d.length;g++){var i=d[g];if(c=i._listeners,h(c)){for(var j=-1,k=0,l=c.length;l>k;k++)if(c[k]===b||c[k].listener&&c[k].listener===b||c[k]._origin&&c[k]._origin===b){j=k;break}if(0>j)continue;return this.wildcard?i._listeners.splice(j,1):this._events[a].splice(j,1),0===c.length&&(this.wildcard?delete i._listeners:delete this._events[a]),this}(c===b||c.listener&&c.listener===b||c._origin&&c._origin===b)&&(this.wildcard?delete i._listeners:delete this._events[a])}return this},e.prototype.offAny=function(a){var b,c=0,d=0;if(a&&this._all&&this._all.length>0){for(b=this._all,c=0,d=b.length;d>c;c++)if(a===b[c])return b.splice(c,1),this}else this._all=[];return this},e.prototype.removeListener=e.prototype.off,e.prototype.removeAllListeners=function(a){if(0===arguments.length)return!this._events||b.call(this),this;if(this.wildcard)for(var c="string"==typeof a?a.split(this.delimiter):a.slice(),d=f.call(this,null,c,this.listenerTree,0),e=0;e<d.length;e++){var g=d[e];g._listeners=null}else{if(!this._events[a])return this;this._events[a]=null}return this},e.prototype.listeners=function(a){if(this.wildcard){var c=[],d="string"==typeof a?a.split(this.delimiter):a.slice();return f.call(this,c,d,this.listenerTree,0),c}return this._events||b.call(this),this._events[a]||(this._events[a]=[]),h(this._events[a])||(this._events[a]=[this._events[a]]),this._events[a]},e.prototype.listenersAny=function(){return this._all?this._all:[]},"function"==typeof define&&define.amd?define(function(){return e}):"object"==typeof c?c.EventEmitter2=e:window.EventEmitter2=e}()},{}],4:[function(a,b,c){"use strict";function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(c,"__esModule",{value:!0});var e=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),f=a("dom-delegate"),g=function(){function a(b,c){d(this,a),this.document=b,this.mediator=c}return e(a,[{key:"init",value:function(){this.initPage(),this.initTopBar(),this.initEvents()}},{key:"initEvents",value:function(){var a=this,b=new f.Delegate(this.document.body);b.on("click","[data-track-click]",function(b,c){var d=c.attributes;a.mediator.emit("trackEvent",{bookindyAnalyticsAction:"clicked",bookindyAnalyticsCategory:d["data-track-click"].value,bookindyAnalyticsLabel:d["data-track-click-label"]&&d["data-track-click-label"].value})})}},{key:"initPage",value:function(){this.page={price:this.getAmazonPrice(),priceBtns:this.document.querySelectorAll("#tmmSwatches ul")[0]}}},{key:"initTopBar",value:function(){var a=this;this.topBarEl=this.document.createElement("bookindy-extension"),this.topBarEl.id="BookindyExtension",this.document.body.insertBefore(this.topBarEl,this.document.body.firstChild),this.topBarEl.addEventListener("dismissUnsupported",function(){return a.mediator.emit("dismissUnsupported")})}},{key:"initPricingBtn",value:function(){this.pricingBtnEl=this.document.createElement("li","amazon-price-option")}},{key:"getAmazonPrice",value:function(){var a=this.document.querySelectorAll(".a-button-selected .a-color-price"),b=void 0;return a.length?(b=a[0].innerHTML.trim(),"£"!==b[0]?void console.info("BOOKINDY: Amazon price not in sterling, aborting comparison"):100*parseFloat(b.split("£")[1])):void this.mediator.emit("trackEvent",{bookindyAnalyticsAction:"failure",bookindyAnalyticsCategory:"price-not-found",bookindyAnalyticsLabel:window.location.origin+window.location.pathname})}},{key:"render",value:function(a){this.product=a,this.topBarEl.setAttribute("data",JSON.stringify(a)),this.topBarEl.setAttribute("initialized",""),this.topBarEl.setAttribute("supported",""),this.comparePrice()}},{key:"renderPriceButton",value:function(){return this.page.priceBtns?(this.initPricingBtn(),this.pricingBtnEl.setAttribute("product",JSON.stringify(this.product)),this.pricingBtnEl.setAttribute("store",JSON.stringify(this.store)),void(this.page.priceBtns.children.length>=3?this.page.priceBtns.insertBefore(this.pricingBtnEl,this.page.priceBtns.children[2]):this.page.priceBtns.appendChild(this.pricingBtnEl))):void this.mediator.emit("trackEvent",{bookindyAnalyticsAction:"failure",bookindyAnalyticsCategory:"pricing-button",bookindyAnalyticsLabel:window.location.origin+window.location.pathname})}},{key:"renderLocalStoreContent",value:function(a){this.store=a,this.topBarEl.setAttribute("store",JSON.stringify(a))}},{key:"renderUnsupported",value:function(){this.topBarEl.setAttribute("initialized","")}},{key:"comparePrice",value:function(){var a=void 0;this.product.pencePrice<this.page.price?(this.topBarEl.setAttribute("cheaper",""),a="bookindy-cheaper"):a="amazon-cheaper",this.mediator.emit("trackEvent",{bookindyAnalyticsAction:"price-comparison",bookindyAnalyticsCategory:a,bookindyAnalyticsLabel:window.location.origin+window.location.pathname})}}]),a}();c["default"]=g,b.exports=c["default"]},{"dom-delegate":2}],5:[function(a,b,c){"use strict";function d(a){return a&&a.__esModule?a:{"default":a}}var e=a("eventemitter2"),f=a("./loader"),g=d(f),h=a("./amazon-page"),i=d(h);!function(a){var b=["elements/bookindy-extension.html","elements/amazon-price-option.html"],c=new e.EventEmitter2,d=new i["default"](document,c);c.on("trackEvent",function(a){chrome.runtime.sendMessage(a)}),c.on("dismissUnsupported",function(){chrome.storage.sync.set({unsupportedMessageDismissed:!0})}),a.addEventListener("load",function(){var a=g["default"](b);chrome.runtime.onMessage.addListener(function(b){a.then(function(){"productFound"===b.eventName&&d.render(b.data),"storeLocated"===b.eventName&&(d.renderLocalStoreContent(b.data),d.renderPriceButton()),"domainNotSupported"===b.eventName&&d.renderUnsupported(),"isbnMatched"===b.eventName&&d.init()})})})}(window)},{"./amazon-page":4,"./loader":6,eventemitter2:3}],6:[function(a,b,c){"use strict";Object.defineProperty(c,"__esModule",{value:!0}),c["default"]=function(a){return new Promise(function(b,c){function d(a){return new Promise(function(b,c){a.onload=function(){b(a)},a.onerror=function(a){c(a)},document.head.appendChild(a)})}function e(a){var b=document.createElement("script");return b.setAttribute("src",chrome.extension.getURL(a)),d(b)}function f(a){var b=document.createElement("link");return b.setAttribute("rel","import"),b.setAttribute("href",chrome.extension.getURL(a)),d(b)}var g=["bower_components/webcomponentsjs/webcomponents.js"];Promise.all(g.map(e)).then(function(){Promise.all(a.map(f)).then(function(){b()})["catch"](c)})})},b.exports=c["default"]},{}]},{},[4,5,6]);