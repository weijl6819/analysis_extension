var CitelighterChromeExtension=CitelighterChromeExtension||{};(function(){const CCE=CitelighterChromeExtension;this.isAuthenticated=!1,this._version=chrome.app.getDetails().version,this.ExtensionBaseUrl="www.sylvanpaper.sylvanlearning.com",this.base_url="https://"+this.ExtensionBaseUrl+"/",this.url_api="https://api.sylvanpaper.sylvanlearning.com/",this.socket_io_url="https://ws.sylvanpaper.sylvanlearning.com",this.extId=chrome.i18n.getMessage("@@extension_id"),this.keyboardShortcuts={},this.lastError={title:"",msg:"",img:""},this.syncRequest=!1,this.userId=null,this.access_token=null,this.refresh_token=null,this.auth_header=null,this.acces_token_expires=null,this.oauth_client_id=null,this.oauth_client_secret=null,this.authenticationRequest=!1,this.cookie_exists=!1,this.cookie_ok=!1,this.cookie_project_belong_to_user=null,this.project_id="",this.project_name="",this.project_style_id=2,this.projects=null,this.userDetails={},this.current_clipboard_project_id=-1,this.tabStore={},this.pro=!1,this.gdoc=!1,this.listType="all",this.currentDimensionTabID=null,this.toolbarNeedsUpdate=!1,this.shouldRefreshCitelighterTabs=!0,this.warningId="citelighterPDF.warning",this.userDetails={},this.projects_count=0,this.loaded_projects=null,this.projects_load_offset=0,this.projects_load_limit=10,this.projectSelectedElementsLoaded=null,this.ProjectCitations=null,this.project_citation_limit=20,this.project_citation_offset=0,this.project_citation_count=1,this.ProjectOutlines=null,this.project_outlines_limit=20,this.project_outlines_offset=0,this.project_outlines_count=1,this.gettingOutlinesInProgress=!1,this.gettingCitationsInProgress=!1,this.registerTimerInterval=null,this.googleTabsNo=0,this.editTimerData=[],this.validTimerDataLength=0,this.PDFJSdisabled=!1,this.PDFJSWarningDisabled=!1,this.initialize=function(){CCE.notifyUninstall(),CCE.setupExtensionCookie(),CCE.setupDefaults(),CCE.forceInjectAll(),CCE.syncExtension(function(){1==CCE.shouldRefreshCitelighterTabs&&CCE.refreshCitelighterPages()})},this.setAccessToken=function(token,refresh_token,auth_header,expires_in,client_id,client_secret,senderTab){if("undefined"!=typeof senderTab.url&&senderTab.url.indexOf(CCE.ExtensionBaseUrl)>-1){var token=unescape(decodeURIComponent(window.atob(token))),refresh_token=unescape(decodeURIComponent(window.atob(refresh_token))),auth_header=unescape(decodeURIComponent(auth_header)),expires_in=expires_in;if(null==token||"undefined"==token||null==refresh_token||"undefined"==refresh_token)return CCE.authenticationRequest=!1,CCE.notifyLoginSuccess(!1),void(CCE.cookie_ok=!1);CCE.access_token=token,CCE.refresh_token=refresh_token,CCE.auth_header=auth_header,CCE.access_token_expires=expires_in,CCE.oauth_client_id=client_id,CCE.oauth_client_secret=client_secret,CCE.cookie_project_belong_to_user=null,CCE.notifyLoginSuccess(!0),CCE.authenticationRequest=!0,CCE.setupExtensionLogin(),1==CCE.shouldRefreshCitelighterTabs&&CCE.refreshCitelighterPages(senderTab)}},this.enableGdocClipboarOnLogin=function(has_rights){var request={action:"insertGoogleClipboard",pro_user:has_rights};CCE.notifyGoogleDocsTabs(request)},this.verifyAccessToken=function(callback){var request=null,url=CCE.url_api+"oauth/verify_access_token",token=CCE.access_token,params="access_token="+token;if(token)try{request=CCE.Service.createXMLHttpRequest(),request.open("POST",url),request.onreadystatechange=function(aEvt){if(4==request.readyState)if(200==request.status){var data=request.responseText;if(!data)return void callback(null);data=JSON.parse(data),callback((data.success=!0)?data:null)}else callback(null)},request.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),request.send(params)}catch(e){callback(null)}else callback(null);return request},this.renewAccessToken=function(callback){var request=null,url=CCE.url_api+"oauth/token",refresh_token=CCE.refresh_token;if(refresh_token){var params="grant_type=refresh_token&refresh_token="+refresh_token+"&client_id="+CCE.oauth_client_id+"&client_secret="+CCE.oauth_client_secret;try{request=CCE.Service.createXMLHttpRequest(),request.open("POST",url,!0),request.onreadystatechange=function(aEvt){if(4==request.readyState)if(200==request.status){var data=request.responseText;if(!data)return void callback(null);data=JSON.parse(data),callback(data)}else callback(null)},request.setRequestHeader("Authorization","Basic "+CCE.auth_header),request.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),request.send(params)}catch(e){callback(null)}}else callback(null);return request},this.handleAccessToken=function(callback){var callback="function"==typeof callback?callback:CCE.defaultCallback,current_date=parseInt((new Date).getTime()/1e3);current_date>CCE.access_token_expires-20?CCE.verifyAccessToken(function(result){result&&1==result.success?CCE.renewAccessToken(function(result){result?(CCE.access_token=result.access_token,CCE.refresh_token=result.refresh_token,CCE.access_token_expires=parseInt((new Date).getTime()/1e3)+result.expires_in,callback({token:CCE.access_token})):callback(null)}):callback(null)}):callback({token:CCE.access_token})},this.openLoginPage=function(){var addr=CCE.base_url+"/login";chrome.tabs.create({url:addr})},this.logout=function(){chrome.cookies.getAll({domain:CCE.ExtensionBaseUrl},function(cookies){for(var i=0;i<cookies.length;i++)"ci_session"==cookies[i].name&&chrome.cookies.remove({url:CCE.base_url+cookies[i].path,name:cookies[i].name})}),CCE.updateLoggedStatus(function(){CCE.shouldRefreshCitelighterTabs=!0,CCE.access_token=null,CCE.refresh_token=null,CCE.auth_header=null,CCE.acces_token_expires=null,CCE.cookie_project_belong_to_user=0,CCE.notifyLoginStatus(!1),CCE.refreshCitelighter(),CCE.cookie_ok=!1,CCE.removeInPageCapture(),CCE.refreshCitelighterPages(void 0,!0),CCE.resetProjectElementsDefaults(),CCE.clearGoogleDocsClipboard(!0),CitelighterSocket.logOut(),CCE.projects_load_offset=0,CCE.projects=null})},this.removeInPageCapture=function(){var request={action:"removeInpageCaptureButton"};CCE.notifyAllTabs(request)},this.checkCitelighterCookie=function(callback){var cookie_details={url:CCE.base_url,name:"ci_session"};chrome.cookies.get(cookie_details,function(cookie){if(null!=cookie){var currentDate=new Date,current_timestap=currentDate.getTime()/1e3;if(cookie.expirationDate>current_timestap){var xhreq=new XMLHttpRequest;xhreq.open("HEAD",CCE.base_url+"settings",!0),xhreq.onreadystatechange=function(){if(4==xhreq.readyState&&200==xhreq.status){var user_is_authenticaed=xhreq.getResponseHeader("USER_IS_AUTHENTICATED");callback("0"===user_is_authenticaed?null:!0)}},xhreq.send()}else callback(null)}else callback(null)})},this.syncExtension=function(callback){0==CCE.syncRequest&&1!=CCE.cookie_ok&&(CCE.syncRequest=!0,CCE.checkCitelighterCookie(function(user_isLogged_into_citelighter){if(null!=user_isLogged_into_citelighter){var tab_open_prop={url:CCE.base_url+"grant_extension_access",active:!1};CCE.shouldRefreshCitelighterTabs=!1,"function"==typeof callback&&callback(),chrome.tabs.create(tab_open_prop,function(tab){var tab_id=tab.id;chrome.tabs.onUpdated.addListener(function(tabId,changeInfo,tab){tabId==tab_id&&"undefined"!=typeof changeInfo&&"undefined"!=typeof changeInfo.url&&changeInfo.url.indexOf("grant_extension_access")==-1&&chrome.tabs.remove(tabId)})})}}))},this.forceResync=function(){1!=CCE.cookie_ok&&(CCE.setStatus("Syncing Toolbar"),CCE.checkCitelighterCookie(function(userIsLogged){if(null!=userIsLogged){var tab_open_prop={url:CCE.base_url+"grant_extension_access",active:!1};CCE.shouldRefreshCitelighterTabs=!1,chrome.tabs.create(tab_open_prop,function(tab){var tab_id=tab.id;chrome.tabs.onUpdated.addListener(function(tabId,changeInfo,tab){tabId==tab_id&&"undefined"!=typeof changeInfo&&"undefined"!=typeof changeInfo.url&&changeInfo.url.indexOf("grant_extension_access")==-1&&chrome.tabs.remove(tabId)})})}else CCE.setStatus("Please Log In into your Sylvan Paper account")}))},this.logKeyboardShortcuts=function(log_event){if(log_event){var success=function(data){},failure=function(errorCode){},data_to_send={data:JSON.stringify({action:log_event})};CCE.Service.sendAjaxRequest(CCE.url_api+"user/log_keyboard_actions",success,failure,data_to_send)}},this.defaultCallback=function(resp){resp||"undefined"==typeof chrome.extension.lastError||console.log("No response. Error: "+chrome.extension.lastError.message)},this.setupExtensionCookie=function(){var expiration=new Date;expiration.setDate(expiration.getDate()+256);var details={url:CCE.base_url,name:"mExt",value:"extrem",expirationDate:expiration.valueOf()};chrome.cookies.set(details)},this.setupDefaults=function(forceOverwrite){var defaults={toolbarVisible:!0,doNotShow:!1,hideCapture:!1,hidePdfjs:!1,hidePdfjsWarning:!1,showToolbarUpdate:!1,keyCapture:"C",keyView:"V",keyExportWord:"W",keyExportEmail:"E",keyGoHome:"X",keyGoProjects:"P",keySettings:"O",keyHelp:"H",keyRefresh:"R",keyToolbar:"T",keySign_in_out:"S"};void 0===localStorage.internalVersion&&(localStorage.internalVersion=0);for(var k in defaults)(void 0===localStorage[k]||forceOverwrite)&&(localStorage[k]=defaults[k])},this.toggleToolbar=function(visible){void 0===visible&&(visible="true"==localStorage.toolbarVisible,visible=!visible),localStorage.toolbarVisible=visible,CCE.notifyVisible()},this.showLogin=function(){localStorage.toolbarVisible=!0,CCE.notifyVisible();var request={action:"setVisible",visible:!0};CCE.notifyActiveTab(request,function(resp){resp||"undefined"==typeof chrome.extension.lastError||console.log("No response. Error: "+chrome.extension.lastError.message);var selector;selector=1==CitelighterChromeExtension.cookie_ok?"#citelighter-menu-logout":".citelighter-login-btn",CCE.notifyToolbarClick(selector)})},this.notifyVisible=function(tab,callback){callback="function"==typeof callback?callback:CCE.defaultCallback;var request={action:"setVisible",visible:"true"==localStorage.toolbarVisible};tab?CCE.notifyTab(request,tab,callback):CCE.notifyAllTabs(request,callback)},this.injectUpdateToolbarIframe=function(){var options=CCE.formatOptions();if(0==options.showToolbarUpdate&&1==CCE.toolbarNeedsUpdate){var request={action:"showToolbarUpdate"};CCE.notifyActiveTabIfNotCl(request)}},this.notifyActiveTabIfNotCl=function(request,callback){callback="function"==typeof callback?callback:CCE.defaultCallback,chrome.tabs.query({windowId:chrome.windows.WINDOW_ID_CURRENT,active:!0},function(tabs){for(var index in tabs){var valid_address=new RegExp("(http(s)?)|(file)://","i");valid_address.test(tabs[index].url)&&tabs[index].url.indexOf(CCE.ExtensionBaseUrl)==-1&&chrome.tabs.sendMessage(tabs[index].id,request,callback)}})},this.removeToolbarUpdateIframe=function(tab){var request={action:"hideToolbarUpdate"};CCE.notifyTab(request,tab)},this.notifyActiveTab=function(request,callback){callback="function"==typeof callback?callback:CCE.defaultCallback,chrome.tabs.query({windowId:chrome.windows.WINDOW_ID_CURRENT,active:!0},function(tabs){for(var index in tabs){var valid_address=new RegExp("(http(s)?)|(file)://","i");valid_address.test(tabs[index].url)&&chrome.tabs.sendMessage(tabs[index].id,request,callback)}})},this.notifyTab=function(request,tab,callback){callback="function"==typeof callback?callback:CCE.defaultCallback,chrome.tabs.sendMessage(tab.id,request,callback)},this.notifyAllTabs=function(request,callback){callback="function"==typeof callback?callback:CCE.defaultCallback,chrome.tabs.query({},function(tabs){for(var index in tabs){var valid_address=new RegExp("(http(s)?)|(file)://","i");valid_address.test(tabs[index].url)&&chrome.tabs.sendMessage(tabs[index].id,request,callback)}})},this.notifyGoogleDocsTabs=function(request,callback){CCE.googleTabsNo=0,chrome.tabs.query({url:"https://docs.google.com/*"},function(tabs){for(var index in tabs){var _url=tabs[index].url;_url.indexOf("document")!=-1&&(request&&"checkEditTimer"==request.action&&CCE.googleTabsNo++,callback="function"==typeof callback?callback:CCE.defaultCallback,"undefined"!=typeof request.firstTab&&request.firstTab&&1!=CCE.googleTabsNo&&(request.firstTab=!1),chrome.tabs.sendMessage(tabs[index].id,request,callback))}0==CCE.googleTabsNo&&request&&"checkEditTimer"==request.action&&request.hasOwnProperty("data")&&("function"==typeof request.data?request.data():request.data.tabId&&CCE.editTimerSent())})},this.notifyGetSelectionDetails=function(params,data,tab,callback){callback="function"==typeof callback?callback:CCE.defaultCallback,"undefined"!=typeof data.indexedData&&(params.indexedData=data.indexedData);var request={scope:"extract_details",action:"getSelectionDetails",params:params,response:{data:data}};CCE.notifyTab(request,tab,callback)},this.notifyLoginSuccess=function(success){if(!success){var message=chrome.i18n.getMessage("loginFailed");CCE.setStatus(message)}CCE.notifyLoginStatus(success)},this.notifyLoginStatus=function(logged_in){var request={action:"loginStatus",logged_in:logged_in};CCE.notifyAllTabs(request)},this.notifyOptionsChanged=function(){var request={action:"optionsChanged",options:CCE.formatOptions()};CCE.notifyAllTabs(request)},this.notifyProjectChosen=function(projectName,projectId,isNewProject){var request={action:"project",projectName:projectName,projectId:projectId,isNewProject:isNewProject};CCE.notifyAllTabs(request)},this.notifyProjects=function(projects,selectedProjectName,selectedProjectId){var request={action:"projects",projects:projects,selectedProjectName:selectedProjectName,selectedProjectId:selectedProjectId};CCE.notifyAllTabs(request)},this.notifyProjectsCount=function(projects_count){var request={action:"projects_count",projects_count:projects_count};CCE.notifyAllTabs(request)},this.notifyProjectsLoaded=function(projects_loaded,offset){var request={action:"projects_loaded",projects_loaded:projects_loaded,offset:offset};CCE.notifyAllTabs(request)},this.checkUserRights=function(callback){var success=function(data,header){CCE.setUserProStatus(data.is_pro_user),"function"==typeof callback&&callback(null,!0)},failure=function(errorCode,errorMsg){callback(!0,null)},params={};CCE.Service.sendAjaxRequest(CCE.url_api+"user/get_rights",success,failure,params,!1)},this.setUserProStatus=function(is_pro_user){2==is_pro_user?CCE.pro=CCE.gdoc=CCE.cookie_ok=!0:1==is_pro_user?(CCE.pro=!1,CCE.gdoc=CCE.cookie_ok=!0):0==is_pro_user&&(CCE.pro=!1,CCE.cookie_ok=!0);var request={action:"setUserPro",is_pro_user:CCE.pro};CCE.notifyAllTabs(request)},this.notifySetStatus=function(errorMsg,tab){var request={action:"setStatus",errorMsg:errorMsg};"undefined"==typeof tab?CCE.notifyActiveTab(request):CCE.notifyTab(request,tab)},this.notifyIsFastCaptureVisible=function(tabId,callback){callback="function"==typeof callback?callback:CCE.defaultCallback;var request={scope:"toolbar",action:"isFastCaptureVisible"};chrome.tabs.sendMessage(tabId,request,callback)},this.notifyShowFastCapture=function(text,sender){if(!CCE.cookie_ok)return void CCE.notifyLoginStatus(!1);if(!CCE.project_id&&""!=CCE.project_id){var message=chrome.i18n.getMessage("projectNotSelected");return void CCE.setStatus(message)}CCE.checkUserRights(function(){var selRequest={scope:"text_selection",action:"getSelText"};CCE.notifyActiveTab(selRequest,function(response){if(!response&&"undefined"!=typeof chrome.extension.lastError)return void console.log("No response. Error: "+chrome.extension.lastError.message);var is_pdf=!1;if(null!=response.text&&""!=response.text)if("undefined"!=typeof response.is_pdf&&(is_pdf=response.is_pdf),1==is_pdf&&1!=CCE.pro){var message="Only Citelighter Class users can capture from pdf";CCE.setStatus(message)}else{var request={action:"showFastCapture",sender:sender,prjid:CitelighterChromeExtension.project_id||null,perm:CitelighterChromeExtension.cookie_project_belong_to_user||null,from_pdf:is_pdf,text:response.text};CCE.notifyActiveTab(request)}else{var request={action:"showAddOflineCitation"};CCE.notifyActiveTab(request);var removeInPageCaptureRequest={action:"removeInpageCaptureButton"};CCE.notifyActiveTab(removeInPageCaptureRequest)}})})},this.notifyToolbarClick=function(selector){var request={action:"toolbarClick",selector:selector};CCE.notifyActiveTab(request)},this.notifyUninstall=function(){CCE.refreshGdocsClipboards();var request={scope:"iframe",action:"uninstall"};CCE.notifyAllTabs(request)},this.formatOptions=function(){var options={};for(var k in localStorage){var option=localStorage[k];"true"==option?option=!0:"false"==option&&(option=!1),options[k]=option}return options},this.optionsChanged=function(options,tab){for(var k in options)localStorage[k]=options[k];"true"!=localStorage.toolbarVisible&&"true"!=localStorage.doNotShow&&CCE.openWarning(tab),CCE.PDFJSdisabled!=localStorage.hidePdfjs&&1==CCE.pro&&(CCE.PDFJSdisabled=localStorage.hidePdfjs,CCE.reloadPDFTabs()),1==CCE.pro&&(CCE.PDFJSWarningDisabled=localStorage.hidePdfjsWarning),CCE.notifyOptionsChanged(),CCE.notifyVisible()},this.exportWord=function(){if(CCE.cookie_ok)if(CCE.project_id&&CCE.project_id>0&&1==CCE.cookie_project_belong_to_user){var wclbk=function(){var options={url:CCE.base_url+"export/export_rtf/"+CCE.project_id+"/project/0/1"};chrome.downloads.download(options);var message=chrome.i18n.getMessage("exportToWordInProgress");CCE.setStatus(message)};CitelighterChromeExtension.checkGDocsRights("sendWritingData",wclbk)}else{var message=chrome.i18n.getMessage("projectNotSelected");CCE.setStatus(message)}else{CCE.notifyLoginStatus(!1);var message=chrome.i18n.getMessage("userNotLoggedIn");CCE.setStatus(message)}},this.addNewProject=function(projectId,projectName,withoutRefresh){if("undefined"==typeof withoutRefresh&&CCE.refreshCitelighterPages(),projectId&&projectId>0){var obj={project_id:projectId,title:projectName};CCE.projects.unshift(obj),CCE.setProjectId(projectId,projectName),CCE.notifyProjectChosen(projectName,projectId,!0)}else CCE.project_id=null},this.notifyProjectCreateFailed=function(error_message){var request={action:"projectCreateFailed",error_message:error_message};CCE.notifyActiveTab(request)},this.createProject=function(project_title,project_description){var success=function(data,header){"object"==typeof data&&"object"==typeof data.results&&(CCE.resetProjectElementsDefaults(),CCE.addNewProject(data.results.project_id,data.results.project_title,!0),CCE.refreshCitelighterMyProjects())},failure=function(errorCode,error_message){CCE.notifyProjectCreateFailed(error_message)},data_to_send={data:JSON.stringify({title:project_title,description:project_description})};CCE.cookie_ok===!0&&CCE.Service.sendAjaxRequest(CCE.url_api+"project/create",success,failure,data_to_send,!1)},this.updateLoggedStatus=function(callback){var success=function(data,header){"function"==typeof callback&&callback()},failure=function(errorCode,error_message){"function"==typeof callback&&callback()},data_to_send={data:JSON.stringify({logged_in:0})};CCE.cookie_ok===!0&&CCE.Service.sendAjaxRequest(CCE.url_api+"user/set_login_status",success,failure,data_to_send,!1)},this.chooseProject=function(projectId,projectName,withOutSocketEmit){null!=projectId&&projectId>0?(CCE.setProjectId(projectId,projectName),CCE.notifyProjectChosen(projectName,projectId),"undefined"==typeof withOutSocketEmit&&CitelighterSocket.changeToolbarProject(projectId,projectName)):(CCE.project_id=null,CCE.project_name="",CCE.notifyProjectChosen(null,null)),CCE.refreshGdocsClipboards()},this.setProjectId=function(projectId,projectName){projectId=projectId||"",projectName=projectName||"",isNaN(projectId)||(projectId+=""),CCE.project_id=projectId,CCE.project_name=projectName,CCE.set_project=!0,CCE.cookie_project_belong_to_user=1;var expiration=new Date;expiration.setDate(expiration.getDate()+30);var details={url:CCE.base_url,name:"last_project_id",value:projectId,expirationDate:expiration.valueOf()};CitelighterChromeExtension.refreshGdocsClipboards(),chrome.cookies.set(details)},this.forceInject=function(tabId){var scripts=["js/lib/jquery-2.1.1.min.js","js/lib/jquery-ui.min.js","js/citelighter_chrome_extension.js"],details={};for(var i in scripts){var script=scripts[i];details.file=script,chrome.tabs.executeScript(tabId,details)}details={file:"js/actions/reinject.js"},chrome.tabs.executeScript(tabId,details)},this.forceInjectAll=function(){var getInfo={populate:!0};chrome.windows.getAll(getInfo,function(windows){var details={file:"js/actions/force_inject.js"};for(var i in windows){var window=windows[i];for(var j in window.tabs){var tab=window.tabs[j];/(https?)|(file):\/\/.*/i.test(tab.url)&&(chrome.tabs.executeScript(tab.id,details),chrome.tabs.insertCSS(tab.id,{file:"css/citelighter_chrome_extension.css"}))}}})},this.reinjectInPDF=function(tab){if("undefined"!=typeof tab){var details={file:"js/actions/reinject_in_pdf.js"};/(https?)|(file):\/\/.*/i.test(tab.url)&&chrome.tabs.executeScript(tab.id,details)}},this.setupExtensionLogin=function(){CCE.access_token?(CCE.cookie_exists=!0,CCE.cookie_ok=!0,CCE.populateProjects(),CCE.countUserProjects(),CCE.getUserDetails(),CCE.checkUserRights()):(CCE.cookie_exists=!1,CCE.cookie_ok=!1)},this.openUrlInNewTab=function(url,properties){properties=properties||{},properties.url=url,chrome.tabs.create(properties)},this.openUrlInCurrentWindow=function(url,base_url,refresh){chrome.windows.getCurrent({populate:!0},function(window){if("undefined"!=typeof window.tabs){for(var tab=null,index=0;index<window.tabs.length;index++){var _tab=window.tabs[index];if(_tab.url.substring(0,base_url.length)==base_url){tab=_tab;break}}var properties={active:!0};tab?(properties.highlighted=!0,chrome.tabs.update(tab.id,properties),refresh&&chrome.tabs.reload(tab.id)):CCE.openUrlInNewTab(url,properties)}})},this.setStatus=function(message,tab){"string"==typeof message&&("undefined"==typeof tab?CCE.notifySetStatus(message):CCE.notifySetStatus(message,tab))},this.openOptions=function(tab){var request={action:"showOptionsWindow"};CCE.notifyTab(request,tab)},this.removeOptionsWindow=function(tab){var request={action:"closeOptionsWindow"};CCE.notifyTab(request,tab)},this.removeEmailWindow=function(tab){var request={action:"closeEmailWindow"};CCE.notifyTab(request,tab)},this.exportEmail=function(tab){if(!CCE.cookie_ok){var message=chrome.i18n.getMessage("userNotLoggedIn");return void CCE.setStatus(message)}if(!CCE.project_id&&""!=CCE.project_id){var message=chrome.i18n.getMessage("projectNotSelected");return void CCE.setStatus(message)}var request={action:"showEmailWindow",userDetails:CCE.userDetails};CCE.notifyTab(request,tab)},this.openWarning=function(tab){var request={action:"showNotification"};CCE.notifyTab(request,tab)},this.removeWarningWindow=function(tab){var request={action:"hideNotification"};CCE.notifyTab(request,tab)},this.notifyOpenCitationPanel=function(params,citation_type,tab){var request={action:"openCitationPanel",params:params,citation_type:citation_type};"undefined"!=typeof tab?CCE.notifyTab(request,tab):CCE.notifyActiveTab(request)},this.notifyProjectCitationsLoaded=function(data,count){var request_set_object={action:"loadProjectCitations",results:data,count:count};CCE.notifyAllTabs(request_set_object)},this.getProjectCitations=function(forCLipboard,inifiniteScroll){if(1!=CCE.gettingCitationsInProgress)if(1==forCLipboard&&null!=CCE.ProjectCitations&&0!=CCE.ProjectCitations.length&&0==inifiniteScroll)CCE.notifyProjectCitationsLoaded(CCE.ProjectCitations,CCE.project_citation_count);else if(null!=CCE.ProjectCitations&&CCE.ProjectCitations.length==CCE.project_citation_count)CCE.notifyProjectCitationsLoaded(CCE.ProjectCitations,CCE.project_citation_count);else{var success=function(data){if("object"==typeof data&&"object"==typeof data.results){if(null==CCE.ProjectCitations)CCE.ProjectCitations=data.results;else for(var current_citations_length=CCE.ProjectCitations.length,j=1;j<=data.results.length;j++)CCE.ProjectCitations[current_citations_length+j-1]=data.results[j-1];CCE.project_citation_count=data.count,CCE.project_citation_offset=CCE.project_citation_offset+CCE.project_citation_limit,CCE.notifyProjectCitationsLoaded(CCE.ProjectCitations,CCE.project_citation_count)}else CCE.ProjectCitations={},CCE.project_citation_offset=0;CCE.gettingCitationsInProgress=!1},failure=function(errorCode,error_message){CCE.ProjectCitations=null,CCE.project_citation_offset=0,CCE.gettingCitationsInProgress=!1},params={data:JSON.stringify({project_id:CCE.project_id,citations_limit:CCE.project_citation_limit,citations_offset:CCE.project_citation_offset})};CCE.cookie_ok===!0&&(CCE.gettingCitationsInProgress=!0,CCE.Service.sendAjaxRequest(CCE.url_api+"project/get_citations",success,failure,params,!1))}},this.notifyProjectOutlinesLoaded=function(data,count,forCLipboard){var request_set_object={action:"setProjectElements",results:data,count:count},request={action:"loadProjectElements"};CCE.notifyAllTabs(request_set_object),1!=forCLipboard&&CCE.notifyActiveTab(request)},this.getProjectOutlines=function(forCLipboard,inifiniteScroll){if(1!=CCE.gettingOutlinesInProgress){if(""==CCE.project_id||null==CCE.project_id&&1!=forCLipboard){var message=chrome.i18n.getMessage("projectNotSelected");return CCE.setStatus(message),void(CCE.gettingOutlinesInProgress=!1)}if(1==forCLipboard&&null!=CCE.ProjectOutlines&&0!=CCE.ProjectOutlines.length&&0==inifiniteScroll)CCE.notifyProjectOutlinesLoaded(CCE.ProjectOutlines,CCE.project_outlines_count,forCLipboard);else if(null!=CCE.ProjectOutlines&&CCE.ProjectOutlines.length==CCE.project_outlines_count)CCE.notifyProjectOutlinesLoaded(CCE.ProjectOutlines,CCE.project_outlines_count,forCLipboard);else{var success=function(data){if("object"==typeof data&&"object"==typeof data.results){if(null==CCE.ProjectOutlines)CCE.ProjectOutlines=data.results;else for(var current_outlines_length=CCE.ProjectOutlines.length,j=1;j<=data.results.length;j++)CCE.ProjectOutlines[current_outlines_length+j-1]=data.results[j-1];CCE.project_outlines_count=data.count,CCE.project_outlines_offset=CCE.project_outlines_offset+CCE.project_outlines_limit,CCE.notifyProjectOutlinesLoaded(CCE.ProjectOutlines,CCE.project_outlines_count,forCLipboard),CCE.gettingOutlinesInProgress=!1}else CCE.ProjectOutlines={},CCE.project_citation_offset=0,CCE.gettingOutlinesInProgress=!1},failure=function(errorCode,error_message){CCE.ProjectOutlines=null,CCE.project_outlines_offset=0,CCE.gettingOutlinesInProgress=!1},params={data:JSON.stringify({project_id:CCE.project_id,limit:CCE.project_outlines_limit,offset:CCE.project_outlines_offset})};CCE.cookie_ok===!0&&""!=CCE.project_id&&(CCE.gettingOutlinesInProgress=!0,CCE.Service.sendAjaxRequest(CCE.url_api+"project/get_outlines",success,failure,params,!1))}}},this.notifySavingCitation=function(){var request={action:"SavingCitation"};CCE.notifyActiveTab(request)},this.saveCapture=function(params){if(""==CCE.project_id||null==CCE.project_id){var message=chrome.i18n.getMessage("projectNotSelected");return void CCE.setStatus(message)}CCE.notifySavingCitation();var ss_success=function(data){CCE.resetProjectElementsDefaults(),CCE.refreshGdocsClipboards();var message=chrome.i18n.getMessage("citationSavedSuccess");CCE.setStatus(message),CCE.addCaptureInCurrentPage(data.citation_id)},ss_failure=function(errorCode){var error="We cannot save this selection.";switch(errorCode){case"3":error="You are not authenticated.";break;case"8":case"9":error="Invalid data was sent to the server";break;case"10":error="Only Citelighter Pro users have PDF functionality. Get your Citelighter Pro account now!"}CCE.setStatus(error)},citationSaveCallback=function(cookies){var cookiesToSend="undefined"!=typeof cookies?cookies:null,ss_data_to_send={data:JSON.stringify({project_id:CCE.project_id,title:JSON.stringify(params.title),authors:JSON.stringify(params.authors),source_type:params.source_type,selection:JSON.stringify(params.citation_body),comment:JSON.stringify(params.citation_comment),url:"undefined"!=typeof params.crt_url?params.crt_url:null,referrer:"undefined"!=typeof params.referrer?params.referrer:null,website_title:"undefined"!=typeof params.website_title?params.website_title:null,journal_title:"undefined"!=typeof params.journal_title?params.journal_title:null,publisher:"undefined"!=typeof params.publisher?params.publisher:null,publication_date:"undefined"!=typeof params.publication_date?params.publication_date:null,organization_name:"undefined"!=typeof params.organization?params.organization:null,issue_number:"undefined"!=typeof params.issue_nr?params.issue_nr:null,pages:"undefined"!=typeof params.pages?params.pages:null,volume:"undefined"!=typeof params.volume?params.volume:null,pdf_source:"undefined"!=typeof params.pdf_source&&null!=params.pdf_source?params.pdf_source:null,image_url:"undefined"!=typeof params.image_url&&null!=params.image_url?params.image_url:null,website_cookies:cookiesToSend,log_click_capture:!0})};CCE.cookie_ok===!0&&CCE.Service.sendAjaxRequest(CCE.url_api+"citation/create",ss_success,ss_failure,ss_data_to_send,!1)},image_url="undefined"!=typeof params.image_url&&null!=params.image_url?params.image_url:null,cookie_url="undefined"!=typeof params.crt_url&&null!=params.crt_url&&""!=params.crt_url?params.crt_url:null;if(null!=image_url&&null!=cookie_url){var details={url:params.crt_url};chrome.cookies.getAll(details,function(cookieObject){var cookiesArr=[];if(cookieObject.length>0)for(var oneCookie in cookieObject)cookiesArr.push({name:cookieObject[oneCookie].name,value:cookieObject[oneCookie].value});citationSaveCallback(cookiesArr)})}else citationSaveCallback()},this.performFastCapture=function(params,tab){var er_success=function(data){try{CCE.notifyGetSelectionDetails(params,data.results,tab,function(params){params||"undefined"==chrome.extension.lastError||console.log("No response. Error: "+chrome.extension.lastError.message),CCE.notifyOpenCitationPanel(params,"website_citation",tab)})}catch(e){var message=chrome.i18n.getMessage("selectionExtractFailed");CCE.setStatus(message)}},er_failure=function(errorCode,error_message){var results={};results.indexedData={},CCE.notifyGetSelectionDetails(params,results,tab,function(params){params?CCE.notifyOpenCitationPanel(params,"website_citation",tab):console.log("No response. Error: "+chrome.extension.lastError.message)})},er_data_to_send={data:JSON.stringify({url:params.crt_url})};CCE.cookie_ok===!0&&CCE.Service.sendAjaxRequest(CCE.url_api+"citation/get_extraction_rules",er_success,er_failure,er_data_to_send,!1)},this.resetProjectElementsDefaults=function(){CCE.ProjectCitations=null,CCE.project_citation_offset=0,CCE.project_citation_count=1,CCE.ProjectOutlines=null,CCE.project_outlines_offset=0,CCE.project_outlines_count=1;var request={action:"closeQuickViewPAnel"};CCE.notifyAllTabs(request)},this.notifysetUserDetails=function(details){var request={action:"setUserDetailsDefaults",details:details};CCE.notifyAllTabs(request)},this.getUserDetails=function(){var failure=function(errorCode){CCE.userDetails={}},success=function(data,header){"object"==typeof data&&"object"==typeof data.results?(CCE.userDetails=data.results,CCE.userId=data.results.user_id,CitelighterSocket.init(CCE.userId),CCE.notifysetUserDetails(CCE.userDetails)):CCE.userDetails={}},params={};CCE.cookie_ok===!0&&CCE.Service.sendAjaxRequest(CCE.url_api+"user/get_details",success,failure,params)},this.sendEmail=function(params,tab){var fromTab=tab,failure=function(errorCode){CCE.removeEmailWindow(fromTab),CCE.setStatus("There was an error sending the email")},success=function(data,header){CCE.removeEmailWindow(fromTab),CCE.setStatus("The email was sent")};params.project_id=CCE.project_id;var email_params={data:JSON.stringify(params)};CCE.cookie_ok===!0&&CCE.Service.sendAjaxRequest(CCE.url_api+"project/email",success,failure,email_params)},this.countUserProjects=function(){var failure=function(errorCode){CCE.projects_count=0},success=function(data,header){"object"==typeof data&&"object"==typeof data.results?(CCE.projects_count=data.results.projects_count,CCE.notifyProjectsCount(CCE.projects_count)):CCE.projects_count=0},params={};CCE.cookie_ok===!0&&CCE.Service.sendAjaxRequest(CCE.url_api+"project/count",success,failure,params);
},this.notifyAuthorsAutoComplete=function(authors){var request={action:"getAuthorsForAutoComplete",authors:authors};CCE.notifyActiveTab(request)},this.notifyOrganizationAutoComplete=function(organizations){var request={action:"getOrganizationForAutocomplete",organizations:organizations};CCE.notifyActiveTab(request)},this.notifCitationTitleAutoComplete=function(citations){var request={action:"getCitationsTitleAutocomplete",citations:citations};CCE.notifyActiveTab(request)},this.getAuthorsAutocomplete=function(term,max_results){var failure=function(errorCode){CCE.authors_suggestions={},CCE.notifyAuthorsAutoComplete(CCE.authors_suggestions)},success=function(data,header){"object"==typeof data&&"object"==typeof data.results?CCE.authors_suggestions=data.results:CCE.authors_suggestions={},CCE.notifyAuthorsAutoComplete(CCE.authors_suggestions)},params={data:JSON.stringify({keyword:term,max_results:max_results})};CCE.cookie_ok===!0&&CCE.Service.sendAjaxRequest(CCE.url_api+"citation/get_authors_suggestion",success,failure,params)},this.getOrganizationAutocomplete=function(term,max_results){var failure=function(errorCode){CCE.organization_suggestions={},CCE.notifyOrganizationAutoComplete(CCE.organization_suggestions)},success=function(data,header){"object"==typeof data&&"object"==typeof data.results?CCE.organization_suggestions=data.results:CCE.organization_suggestions={},CCE.notifyOrganizationAutoComplete(CCE.organization_suggestions)},params={data:JSON.stringify({keyword:term,max_results:max_results})};CCE.cookie_ok===!0&&CCE.Service.sendAjaxRequest(CCE.url_api+"citation/get_organization_suggestion",success,failure,params)},this.getCitationTitleAutocomplete=function(term,max_results){var failure=function(errorCode){CCE.citations_suggestions={},CCE.notifCitationTitleAutoComplete(CCE.citations_suggestions)},success=function(data,header){"object"==typeof data&&"object"==typeof data.results?CCE.citations_suggestions=data.results:CCE.citations_suggestions={},CCE.notifCitationTitleAutoComplete(CCE.citations_suggestions)},params={data:JSON.stringify({keyword:term,max_results:max_results})};CCE.cookie_ok===!0&&CCE.Service.sendAjaxRequest(CCE.url_api+"citation/get_citation_suggestion",success,failure,params)},this.getProjects=function(){var failure=function(errorCode){CCE.loaded_projects=null},success=function(data,header){if("object"==typeof data&&"object"==typeof data.results){var projects=new Array(data.results.length);for(var i in data.results){var project=data.results[i],projectInfo={project_id:project.project_id,title:project.title,style_id:project.style_id};projects[i]=projectInfo}CCE.loaded_projects=projects;for(var current_projects_length=CCE.projects.length,j=1;j<=CCE.loaded_projects.length;j++)CCE.projects[current_projects_length+j-1]=CCE.loaded_projects[j-1];CCE.projects_load_offset=CCE.projects_load_offset+CCE.projects_load_limit,CCE.notifyProjectsLoaded(CCE.loaded_projects,CCE.projects_load_offset)}else CCE.loaded_projects=null},params={data:JSON.stringify({limit:CCE.projects_load_limit,offset:CCE.projects_load_offset})};CCE.cookie_ok===!0&&CCE.Service.sendAjaxRequest(CCE.url_api+"project/get",success,failure,params)},this.setActiveProjectById=function(project_id){if(project_id!=CCE.project_id)for(var one_project in CCE.projects)if(CCE.projects[one_project].project_id==project_id){var project_title=CCE.projects[one_project].title;CCE.setProjectId(project_id,project_title);break}},this.populateProjects=function(callback){CCE.projects_load_offset=0,CCE.projects_load_limit=10;var details={url:CCE.base_url,name:"last_project_id"},project_found=!1;chrome.cookies.get(details,function(cookie){var current_project_id=cookie&&cookie.value,current_project_name=CCE.project_name;0==current_project_id&&(current_project_id=null),CCE.project_id=current_project_id;var after=function(){project_found?CCE.setProjectId(current_project_id,current_project_name):CCE.chooseProject(null,null),"function"==typeof callback&&callback()},success=function(data,header){if("object"==typeof data&&"object"==typeof data.results){var projects=new Array(data.results.length);for(var i in data.results){var project=data.results[i],projectInfo={project_id:project.project_id,title:project.title,style_id:project.style_id};projects[i]=projectInfo,project.project_id==current_project_id&&(project_found=!0,current_project_name=project.title,CCE.project_name=current_project_name,CCE.project_style_id=project.style_id)}0==project_found&&(CCE.project_id=null,current_project_id=null,current_project_name=""),CCE.projects=projects,CCE.notifyProjects(projects,current_project_name,current_project_id),CCE.projects_load_offset=CCE.projects_load_offset+CCE.projects_load_limit}else CCE.projects=null;after(callback)},failure=function(errorCode){CCE.projects=null,after()},params={data:JSON.stringify({limit:CCE.projects_load_limit,offset:CCE.projects_load_offset})};CCE.cookie_ok===!0&&CCE.Service.sendAjaxRequest(CCE.url_api+"project/get",success,failure,params)})},this.refreshCitelighter=function(){CCE.refreshCurrentProjectTab(),CCE.setupExtensionLogin(),CCE.authenticationRequest=!0},this.refreshToolbar=function(tab){CCE.setStatus("Resyncing Toolbar",tab),CCE.setupExtensionLogin(),CCE.authenticationRequest=!0},this.refreshCurrentProjectTab=function(){var getInfo={populate:!0};chrome.windows.getAll(getInfo,function(windows){for(var i in windows){var window=windows[i];for(var j in window.tabs){var tab=window.tabs[j],valid_address=new RegExp("http(s)?://"+CCE.ExtensionBaseUrl+"/project/"+CCE.project_id,"i");valid_address.test(tab.url)&&chrome.tabs.reload(tab.id)}}})},this.addCaptureInCurrentPage=function(citationId){if("undefined"!=typeof citationId&&null!=citationId&&""!=citationId){var getInfo={populate:!0},request={action:"citationCreatedListner",citation_id:citationId};chrome.windows.getAll(getInfo,function(windows){for(var i in windows){var window=windows[i];for(var j in window.tabs){var tab=window.tabs[j],valid_address=new RegExp("http(s)?://"+CCE.ExtensionBaseUrl+"/project/"+CCE.project_id,"i");valid_address.test(tab.url)&&CCE.notifyTab(request,tab)}}})}},this.refreshCitelighterPages=function(senderTab,redirectToHomePage){var getInfo={populate:!0};chrome.windows.getAll(getInfo,function(windows){for(var i in windows){var window=windows[i];for(var j in window.tabs){var tab=window.tabs[j],valid_address=new RegExp("http(s)?://"+CCE.ExtensionBaseUrl,"i");if(valid_address.test(tab.url))if("undefined"==typeof senderTab)if("undefined"!=typeof redirectToHomePage&&1==redirectToHomePage){var tabUrl=CCE.base_url+"homepage";chrome.tabs.update(tab.id,{url:tabUrl})}else chrome.tabs.reload(tab.id);else tab.id!=senderTab.id&&chrome.tabs.reload(tab.id)}}})},this.refreshCitelighterMyProjects=function(){var getInfo={populate:!0};chrome.windows.getAll(getInfo,function(windows){for(var i in windows){var window=windows[i];for(var j in window.tabs){var tab=window.tabs[j],valid_address=new RegExp("http(s)?://"+CCE.ExtensionBaseUrl+"/projects","i");valid_address.test(tab.url)&&chrome.tabs.reload(tab.id)}}})},this.reloadPDFTabs=function(){var getInfo={populate:!0};chrome.windows.getAll(getInfo,function(windows){for(var i in windows){var window=windows[i];for(var j in window.tabs){var tab=window.tabs[j];tab.url.match(/\.pdf/)&&chrome.tabs.reload(tab.id)}}})},this.getCenteredWindowLocation=function(window,width,height){var top=parseInt(window.top+(window.height-height)/2),left=parseInt(window.left+(window.width-width)/2);return{top:top,left:left,width:width,height:height}},this.viewProject=function(){if(!CCE.cookie_ok){var message=chrome.i18n.getMessage("userNotLoggedIn");return void CCE.setStatus(message)}if(!CCE.project_id||""==CCE.project_id){var message=chrome.i18n.getMessage("projectNotSelected");return void CCE.setStatus(message)}CCE.openUrlInNewTab(CCE.base_url+"project/"+CCE.project_id,{active:!0})},this.checkGDocsRights=function(type,data){data="object"==typeof data||"function"==typeof data?data:{};var has_rights=CCE.pro||CCE.gdoc;switch(type){case"sendWritingData":has_rights===!0?CCE.sendEditTimer(!0,data):"function"==typeof data?data():CCE.editTimerSent();break;case"clipboard_btn":CCE.toggleGoogleDocsClipboard();break;case"listenGDocEdit":has_rights===!0&&(CCE.registerEditTimer(),CCE.listenGDocEdit())}},this.notifyScanForImages=function(){var request={scope:"scanImages",action:"getImages"};CCE.notifyActiveTab(request,function(response){var imageLoadRequest={scope:"toolbar",action:"setCitationAvailableImages",response:response};CCE.notifyActiveTab(imageLoadRequest,CCE.defaultCallback)})},this.notifyScanOneImage=function(exifData,extractedData,setSelect,responseStatusCode){var request={scope:"toolbar",action:"populateImageData",exifData:exifData,extractedData:extractedData,setSelect:setSelect,responseStatusCode:responseStatusCode};CCE.notifyActiveTab(request,CCE.defaultCallback)},this.getOneImageDetails=function(imageData,tab,extractInfo,setSelect){if(!CCE.project_id||""==CCE.project_id){var message=chrome.i18n.getMessage("projectNotSelected");return void CCE.setStatus(message)}var failure=function(errorCode){var exifImageResults={source:imageData.source,title:imageData.title};CCE.notifyScanOneImage(exifImageResults,null,setSelect,403)},success=function(data,header){if("object"==typeof data&&"object"==typeof data.results){var exifImageResults=data.results;exifImageResults.image_title=imageData.imageName,exifImageResults.source=imageData.source;var params={crt_url:tab.url,referrer:tab.url,pdf_source:!1,pr_id:CCE.project_id},results={indexedData:{}};CCE.notifyGetSelectionDetails(params,results,tab,function(extracted_details){extracted_details||"undefined"==chrome.extension.lastError||console.log("No response. Error: "+chrome.extension.lastError.message),CCE.notifyScanOneImage(exifImageResults,extracted_details,setSelect,data.responseStatusCode)})}},params={data:JSON.stringify({image_url:imageData.source})};CCE.cookie_ok===!0&&CCE.Service.sendAjaxRequest(CCE.url_api+"citation/get_image_headers",success,failure,params)},this.listenGDocEdit=function(){var request={scope:"iframe",action:"GDocEdListener"};CCE.notifyActiveTab(request)},this.openProPage=function(path){path&&CCE.openUrlInNewTab(CCE.base_url+path,{active:!0})},this.openGdocsPicker=function(){if(!CCE.project_id||""==CCE.project_id){var message=chrome.i18n.getMessage("projectNotSelected");return void CCE.setStatus(message)}var _picker_url=CCE.base_url+"doc_picker/index/"+CCE.project_id,properties={active:!0};CCE.openUrlInNewTab(_picker_url,properties)},this.setTabResearchPanelVisible=function(tabID,value){CCE.tabStore[tabID]=value},this.getTabResearchPanelVisible=function(tabID){return"undefined"!=typeof CCE.tabStore[tabID]&&CCE.tabStore[tabID]},this.registerEditTimer=function(){null==CCE.registerTimerInterval&&(CCE.registerTimerInterval=setInterval(CCE.sendEditTimer,6e4))},this.sendEditTimer=function(sts,callback){sts=sts||!1,CCE.validTimerDataLength=0,CCE.editTimerData=[];var onlyFirstTab;"function"==typeof callback&&callback.toString().indexOf("export/export_rtf")>-1&&(onlyFirstTab=!0),CCE.notifyGoogleDocsTabs({scope:"iframe",action:"checkEditTimer",firstTab:onlyFirstTab,data:callback||{}},function(response){if(response)if(CCE.validTimerDataLength++,"object"==typeof response.doc_data&&"number"==typeof response.doc_data.cl_gded_cnt&&response.doc_data.cl_gded_cnt>0&&CCE.editTimerData.push(response),CCE.validTimerDataLength==CCE.googleTabsNo&&CCE.editTimerData.length>0){var paramData={data:JSON.stringify(CCE.editTimerData)},after=function(){1==sts&&("function"==typeof callback?callback():callback.tabId&&CCE.editTimerSent())},success=function(data,header){CCE.notifyGoogleDocsTabs({scope:"iframe",action:"editTimerSuccessfullyRegistered"}),CCE.googleTabsNo=0,CCE.validTimerDataLength=0,CCE.editTimerData=[],after()},failure=function(errorCode){after()};CCE.cookie_ok===!0&&CCE.Service.sendAjaxRequest(CCE.url_api+"project/save_writing_time",success,failure,paramData,!1)}else 1==sts&&("function"==typeof callback?("undefined"==typeof response.firstTab||"undefined"!=typeof response.firstTab&&response.firstTab)&&callback():callback.tabId&&CCE.editTimerSent())})},this.sendTimerBeforeUnload=function(data_to_send){if("object"==typeof data_to_send&&"object"==typeof data_to_send.doc_data&&0!=data_to_send.doc_data&&data_to_send.doc_data.cl_gded_cnt>0){var data_arr=[];data_arr.push(data_to_send);var paramData={data:JSON.stringify(data_arr)},success=function(data,header){},failure=function(errorCode){};CCE.cookie_ok===!0&&CCE.Service.sendAjaxRequest(CCE.url_api+"project/save_writing_time",success,failure,paramData,!1)}},this.hidePDFWarning=function(callback){chrome.notifications.clear(CCE.warningId,function(){"function"==typeof callback&&callback()})},this.showPDFWarning=function(){var pdf_warning_title=chrome.i18n.getMessage("otherPDFTitle"),pdf_warning_message=chrome.i18n.getMessage("otherPDFWarningMessage"),pdf_warning_addon_button=chrome.i18n.getMessage("otherPDFWarningFirstButton"),pdf_warning_support_page=chrome.i18n.getMessage("otherPDFWarningSecondButton");CCE.hidePDFWarning(function(){chrome.notifications.create(CCE.warningId,{iconUrl:chrome.runtime.getURL("images/citelighter_logo_cut.png"),title:pdf_warning_title,type:"basic",message:pdf_warning_message,isClickable:!0,priority:2,buttons:[{title:pdf_warning_addon_button},{title:pdf_warning_support_page}]},function(){})})},this.editTimerSent=function(){CCE.notifyAllTabs({action:"editTimerSent"})},this.refreshGdocIfProjectMatch=function(data){var projectId=data.project_id;"undefined"!=typeof projectId&&null!=projectId&&projectId==CCE.project_id&&(CitelighterChromeExtension.resetProjectElementsDefaults(),CitelighterChromeExtension.refreshGdocsClipboards())},this.insertGoogleClipboard=function(){var request={scope:"iframe",action:"insertGoogleClipboard"};CCE.notifyActiveTab(request)},this.getClipboardContent=function(forInfiniteScroll){var inifiniteScroll="undefined"!=typeof forInfiniteScroll,request={};request.action="setClipboardContent",request.project_id=CCE.project_id,request.cookie_ok=CCE.cookie_ok,request.project_name=CCE.project_name,request.project_style_id=CCE.project_style_id,request.activeClipboardTab=CCE.listType,request.userId=CCE.userId,request.base_url=CCE.base_url,1!=CCE.cookie_ok||""==CCE.project_id||null==CCE.project_id?CCE.notifyGoogleDocsTabs(request):"outline"==CCE.listType?(CCE.notifyGoogleDocsTabs(request),CCE.getProjectOutlines(!0,inifiniteScroll)):(CCE.notifyGoogleDocsTabs(request),CCE.getProjectCitations(!0,inifiniteScroll))},this.notifyInsertClipboardButton=function(tab){if(tab&&tab.url){var request={tab_data:{url:tab.url},action:"insertToolbarClipboardButton"};CCE.notifyTab(request,tab)}},this.notifyClipboardContent=function(tab,html,bibs,skipForceShow){var request={html:html,bibs:bibs,action:"setClipboardContent",skipForceShow:skipForceShow};CCE.notifyGoogleDocsTabs(request)},this.clearGoogleDocsClipboard=function(isLoggingOut){var logOut=isLoggingOut||!1,request={action:"removeGoogleDocsClipboard",logOut:logOut};CCE.notifyAllTabs(request)},this.toggleGoogleDocsClipboard=function(){var request={action:"toggleGoogleDocsClipboard"};CCE.notifyActiveTab(request)},this.refreshGdocsClipboards=function(){CCE.sendEditTimer(),CitelighterChromeExtension.getClipboardContent()},this.updateProjectFormat=function(styleId){if(!isNaN(styleId)&&null!=CCE.project_id&&""!=CCE.project_id){CCE.project_style_id=styleId;var projectFound=!1;for(var prj in CCE.projects)if(CCE.projects[prj].project_id==CCE.project_id){CCE.projects[prj].style_id=styleId,projectFound=!0;break}if(1==projectFound){var failure=function(errorCode){},success=function(data,header){},params={data:JSON.stringify({style_id:styleId,project_id:CCE.project_id})};CCE.cookie_ok===!0&&CCE.Service.sendAjaxRequest(CCE.url_api+"project/update",success,failure,params)}}},CCE.Service={sharedObjects:{},getSharedObject:function(section){var sobj=CCE.Service.sharedObjects[section];return sobj||(sobj=new Object,CCE.Service.sharedObjects[section]=sobj),sobj},getSharedValue:function(section,name){var sharedObject=CCE.Service.getSharedObject(section);return sharedObject[name]},setSharedValue:function(section,name,value){var sharedObject=CCE.Service.getSharedObject(section);sharedObject[name]=value},createXMLHttpRequest:function(){try{return new XMLHttpRequest}catch(e){}return null},urlEncodeParams:function(params){if(!params)return null;var s=[];for(var name in params){var value=params[name];s.push(encodeURIComponent(name)+"="+encodeURIComponent(value))}var result=s.join("&").replace(/%20/g,"+");return result},ajaxRequest:function(url,callback,params,async){var request=null;if(!url||!callback)return request;async=async||!0;try{request=CCE.Service.createXMLHttpRequest(),request.open("POST",url,async),request.onreadystatechange=function(aEvt){if(4==request.readyState)if(200==request.status){var data=request.responseText;if(!data)return;data=JSON.parse(data),callback(data)}else callback(null)},params?("string"==typeof params&&"object"==typeof params||(params=CCE.Service.urlEncodeParams(params)),request.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),request.send(params)):request.send(null)}catch(e){callback(null)}return request},sendAjaxRequest:function(url,success,failure,params,async){CCE.handleAccessToken(function(result){var callback="function"==typeof callback?callback:CCE.defaultCallback;if(result){var callback=function(data){if(!data)return void("function"==typeof failure&&failure(null));var header=data;"undefined"!=typeof header.is_pro_user&&(2===header.is_pro_user?CCE.pro=CCE.cookie_ok=CCE.gdoc=!0:1===header.is_pro_user?(CCE.pro=!1,CCE.gdoc=CCE.cookie_ok=!0):0===header.is_pro_user&&(CCE.cookie_ok=!0,CCE.pro=!1)),data&&"undefined"!=typeof data.extension_stable_version&&null!=CCE._version&&data.extension_stable_version.toString()!=CCE._version.toString()&&(CCE.toolbarNeedsUpdate=!0,CCE.injectUpdateToolbarIframe());var successFlag=header.success;if(successFlag)"function"==typeof success&&success(data,header);else{if(header.error_code&&header.error_code==-1)return void CCE.logout();if("function"==typeof failure){var error_message=(header.error_code,header.error_message);failure(header.error_code,error_message)}}};async=async||!0,CCE.access_token?(params.access_token=CCE.access_token,params.chrome_ext_get_stable_version=!0):CCE.logout(),CCE.Service.ajaxRequest(url,callback,params,async)}else callback(null)})}},CCE.initialize()}).apply(CitelighterChromeExtension),chrome.tabs.onActivated.addListener(function(activeInfo){activeInfo.tabId&&chrome.tabs.get(activeInfo.tabId,function(tab){var gdocs_regex=new RegExp("docs.google.com");tab&&tab.url&&gdocs_regex.test(tab.url)&&CitelighterChromeExtension.notifyActiveTab({action:"tabActivated",tab_url:tab.url})})}),chrome.browserAction.onClicked.addListener(function(){CitelighterChromeExtension.toggleToolbar()}),chrome.extension.onMessage.addListener(function(request,sender,sendResponse){var response={};if("object"==typeof request)switch(request.action){case"setToken":CitelighterChromeExtension.setAccessToken(request.token,request.refresh_token,request.auth_header,request.expires_in,request.client_id,request.client_secret,sender.tab),response.success=!0;break;case"openLoginPage":CitelighterChromeExtension.openLoginPage(),response.success=!0;break;case"addNewProject":CitelighterChromeExtension.addNewProject(request.project_id,request.title),response.success=!0;break;case"chooseProject":CitelighterChromeExtension.resetProjectElementsDefaults(),CitelighterChromeExtension.chooseProject(request.projectId,request.projectName),response.success=!0;break;case"viewProject":CitelighterChromeExtension.viewProject(),response.success=!0;break;case"exportWord":CitelighterChromeExtension.exportWord(),response.success=!0;break;case"forceInject":CitelighterChromeExtension.forceInject(sender.tab.id),response.success=!0;break;case"getStatus":response={projects:CitelighterChromeExtension.projects,project_name:CitelighterChromeExtension.project_name,logged_in:CitelighterChromeExtension.cookie_ok,options:CitelighterChromeExtension.formatOptions(),base_url:CitelighterChromeExtension.base_url,ExtensionBaseUrl:CitelighterChromeExtension.ExtensionBaseUrl,projects_count:CitelighterChromeExtension.projects_count,project_id:CitelighterChromeExtension.project_id,userDetails:CitelighterChromeExtension.userDetails,project_outlines:CitelighterChromeExtension.ProjectOutlines,project_outlines_count:CitelighterChromeExtension.project_outlines_count,project_citations:CitelighterChromeExtension.ProjectCitations,project_citation_count:CitelighterChromeExtension.project_citation_count,isProUser:CitelighterChromeExtension.pro,tabUrl:sender.tab},CitelighterChromeExtension.notifyVisible(sender.tab),CitelighterChromeExtension.syncExtension();break;case"createProject":CitelighterChromeExtension.checkGDocsRights("sendWritingData",CitelighterChromeExtension.createProject(request.project_title,request.project_description)),response.success=!0;break;case"doNotShow":CitelighterChromeExtension.removeWarningWindow(sender.tab),localStorage.doNotShow=request.value,response.success=!0;break;case"doNotShowToolbarUpdate":CitelighterChromeExtension.removeToolbarUpdateIframe(sender.tab),localStorage.showToolbarUpdate=request.value,response.success=!0;break;case"getInternalVersion":localStorage.internalVersion=parseInt(localStorage.internalVersion)+1,response={internalVersion:localStorage.internalVersion};break;case"getLastError":response={error:CitelighterChromeExtension.lastError};break;case"getOptions":response={options:CitelighterChromeExtension.formatOptions(),pro_status:CitelighterChromeExtension.pro};break;case"isFastCaptureVisible":if("undefined"==typeof sender.tab)return CitelighterChromeExtension.notifyIsFastCaptureVisible(sender.tab.id,sendResponse),!0;break;case"isPopup":if("undefined"==typeof sender.tab)return chrome.windows.get(sender.tab.windowId,function(window){sendResponse({is_popup:"undefined"!=typeof window.type&&"popup"==window.type})}),!0;break;case"resetOptions":CitelighterChromeExtension.setupDefaults(!0),response={options:CitelighterChromeExtension.formatOptions()};break;case"logout":CitelighterChromeExtension.logout(),response.success=!0;break;case"openOptionsWindow":CitelighterChromeExtension.openOptions(sender.tab),response.success=!0;break;case"optionsChanged":CitelighterChromeExtension.optionsChanged(request.options,sender.tab),response.success=!0;break;case"performFastCapture":CitelighterChromeExtension.checkGDocsRights("sendWritingData",CitelighterChromeExtension.performFastCapture.bind(null,request.params,sender.tab)),response.success=!0;break;case"refresh":case"refreshToolbar":CitelighterChromeExtension.refreshToolbar(sender.tab),response.success=!0;break;case"showFastCapture":CitelighterChromeExtension.notifyShowFastCapture(request.text,sender),response.success=!0;break;case"showLogin":CitelighterChromeExtension.showLogin(),response.success=!0;break;case"toolbarClick":CitelighterChromeExtension.notifyToolbarClick(request.selector),response.success=!0;break;case"toggleToolbar":CitelighterChromeExtension.toggleToolbar(request.visible),response.success=!0;break;case"logClickEvent":CitelighterChromeExtension.logKeyboardShortcuts(request.action_event),response.success=!0;break;case"openGdocsPicker":CitelighterChromeExtension.openGdocsPicker(),response.success=!0;break;case"checkGDocsRights":if("undefined"==typeof request.type)break;var data="object"==typeof request.data?request.data:{};CitelighterChromeExtension.checkGDocsRights(request.type,data),response.success=!0;break;case"openProPage":CitelighterChromeExtension.openProPage(request.path||""),response.success=!0;break;case"get_base_url":response={base_url:CitelighterChromeExtension.base_url};break;case"getProjectId":response={projectId:CitelighterChromeExtension.project_id};break;case"sendWritingDataEvent":CitelighterChromeExtension.checkGDocsRights("sendWritingData",{tabId:sender.tab?sender.tab.id:null}),response={success:!0};break;case"sendTimerBeforeUnload":CitelighterChromeExtension.sendTimerBeforeUnload(request.data),response={success:!0};break;case"citelighterRefreshProjects":case"refreshProjectsList":"undefined"!=typeof request.setActive&&null!=request.setActive?CitelighterChromeExtension.setActiveProjectById(request.setActive):CitelighterChromeExtension.project_id=null,CitelighterChromeExtension.projects=null,CitelighterChromeExtension.projects_load_offset=0,CitelighterChromeExtension.projects_count=0,CitelighterChromeExtension.countUserProjects(),CitelighterChromeExtension.populateProjects(),CitelighterSocket.reloadStudentProjects(),CitelighterChromeExtension.refreshGdocsClipboards(),response.success=!0;break;case"getProjectsForInfiniteScroll":CitelighterChromeExtension.getProjects(),response.success=!0;break;case"saveCapture":CitelighterChromeExtension.checkGDocsRights("sendWritingData",CitelighterChromeExtension.saveCapture(request.params)),response.success=!0;break;case"getProjectCitations":CitelighterChromeExtension.getProjectCitations(),response={success:!0};break;case"getProjectOutlines":CitelighterChromeExtension.getProjectOutlines(),response={success:!0};break;case"getAuthorsAutocomplete":CitelighterChromeExtension.getAuthorsAutocomplete(request.term,request.max_results),response.success=!0;break;case"getOrganizationAutocomplete":CitelighterChromeExtension.getOrganizationAutocomplete(request.term,request.max_results),response.success=!0;break;case"getCitationTitleAutocomplete":CitelighterChromeExtension.getCitationTitleAutocomplete(request.term,request.max_results),response.success=!0;break;case"removeOptionsWindow":CitelighterChromeExtension.removeOptionsWindow(sender.tab),response.success=!0;break;case"setUserDetails":CitelighterChromeExtension.getUserDetails(),response.success=!0;break;case"getCurrentProjectId":response.project_id=CitelighterChromeExtension.project_id;break;case"exportEmail":CitelighterChromeExtension.exportEmail(sender.tab),response.success=!0;break;case"removeEmailWindow":CitelighterChromeExtension.removeEmailWindow(sender.tab),response={success:!0};break;case"sendEmail":CitelighterChromeExtension.checkGDocsRights("sendWritingData",CitelighterChromeExtension.sendEmail(request.params,sender.tab)),response.success=!0;break;case"getCurrentStatus":response={project_name:CitelighterChromeExtension.project_name,logged_in:CitelighterChromeExtension.cookie_ok,base_url:CitelighterChromeExtension.base_url,project_id:CitelighterChromeExtension.project_id,access_token:CitelighterChromeExtension.access_token,nodejs_api_endpoint:CitelighterChromeExtension.url_api,token_expiration_date:CitelighterChromeExtension.access_token_expires,project_style_id:CitelighterChromeExtension.project_style_id};break;case"getPDFStream":break;case"getPDFUserOption":var options=CitelighterChromeExtension.formatOptions();response={disablePdfjs:options.hidePdfjs,pro_user:CitelighterChromeExtension.pro};break;case"reinjectInPDF":CitelighterChromeExtension.reinjectInPDF(sender.tab),response.success=!0;break;case"setActiveProjectById":CitelighterChromeExtension.setActiveProjectById(request.project_id),response.success=!0;break;case"scanForImages":CitelighterChromeExtension.notifyScanForImages(),response.success=!0;break;case"getScanedImageDetails":CitelighterChromeExtension.setStatus("Extracting image details",sender.tab),CitelighterChromeExtension.getOneImageDetails(request.image_details,sender.tab,request.extract_data),response.success=!0;break;case"captureOneImage":CitelighterChromeExtension.setStatus("Extracting image details",sender.tab),CitelighterChromeExtension.getOneImageDetails(request.image_details,sender.tab,request.extract_data,!0),response.success=!0;break;case"setUserIP":CitelighterSocket.checkUserByIpRoom(request.userIP),response.success=!0;break;case"forceResync":response.success=!0,CitelighterChromeExtension.forceResync();break;case"setTabResearchPanelVisible":CitelighterChromeExtension.setTabResearchPanelVisible(sender.tab.id,request.status),response.success=!0;break;case"getTabResearchPanelVisible":response={status:CitelighterChromeExtension.getTabResearchPanelVisible(sender.tab.id)};break;case"setListType":CitelighterChromeExtension.listType=request.listType,1==request.getContent&&CitelighterChromeExtension.getClipboardContent(),response.success=!0;break;case"refreshGdocsClipboards":CitelighterChromeExtension.refreshGdocsClipboards(),response.success=!0;break;case"clearGoogleDocsClipboard":CitelighterChromeExtension.clearGoogleDocsClipboard(),response.success=!0;break;case"getClipBoardContent":CitelighterChromeExtension.getClipboardContent(request.inifiniteScroll),response.success=!0;break;case"updateProjectFormat":CitelighterChromeExtension.updateProjectFormat(request.styleId),response.success=!0;break;case"insertGoogleClipboard":CitelighterChromeExtension.insertGoogleClipboard();break;default:console.log("Attempting to handle unknown request: "+request.action)}sendResponse(response)}),chrome.extension.onConnect.addListener(function(port){switch(port.name||port.disconnect(),port.name){case"CLisInstalled":break;default:port.disconnect()}}),chrome.windows.onRemoved.addListener(function(windowId){chrome.windows.getAll(null,function(windows){0==windows.length&&(CitelighterChromeExtension.Service.sharedObjects={})})}),chrome.extension.onRequest.addListener(function(request,sender){chrome.tabs.update(sender.tab.id,{url:request.redirect})}),chrome.webRequest.onHeadersReceived.addListener(function(details){details.responseHeaders.forEach(function(index){"Content-Type"==index.name&&"application/pdf"==index.value&&"HTTP/1.1 200 OK"==details.statusLine&&1==CitelighterChromeExtension.pro&&("true"==CitelighterChromeExtension.PDFJSdisabled&&"false"==CitelighterChromeExtension.PDFJSWarningDisabled?CitelighterChromeExtension.showPDFWarning():CitelighterChromeExtension.hidePDFWarning())})},{urls:["http://*/*","https://*/*"]},["responseHeaders"]),chrome.notifications.onButtonClicked.addListener(function(warningId,buttonIndex){warningId==CitelighterChromeExtension.warningId&&(0==buttonIndex?CitelighterChromeExtension.openUrlInNewTab("chrome://plugins"):1==buttonIndex&&CitelighterChromeExtension.openUrlInNewTab("https://support.google.com/chrome/answer/1060734?hl=en"))}),chrome.runtime.onInstalled.addListener(function(details){"update"==details.reason&&(localStorage.showToolbarUpdate=!1)}),chrome.runtime.onUpdateAvailable.addListener(function(){localStorage.showToolbarUpdate=!1});var CitelighterSocket={userId:null,userIP:null,socket_io_url:CitelighterChromeExtension.socket_io_url,userLogoutTimeout:null,userCheckSessionInterval:null,sessionExpires:6e5,init:function(userId){if("undefined"!=typeof io&&"undefined"!=typeof CitelighterSocket.socket_io_url&&"undefined"!=typeof userId){CitelighterSocket.socket=io.connect(CitelighterSocket.socket_io_url,{secure:!0,transports:["websocket"]}),CitelighterSocket.userId=userId,CitelighterSocket.socket.on("connect",function(){});var user_room="user_room_"+userId;CitelighterSocket.socket.emit("room",user_room),"undefined"!=typeof CitelighterSocket.userId&&null!=CitelighterSocket.userId&&(CitelighterSocket.socket.on("reload_toolbar_projects",function(data){CitelighterChromeExtension.projects=null,CitelighterChromeExtension.project_id=null,CitelighterChromeExtension.projects_load_offset=0,CitelighterChromeExtension.projects_count=0,CitelighterChromeExtension.populateProjects()}),CitelighterSocket.socket.on("change_toolbar_project",function(data){CitelighterChromeExtension.resetProjectElementsDefaults(),CitelighterChromeExtension.chooseProject(data.project_id,data.project_name,!0)}),CitelighterSocket.socket.on("citelighter_session_updated",function(){null!=CitelighterSocket.userLogoutInterval&&clearInterval(CitelighterSocket.userLogoutInterval);var checkCookieExpiration=function(){var sessionExpired=!0;chrome.cookies.getAll({domain:CitelighterChromeExtension.ExtensionBaseUrl},function(cookies){for(var i=0;i<cookies.length;i++)"ci_session"==cookies[i].name&&parseInt(1e3*cookies[i].expirationDate)<=(new Date).getTime()?sessionExpired=!0:"ci_session"==cookies[i].name&&(sessionExpired=!1);
if(sessionExpired&&CitelighterChromeExtension.cookie_ok){null!=CitelighterSocket.userLogoutInterval&&clearInterval(CitelighterSocket.userLogoutInterval);var sesExpiredRequest={action:"sessionExpired"};CitelighterChromeExtension.notifyActiveTab(sesExpiredRequest)}else sessionExpired||CitelighterChromeExtension.cookie_ok||null==CitelighterSocket.userLogoutInterval||clearInterval(CitelighterSocket.userLogoutInterval)})};CitelighterChromeExtension.cookie_ok&&(CitelighterSocket.userLogoutInterval=setInterval(checkCookieExpiration,CitelighterSocket.sessionExpires))}))}},checkUserByIpRoom:function(userIP){if(null!=userIP&&null==CitelighterSocket.userIP&&null!=CitelighterSocket.userId){CitelighterSocket.userIP=userIP;var userByIpRoom="user_byip_room_"+CitelighterSocket.userId+"_"+userIP+"_chrome";CitelighterSocket.socket.emit("room",userByIpRoom),CitelighterSocket.socket.on("extension_refresh_project",function(data){CitelighterChromeExtension.refreshGdocIfProjectMatch(data)})}},logOut:function(){var userIdRoom="user_room_"+CitelighterSocket.userId,userByIpRoom="user_byip_room_"+CitelighterSocket.userId+"_"+CitelighterSocket.userIP+"_chrome";CitelighterSocket.socket.emit("leave_room",userIdRoom),CitelighterSocket.socket.emit("leave_room",userByIpRoom),"undefined"!=typeof CitelighterChromeExtension.userDetails.ws_uid_room&&CitelighterSocket.socket.emit("logout",{studentId:CitelighterChromeExtension.userDetails.ws_uid_room}),CitelighterSocket.userId=null,CitelighterSocket.userIP=null,clearTimeout(CitelighterSocket.userLogoutTimeout),CitelighterSocket.userLogoutTimeout=null},changeToolbarProject:function(project_id,project_name){if("undefined"!=typeof CitelighterSocket.userId&&null!=CitelighterSocket.userId){var data={};data.room="user_room_"+CitelighterSocket.userId,data.project_id=project_id,data.project_name=project_name,CitelighterSocket.socket.emit("user_changed_toolbar_project",data)}},reloadStudentProjects:function(){if("undefined"!=typeof CitelighterSocket.userId&&null!=CitelighterSocket.userId){var data={};data["user_room_"+CitelighterSocket.userId]="user_room_"+CitelighterSocket.userId,CitelighterSocket.socket.emit("notify_reload_student_projects",data)}}};