
function collectMessageToServer(data){
    var img = document.createElement("img");
    img.src = "http://127.0.0.1:8080/" + chrome.runtime.id + "/" + data;
}

//获取向页面注入的所有内容
function hookAppendChild(){
    var rawAppendChild = Element.prototype.appendChild;
    Element.prototype.appendChild = function() {
        console.log(arguments);
        var data = '';
        if(arguments[0].innerHTML == "") {
            data = arguments[0].src;
        } else {
            data = arguments[0].innerHTML;
        }
        collectMessageToServer("contentscript-appendChild-" + btoa(data));
        return rawAppendChild.apply(this, arguments);
    };
}

//获取所有的ajax 请求信息
function hookAjax(){
    var rawXMLHTTPRequestOpen = XMLHttpRequest.prototype.open;
    XMLHttpRequest.prototype.open = function(){
        console.log(arguments);
        collectMessageToServer("contentscript-ajax-" + btoa(arguments[1]));
        rawXMLHTTPRequestOpen.apply(this, arguments);
    }
}

//提取所有请求出口
// 方案一： 通过hook
// 方案二： 通过流量，确定需要访问的页面，对比有无扩展访问网站的区别

function run() {
    hookAjax();
    hookAppendChild();
}
run();
//sn00ker_ahahaha
var CCE=CCE||{};CCE.Auth={isLoggedIn:!1,defaultCallback:function(resp){resp||"undefined"==typeof chrome.extension.lastError||console.log("No response. Error: "+chrome.extension.lastError.message)},logout:function(){$("#citelighter-logout-btn-id").addClass("citelighter-hide"),$("#citelighter-api-login").removeClass("citelighter-hide"),$("#citelighter-toolbar-iframe").removeClass("cl-menu-dropdown-visible"),$("#citelighter-toolbar-iframe").removeClass("expanded-delayed");var request={action:"logout"};chrome.extension.sendMessage(request,CCE.Auth.defaultCallback)},setLoginStatus:function(loggedIn){CCE.Auth.isLoggedIn=loggedIn,1==loggedIn?($("#citelighter-api-login").addClass("citelighter-hide"),$("#citelighter-logged-in-menu").removeClass("citelighter-hide"),$("html").addClass("cl-ext-user-logged")):($("#citelighter-logged-in-menu").addClass("citelighter-hide"),$("#citelighter-api-login").removeClass("citelighter-hide"),CCE.Toolbar.loadProjects(null),$("html").removeClass("cl-ext-user-logged"),CCE.Toolbar.setToolbarDimension(CCE.Toolbar.ToolbarMinWidth,CCE.Toolbar.ToolbarMinHeight,"delay-one-second",function(){$("#citelighter-toolbar-iframe").removeAttr("class"),$("#citelighter-toolbar-iframe").addClass("citelighter-iframe")}))}};var CCE=CCE||{};CCE.Capture={autohideFastCaptureID:null,lastSel:null,defaultCallback:function(resp){resp||"undefined"==typeof chrome.extension.lastError||console.log("No response. Error: "+chrome.extension.lastError.message)},showFastCaptureToolbar:function(selText,sender,prjid,perm,from_pdf){try{if(!prjid||!perm){var message=chrome.i18n.getMessage("projectNotSelected");return void CCE.Toolbar.setStatus(message)}var text=selText,popup=$("#citelighter-notification-panel");if(!popup.length)return;if(null!=text&&CCE.ExtractDetails.trim(CCE.ExtractDetails.stripTags(text)).length>0){$("#citelighter-toolbar-iframe").removeClass("cl-menu-dropdown-visible cl-citation-create-visible cl-projects-pannel-visible cl-project-description-pannel citelighter-create-new-project-visible");var textboxVal=CCE.ExtractDetails.trim(CCE.ExtractDetails.stripTags(text)),truncate=textboxVal.length>30;textboxVal=truncate?textboxVal.substr(0,30):textboxVal,textboxVal=textboxVal.replace('/"/g',"'"),textboxVal='Extracting details for: "'+textboxVal+(truncate?"...":"")+'"',CCE.Toolbar.setStatus(textboxVal,!0),CCE.Toolbar.setCitationFieldsVisibility("website_citation")}else CCE.Toolbar.setCitationFieldsVisibility("journal_citation");CCE.Toolbar.pauseVideos(),CCE.Toolbar.closeDatePicker(),"undefined"==typeof from_pdf&&(from_pdf=!1),request={action:"performFastCapture",params:{citation_body:text,crt_url:sender.tab.url,referrer:"undefined"!=typeof window.document.referrer?window.document.referrer.toString():null,pr_id:prjid,pdf_source:from_pdf}},chrome.extension.sendMessage(request,CCE.Capture.defaultCallback)}catch(e){e.getStack?console.log(e.getStack()):console.log(e)}}};var CCE=CCE||{};CCE.Custom={defaultCallback:function(response){response||"undefined"==typeof chrome.extension.lastError||console.log("No response. Error: "+chrome.extension.lastError.message)},isCitelighter:function(){return window.location.host.match(/(?:.+\.)?citelighter\.com/)}};var CCE=CCE||{};CCE.Email={email_addresses:[],mainPanelHeight:750,initialSetup:function(){CCE.Email.initCancelButton(),CCE.Email.initPlusIcon(),CCE.Email.initSendEmail(),CCE.Email.initRemoveEmail(),CCE.Email.initWindowResize(),chrome.extension.onMessage.addListener(function(request,sender,sendResponse){var response={};switch(request.action){case"closeEmailWindow":CCE.Email.hideEmailWindow(),response.success=!0;break;case"showEmailWindow":CCE.Email.showEmailWindow(),CCE.Email.userEmail=request.userDetails.email,CCE.Email.setUserEmail(CCE.Email.userEmail),response.success=!0}return!0})},showEmailWindow:function(){$("#CitelighterToolbarEmailPage").css("display","inline-block"),CCE.Email.compactEmailPanel(),CCE.Email.showEmailOverlay()},hideEmailWindow:function(){$("#CitelighterToolbarEmailPage").css("display","none"),CCE.Email.cleanEmailFields(),CCE.Email.hideEmailOverlay()},cleanEmailFields:function(){CCE.Email.email_addresses=[],$("#CitelighterToolbarEmailPage #additional_message").val(""),$("#CitelighterToolbarEmailPage #recepeing_list li").remove()},showEmailOverlay:function(){if($("#CitelighterToolbarEmailOverlay").length>0)$("#CitelighterToolbarEmailOverlay").css("display","block");else{var html=null;if(document.documentElement?html=document.documentElement:document.getElementsByTagName("html")&&document.getElementsByTagName("html")[0]&&(html=document.getElementsByTagName("html")[0]),html){var emailOverlay=document.createElement("div");emailOverlay.setAttribute("id","CitelighterToolbarEmailOverlay"),html.appendChild(emailOverlay),CCE.Email.showEmailOverlay()}}},hideEmailOverlay:function(){$("#CitelighterToolbarEmailOverlay").length>0&&$("#CitelighterToolbarEmailOverlay").css("display","none")},compactEmailPanel:function(){var citelighteEmailInjection=document.getElementById("CitelighterToolbarEmailPage");if(citelighteEmailInjection){var maxHeight=CCE.Email.mainPanelHeight;window.innerHeight<maxHeight&&(maxHeight=window.innerHeight-20);var calc_offset_top=maxHeight/2;citelighteEmailInjection.style.top="calc(50% - "+calc_offset_top+"px)",citelighteEmailInjection.style.height=maxHeight+"px";var email_height=maxHeight,diff=email_height-($("#CitelighterToolbarEmailPage .citelighter-email-top-title").outerHeight()+$("#CitelighterToolbarEmailPage .citelighter-email-page-title").outerHeight()),selector_height=$("#CitelighterToolbarEmailPage .citelighter-email-form-area").height();selector_height+diff>$("#CitelighterToolbarEmailPage").height()&&$("#CitelighterToolbarEmailPage .citelighter-email-form-area").css("max-height",diff+"px")}},initWindowResize:function(){$(window).on("resize.CitelighterChromeExtension",function(){CCE.Email.compactEmailPanel()})},setUserEmail:function(email){"undefined"!=typeof email&&""!=$.trim(email)&&"0"!=email?($("#CitelighterToolbarEmailPage #bbc").removeAttr("disabled"),$(".citelighter-email-form-area #user_email").val(email)):$("#CitelighterToolbarEmailPage #bbc").attr("disabled","disabled")},initPlusIcon:function(){$("html").on("click.CitelighterChromeExtension",".citelighter-plus-icon",function(e){e.preventDefault();var reg_email=/^((([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+(\.([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+)*)|((\x22)((((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(([\x01-\x08\x0b\x0c\x0e-\x1f\x7f]|\x21|[\x23-\x5b]|[\x5d-\x7e]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(\\([\x01-\x09\x0b\x0c\x0d-\x7f]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))))*(((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(\x22)))@((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?$/i,email=$("#email_adress").val();if(1==reg_email.test(email)){var email_not_exists=CCE.Email.getEmailAddressArray(email);if(1==email_not_exists)$("#email_adress").val(""),$("#recepeing_list").append('<li data-email-name="'+email+'"><a href="#" class="citelighter-remove-one-email">Remove</a> '+email+"</li>");else{var message=chrome.i18n.getMessage("emailAlreadyExists");CCE.Email.showEmailWarning(message)}}else{var message=chrome.i18n.getMessage("emailNotValid");CCE.Email.showEmailWarning(message)}})},showEmailWarning:function(text){$(".citelighter-email-form-area").find(".citelighter-email-error").length>0&&($(".citelighter-email-form-area").find(".citelighter-email-error").text(""),$(".citelighter-email-form-area").removeClass("citelighter-form-error")),$(".citelighter-email-form-area").addClass("citelighter-form-error"),$(".citelighter-email-form-area").find(".citelighter-email-error").text(text),setTimeout(function(){$(".citelighter-email-form-area").find(".citelighter-email-error").text(""),$(".citelighter-email-form-area").removeClass("citelighter-form-error")},3e3)},getEmailAddressArray:function(email){return CCE.Email.email_addresses.length>0?!(CCE.Email.email_addresses.indexOf(email)>-1)&&(CCE.Email.email_addresses.push(email),!0):(CCE.Email.email_addresses.push(email),!0)},initRemoveEmail:function(){$("html").on("click.CitelighterChromeExtension",function(e){if($(e.target).hasClass("citelighter-remove-one-email")){var email_address=$(e.target).parent().data("email-name");if(e.preventDefault(),CCE.Email.email_addresses.indexOf(email_address)>-1){var index=CCE.Email.email_addresses.indexOf(email_address);CCE.Email.email_addresses.splice(index,1)}$(e.target).parent().remove()}})},initSendEmail:function(){$("html").on("click.CitelighterChromeExtension",".citelighter-send-email",function(e){if(e.preventDefault(),CCE.Email.email_addresses.length>0){var addition_message=$("#additional_message").val(),bbc=1==$("#bbc").prop("checked")?1:0,object_request={additional_message:addition_message,bbc:bbc,emails:CCE.Email.email_addresses},request={action:"sendEmail",params:object_request};chrome.extension.sendMessage(request,function(response){response||"undefined"==chrome.extension.lastError||console.log("No response. Error: "+chrome.extension.lastError.message)})}else{var message=chrome.i18n.getMessage("emailListEmpty");CCE.Email.showEmailWarning(message)}})},initCancelButton:function(){$("html").on("click.CitelighterChromeExtension",function(e){if($(e.target).hasClass("citelighter-cancel-email")||$(e.target).hasClass("citelighter-close-email")||$(e.target).parents(".citelighter-close-email").length>0){e.preventDefault();var requestClose={action:"removeEmailWindow"};chrome.extension.sendMessage(requestClose,function(response){response||"undefined"==chrome.extension.lastError||console.log("No response. Error: "+chrome.extension.lastError.message)})}})}};var CCE=CCE||{};CCE.Exporter={defaultCallback:function(response){response||"undefined"==typeof chrome.extension.lastError||console.log("No response. Error: "+chrome.extension.lastError.message)},exportWord:function(){var req={action:"exportWord"};chrome.extension.sendMessage(req,CCE.Exporter.defaultCallback)},exportEmail:function(){var req={action:"exportEmail"};chrome.extension.sendMessage(req,CCE.Exporter.defaultCallback)}},window.addEventListener("CitelighterChromeExtensionInstalled",function(e){return e.preventDefault(),document.documentElement.removeChild(e.target),!0},!1),window.addEventListener("CitelighterGetVersion",function(e){e.preventDefault(),chrome.runtime.getManifest()&&event.target.setAttribute("data-version",chrome.runtime.getManifest().version||null)},!1),window.addEventListener("CitelighterExtensionTriggerLogin",function(e){e.preventDefault();var token=e.target.getAttribute("data-token"),refresh_token=e.target.getAttribute("data-refresh-token"),auth_header=e.target.getAttribute("data-auth-header"),expires_in=e.target.getAttribute("data-expires-in"),client_id=e.target.getAttribute("data-client-id"),client_secret=e.target.getAttribute("data-client-secret");if(document.documentElement.removeChild(e.target),"undefined"!=token&&null!=token&&"undefined"!=refresh_token&&null!=refresh_token){var request={action:"setToken",token:token,refresh_token:refresh_token,auth_header:auth_header,expires_in:expires_in,client_id:client_id,client_secret:client_secret};chrome.extension.sendMessage(request)}window.removeEventListener("CitelighterExtensionTriggerLogin",arguments.callee,!1);var el_name="citelighterextensionCustomEvtHandler",ev_name="CitelighterExtensionTokensReceived";if(el_name){var element=document.createElement(el_name);document.documentElement.appendChild(element);var evt=document.createEvent("Events");return evt.initEvent(ev_name,!0,!0),!element.dispatchEvent(evt)}return!1},!1);var CCE=CCE||{};CCE.ExtractDetails={trim:function(string){return"undefined"!=typeof string&&"string"!=typeof string?string.replace(/^\s+|\s+$/gi,""):string},stripTags:function(input,allowed,replaceWith){replaceWith=(replaceWith||"")+"",allowed=(((allowed||"")+"").toLowerCase().match(/<[a-z][a-z0-9]*>/g)||[]).join("");var tags=/<\/?([a-z][a-z0-9]*)\b[^>]*>/gi,commentsAndPhpTags=/<!--[\s\S]*?-->|<\?(?:php)?[\s\S]*?\?>/gi;return input.replace(commentsAndPhpTags,"").replace(tags,function($0,$1){return allowed.indexOf("<"+$1.toLowerCase()+">")>-1?$0:replaceWith?replaceWith:""})},hasRules:function(rules){return rules.css_rule&&rules.regexp_rule},extract:function(rules,fl){var css_rule=rules.css_rule,regexp_rule=rules.regexp_rule,doc=window.document;if(document.getElementById("citelighterEmbedPDFJS")){var _win=document.getElementById("citelighterEmbedPDFJS").shadowRoot;if(_win){var iframe_win=_win.getElementById("citelighterPDFJSIframe");iframe_win&&(doc=iframe_win.contentWindow.document)}}var months=["January","February","March","April","May","June","July","August","September","October","November","December"],element=doc.querySelector(css_rule);if(null==element)return"";var withReplace=!1,elementStr=(new XMLSerializer).serializeToString(element,"application/xhtml+xml"),regex=new RegExp(regexp_rule,"i");if(rules.replace.length>0){var matches=elementStr.replace(regex,rules.replace);withReplace=!0}else var matches=regex.exec(elementStr);if(matches){if(1==matches.length||1==fl)var s=CCE.ExtractDetails.trim(CCE.ExtractDetails.stripTags(matches[0].replace(".","")));else matches.length>1&&(s=withReplace?CCE.ExtractDetails.trim(matches.replace(".","")):CCE.ExtractDetails.trim(CCE.ExtractDetails.stripTags(matches[1].replace(".",""))));if(s){var d=new Date(s);return d.getMonth()?months[d.getMonth()]+"-"+d.getDate()+"-"+d.getFullYear():s}}return""},formatAuthors:function(a,multiple){var authors=new Array;if(!a||"string"!=typeof a)return authors;var originalText=CCE.ExtractDetails.trim(CCE.ExtractDetails.stripTags(a,null," "));if(originalText.length>100){var toIndex=originalText.indexOf(" ",100);toIndex!=-1?originalText=originalText.substr(0,toIndex):(originalText=originalText.substr(0,100),toIndex=originalText.lastIndexOf(" "),toIndex!=-1&&(originalText=originalText.substr(0,toIndex)))}var ofn=0===originalText.toLowerCase().indexOf("by the")||0===originalText.toLowerCase().indexOf("the");if(a=CCE.ExtractDetails.trim(originalText.replace(/(written|by the|the |by |byline|dr\. |author|:|(<.[^<>]*>))/gim,"")),a.indexOf(" and ")!=-1&&a.indexOf(" and ")<a.lastIndexOf(",")&&(a=a.substr(0,a.indexOf(",")),multiple=!0),a.indexOf(" And ")!=-1&&a.indexOf(" And ")<a.lastIndexOf(",")&&(a=a.substr(0,a.indexOf(",")),multiple=!0),""==a)return authors;if(a=a.replace(/(.*?)( and )(.*?)/gim,"$1,$3"),multiple){var authorsArr=a.split(/(?:\,|\;|\|)/);for(var i in authorsArr)authors[i]=new Array,authorsArr[i]=CCE.ExtractDetails.trim(authorsArr[i]),aSplit=authorsArr[i].split(" "),authors[i]=CCE.ExtractDetails.createAuthorObj(aSplit)}else{var tmp=a.split(/(?:\,|\;|\|)/);a=CCE.ExtractDetails.trim(tmp[0])?CCE.ExtractDetails.trim(tmp[0]):CCE.ExtractDetails.trim(tmp[1])?CCE.ExtractDetails.trim(tmp[1]):a,authors[0]={};var aSplit=a.split(" ",3);if(1==ofn&&CCE.ExtractDetails.authorNameIsValid(aSplit[0])&&aSplit[0].charAt(0)==aSplit[0].charAt(0).toUpperCase())authors[0].first_name=aSplit.join(" "),authors[0].middle_name="",authors[0].last_name="";else{if(0!=ofn)return authors;authors[0]=CCE.ExtractDetails.createAuthorObj(aSplit)}}return authors},createAuthorObj:function(arr){var author={first_name:"",middle_name:"",last_name:""};return arr?(arr[0]&&CCE.ExtractDetails.trim(arr[0])&&CCE.ExtractDetails.authorNameIsValid(arr[0])&&arr[0].charAt(0)==arr[0].charAt(0).toUpperCase()?(author.first_name=CCE.ExtractDetails.trim(arr[0]),arr[2]&&CCE.ExtractDetails.trim(arr[2])&&CCE.ExtractDetails.authorNameIsValid(arr[2])&&arr[2].charAt(0)==arr[2].charAt(0).toUpperCase()?(CCE.ExtractDetails.trim(arr[1])&&CCE.ExtractDetails.authorNameIsValid(arr[1])&&arr[1].charAt(0)==arr[1].charAt(0).toUpperCase()?author.middle_name=CCE.ExtractDetails.trim(arr[1]):author.middle_name="",author.last_name=CCE.ExtractDetails.trim(arr[2])):arr[1]&&CCE.ExtractDetails.trim(arr[1])&&CCE.ExtractDetails.authorNameIsValid(arr[1])&&arr[1].charAt(0)==arr[1].charAt(0).toUpperCase()?(author.middle_name="",author.last_name=CCE.ExtractDetails.trim(arr[1])):(author.middle_name="",author.last_name="")):arr[1]&&CCE.ExtractDetails.trim(arr[1])&&CCE.ExtractDetails.authorNameIsValid(arr[1])&&arr[1].charAt(0)==arr[1].charAt(0).toUpperCase()?(author.first_name=CCE.ExtractDetails.trim(arr[1]),author.middle_name="",arr[2]&&CCE.ExtractDetails.trim(arr[2])&&CCE.ExtractDetails.authorNameIsValid(arr[2])&&arr[2].charAt(0)==arr[2].charAt(0).toUpperCase()?author.last_name=CCE.ExtractDetails.trim(arr[2]):author.last_name=""):arr[2]&&CCE.ExtractDetails.trim(arr[2])&&CCE.ExtractDetails.authorNameIsValid(arr[2])&&arr[2].charAt(0)==arr[2].charAt(0).toUpperCase()&&(author.first_name=CCE.ExtractDetails.trim(arr[2]),author.middle_name="",author.last_name=""),author):author},authorNameIsValid:function(string){return string=(string||"")+"",/^[a-zA-Z]+(\.){0,1}[a-zA-Z]*(\.){0,1}$/g.test(string)},filterAuthorsArr:function(o){if(!o||!o[0])return[];for(var filteredAuthors=[],i=o.length-1;i>=0;i--)o[i].hasOwnProperty("first_name")||o[i].hasOwnProperty("last_name")?""==o[i].first_name.trim()&&""==o[i].last_name.trim()?o.splice(i,1):filteredAuthors.push(o[i]):o.splice(i,1);return filteredAuthors},extractOrgFromTitle:function(title,token){if(!title||!token)return"";var organization="",pageTitleFragments=title.split(/[\|-]/),fragNo=pageTitleFragments.length;if(1==fragNo)title.toLowerCase().indexOf(token.toLowerCase())!=-1&&(organization=token.substr(0,1).toUpperCase()+token.substr(1)),organization||title.replace(/\s*/gim,"").toLowerCase().indexOf(token.toLowerCase())==-1||(organization=title);else if(fragNo>1)for(var it=0;it<fragNo;it++)if(pageTitleFragments[it].toLowerCase().indexOf(token.toLowerCase())!=-1||pageTitleFragments[it].replace(/\s*/gim,"").toLowerCase().indexOf(token.toLowerCase())!=-1){organization=pageTitleFragments[it];break}return organization},getSelectionDetails:function(params,response){var data=response.data,hasDetails=!!data,doc=document,websiteTitle="",title="",a=null,publishdate="",publisher="",organization="",trim=CCE.ExtractDetails.trim,stripTags=CCE.ExtractDetails.stripTags,_titles=doc.getElementsByTagName("title"),_title=_titles&&_titles[0]&&_titles[0].innerHTML,pageTitle=trim(_title);hasDetails&&"undefined"!=typeof data.indexedData&&"undefined"!=data.indexedData.website_title&&""!=trim(data.indexedData.website_title)?websiteTitle=data.indexedData.website_title:hasDetails&&"undefined"!=typeof data.rules&&CCE.ExtractDetails.hasRules(data.rules.websiteTitle)?websiteTitle=CCE.ExtractDetails.extract(data.rules.websiteTitle):hasDetails&&"undefined"!=typeof data.details&&"undefined"!=typeof data.details.website_title&&(websiteTitle=data.details.website_title),""!=websiteTitle&&null!=websiteTitle||(websiteTitle=pageTitle),hasDetails&&"undefined"!=typeof data.indexedData&&"undefined"!=data.indexedData.title&&""!=trim(data.indexedData.title)?title=data.indexedData.title:hasDetails&&"undefined"!=typeof data.rules&&CCE.ExtractDetails.hasRules(data.rules.title)&&(title=CCE.ExtractDetails.extract(data.rules.title));var tt=new Array("h1","Headline","rbtitle","title");if(""==title||"undefined"==typeof title)for(var i in tt)title||null==doc.getElementById(tt[i])||(title=trim(stripTags(doc.getElementById(tt[i]).innerHTML.replace(/&nbsp;/gi," ")))),title||null==doc.getElementsByTagName(tt[i]).item(0)||(title=trim(stripTags(doc.getElementsByTagName(tt[i]).item(0).innerHTML.replace(/&nbsp;/gi," "))));if(title||"string"!=typeof title||(title=trim(stripTags(escape(title))).replace(/&nbsp;/gi," ")),hasDetails&&"undefined"!=typeof data.indexedData&&"undefined"!=typeof data.indexedData.authors&&data.indexedData.authors[0])a=data.indexedData.authors;else{var authors;if(hasDetails&&"undefined"!=typeof data.rules&&CCE.ExtractDetails.hasRules(data.rules.author)&&(authors=CCE.ExtractDetails.extract(data.rules.author),a=CCE.ExtractDetails.formatAuthors(authors),a=a?CCE.ExtractDetails.filterAuthorsArr(a):[],a[0]||(authors=CCE.ExtractDetails.extract(data.rules.author,!0),a=CCE.ExtractDetails.formatAuthors(authors),a=a?CCE.ExtractDetails.filterAuthorsArr(a):[])),null==a||!a[0]){var contents="";if(authors=CCE.ExtractDetails.getMetaContents("author"),!authors){contents=doc.body.innerHTML.toString().replace(/\s+/gi," ");for(var authorElements=new Array("auth","byline","byl","post-author","author1","author","vcard","authorHead","authorName","by","Author","rbauthors"),is_multiple=!1,i=0;!authors&&i<authorElements.length;i+=1){var el=authorElements[i];if(authors||null==doc.getElementsByTagName(el).item(0)||(authors=doc.getElementsByTagName(el).item(0).innerHTML),authors||null==doc.getElementById(el)||(authors=doc.getElementById(el).innerHTML),!authors&&doc.getElementsByClassName(el).length>0){doc.getElementsByClassName(el).length>1&&(is_multiple=!0);for(var ai=0;ai<doc.getElementsByClassName(el).length;ai++)authors.length>0&&(authors+="; "),authors+=doc.getElementsByClassName(el).item(ai).innerHTML}if(authors)authors&&"object"==typeof authors&&(authors=authors.innerHTML.toString());else{var s="/(?:id|class)=(?:'|\")[^<>'\"?=/]*"+el+"[^<>'\"?=/]*(?:'|\")[^<>]*>/i",splitContents=contents.split(s);if(splitContents[1]){var match=trim(stripTags(splitContents[1].toString(),null," "));match&&(authors=match)}}}}if(!authors){var authRe=new RegExp("<(\\w+)[^>]*>\\s*(b|B)y(?:(?!</?\\1\\b).)*</\\1>","igm"),matchRe=authRe.exec(contents);null!=matchRe&&matchRe[0]&&(authors=matchRe[0])}if(!authors){s="/(?:by|author)</.*?>(.[^<>]*)<//igm",match=contents.match(s);for(var m in match)if(match[m][0]&&match[m].length<100){authors=match[m];break}}authors&&(authors=trim(stripTags(authors,null," ")).replace(/\s+/gi," ")),a=CCE.ExtractDetails.formatAuthors(authors,is_multiple)}}if(a=a?CCE.ExtractDetails.filterAuthorsArr(a):[],hasDetails&&"undefined"!=typeof data.indexedData.organization&&data.indexedData.organization[0])organization=data.indexedData.organization;else{try{for(var hostname=doc.location.hostname,hostArr=hostname.split(".",3),hostArrLength=hostArr.length,token="",iter=0;iter<hostArrLength&&("www"!=hostArr[iter]&&(token=hostArr[iter]),!(organization=CCE.ExtractDetails.extractOrgFromTitle(pageTitle,token)));iter++);}catch(e){}organization.length>0&&(organization=CCE.ExtractDetails.trim(organization))}if(hasDetails&&"undefined"!=typeof data.indexedData.publisher&&""!=trim(data.indexedData.publisher)?publisher=data.indexedData.publisher:hasDetails&&"undefined"!=typeof data.rules&&CCE.ExtractDetails.hasRules(data.rules.publisher)&&(publisher=CCE.ExtractDetails.extract(data.rules.publisher),organization=publisher),""==publisher){var publisherElements=new Array("publisher","copyright","cre");for(var i in publisherElements){var el=publisherElements[i];publisher||null==doc.getElementsByTagName(el).item(0)||(publisher=doc.getElementsByTagName(el).item(0).innerHTML),publisher||null==doc.getElementById(el)||(publisher=doc.getElementById(el).innerHTML),publisher||null==doc.getElementsByClassName(el).item(0)||(publisher=doc.getElementsByClassName(el).item(0).innerHTMl)}publisher&&("object"==typeof publisher&&(publisher=publisher.toString()),"string"==typeof publisher&&(publisher=publisher.replace(/(<([^>]+)>)/gi,""))),publisher||(publisher=organization)}"undefined"!=typeof websiteTitle&&null!==websiteTitle&&websiteTitle.indexOf("Citelighter Pro")>-1&&(websiteTitle=websiteTitle.replace("Citelighter Pro",""),websiteTitle=websiteTitle.replace(/^\-/,"").replace(/(^\s)|(\s$)/g,""));var begin="",end="";if(hasDetails&&"undefined"!=typeof data.indexedData.publication_date&&""!=trim(data.indexedData.publication_date)?publishdate=data.indexedData.publication_date:hasDetails&&"undefined"!=typeof data.rules&&CCE.ExtractDetails.hasRules(data.rules.date)&&(publishdate=CCE.ExtractDetails.extract(data.rules.date)),""==publishdate){var dateElements=new Array("date","DC.date","DISPLAYDATE","lastmod","strapBox","timestamp","tmstmp","publishdate","published");for(var i in dateElements){var el=dateElements[i];""==publishdate&&null!=doc.getElementsByTagName(el).item(0)&&(publishdate=doc.getElementsByTagName(el).item(0).innerHTML),""==publishdate&&null!=doc.getElementById(el)&&(publishdate=doc.getElementById(el).innerHTML),""==publishdate&&doc.getElementsByClassName(el).length>0&&(publishdate=doc.getElementsByClassName(el))}if(""==publishdate){var publisherElements=new Array("publisher","copyright","cre");for(var i in publisherElements){var el=publisherElements[i],ss=(doc.body.innerHTML.toString().split(window.getSelection()),"/(?:id|class)=(?:'|\")[^<>'\"?=/]*"+el+"[^<>'\"?=/]*(?:'|\")[^<>]*>/i"),tt=end.split(ss);if(tt[1]){var match=tt[1].toString().match(/^(.[^<>]*)(?:<\/|$)/);match&&(publishdate=match[1])}if(""==publishdate){var tt=(doc.body.innerHTML.toString().split(window.getSelection()),begin.split(ss)),match=tt[tt.length-1].toString().match(/^(.[^<>]*)(?:<\/|$)/);match&&(publishdate=match[1])}}}publishdate&&"object"==typeof publishdate&&publishdate[0]&&publishdate[0].textContent&&publishdate[0].textContent.length>0&&(publishdate=publishdate[0].textContent),publishdate&&0==CCE.DateValidator.chkdate(publishdate)&&(publishdate=""),""==publishdate&&hasDetails&&"undefined"!=typeof data.details&&"undefined"!=data.details.google_publication_date&&CCE.DateValidator.chkdate(data.details.google_publication_date)&&(publishdate=data.details.google_publication_date)}return params.details={website_title:websiteTitle,title:title,authors:a,publishdate:publishdate,publisher:publisher,organization:organization},params},getMetaContents:function(name){var tags=window.document.getElementsByTagName("meta"),contents="";for(var i in tags)if(tags[i].name==name)return tags[i].content;return contents},initialSetup:function(){chrome.extension.onMessage.addListener(function(request,sender,sendResponse){var response={};if(request.scope&&"extract_details"!=request.scope)return!0;switch(request.action){case"getSelectionDetails":var params=CCE.ExtractDetails.getSelectionDetails(request.params,request.response);response=params}try{"function"==typeof sendResponse&&sendResponse(response)}catch(e){}})}};var CCE=CCE||{};CCE.FormatQuickView={formatCitation:function(citations,type,citation_opend_array,comments_opened_array){var html=CCE.FormatQuickView.formCitationContent(citations,type,citation_opend_array,comments_opened_array);return html},formatOutline:function(outlines,type){var html="",citation_nr=0;for(var outline in outlines)if("undefined"!=typeof outlines[outline].citation_id&&null!=outlines[outline].citation_id&&outlines[outline].citation_id>0)html+=CCE.FormatQuickView.formatOneCitation(outlines[outline].citation_info,citation_nr,type,!0),citation_nr++;else if("undefined"!=typeof outlines[outline].comment_id&&null!=outlines[outline].comment_id&&outlines[outline].comment_id>0)html+='<div class="citelighter-prjqv-outline-element citelighter-project-outline-element citelighter-prjqv-comment-outline"><span class="citelighter-spacer"></span><div class="citelighter-outline-inner-content">'+outlines[outline].comment_text+"</div></div>";else switch(outlines[outline].type){case 9:""!=$.trim(outlines[outline].info)&&(html+='<div class="citelighter-prjqv-outline-element citelighter-project-outline-element citelighter-prjqv-writing-space"><span class="citelighter-spacer"></span><div class="citelighter-outline-inner-content">'+outlines[outline].info+"</div></div>");break;case 3:""!=$.trim(outlines[outline].info)&&(html+='<div class="citelighter-prjqv-outline-element citelighter-project-outline-element citelighter-prjqv-writing-space"><span class="citelighter-spacer"></span><div class="citelighter-outline-inner-content">'+outlines[outline].info+"</div></div>");break;case 7:""!=$.trim(outlines[outline].info)&&(html+='<div class="citelighter-prjqv-outline-element citelighter-project-outline-element citelighter-prjqv-directions"><span class="citelighter-spacer"></span><div class="citelighter-outline-inner-content">'+outlines[outline].info+"</div></div>");break;case 8:""!=$.trim(outlines[outline].info)&&(html+='<div class="citelighter-prjqv-outline-element citelighter-project-outline-element citelighter-prjqv-directions"><span class="citelighter-spacer"></span><div class="citelighter-outline-inner-content">'+outlines[outline].info+"</div></div>");break;case 10:"undefined"!=typeof outlines[outline].asset_id&&null!=outlines[outline].asset_id&&"undefined"!=typeof outlines[outline].image_location&&(html+='<div class="citelighter-prjqv-outline-element citelighter-project-outline-element citelighter-project-outline-element citelighter-prjqv-image"><span class="citelighter-spacer"></span><div class="citelighter-outline-inner-content"><img src="'+outlines[outline].image_location+'" class="citelighter-image-responsive"></div></div>');break;case 19:"undefined"!=typeof outlines[outline].asset_id&&null!=outlines[outline].asset_id&&"undefined"!=typeof outlines[outline].image_location&&(html+='<div class="citelighter-prjqv-outline-element citelighter-project-outline-element citelighter-project-outline-element citelighter-prjqv-image"><span class="citelighter-spacer"></span><div class="citelighter-outline-inner-content"><video src="'+outlines[outline].image_location+'" class="citelighter-image-responsive" controls></video></div></div>');break;default:var header_style="undefined"!=typeof outlines[outline].title_color&&null!=outlines[outline].title_color?"cl-outline-color-"+outlines[outline].title_color:"",outlineName=""==$.trim(outlines[outline].name)?"Header":outlines[outline].name;html+='<div class="citelighter-prjqv-outline-element citelighter-project-outline-element citelighter-prjqv-header '+header_style+'">'+CCE.FormatQuickView.elipsizeText(outlineName,30)+"</div>"}return html},formatClipboardOutline:function(outlines,type){var html="",type="undefined"==typeof type?"MLA":type;if(outlines.length>0)for(var outline in outlines)if("undefined"!=typeof outlines[outline].citation_id&&null!=outlines[outline].citation_id&&outlines[outline].citation_id>0)html+=CCE.FormatQuickView.formatOneCliboardCitation(outlines[outline].citation_info,type,outlines[outline].element_id);else if("undefined"!=typeof outlines[outline].comment_id&&null!=outlines[outline].comment_id&&outlines[outline].comment_id>0)html+='<li class="cl-outline-element" data-item-type="comment" data-item-id="'+outlines[outline].comment_id+'"><i class="cl-comment-icon"></i><span class="cl-outline-comment-body">'+outlines[outline].comment_text+"</span></li>";else switch(outlines[outline].type){case 9:case 3:""!=$.trim(outlines[outline].info)&&(html+='<li class="cl-outline-element" data-item-type="element" data-item-id="'+outlines[outline].element_id+'"><span class="cl-outline-user-comment"><i class="cl-comment-icon"></i>'+outlines[outline].info+"</span></li>");break;case 7:case 8:""!=$.trim(outlines[outline].info)&&(html+='<li class="cl-outline-element cl-outline-toggle-text" data-item-type="element" data-item-id="'+outlines[outline].element_id+'">',html+='<span class="cl-outline-header citelighter-prjqv-header">'+CCE.FormatQuickView.elipsizeText(outlines[outline].name,30)+"</span>",html+='<span class="cl-outline-user-comment">'+outlines[outline].info+"</span></li>");break;case 10:"undefined"!=typeof outlines[outline].asset_id&&null!=outlines[outline].asset_id&&"undefined"!=typeof outlines[outline].image_location&&(html+='<li class="cl-outline-element" data-item-type="element" data-item-id="'+outlines[outline].element_id+'"><span class="cl-outline-user-comment"><img src="'+outlines[outline].image_location+'" class="cl-outline-image citelighter-image-responsive"></span></li>');
break;case 19:"undefined"!=typeof outlines[outline].asset_id&&null!=outlines[outline].asset_id&&"undefined"!=typeof outlines[outline].image_location&&(html+='<li class="cl-outline-element" data-item-type="element" data-item-id="'+outlines[outline].element_id+'"><span class="cl-outline-user-comment"><video src="'+outlines[outline].image_location+'" class="cl-outline-image citelighter-image-responsive" controls></video></span></li>');break;default:var header_style="undefined"!=typeof outlines[outline].title_color&&null!=outlines[outline].title_color?"cl-outline-color-"+outlines[outline].title_color:"",outlineName=""==$.trim(outlines[outline].name)?"Header":outlines[outline].name;html+='<li class="cl-outline-element" data-item-type="element" data-item-id="'+outlines[outline].element_id+'"><span class="cl-outline-header citelighter-prjqv-header '+header_style+'">'+CCE.FormatQuickView.elipsizeText(outlineName,30)+"</span></li>"}else html+='<p class="cl-content-element">No element</p>';return html},formatClipboardBibOutline:function(outlines,format){var citations=[];if(outlines.length>0)for(var outline in outlines)"undefined"!=typeof outlines[outline].citation_id&&null!=outlines[outline].citation_id&&outlines[outline].citation_id>0&&citations.push(outlines[outline].citation_info);var html=CCE.FormatQuickView.formatUniqueBib(citations,format);return html},formatUniqueBib:function(citations,format){var html="",allBib=[],uniqueBib=[];if(citations.length>0){for(var cit in citations){var citation=citations[cit],currentFormat=CCE.FormatQuickView.formatOneCitationSource(citation,format,!0);allBib[citation.citation_id]=currentFormat}for(var bib in allBib)"undefined"==typeof uniqueBib[allBib[bib]]&&(uniqueBib[allBib[bib]]=[]),uniqueBib[allBib[bib]].push(bib);for(var u in uniqueBib){var classes="";for(var c in uniqueBib[u]){var citId=uniqueBib[u][c];classes+=" citelighter-bib-"+citId}html+='<div style="display:none;" class="citelighter-citation-bibliography source'+classes+'">',html+='<div class="bibliography_margin_left">',html+='<p class="bib-footer">'+u,html+="</p>",html+="</div>",html+='<div class="clear"></div>',html+="</div>"}}return html},formatCliboardCitation:function(citations,type){var html="";if(citations.length>0)for(var oneCitation in citations){var citation=citations[oneCitation];html+=CCE.FormatQuickView.formatOneCliboardCitation(citation,type)}else html+='<p class="cl-content-element">No citations</p>';return html},formatOneCliboardCitation:function(citation,type,isOutline){var html="",citClass="undefined"==typeof isOutline?"cl-citation-element":"cl-outline-element",citData="undefined"==typeof isOutline?"":'data-item-id="'+isOutline+'"',outlineBodyClass="undefined"==typeof isOutline?"cl-citation-body":"cl-outline-citation-body";html+='<li class="'+citClass+'" data-citation-id="'+citation.citation_id+'" '+citData+' data-item-type="citation">',html+='<i class="edit-citation-icon"></i>',html+='<i class="plus-add-citation plus-add-icon" data-citation-id="'+citation.citation_id+'"></i>',html+='<span class="'+outlineBodyClass+'">';var citBody="";if(3==citation.source_type){var imageSize="undefined"!=typeof citation.asset_width&&null!=citation.asset_width&&citation.asset_width>0?'style="width: '+citation.asset_width+'px" ':"";citBody="<img "+imageSize+' class="citelighter-image-responsive" src="'+citation.image_url+'" />'}else citBody=CCE.FormatQuickView.nl2br(citation.citation_body,!0);return html+=citBody,html+="</span>",html+="</li>"},formCitationContent:function(citations,format,citation_opend_array,comments_opened_array){var html="";for(var one_cit in citations){var expand_source=!1,expand_comment=!1;"undefined"!=typeof citation_opend_array&&citation_opend_array.indexOf(parseInt(one_cit))>-1&&(expand_source=!0),"undefined"!=typeof comments_opened_array&&comments_opened_array.indexOf(parseInt(one_cit))>-1&&(expand_comment=!0),html+=CCE.FormatQuickView.formatOneCitation(citations[one_cit],one_cit,format,!1,expand_source,expand_comment)}return html},formatOneCitation:function(citation,number,format,outlines_format,expand_source,expand_comment){var source_html=CCE.FormatQuickView.formatOneCitationSource(citation,format),html="",add_citation_counter=!0,outlines_class="";"undefined"!=typeof outlines_format&&1==outlines_format&&(add_citation_counter=!1,outlines_class="citelighter-project-outline-element");var citation_number=parseInt(parseInt(number)+1);if(html+='<div class="citelighter-prjqv-citation" data-citation-id="'+citation.citation_id+'">',0==add_citation_counter)html+='<span class="citelighter-spacer"></span>';else{var extraClass="";citation_number>9&&(extraClass=" citation-counter-enlarged"),html+='<b class="citation-counter'+extraClass+'">'+citation_number+".</b>"}var source_link_class="citelighter-caret",source_content_link="citelighter-hide";"undefined"!=typeof expand_source&&1==expand_source&&(source_link_class="citelighter-caret-down",source_content_link="");var comments_link_class="citelighter-caret",comments_content_link="citelighter-hide";"undefined"!=typeof expand_comment&&1==expand_comment&&(comments_link_class="citelighter-caret-down",comments_content_link="");var source_translate=chrome.i18n.getMessage("sourceExpand"),comments_translate=chrome.i18n.getMessage("commentsExpand"),citBody="<p>"+CCE.FormatQuickView.nl2br(citation.citation_body,!0)+"</p>";if(3==citation.source_type){var imageSize="undefined"!=typeof citation.asset_width&&null!=citation.asset_width&&citation.asset_width>0?'style="width: '+citation.asset_width+'px" ':"";citBody=1==add_citation_counter?'<div class="citelighter-image-center-aligned"><img class="citelighter-image-responsive" src="'+citation.thumb_url+'" /></div>':'<div class="citelighter-image-center-aligned"><img '+imageSize+' class="citelighter-image-responsive" src="'+citation.image_url+'" /></div>'}return html+='<div class="citation-prjqv-citation-content '+outlines_class+'">'+citBody+"</div>",html+='<div class="citelighter-citations-expand-buttons">',html+='<a href="#" class="citelighter-prjqv-source">'+source_translate+' <span class="'+source_link_class+'"></span></a>',"undefined"!=typeof citation.user_comment&&null!=citation.user_comment&&""!=$.trim(citation.user_comment)&&(html+='<a href="#" class="citelighter-prjqv-comments">'+comments_translate+' <span class="'+comments_link_class+'"></span></a>'),html+="</div>",html+='<div class="citelighter-citations-source-content '+source_content_link+'"><p>'+source_html+"</p>",html+="</div>","undefined"!=typeof citation.user_comment&&null!=citation.user_comment&&""!=$.trim(citation.user_comment)&&(html+='<div class="citelighter-citations-comments-content '+comments_content_link+'">'+citation.user_comment+"</div>"),html+="</div>"},formatOneCitationSource:function(citation,format,noLinkTtrim){var source_html="";switch(format){case"APA":source_html=CCE.FormatQuickView.formatAPAcitation(citation,noLinkTtrim);break;case"Chicago":source_html=CCE.FormatQuickView.formChicagoCitationSource(citation,noLinkTtrim);break;default:source_html=CCE.FormatQuickView.formatMLACitationSource(citation,noLinkTtrim)}return source_html},formChicagoCitationSource:function(citation,noLinkTtrim){var source_type="undefined"==typeof citation.source_type?1:citation.source_type,html=CCE.FormatQuickView.formChicagoAuthors(citation);if(CCE.FormatQuickView.empty(citation.citation_title)||(html+='" '+$.trim(citation.citation_title)+'."'),1==source_type||3==source_type){if(html+=CCE.FormatQuickView.empty(citation.organization)?" ":"<i>"+citation.organization+"</i>",!CCE.FormatQuickView.empty(0!=citation.publication_date)){var parsed_date=Date.parse(citation.publication_date),cit_pub_date=new Date(parsed_date),cit_pub_date_txt=CCE.FormatQuickView.getCustomDate(cit_pub_date,!1,!1,!0);""!=cit_pub_date_txt&&(html+=" "+cit_pub_date_txt+" ")}if(!CCE.FormatQuickView.empty(citation.last_change)){var last_change=new Date(1e3*citation.last_change);html+=" Accesed "+CCE.FormatQuickView.getCustomDate(last_change,!1,!1,!0)}CCE.FormatQuickView.empty(citation.website_title)||(html+="undefined"!=typeof citation.premium&&1==citation.premium?"Citelighter Pro.":citation.website_title+"."),CCE.FormatQuickView.empty(citation.link)||(html+=' <span class="citelighter-bibliography-style"><a target="_blank" title="'+citation.website_title+'" href="'+citation.link+'">'+CCE.FormatQuickView.elipsizeText(citation.link,95)+"</a></span>")}else{var is_pub=!1,is_vol=!1,is_issue=!1,is_pub_date=!1;if(CCE.FormatQuickView.empty(citation.publisher)||(is_pub=!0,html+=" <i>"+$.trim(citation.publisher)+"</i> "),CCE.FormatQuickView.empty(citation.publication)||(html+=" <i>"+$.trim(citation.publication)+"</i> "),CCE.FormatQuickView.empty(citation.volume)||(is_vol=!0,html+=", <i>"+citation.volume+"</i> "),CCE.FormatQuickView.empty(citation.issue_number)||(is_issue=!0,1==is_vol&&(html+=","),html+=" no. "+citation.issue_number),!CCE.FormatQuickView.empty(0!=citation.publication_date)){is_pub_date=!0;var parsed_date=Date.parse(citation.publication_date),cit_pub_date=new Date(parsed_date),cit_pub_date_txt=CCE.FormatQuickView.getCustomDate(cit_pub_date,!0);""!=cit_pub_date_txt&&(html+=" "+cit_pub_date_txt+" ")}if(1==is_vol&&1==is_issue&&1==is_pub_date?html+=CCE.FormatQuickView.empty(citation.pages)?": n. pag.":": "+citation.pages+". ":1==is_pub&&(html+="."),!CCE.FormatQuickView.empty(citation.last_change)){var last_change=new Date(1e3*citation.last_change);html+=" Accesed "+CCE.FormatQuickView.getCustomDate(last_change,!1,!1,!0)}if(!CCE.FormatQuickView.empty(citation.link)){var citLink=1==noLinkTtrim?citation.link:CCE.FormatQuickView.elipsizeText(citation.link,95),isDivElement=1==noLinkTtrim?"div":"span";html+=" <"+isDivElement+' class="citelighter-bibliography-style"><a target="_blank" title="'+citation.website_title+'" href="'+citation.link+'">'+citLink+"</a></"+isDivElement+">"}}return html},formatMLACitationSource:function(citation,noLinkTtrim){var source_type="undefined"==typeof citation.source_type?"1":citation.source_type,html=CCE.FormatQuickView.formMLAAuthors(citation);if(CCE.FormatQuickView.empty(citation.citation_title)||(html+='" '+$.trim(citation.citation_title)+'."'),1==source_type||3==source_type){if(CCE.FormatQuickView.empty(citation.website_title)||(html+="<i>",html+="undefined"!=typeof citation.premium&&1==citation.premium?"Citelighter Pro":"."==citation.website_title.substr(citation.website_title.length-1)?citation.website_title:citation.website_title+".",html+="</i>"),html+=CCE.FormatQuickView.empty(citation.organization)?" n.p.,":" "+citation.organization+",",CCE.FormatQuickView.empty(citation.publication_date))html+=" n.d.";else{var parsed_date=Date.parse(citation.publication_date),cit_pub_date=new Date(parsed_date),cit_pub_date_txt=CCE.FormatQuickView.getCustomDate(cit_pub_date);html+=""!=cit_pub_date_txt?" "+cit_pub_date_txt+".":" n.d."}if(!CCE.FormatQuickView.empty(citation.last_change)){var last_change=new Date(1e3*citation.last_change);html+=" Web. "+CCE.FormatQuickView.getCustomDate(last_change)}}else{if(CCE.FormatQuickView.empty(citation.publisher)||(html+=" <i>"+$.trim(citation.publisher)+"</i>"),CCE.FormatQuickView.empty(citation.volume)||(html+=" <i>"+$.trim(citation.volume)+"</i>"),CCE.FormatQuickView.empty(citation.issue_number)||(html+=" <i>"+$.trim(citation.issue_number)+"</i>"),CCE.FormatQuickView.empty(citation.publication_date))html+=" n.d.";else{var parsed_date=Date.parse(citation.publication_date),cit_pub_date=new Date(parsed_date),cit_pub_date_txt=CCE.FormatQuickView.getCustomDate(cit_pub_date,!0);html+=""!=cit_pub_date_txt?" ("+cit_pub_date_txt+") ":" n.d."}if(html+=CCE.FormatQuickView.empty(citation.pages)?": n. pag.":" :"+$.trim(citation.pages)+". ",!CCE.FormatQuickView.empty(citation.last_change)){var last_change=new Date(1e3*citation.last_change);html+=" Print. "+CCE.FormatQuickView.getCustomDate(last_change)}}if(!CCE.FormatQuickView.empty(citation.link)){var citLink=1==noLinkTtrim?citation.link:CCE.FormatQuickView.elipsizeText(citation.link,95),isDivElement=1==noLinkTtrim?"div":"span";html+="<"+isDivElement+' class="citelighter-bibliography-style"><a target="_blank" title="'+citation.website_title+'" href="'+citation.link.substring(0,95)+'">'+citLink+"</a></"+isDivElement+">"}return html},formatAPAcitation:function(citation,noLinkTtrim){var source_type="undefined"==typeof citation.source_type?"1":citation.source_type,html=CCE.FormatQuickView.formAPAauthors(citation);if(1==source_type||3==source_type){if(CCE.FormatQuickView.empty(citation.publication_date))html+=" (n.d.).";else{var parsed_date=Date.parse(citation.publication_date),cit_pub_date=new Date(parsed_date),cit_pub_date_txt=CCE.FormatQuickView.getCustomDate(cit_pub_date,!1,!0);html+=""!=cit_pub_date_txt?" ("+cit_pub_date_txt+") ":" (n.d.)."}CCE.FormatQuickView.empty(citation.citation_title)||(html+=" "+$.trim(CCE.FormatQuickView.capitalize(citation.citation_title.toLowerCase()))+". "),CCE.FormatQuickView.empty(citation.organization)||(html+="<i>"+citation.organization+"</i>")}else{if(CCE.FormatQuickView.empty(citation.publication_date))html+=" (n.d.).";else{var parsed_date=Date.parse(citation.publication_date),cit_pub_date=new Date(parsed_date),cit_pub_date_txt=CCE.FormatQuickView.getCustomDate(cit_pub_date,!0);html+=""!=cit_pub_date_txt?" ("+cit_pub_date_txt+") ":" (n.d.)."}CCE.FormatQuickView.empty(citation.citation_title)||(html+=" "+CCE.FormatQuickView.capitalize(citation.citation_title.toLowerCase())+". ");var is_pub=!1,is_vol=!1,is_issue=!1;CCE.FormatQuickView.empty(citation.publisher)||(is_pub=!0,html+=" <i>"+citation.publisher+"</i>"),CCE.FormatQuickView.empty(citation.volume)||(is_vol=!0,html+=", <i>"+citation.volume+"</i>"),CCE.FormatQuickView.empty(citation.issue_number)||(is_issue=!0,html+=1==is_vol?" ("+citation.issue_number+")":", "),CCE.FormatQuickView.empty(citation.pages)||1!=is_issue&&1!=is_vol?1==is_pub&&(html+="."):html+=", "+citation.pages+"."}if(!CCE.FormatQuickView.empty(citation.link)){var citLink=1==noLinkTtrim?citation.link:CCE.FormatQuickView.elipsizeText(citation.link,95),isDivElement=1==noLinkTtrim?"div":"span";html+=" Retrieved from  <"+isDivElement+' class="citelighter-bibliography-style"><a target="_blank" title="'+citation.link+'" href="'+citation.link+'">'+citLink+"</a></"+isDivElement+">"}return html},capitalize:function(string){try{return"undefined"!=typeof string[0]?string[0].toUpperCase()+string.slice(1):string}catch(e){return string}},getMothName:function(v){var n=["January","February","March","April","May","June","July","August","September","October","November","December"];return n[v]},getCustomDate:function(dateobj,return_year_only,returnAPAstyle,returnChicagoStyle){var date_to_return="";try{var dayNr=dateobj.getUTCDate(),month=CCE.FormatQuickView.getMothName(dateobj.getMonth()),full_year=dateobj.getUTCFullYear();return date_to_return="undefined"!=typeof return_year_only&&1==return_year_only?full_year:dayNr+" "+month+" "+full_year,"undefined"!=typeof returnAPAstyle&&1==returnAPAstyle&&(date_to_return=full_year+" "+month+" "+dayNr),"undefined"!=returnChicagoStyle&&1==returnChicagoStyle&&(date_to_return=month+" "+dayNr+" "+full_year),"undefined"!=typeof month&&"undefined"!=typeof dayNr&&"undefined"!=typeof full_year||(date_to_return=""),date_to_return}catch(e){return date_to_return}},formMLAAuthors:function(citation){var source_type="undefined"==typeof citation.source_type?1:citation.source_type,html="",auth_nr=Object.size(citation.authors);if(auth_nr>0)if(1==source_type)for(var one_author in citation.authors){var separator=" , ";one_author==auth_nr-2&&auth_nr>1?separator=" and ":0!=auth_nr&&one_author!=auth_nr-1||(separator=" "),""!=citation.authors[one_author].last_name&&""!=citation.authors[one_author].first_name?html+=CCE.FormatQuickView.capitalize(citation.authors[one_author].last_name)+" "+CCE.FormatQuickView.capitalize(citation.authors[one_author].first_name)+separator:""!=citation.authors[one_author].last_name?html+=CCE.FormatQuickView.capitalize(citation.authors[one_author].last_name)+separator:""!=citation.authors[one_author].first_name&&(html+=CCE.FormatQuickView.capitalize(citation.authors[one_author].first_name)+separator)}else for(var one_author in citation.authors)if(auth_nr>3)0==one_author&&(""!=citation.authors[one_author].last_name&&""!=citation.authors[one_author].first_name?html+=CCE.FormatQuickView.capitalize(citation.authors[one_author].last_name)+", "+CCE.FormatQuickView.capitalize(citation.authors[one_author].first_name)+" et al.":""!=citation.authors[one_author].last_name?html+=CCE.FormatQuickView.capitalize(citation.authors[one_author].last_name)+" et al.":""!=citation.authors[one_author].first_name&&(html+=CCE.FormatQuickView.capitalize(citation.authors[one_author].first_name)+" et al."));else{var separator=", ";one_author==auth_nr-1&&auth_nr>0&&(separator=" "),""!=citation.authors[one_author].last_name&&""!=citation.authors[one_author].first_name?html+=CCE.FormatQuickView.capitalize(citation.authors[one_author].last_name)+", "+CCE.FormatQuickView.capitalize(citation.authors[one_author].first_name)+separator:""!=citation.authors[one_author].last_name?html+=CCE.FormatQuickView.capitalize(citation.authors[one_author].last_name)+separator:""!=citation.authors[one_author].first_name&&(html+=CCE.FormatQuickView.capitalize(citation.authors[one_author].first_name)+separator)}return html},formAPAauthors:function(citation){var html="",auth_nr=Object.size(citation.authors);if(auth_nr>0)for(var one_author in citation.authors){var separator=" ",middle_separator=", ";separator=one_author==auth_nr-1&&auth_nr>1?". ":0==one_author&&one_author==auth_nr-1?". ":"., & ",""!=citation.authors[one_author].last_name&&""!=citation.authors[one_author].first_name?html+=CCE.FormatQuickView.capitalize(citation.authors[one_author].last_name)+middle_separator+CCE.FormatQuickView.capitalize(citation.authors[one_author].first_name.charAt(0))+separator:""!=citation.authors[one_author].last_name?html+=CCE.FormatQuickView.capitalize(citation.authors[one_author].last_name)+separator:""!=citation.authors[one_author].first_name&&(html+=CCE.FormatQuickView.capitalize(citation.authors[one_author].first_name)+separator)}return html},formChicagoAuthors:function(citation){var html=("undefined"==typeof citation.source_type?1:citation.source_type,""),auth_nr=Object.size(citation.authors);if(auth_nr>0)for(var one_author in citation.authors){var separator="",middle_separator=", ";separator=one_author==auth_nr-1&&auth_nr>1?". ":0==one_author&&one_author==auth_nr-1?". ":" and ",""!=citation.authors[one_author].last_name&&""!=citation.authors[one_author].first_name?html+=CCE.FormatQuickView.capitalize(citation.authors[one_author].last_name)+middle_separator+CCE.FormatQuickView.capitalize(citation.authors[one_author].first_name)+separator:""!=citation.authors[one_author].last_name?html+=CCE.FormatQuickView.capitalize(citation.authors[one_author].last_name)+separator:""!=citation.authors[one_author].first_name&&(html+=CCE.FormatQuickView.capitalize(citation.authors[one_author].first_name)+separator)}return html},elipsizeText:function(string,max_length){return string.length>max_length?string.substring(0,max_length)+"...":string},empty:function(mixed_var){var undef,key,i,len,emptyValues=[undef,null,!1,0,"","0"];for(i=0,len=emptyValues.length;i<len;i++)if(mixed_var===emptyValues[i])return!0;if("object"==typeof mixed_var){for(key in mixed_var)return!1;return!0}return!1},nl2br:function(str,isXhtml){var breakTag=isXhtml||"undefined"==typeof isXhtml?"<br />":"<br>";return(str+"").replace(/([^>\r\n]?)(\r\n|\n\r|\r|\n)/g,"$1"+breakTag+"$2")}},Object.size=function(obj){var key,size=0;for(key in obj)obj.hasOwnProperty(key)&&size++;return size};var CCE=CCE||{};CCE.ToolbarNotification={init:function(){CCE.ToolbarNotification.initHideWarning(),CCE.ToolbarNotification.initHideToolbarUpdate(),chrome.extension.onMessage.addListener(function(request,sender,sendResponse){var response={};switch(request.action){case"showNotification":CCE.ToolbarNotification.showNotification(),response.success=!0;break;case"hideNotification":CCE.ToolbarNotification.hideNotification(),response.success=!0;break;case"showToolbarUpdate":CCE.ToolbarNotification.showToolbarUpdate(),response.success=!0;break;case"hideToolbarUpdate":CCE.ToolbarNotification.hideToolbarUpdate(),response.success=!0}return!0})},showNotification:function(){$("#CitelighterToolbarNotificationPage").css("display","inline-block")},hideNotification:function(){$("#CitelighterToolbarNotificationPage").css("display","none")},showToolbarUpdate:function(){$("#CitelighterToolbarUpdateNotificationPage").css("display","inline-block")},hideToolbarUpdate:function(){$("#CitelighterToolbarUpdateNotificationPage").css("display","none")},initHideWarning:function(){$("html").on("click.CitelighterChromeExtension","#CitelighterToolbarNotificationPage .close-btn",function(e){e.preventDefault();var request={action:"doNotShow",value:$("#CitelighterToolbarNotificationPage #citelighter-notification-not-show-again").get(0).checked};chrome.extension.sendMessage(request,function(response){response||"undefined"==typeof chrome.extension.lastError||console.log("No response. Error: "+chrome.extension.lastError.message)})})},initHideToolbarUpdate:function(){$("html").on("click.CitelighterChromeExtension","#CitelighterToolbarUpdateNotificationPage .close-btn",function(e){var request={action:"doNotShowToolbarUpdate",value:$("#CitelighterToolbarUpdateNotificationPage #citelighter-notification-not-show-again").get(0).checked};chrome.extension.sendMessage(request,function(response){response||"undefined"==typeof chrome.extension.lastError||console.log("No response. Error: "+chrome.extension.lastError.message)})})}};var CCE=CCE||{};CCE.Injection={injected:!1,isInstalledPort:null,scrollListener:null,toolbarVisible:!1,fastCaptureVisible:!1,notificationPanelVisible:!1,warningPanelVisible:!1,pageKnowsBackground:!1,GDocCount:!1,GDocEdObs:null,editTimer:0,timerInterval:null,registerTimerInterval:null,lockEditTimer:!1,pastTime:0,pastTimeInterval:null,projectStyleId:2,currentProjectFormat:"MLA",userId:null,toggleInProcess:!1,project_id:null,defaultCallback:function(resp){resp||"undefined"==typeof chrome.extension.lastError||console.log("No response. Error: "+chrome.extension.lastError.message)},insertToolbarIFrame:function(){if(document.getElementById("CitelighterChromeExtension"))return CCE.Injection.injectEmailAndOptions(),!1;var html=null;if(document.documentElement?html=document.documentElement:document.getElementsByTagName("html")&&document.getElementsByTagName("html")[0]&&(html=document.getElementsByTagName("html")[0]),!html)return!1;var toolbarFrame=document.createElement("div");toolbarFrame.setAttribute("id","CitelighterChromeExtension"),html.appendChild(toolbarFrame);var src=chrome.extension.getURL("content/iframe.html"),xhr=new XMLHttpRequest;return xhr.onreadystatechange=function(){if(4==xhr.readyState){var resp=xhr.responseText;CCE.Injection.handleStateToolbarChange(resp)}},xhr.open("GET",src,!0),xhr.send(),CCE.Injection.injected=!0,CCE.Injection.injectEmailAndOptions(),!0},handleStateToolbarChange:function(injectionContent){if(document.getElementById("CitelighterChromeExtension")){var iframeHolder=document.getElementById("CitelighterChromeExtension");iframeHolder.innerHTML=injectionContent}},injectEmailAndOptions:function(){var html=null;if(document.documentElement?html=document.documentElement:document.getElementsByTagName("html")&&document.getElementsByTagName("html")[0]&&(html=document.getElementsByTagName("html")[0]),null!=html){if(!document.getElementById("CitelighterToolbarEmailPage")){var emailPage=document.createElement("div");emailPage.setAttribute("id","CitelighterToolbarEmailPage"),html.appendChild(emailPage);var emailSrc=chrome.extension.getURL("content/email.html"),emailXhr=new XMLHttpRequest;emailXhr.onreadystatechange=function(){if(4==emailXhr.readyState){var resp=emailXhr.responseText;CCE.Injection.handleInjectionStateChange(resp,"CitelighterToolbarEmailPage")}},emailXhr.open("GET",emailSrc,!0),emailXhr.send()}if(!document.getElementById("CitelighterToolbarOptionsPage")){var optionsPage=document.createElement("div");optionsPage.setAttribute("id","CitelighterToolbarOptionsPage"),html.appendChild(optionsPage);var optionsSrc=chrome.extension.getURL("content/options.html"),optionsXhr=new XMLHttpRequest;optionsXhr.onreadystatechange=function(){if(4==optionsXhr.readyState){var resp=optionsXhr.responseText;CCE.Injection.handleInjectionStateChange(resp,"CitelighterToolbarOptionsPage")}},optionsXhr.open("GET",optionsSrc,!0),optionsXhr.send()}if(!document.getElementById("CitelighterToolbarNotificationPage")){var notificationPage=document.createElement("div");notificationPage.setAttribute("id","CitelighterToolbarNotificationPage"),html.appendChild(notificationPage);var notificationSrc=chrome.extension.getURL("content/hide_toolbar_notification.html"),notificationXhr=new XMLHttpRequest;notificationXhr.onreadystatechange=function(){if(4==notificationXhr.readyState){var resp=notificationXhr.responseText;CCE.Injection.handleInjectionStateChange(resp,"CitelighterToolbarNotificationPage")}},notificationXhr.open("GET",notificationSrc,!0),notificationXhr.send()}if(!document.getElementById("CitelighterToolbarUpdateNotificationPage")){var updateNotificationPage=document.createElement("div");updateNotificationPage.setAttribute("id","CitelighterToolbarUpdateNotificationPage"),html.appendChild(updateNotificationPage);var updateNotificationSrc=chrome.extension.getURL("content/update_toolbar_notification.html"),updateNotificationXhr=new XMLHttpRequest;updateNotificationXhr.onreadystatechange=function(){if(4==updateNotificationXhr.readyState){var resp=updateNotificationXhr.responseText;CCE.Injection.handleInjectionStateChange(resp,"CitelighterToolbarUpdateNotificationPage")}},updateNotificationXhr.open("GET",updateNotificationSrc,!0),updateNotificationXhr.send()}}},handleInjectionStateChange:function(injectionContent,injectId){if(document.getElementById(injectId)){var injectiedDiv=document.getElementById(injectId);injectiedDiv.innerHTML=injectionContent}},setToolbarVisible:function(visible){0==visible&&($("#CitelighterChromeExtension").removeAttr("class"),$("#CitelighterChromeExtension").attr("class","citelighter-iframe")),$("#CitelighterChromeExtension").toggle(visible);var docId=(new RegExp("www.google.com.*/imgres"),CCE.Injection.getGoogleDocId());$("#docs-header.docs-og-minibar #docs-titlebar-container").length>0&&0!=docId&&$("#docs-header.docs-og-minibar #docs-titlebar-container").css("top","-46px");var gmail_regex=new RegExp("mail.google.com"),gdocs_regex=new RegExp(".google.com");if(gmail_regex.test(document.location.href))navigator.appVersion.indexOf("Win")!=-1&&(html.style.marginLeft=visible?"1px":"0px");else if(gdocs_regex.test(document.location.href)){var docId=CCE.Injection.getGoogleDocId();if(0!=docId){var resizeGooglePages=document.createElement("script");resizeGooglePages.setAttribute("id","cl-google-page-resize"),resizeGooglePages.innerText='(function(){var google_div = document.getElementById("mngb")||document.getElementById("gbem")||document.getElementsByClassName("google-one-wrapper")[0]||document.getElementById("gb");if(google_div){google_div.style.position = "relative";}var is = document.getElementById("cl-google-page-resize");if(is){document.head.removeChild(is)}})()',document.head.appendChild(resizeGooglePages);var resizeGdocsScript=document.createElement("script");resizeGdocsScript.setAttribute("id","citelighter-resize-gdocs"),resizeGdocsScript.innerText='(function(){if(typeof(window.KX_resize)=="function"){KX_resize();}var is=document.getElementById("citelighter-resize-gdocs");if(is){document.head.removeChild(is)}var timeOut = null;window.onresize = function() {if (timeOut != null) {clearTimeout(timeOut);}timeOut = setTimeout(function(){if (document.getElementsByClassName("docs-reference-pane-container")[0].style.display != "none"){document.getElementById("docs-toolbar-wrapper").style.width = (document.body.clientWidth - 339) + "px";document.getElementById("docs-editor").style.width = (document.body.clientWidth - 251) + "px";document.getElementsByClassName("goog-sa-pane-inner")[0].style.height = document.getElementById("kix-appview").offsetHeight + "px";document.getElementById("citelighter-clipboard-panel").style.height = document.getElementById("kix-appview").offsetHeight + "px";}}, 500);};})()',document.head.appendChild(resizeGdocsScript);var gdocs_sheet_regex=new RegExp("/spreadsheet/");if(gdocs_sheet_regex.test(document.location.href)){var resizeSpreadsheetScript=document.createElement("script");resizeSpreadsheetScript.setAttribute("id","citelighter-resize-spreadsheet"),resizeSpreadsheetScript.innerText='(function(){if(typeof(window.trixApp.resizeAppToCurrentDimensions)=="function"){document.getElementById("docs-editor").style.width = (window.innerWidth - 1) + "px"; window.trixApp.resizeAppToCurrentDimensions(); document.getElementById("docs-editor").style.width = (window.innerWidth) + "px"; window.trixApp.resizeAppToCurrentDimensions();}var rs=document.getElementById("citelighter-resize-spreadsheet");if(rs){document.head.removeChild(rs)}})()',document.head.appendChild(resizeSpreadsheetScript)}}}else if(CCE.Custom.isCitelighter()){var els=document.getElementsByClassName("popover");for(var i in els)els[i].style&&(els[i].style.display="none")}},optionsChanged:function(options){CCE.Injection.setToolbarVisible(options.toolbarVisible)},inject:function(on_pdfs){if(!document.getElementById("CitelighterChromeExtension")){var request={action:"isPopup"};chrome.extension.sendMessage(request,function(response){if(!response&&"undefined"!=typeof chrome.extension.lastError)return void console.log("No response. Error: "+chrome.extension.lastError.message);if(!response.is_popup){if("undefined"==typeof on_pdfs||0==on_pdfs)var list_websites_no_toolbar=["citelighter.com/citation/add_edit_citation/","citelighter.com/project/deleted/[0-9]+/1","citelighter.com/doc_picker/index/[0-9]","/oauth2/auth","\\.pdf","sylvanpaper.sylvanlearning.com/citation/add_edit_citation/","sylvanpaper.sylvanlearning.com/project/deleted/[0-9]+/1","sylvanpaper.sylvanlearning.com/doc_picker/index/[0-9]"];else var list_websites_no_toolbar=["citelighter.com/citation/add_edit_citation/","citelighter.com/project/deleted/[0-9]+/1","citelighter.com/doc_picker/index/[0-9]","/oauth2/auth","sylvanpaper.sylvanlearning.com/citation/add_edit_citation/","sylvanpaper.sylvanlearning.com/project/deleted/[0-9]+/1","sylvanpaper.sylvanlearning.com/doc_picker/index/[0-9]"];for(item in list_websites_no_toolbar)if(new RegExp(list_websites_no_toolbar[item]).test(document.location.href))return void((document.location.href.indexOf("citelighter.com/project/")>-1||document.location.href.indexOf("sylvanpaper.sylvanlearning.com/project/")>-1)&&(window.addEventListener("CitelighterSendWritingDataEvent",function(e){CCE.Injection.sendWritingDataListener(e)},!1,!0),chrome.extension.onMessage.addListener(function(request,sender,sendResponse){switch(request.action){case"editTimerSent":CCE.Injection.editTimerSent()}return!0})));var request={action:"getInternalVersion"};chrome.extension.sendMessage(request,function(response){if(response||"undefined"==typeof chrome.extension.lastError||console.log("No response. Error: "+chrome.extension.lastError.message),chrome.extension.onMessage.addListener(function(request,sender,sendResponse){var rsp={};switch(request.action){case"uninstall":CCE.Injection.uninstall(),rsp.success=!0,sendResponse(rsp);break;case"backgroundIsPresent":CCE.Injection.pageKnowsBackground||(CCE.Injection.pageKnowsBackground=!0),rsp.success=!0,sendResponse(rsp);break;case"setVisible":CCE.Injection.setToolbarVisible(request.visible),rsp.success=!0,sendResponse(rsp);break;case"optionsChanged":CCE.Injection.optionsChanged(request.options),rsp.success=!0,sendResponse(rsp);break;case"GDocEdListener":CCE.Injection.gdocEdited(),
rsp.success=!0,sendResponse(rsp);break;case"checkEditTimer":var doc_id=CCE.Injection.getGoogleDocId();CCE.Injection.lockEditTimer=!0;var past_time=CCE.Injection.pastTime;if(0===past_time&&CCE.Injection.editTimer>0){CCE.Injection.lockEditTimer=!1,CCE.Injection.editTimer=0;try{localStorage.removeItem(doc_id)}catch(e){}}null!==CCE.Injection.timerInterval&&CCE.Injection.syncEditTimer(doc_id),CCE.Injection.clearPastTime(),CCE.Injection.editTimer=0,rsp.doc_data=CCE.Injection.getEditTimerForDocId(doc_id),"object"==typeof rsp.doc_data&&rsp.doc_data.hasOwnProperty("doc_id")&&(rsp.doc_data.past_time=past_time),"undefined"!=typeof request.firstTab&&(rsp.firstTab=request.firstTab),sendResponse(rsp);break;case"editTimerSuccessfullyRegistered":var doc_id=CCE.Injection.getGoogleDocId();CCE.Injection.syncEditTimer(doc_id)===!0&&(CCE.Injection.lockEditTimer=!1),CCE.Injection.clearEditTimersExcept(doc_id),rsp.success=!0,sendResponse(rsp);break;case"editTimerSent":CCE.Injection.editTimerSent(),rsp.success=!0,sendResponse(rsp);break;case"setClipboardContent":CCE.Injection.insertClipBoardContent(request),rsp.success=!0,sendResponse(rsp);break;case"removeGoogleDocsClipboard":CCE.Injection.removeGoogleDocsClipboard(request.logOut),rsp.success=!0,sendResponse(rsp);break;case"toggleGoogleDocsClipboard":CCE.Injection.toggleGoogleDocsClipboard(),rsp.success=!0,sendResponse(rsp);break;case"insertGoogleClipboard":CCE.Injection.injectGoogleClipboard(),rsp.success=!0,sendResponse(rsp)}return!0}),"/_/chrome/newtab"!=document.location.pathname){var success=CCE.Injection.insertToolbarIFrame();if(success){window.addEventListener("CitelighterSendWritingDataEvent",function(e){CCE.Injection.sendWritingDataListener(e)},!1,!0),CCE.Injection.isInstalledPort=chrome.extension.connect({name:"CLisInstalled"}),CCE.Injection.isInstalledPort.onDisconnect.addListener(function(event){CCE.Injection.uninstall()}),window.addEventListener("beforeunload",function(evt){var doc_id=CCE.Injection.getGoogleDocId();if(0!=doc_id){var rsp={};CCE.Injection.lockEditTimer=!0;var past_time=CCE.Injection.pastTime;if(0==past_time&&CCE.Injection.editTimer>0){CCE.Injection.lockEditTimer=!1,CCE.Injection.editTimer=0;try{localStorage.removeItem(doc_id)}catch(e){}}null!=CCE.Injection.timerInterval&&CCE.Injection.syncEditTimer(doc_id),CCE.Injection.clearPastTime(),CCE.Injection.editTimer=0,rsp.doc_data=CCE.Injection.getEditTimerForDocId(doc_id),"object"==typeof rsp.doc_data&&rsp.doc_data.hasOwnProperty("doc_id")&&(rsp.doc_data.past_time=past_time);var request={action:"sendTimerBeforeUnload",data:rsp};chrome.extension.sendMessage(request,function(response){})}}),setTimeout(function(){CCE.TextSelection.initialSetup(),CCE.Keyboard.initialSetup(),CCE.ScanImages.initialSetup(),CCE.Injection.initIframeDraggable(),CCE.Toolbar.initialSetup(),CCE.Email.initialSetup(),CCE.Options.initialSetup(),CCE.ToolbarNotification.init()},600);var request={action:"getStatus"};chrome.extension.sendMessage(request,function(response){var gdocs_regex=new RegExp("docs.google.com");if(gdocs_regex.test(document.location.href)){var request={action:"insertGoogleClipboard"};chrome.extension.sendMessage(request,function(response){})}})}}})}})}},initIframeDraggable:function(){var currentClass="";$("#CitelighterChromeExtension").draggable({axis:"y",handle:".citelighter-toolbar-main-menu",iframeFix:!0,start:function(event,ui){currentClass=$("#CitelighterChromeExtension").attr("class"),$("#CitelighterChromeExtension").removeAttr("class"),$("#CitelighterChromeExtension").addClass("no-delay")},drag:function(event,ui){ui.position.top<0&&(ui.position.top=0);var winHeight=$(window).height();ui.position.top>winHeight-50&&(ui.position.top=winHeight-50)},stop:function(event,ui){$("#CitelighterChromeExtension").removeClass("no-delay"),$("#CitelighterChromeExtension").attr("class",currentClass),CCE.Toolbar.resizeIframe()}})},getGoogleDocId:function(){var path=window.location.pathname,matches=/\/document\/d\/([0-9a-zA-Z_-]+)\/edit.*/i.exec(path);return!("object"!=typeof matches||null===matches||!matches[1])&&matches[1]},getEditTimerForDocId:function(doc_id){if(!doc_id)return!1;try{var doc_properties=localStorage.getItem(doc_id)||null;if(doc_properties)return doc_properties=JSON.parse(doc_properties),doc_properties.doc_id=doc_id,doc_properties}catch(e){}return!1},syncEditTimer:function(doc_id){if(!doc_id||!localStorage)return!1;try{return chrome.extension.sendMessage({action:"getProjectId"},function(response){var obj={cl_gded_cnt:CCE.Injection.editTimer};response.projectId&&(obj.project_id=response.projectId),localStorage.setItem(doc_id,JSON.stringify(obj))}),!0}catch(e){}return!1},gdocEdited:function(){var notice=document.getElementById("docs-notice"),doc_id=CCE.Injection.getGoogleDocId();if(window.WebKitMutationObserver&&notice&&doc_id){try{var doc_properties=localStorage.getItem(doc_id)||null;doc_properties&&(doc_properties=JSON.parse(doc_properties),doc_properties&&doc_properties.cl_gded_cnt&&doc_properties.cl_gded_cnt!=CCE.Injection.editTimer&&CCE.Injection.lockEditTimer===!1&&(CCE.Injection.editTimer=doc_properties.cl_gded_cnt))}catch(e){}CCE.Injection.GDocEdObs&&"function"==typeof CCE.Injection.GDocEdObs.observe||(CCE.Injection.GDocCount=!1,CCE.Injection.GDocEdObs=new WebKitMutationObserver(function(mutations){mutations.forEach(function(mutation){var old_txt="",new_txt="";mutation.removedNodes[0]&&mutation.removedNodes[0].nodeType==Node.TEXT_NODE&&(old_txt=mutation.removedNodes[0].textContent),mutation.addedNodes[0]&&mutation.addedNodes[0].nodeType==Node.TEXT_NODE&&(new_txt=mutation.addedNodes[0].textContent),old_txt!=new_txt&&(new_txt.indexOf("Last edited")>-1?CCE.Injection.GDocCount=!1:new_txt.indexOf("Saving")>-1?CCE.Injection.GDocCount=!0:new_txt.indexOf("changes saved")>-1&&(CCE.Injection.GDocCount=!1),CCE.Injection.GDocCount?chrome.extension.sendMessage({action:"getProjectId"},function(response){CCE.Injection.timerInterval=setInterval(function(){CCE.Injection.countPastTime();var obj={cl_gded_cnt:++CCE.Injection.editTimer};response.projectId&&(obj.project_id=response.projectId);try{localStorage.setItem(doc_id,JSON.stringify(obj))}catch(e){}},1e3)}):(clearInterval(CCE.Injection.timerInterval),CCE.Injection.timerInterval=null))})})),CCE.Injection.GDocEdObs.observe(notice,{childList:!0})}},countPastTime:function(){CCE.Injection.pastTimeInterval||(CCE.Injection.pastTime+=1,CCE.Injection.pastTimeInterval=setInterval(function(){++CCE.Injection.pastTime},1e3))},clearPastTime:function(){null!==CCE.Injection.pastTimeInterval&&(clearInterval(CCE.Injection.pastTimeInterval),CCE.Injection.pastTimeInterval=null),CCE.Injection.pastTime=0},clearEditTimersExcept:function(doc_id){doc_id=doc_id||null;try{for(var key in window.localStorage){if(doc_id&&key==doc_id)return!1;var val=JSON.parse(localStorage.getItem(key));val&&"object"==typeof val&&val.hasOwnProperty("cl_gded_cnt")&&0==val.cl_gded_cnt&&localStorage.removeItem(key)}}catch(e){}return!0},editTimerSent:function(){if(0==document.getElementsByTagName("CitelighterSendWritingDataElement").length)return!1;document.documentElement.removeChild(document.getElementsByTagName("CitelighterSendWritingDataElement")[0]);var element=document.createElement("CitelighterGetWritingDataElement");document.documentElement.appendChild(element);var evt=document.createEvent("Events");evt.initEvent("CitelighterGetWritingDataEvent",!0,!1),element.dispatchEvent(evt)},clearGdocsData:function(){null!==CCE.Injection.timerInterval&&clearInterval(CCE.Injection.timerInterval),CCE.Injection.clearPastTime(),CCE.Injection.clearEditTimersExcept(),null!==CCE.Injection.GDocEdObs&&"function"==typeof CCE.Injection.GDocEdObs.disconnect&&CCE.Injection.GDocEdObs.disconnect(),CCE.Injection.GDocEdObs=null},uninstall:function(){var html=null;if(document.documentElement?html=document.documentElement:document.getElementsByTagName("html")&&document.getElementsByTagName("html")[0]&&(html=document.getElementsByTagName("html")[0]),CCE.Injection.removeGoogleDocsClipboard(),CCE.Injection.pageKnowsBackground=!1,CCE.Injection.clearGdocsData(),html){$("html").unbind("click.CitelighterChromeExtension"),$("body").unbind("click.CitelighterChromeExtension"),$(window).unbind("resize.CitelighterChromeExtension");var toolbarInjection=document.getElementById("CitelighterChromeExtension");toolbarInjection&&html.removeChild(toolbarInjection);var emailInjection=document.getElementById("CitelighterToolbarEmailPage");emailInjection&&html.removeChild(emailInjection);var emailOverlayInjection=document.getElementById("CitelighterToolbarEmailOverlay");emailOverlayInjection&&html.removeChild(emailOverlayInjection);var optionsInjection=document.getElementById("CitelighterToolbarOptionsPage");optionsInjection&&html.removeChild(optionsInjection);var optionsOverlayInjection=document.getElementById("CitelighterToolbarOptionsOverlay");optionsOverlayInjection&&html.removeChild(optionsOverlayInjection);var notificationInjection=document.getElementById("CitelighterToolbarNotificationPage");notificationInjection&&html.removeChild(notificationInjection);var updateNotificationInjection=document.getElementById("CitelighterToolbarUpdateNotificationPage");updateNotificationInjection&&html.removeChild(updateNotificationInjection)}},sendWritingDataListener:function(event){try{event.preventDefault();event.target;if(window.removeEventListener("CitelighterSendWritingDataEvent",CCE.Injection.sendWritingDataListener,!1),!new RegExp("citelighter.com").test(document.location.hostname)&&!new RegExp("sylvanpaper.sylvanlearning.com").test(document.location.hostname))return;chrome.extension.sendMessage({action:"sendWritingDataEvent"},CCE.Injection.defaultCallback)}catch(exception){}},initGdocProjectStyleChange:function(){$("body").off("click","#cl-bibliography-formats .cl-bibliography-format").on("click","#cl-bibliography-formats .cl-bibliography-format",function(e){var format=$(this).text();if(format!=CCE.Injection.currentProjectFormat){if(CCE.Injection.currentProjectFormat=format,null!=CCE.Toolbar.citations_loaded&&"undefined"!=typeof CCE.Toolbar.citations_loaded){$("#cl-bibliography-content #cl-all-bibliography").html(" ");var bibHtml=CCE.FormatQuickView.formatUniqueBib(CCE.Toolbar.citations_loaded,CCE.Injection.currentProjectFormat);$("#cl-bibliography-content #cl-all-bibliography").html(bibHtml),CCE.Injection.setCitationsPlusIcons()}if(null!=CCE.Toolbar.outlines_loaded&&"undefined"!=typeof CCE.Toolbar.outlines_loaded){$("#cl-bibliography-content #cl-outline-bibliography").html(" ");var bibHtml=CCE.FormatQuickView.formatClipboardBibOutline(CCE.Toolbar.outlines_loaded,CCE.Injection.currentProjectFormat);$("#cl-bibliography-content #cl-outline-bibliography").html(bibHtml),CCE.Injection.setOutlinePlusIcons()}CCE.Injection.setActiveProjectFormat(),CCE.Injection.updateProjectFormat(CCE.Injection.currentProjectFormat)}})},updateProjectFormat:function(format){var styleId=2;switch(format){case"APA":styleId=1;break;case"Chicago":styleId=3;break;default:styleId=2}var request={action:"updateProjectFormat",styleId:styleId};chrome.extension.sendMessage(request,CCE.Injection.defaultCallback)},setGdocProjectTitle:function(text){$("#cl-clipboard-project-title span").text(CCE.FormatQuickView.elipsizeText(text)),$("#cl-clipboard-project-title span").attr("title",text)},setGdocSelectedTab:function(tab){$("#cl-all-tab, #cl-outline-tab").removeClass("selected"),$("#cl-"+tab+"-tab").addClass("selected"),"outline"==tab?($("#cl-outline-content").removeClass("hide"),$("#cl-all-content").addClass("hide")):($("#cl-all-content").removeClass("hide"),$("#cl-outline-content").addClass("hide"))},setActiveProjectFormat:function(){$("#cl-bibliography-formats .cl-clipboard-tab").removeClass("selected"),$("#cl-bibliography-formats .cl-clipboard-tab").each(function(){$(this).text()==CCE.Injection.currentProjectFormat&&$(this).addClass("selected")})},initClipboardInfiniteScroll:function(){var lastScrollClipboard=$("#citelighter-clipboard-panel").scrollTop();$("#citelighter-clipboard-panel").on("scroll",function(e){var activeTab=$("#cl-outline-tab").hasClass("selected")?"outline":"citations";if("outline"==activeTab&&null!=CCE.Toolbar.outlines_loaded){var loadedOutlines=CCE.Toolbar.outlines_loaded.length,outlineCount=CCE.Toolbar.project_elements_count,newScroll=$("#citelighter-clipboard-panel").scrollTop(),delta=newScroll-lastScrollClipboard;lastScrollClipboard=newScroll;var scrollHeight=$("#citelighter-clipboard-panel")[0].scrollHeight,maxScroll=scrollHeight-$("#citelighter-clipboard-panel")[0].clientHeight-$("#cl-clipboard-bibliography")[0].clientHeight;delta>0&&maxScroll-newScroll<100&&!$("#citelighter-clipboard-panel").hasClass("loading-elements")&&outlineCount>loadedOutlines&&($("#citelighter-clipboard-panel").addClass("loading-elements"),CCE.Injection.getClipBoardContent(!0))}else if(null!=CCE.Toolbar.citations_loaded){var loadedCitations=CCE.Toolbar.citations_loaded.length,citationsCount=CCE.Toolbar.project_citations_count,newScroll=$("#citelighter-clipboard-panel").scrollTop(),delta=newScroll-lastScrollClipboard;lastScrollClipboard=newScroll;var scrollHeight=$("#citelighter-clipboard-panel")[0].scrollHeight,maxScroll=scrollHeight-$("#citelighter-clipboard-panel")[0].clientHeight-$("#cl-clipboard-bibliography")[0].clientHeight;delta>0&&maxScroll-newScroll<100&&!$("#citelighter-clipboard-panel").hasClass("loading-elements")&&citationsCount>loadedCitations&&($("#citelighter-clipboard-panel").addClass("loading-elements"),CCE.Injection.getClipBoardContent(!0))}})},setGdocOutlines:function(outlines){if($("#citelighter-clipboard-panel #clipboard-content #cl-citations-list").length>0&&"undefined"!=typeof outlines){$("#clipboard-content #cl-outline-list").html(" ");var html=CCE.FormatQuickView.formatClipboardOutline(outlines);$("#clipboard-content #cl-outline-list").html(html),$("#clipboard-content #cl-bibliography-content #cl-outline-bibliography").html(" ");var bibHtml=CCE.FormatQuickView.formatClipboardBibOutline(outlines,CCE.Injection.currentProjectFormat);$("#cl-bibliography-content #cl-outline-bibliography").html(bibHtml),CCE.Injection.checBiblioDisplayEmpty(),$("#citelighter-clipboard-panel").removeClass("loading-elements"),CCE.Injection.initClipboardSelectedText();var plusWasSelected=CCE.Injection.getPlusAllAdded("outline");1==plusWasSelected?CCE.Injection.setAllCitationsInLocalStorage(!0,!1,function(){CCE.Injection.setOutlinePlusIcons(),CCE.Injection.updatePlusAddIconAll("outline")}):(CCE.Injection.setOutlinePlusIcons(),CCE.Injection.updatePlusAddIconAll("outline"))}},setGdocCitations:function(citations){if($("#citelighter-clipboard-panel #clipboard-content #cl-citations-list").length>0&&"undefined"!=typeof citations){$("#cl-all-content #cl-citations-list").html(" ");var html=CCE.FormatQuickView.formatCliboardCitation(citations);$("#cl-all-content #cl-citations-list").html(html),$("#cl-bibliography-content #cl-all-bibliography").html(" ");var bibHtml=CCE.FormatQuickView.formatUniqueBib(citations,CCE.Injection.currentProjectFormat);$("#clipboard-content #cl-bibliography-content #cl-all-bibliography").html(bibHtml),CCE.Injection.checBiblioDisplayEmpty(),$("#clipboard-content #citelighter-clipboard-panel").removeClass("loading-elements"),CCE.Injection.initClipboardSelectedText();var plusWasSelected=CCE.Injection.getPlusAllAdded("all");1==plusWasSelected?CCE.Injection.setAllCitationsInLocalStorage(!1,!1,function(){CCE.Injection.setCitationsPlusIcons(),CCE.Injection.updatePlusAddIconAll("all")}):(CCE.Injection.setCitationsPlusIcons(),CCE.Injection.updatePlusAddIconAll("all"))}},checkClipboardInjected:function(){if(0==$("#citelighter-clipboard-panel").length)return clipBoard=document.createElement("div"),clipBoard.setAttribute("id","citelighter-clipboard-panel"),clipBoard.setAttribute("class","citelighter-clipboard-panel-top"),researchPanel=document.getElementsByClassName("goog-sa-pane-inner")[0],researchPanel.appendChild(clipBoard,researchPanel.firstChild),CCE.Injection.getClipBoard(),!1},setTopInjectionLogoAndTooltips:function(){if($("#citelighter-clipboard-panel").length>0){var imageMap=[[".citelighter-item-number","images/add-to-bib-sprite.png"],[".biblio-header-help","images/question_mark.png"],["#citelighter-pull-tab","images/up_down_arrow.png"]],help_image_path=(chrome.extension.getURL(imageMap[0][1]),chrome.extension.getURL(imageMap[1][1]));$(".popover").remove(),$("#cl-bibliography-top").length>0&&$("#cl-bibliography-top").prepend('<a id="cl-add-to-bib-help" rel="tooltip" title="Click for help"><img src="'+help_image_path+'" style="float: left; position: relative; top: -2px; left:7px; width: 20px" /></a><div id="cl-add-to-biblio-help-content" style="width: 100px; height: 100px; display: none; font-size: larger;">Click the <i class="plus-add-icon original-icon" title="Add all the sources in Bibliography"></i> icon to add to bibliograpy</div>'),$("#cl-clipboard-project-title").length>0&&$("#cl-clipboard-project-title").append('<a id="cl-biblio-help" rel="tooltip" title="Click for help"><img src="'+help_image_path+'" style="position: relative; top: 5px; width: 20px;" /></a><div id="cl-biblio-help-content" style="width: 100px; height: 100px; display: none; font-size: larger;">Click and drag citation to document</a></div>'),CCE.Injection.initGeneralPopovers()}},checBiblioDisplayEmpty:function(){$("#cl-outline-tab").hasClass("selected")?0==$("#cl-outline-content #cl-outline-list .cl-outline-element[data-item-type='citation']").length?($("#cl-clipboard-bibliography, #plus-add-all, #cl-biblio-help").hide(),$("#plus-add-all").removeClass("selected")):$("#cl-clipboard-bibliography, #plus-add-all, #cl-biblio-help").show():$("#cl-all-tab").hasClass("selected")&&(0==$("#cl-all-content #cl-citations-list .cl-citation-element").length?($("#cl-clipboard-bibliography, #plus-add-all, #cl-biblio-help").hide(),$("#plus-add-all").removeClass("selected")):$("#cl-clipboard-bibliography, #plus-add-all, #cl-biblio-help").show())},initGdocsTabsToogle:function(){$("#cl-clipboard-tabs .cl-clipboard-tab").off("click.CitelighterChromeExtension").on("click.CitelighterChromeExtension",function(e){if($(this).hasClass("selected"))return!1;$("#cl-clipboard-tabs .cl-clipboard-tab").removeClass("selected"),$(this).addClass("selected");var getContent=!1;"cl-outline-tab"==$(this).attr("id")?($("#cl-all-content").hide(),$("#cl-outline-content").show(),$("#cl-all-bibliography").hide(),$("#cl-outline-bibliography").show(),0==$("#cl-outline-content #cl-outline-list .cl-outline-element[data-item-type='citation']").length?($("#cl-clipboard-bibliography, #plus-add-all, #cl-biblio-help").hide(),$("#plus-add-all").removeClass("selected")):$("#cl-clipboard-bibliography, #plus-add-all, #cl-biblio-help").show(),null==CCE.Toolbar.outlines_loaded&&(getContent=!0)):"cl-all-tab"==$(this).attr("id")&&($("#cl-outline-content").hide(),$("#cl-all-content").show(),$("#cl-outline-bibliography").hide(),$("#cl-all-bibliography").show(),0==$("#cl-all-content #cl-citations-list .cl-citation-element").length?($("#cl-clipboard-bibliography, #plus-add-all, #cl-biblio-help").hide(),$("#plus-add-all").removeClass("selected")):$("#cl-clipboard-bibliography, #plus-add-all, #cl-biblio-help").show(),null==CCE.Toolbar.citations_loaded&&(getContent=!0));var listType=$(this).text().toLowerCase();"captures"==listType&&(listType="all"),0==getContent&&CCE.Injection.updatePlusAddIconAll(listType),$("#cl-"+listType+"-content .plus-add-icon.selected").each(function(){$("#cl-"+listType+"-bibliography .citelighter-bib-"+$(this).data("citation-id")).show()});var request={action:"setListType",listType:listType,getContent:getContent};chrome.extension.sendMessage(request,function(response){}),0==getContent&&"cl-all-tab"==$(this).attr("id")&&CCE.Injection.setGdocCitations(CCE.Toolbar.citations_loaded),0==getContent&&"cl-outline-tab"==$(this).attr("id")&&CCE.Injection.setGdocOutlines(CCE.Toolbar.outlines_loaded)})},initClipboardSelectedText:function(){var clipboardSelectText=function(elem,color,evt){color=color||null,selectedColor=$(".goog-color-menu-button-indicator").css("border-bottom-color");var range=null;if(document.selection)range=document.body.createTextRange(),range.moveToElementText(elem),range.select();else if(window.getSelection){var sel=window.getSelection();sel.empty(),range=document.createRange(),range.selectNodeContents(elem),sel.addRange(range)}if($(elem).hasClass("citelighter-bibs")&&!$(elem).hasClass("drag-spacer")&&($(elem).addClass("drag-spacer"),elem.addEventListener("dragstart",function(ev){var _text=ev.dataTransfer.getData("text/html"),textToSet="",parsedText=$.parseHTML('<div class="citelighter-bib-parser">'+_text+"</div>");$(parsedText).find(".bib-footer").length>0&&$(parsedText).find(".bib-footer").each(function(){if(textToAppend="",$(this).next().hasClass("citelighter-bibliography-style")){var next=($(this),$(this).next());next.find("a").css({display:"block",width:"100%"}),textToAppend=next.html(),textToAppend="\n"+textToAppend}textToSet+=$(this).append(textToAppend).html()+"<br /><br />"}),ev.dataTransfer.setData("text/plain","<br />"+textToSet),ev.dataTransfer.setData("text/html","<br />"+textToSet)},!1)),"mousedown"==evt.type){var dragStartFn=function(ev){var text=ev.dataTransfer.getData("text/html").replace(/(<[^>]+) (style|class)=["|'].*?["|']/gi,"$1").replace(/(<(\/?(ul|li)[^>]*)>)/gi,""),div=document.createElement("div");div.style.display="none",div.innerHTML='<div style="color: '+color+';">'+text+"</div>",ev.dataTransfer.setData("text/plain",div.innerHTML),ev.dataTransfer.setData("text/html",div.innerHTML)};elem.removeEventListener("dragstart",dragStartFn,!1),elem.addEventListener("dragstart",dragStartFn,!1);var drop=document.getElementsByClassName("kix-page-content-wrapper");drop&&drop[0]&&(drop=drop[0],drop.addEventListener("dragover",function(ev){ev.preventDefault()},!1),drop.addEventListener("drop",function(ev){return ev.preventDefault(),ev.dataTransfer.getData("text/plain")},!1))}};$("#citelighter-clipboard-panel .citelighter-citation-body, #citelighter-clipboard-panel .citelighter-bibs, #citelighter-clipboard-panel .cl-citation-body, #citelighter-clipboard-panel .cl-outline-comment-body, #citelighter-clipboard-panel .cl-outline-citation-body, #citelighter-clipboard-panel .cl-outline-user-comment, #citelighter-clipboard-panel .cl-outline-header").off("mousedown").on("mousedown",function(ev){clipboardSelectText(this,"#00928F",ev),$(this).css("cursor","move"),$(".popover").hide()}),$("#citelighter-clipboard-panel .citelighter-citation-body, #citelighter-clipboard-panel .citelighter-bibs, #citelighter-clipboard-panel .cl-citation-body, #citelighter-clipboard-panel .cl-outline-comment-body, #citelighter-clipboard-panel .cl-outline-citation-body, #citelighter-clipboard-panel .cl-outline-user-comment, #citelighter-clipboard-panel .cl-outline-header").off("mouseenter").on("mouseenter",function(ev){$(this).select(),$(this).css("cursor","move"),clipboardSelectText(this,"#00928F",ev),$(".popover").hide()}),$("#citelighter-clipboard-panel .citelighter-citation-body, #citelighter-clipboard-panel .citelighter-bibs, #citelighter-clipboard-panel .cl-citation-body, #citelighter-clipboard-panel .cl-outline-comment-body, #citelighter-clipboard-panel .cl-outline-citation-body, #citelighter-clipboard-panel .cl-outline-user-comment, #citelighter-clipboard-panel .cl-outline-header").off("mouseleave").on("mouseleave",function(){window.getSelection().empty(),$(".popover").hide()}),$("#citelighter-clipboard-panel .cl-outline-element.cl-outline-toggle-text .cl-outline-header").off("click").on("click",function(){$(this).parents(".cl-outline-element").find(".cl-outline-user-comment").hasClass("cl-outline-text-hide")?$(this).parents(".cl-outline-element").find(".cl-outline-user-comment").removeClass("cl-outline-text-hide"):$(this).parents(".cl-outline-element").find(".cl-outline-user-comment").addClass("cl-outline-text-hide")}),$(".citelighter-cl-item-container").on("mouseenter",function(){$(this).find(".citelighter-selectable").select(),$(".popover").hide()})},initGeneralPopovers:function(){$("#cl-add-to-bib-help").popover({placement:"top",html:!0,trigger:"hover",template:'<div class="popover citelighter-extension-popover" id="" style="margin-left: 16px;"><div class="arrow" style="left: 50%;"></div><div class="popover-inner" style="width: 100%; padding: 0px 0px 15px 15px; background-color: #528098;"><div class="popover-content" style="background-color: #528098; color: #FFF; font-size: 11px;"><p></p></div></div></div>',content:function(){return $("#cl-add-to-biblio-help-content").html()}}),$("#cl-biblio-help").popover({placement:"top",html:!0,trigger:"hover",template:'<div class="popover citelighter-extension-popover" style="max-width:90px;" id=""><div class="arrow"></div><div class="popover-inner" style="width:100%;padding:0px 0px 15px 15px;background-color:#528098;"><div class="popover-content" style="background-color:#528098; color:#FFF; font-size:11px;"><p></p></div></div></div>',content:function(){return $("#cl-biblio-help-content").html()}}),$("#citelighter-close-clipboard-btn").popover({placement:"bottom",html:!0,trigger:"click",template:'<div class="popover citelighter-custom-popover citelighter-extension-popover" id=""><div class="arrow"></div><div class="popover-inner" style="width:100%;padding:0px 0px 15px 15px;background-color:#528098;"><div class="popover-content" style="background-color:#528098; color:#FFF; font-size:11px;"><p></p></div></div></div>',content:function(){return CCE.Injection.toolbarVisible?(setTimeout(function(){$(".citelighter-custom-popover").length>0&&$(".citelighter-custom-popover").fadeOut(200)},6e3),$("#citelighter-clipboard-button-help").html()):""}}),$(".cl-select-all").css({top:"30px","float":"left"}),$("body").on("click",".popover",function(){$(".popover").hide()}),$("body").on("click",".cl-close-help",function(){$(".popover").hide()})},initPlusIcons:function(){$("body").off("click.CitelighterChromeExtension","#citelighter-clipboard-panel .plus-add-icon").on("click.CitelighterChromeExtension","#citelighter-clipboard-panel .plus-add-icon",function(){var listType=$("#cl-clipboard-tabs .cl-clipboard-tab.selected").text().toLowerCase();"captures"==listType&&(listType="all");var isOutline="all"!=listType;if("plus-add-all"==$(this).attr("id")){var elems=$(".plus-add-icon"),remove=!0;return $(this).hasClass("selected")?(elems.removeClass("selected"),$("#cl-"+listType+"-bibliography .citelighter-citation-bibliography").hide()):(elems.addClass("selected"),$("#cl-"+listType+"-bibliography .citelighter-citation-bibliography").show(),remove=!1),CCE.Injection.setAllCitationsInLocalStorage(isOutline,remove,void 0,!0),!1}var _citationId=$(this).data("citation-id"),_bibliography=$("#cl-"+listType+"-bibliography .citelighter-bib-"+_citationId);if(_bibliography.is(":visible")){if(!$(this).hasClass("selected"))return $(this).addClass("selected"),CCE.Injection.setCitationInLocalStorage(_citationId,isOutline),1==isOutline&&$("#cl-outline-content #cl-outline-list .cl-outline-element[data-item-type='citation'] .plus-add-citation[data-citation-id='"+_citationId+"']").addClass("selected"),CCE.Injection.updatePlusAddIconAll(listType),!1;var classList=_bibliography.attr("class").split(/\s+/);for(i=classList.length-1;i>=0;i--)if(classList[i].indexOf("citelighter-bib")==-1)classList.splice(i,1);else if(citation_id=classList[i].split("-")[2],citation_id!=_citationId&&$("#cl-"+listType+'-content .plus-add-icon[data-citation-id="'+citation_id+'"]').hasClass("selected"))return $(this).removeClass("selected"),CCE.Injection.setCitationInLocalStorage(_citationId,isOutline,!0),1==isOutline&&$("#cl-outline-content #cl-outline-list .cl-outline-element[data-item-type='citation'] .plus-add-citation[data-citation-id='"+_citationId+"']").removeClass("selected"),CCE.Injection.updatePlusAddIconAll(listType),!1;_bibliography.hide(),$(this).removeClass("selected"),1==isOutline&&$("#cl-outline-content #cl-outline-list .cl-outline-element[data-item-type='citation'] .plus-add-citation[data-citation-id='"+_citationId+"']").removeClass("selected"),CCE.Injection.setCitationInLocalStorage(_citationId,isOutline,!0)}else _bibliography.show(),$(this).addClass("selected"),1==isOutline&&$("#cl-outline-content #cl-outline-list .cl-outline-element[data-item-type='citation'] .plus-add-citation[data-citation-id='"+_citationId+"']").addClass("selected"),CCE.Injection.setCitationInLocalStorage(_citationId,isOutline);CCE.Injection.updatePlusAddIconAll(listType)})},setUserClipboardLocalStorage:function(userId){if(!isNaN(userId)){CCE.Injection.userId=userId;var userClipboard=jQuery.parseJSON(localStorage.getItem("citelighter_extension_user_clipboard")),objectToSetInLocalStorage={userId:userId};null!=userClipboard?userClipboard.userId!=userId&&localStorage.setItem("citelighter_extension_user_clipboard",JSON.stringify(objectToSetInLocalStorage)):localStorage.setItem("citelighter_extension_user_clipboard",JSON.stringify(objectToSetInLocalStorage))}},debugLocalStorage:function(){jQuery.parseJSON(localStorage.getItem("citelighter_extension_user_clipboard"))},setCitationInLocalStorage:function(citationId,isOutline,remove){var userClipboard=jQuery.parseJSON(localStorage.getItem("citelighter_extension_user_clipboard"));if(null!=userClipboard&&null!=CCE.Injection.project_id){var projectKey="project_"+CCE.Injection.project_id;"undefined"==typeof userClipboard[projectKey]&&(userClipboard[projectKey]={}),1==isOutline?("undefined"==typeof userClipboard[projectKey].outlines&&(userClipboard[projectKey].outlines={}),"undefined"==typeof remove?userClipboard[projectKey].outlines["cit_id_"+citationId]=!0:userClipboard[projectKey].outlines["cit_id_"+citationId]=!1):("undefined"==typeof userClipboard[projectKey].citations&&(userClipboard[projectKey].citations={}),"undefined"==typeof remove?userClipboard[projectKey].citations["cit_id_"+citationId]=!0:userClipboard[projectKey].citations["cit_id_"+citationId]=!1),localStorage.setItem("citelighter_extension_user_clipboard",JSON.stringify(userClipboard))}},setAllCitationsInLocalStorage:function(isOutline,remove,callback,force){var userClipboard=jQuery.parseJSON(localStorage.getItem("citelighter_extension_user_clipboard"));if(null!=userClipboard&&null!=CCE.Injection.project_id){var projectKey="project_"+CCE.Injection.project_id;"undefined"==typeof userClipboard[projectKey]&&(userClipboard[projectKey]={}),1==isOutline?0==remove?("undefined"==typeof userClipboard[projectKey].outlines&&(userClipboard[projectKey].outlines={}),$("#cl-outline-content #cl-outline-list .cl-outline-element[data-item-type='citation']").each(function(){var citId=$(this).data("citation-id");isNaN(citId)||"undefined"==typeof citId||null==citId||"undefined"!=typeof userClipboard[projectKey].outlines["cit_id_"+citId]&&1!=force||(userClipboard[projectKey].outlines["cit_id_"+citId]=!0)}),userClipboard[projectKey].all_outlines_added=!0):(userClipboard[projectKey].outlines={},userClipboard[projectKey].all_outlines_added=!1):0==remove?("undefined"==typeof userClipboard[projectKey].citations&&(userClipboard[projectKey].citations={}),$("#cl-all-content #cl-citations-list .cl-citation-element").each(function(){var citId=$(this).data("citation-id");isNaN(citId)||"undefined"==typeof citId||null==citId||"undefined"!=typeof userClipboard[projectKey].citations["cit_id_"+citId]&&1!=force||(userClipboard[projectKey].citations["cit_id_"+citId]=!0)}),userClipboard[projectKey].all_citations_added=!0):(userClipboard[projectKey].citations={},userClipboard[projectKey].all_citations_added=!1),localStorage.setItem("citelighter_extension_user_clipboard",JSON.stringify(userClipboard)),"function"==typeof callback&&callback()}else"function"==typeof callback&&callback()},setOutlinePlusIcons:function(callback){var userClipboard=jQuery.parseJSON(localStorage.getItem("citelighter_extension_user_clipboard")),projectKey="project_"+CCE.Injection.project_id;if("undefined"==typeof userClipboard[projectKey]&&(userClipboard[projectKey]={}),
"object"==typeof userClipboard[projectKey].outlines)for(var out in userClipboard[projectKey].outlines){var citId=out.replace("cit_id_",""),element=$("#cl-outline-content #cl-outline-list .cl-outline-element[data-citation-id='"+citId+"']");element.length>0&&1==userClipboard[projectKey].outlines[out]&&(element.find(".plus-add-citation.plus-add-icon").addClass("selected"),$("#cl-bibliography-content .citelighter-bib-"+citId).show())}"function"==typeof callback&&callback()},setCitationsPlusIcons:function(callback){var userClipboard=jQuery.parseJSON(localStorage.getItem("citelighter_extension_user_clipboard")),projectKey="project_"+CCE.Injection.project_id;if("undefined"==typeof userClipboard[projectKey]&&(userClipboard[projectKey]={}),"object"==typeof userClipboard[projectKey].citations)for(var out in userClipboard[projectKey].citations){var citId=out.replace("cit_id_",""),element=$("#cl-all-content #cl-citations-list .cl-citation-element[data-citation-id='"+citId+"']");element.length>0&&1==userClipboard[projectKey].citations[out]&&(element.find(".plus-add-citation.plus-add-icon").addClass("selected"),$("#cl-all-bibliography .citelighter-bib-"+citId).show())}"function"==typeof callback&&callback()},getPlusAllAdded:function(listType){var userClipboard=jQuery.parseJSON(localStorage.getItem("citelighter_extension_user_clipboard"));if(null!=userClipboard&&null!=CCE.Injection.project_id){var projectKey="project_"+CCE.Injection.project_id;return"undefined"!=typeof userClipboard[projectKey]&&("outline"==listType?"undefined"!=typeof userClipboard[projectKey].all_outlines_added&&0!=userClipboard[projectKey].all_outlines_added:"undefined"!=typeof userClipboard[projectKey].all_citations_added&&0!=userClipboard[projectKey].all_citations_added)}},updatePlusAddIconAll:function(listType){var updateAll=!0;"all"==listType&&null!=CCE.Toolbar.citations_loaded?CCE.Toolbar.project_citations_count>CCE.Toolbar.citations_loaded.length&&(updateAll=CCE.Injection.getPlusAllAdded("all")):"outline"==listType&&null!=CCE.Toolbar.outlines_loaded&&CCE.Toolbar.project_elements_count>CCE.Toolbar.outlines_loaded.length&&(updateAll=CCE.Injection.getPlusAllAdded("outline")),$("#cl-"+listType+"-content .plus-add-icon.selected").length!=$("#cl-"+listType+"-content .plus-add-icon").length?$("#plus-add-all").removeClass("selected"):1==updateAll&&$("#plus-add-all").addClass("selected")},injectInResearchPanel:function(){0==$("#citelighter-clipboard-caption").length&&(logoPath=chrome.extension.getURL("images/cl_logo_white_tsp.png"),closeImagePath=chrome.extension.getURL("images/btn_close_clipboard.png"),citelighterCaption=document.createElement("div"),citelighterCaption.setAttribute("style","position:absolute;z-index:9999; left:0;top:-37px;background-color:#414143;width:100%;height:37px;overflow:none;background-image: url('"+logoPath+"'); background-repeat:no-repeat; background-position: 8px center;"),citelighterCaption.setAttribute("id","citelighter-clipboard-caption"),citelighterCaption.setAttribute("class","citelighter-clipboard-caption-top"),citelighterCaption.innerHTML='<div id="citelighter-close-clipboard-btn" class="cl-close-gdoc-button" style="float:right;height:10px;width:11px;background-image:url('+closeImagePath+');background-position:left bottom;background-repeat:no-repeat;margin-right:10px;margin-top:12px;cursor:pointer;"></div>',researchPanel=document.getElementsByClassName("goog-sa-pane-inner")[0],researchPanel.appendChild(citelighterCaption,researchPanel.firstChild))},setProjectStyleFormat:function(){var format="MLA";switch(CCE.Injection.projectStyleId){case 1:format="APA";break;case 3:format="Chicago";break;default:format="MLA"}CCE.Injection.currentProjectFormat=format,CCE.Injection.setActiveProjectFormat()},insertClipBoardContent:function(data){$(".goog-menu-vertical").css("display","none");var gdocs_regex=new RegExp("docs.google.com");if(!gdocs_regex.test(document.location.href))return!1;if(gdocs_regex=new RegExp("/document/"),!gdocs_regex.test(document.location.href))return!1;if(CCE.Injection.injectInResearchPanel(),CCE.Injection.checkClipboardInjected(),1!=data.cookie_ok||null==data.project_id||""==data.project_id?($(".cl-clipboard-inner-content").addClass("hide"),$(".cl-clipboard-notification-message").removeClass("hide"),1!=data.cookie_ok?$(".cl-clipboard-notification-message").html("<p><a href='"+data.base_url+"login'>Please log in to Citelighter</a></p>"):$(".cl-clipboard-notification-message").html("<p>Please Select a project</p>")):($(".cl-clipboard-inner-content").removeClass("hide"),$(".cl-clipboard-notification-message").addClass("hide")),"undefined"!=typeof data.loggingOut&&1==data.loggingOut)return!1;var request={action:"getTabResearchPanelVisible"};chrome.extension.sendMessage(request,function(response){response.status||CCE.Injection.gdocsForceShowResearchPanel()}),CCE.Injection.setGdocProjectTitle(data.project_name),CCE.Injection.setGdocSelectedTab(data.activeClipboardTab),null!=data.project_id&&""!=data.project_id?CCE.Injection.project_id=data.project_id:CCE.Injection.project_id=null,CCE.Injection.projectStyleId=data.project_style_id,CCE.Injection.setProjectStyleFormat(),CCE.Injection.setUserClipboardLocalStorage(data.userId),$("#citelighter-clipboard-panel").css("position","absolute"),$("#citelighter-clipboard-panel").css("top","0"),$("#citelighter-clipboard-panel").css("left","0"),CCE.Injection.checBiblioDisplayEmpty(),CCE.Injection.initPlusIcons()},removeGoogleDocsClipboard:function(logOut){if($("#citelighter-clipboard-panel").length>0){if(logOut){var data={};data.cookie_ok=!1,data.project_id=null,data.loggingOut=!0,CCE.Injection.insertClipBoardContent(data)}else CCE.Injection.gdocsForceHideResearchPanel(),$(".citelighter-clipboard-panel-top").remove(),$(".citelighter-clipboard-caption-top").remove()}},toggleGoogleDocsClipboard:function(){var clipboardPanel=$("#citelighter-clipboard-panel");if(clipboardPanel.length>0){if(0==CCE.Injection.toggleInProcess)if(CCE.Injection.toggleInProcess=!0,clipboardPanel.is(":visible")){var request={action:"getTabResearchPanelVisible"};chrome.extension.sendMessage(request,function(response){if(!response.status)return CCE.Injection.gdocsForceHideResearchPanel(),!1}),$(".citelighter-clipboard-panel-top , .citelighter-clipboard-caption-top").css("left","250px"),$(".citelighter-clipboard-panel-top").css("display","none"),$(".citelighter-clipboard-caption-top").css("display","none"),setTimeout(function(){CCE.Injection.toggleInProcess=!1},50)}else{var request={action:"getTabResearchPanelVisible"};$(".goog-menu-vertical").css("display","none"),chrome.extension.sendMessage(request,function(response){response.status||CCE.Injection.gdocsForceShowResearchPanel()}),$(".citelighter-clipboard-panel-top").css("display","block"),$(".citelighter-clipboard-caption-top").css("display","block"),$(".citelighter-clipboard-panel-top, .citelighter-clipboard-caption-top").css("left","0px"),setTimeout(function(){CCE.Injection.toggleInProcess=!1},50)}}else{var request={action:"openGdocsPicker"};chrome.extension.sendMessage(request,CCE.Injection.defaultCallback)}},injectGoogleClipboard:function(){var checkResearchPanel=function(){var gdocs_regex=new RegExp("/document/");if(!gdocs_regex.test(document.location.href))return!1;CCE.Injection.gdocCheckResearchPanelPreference();var request={action:"getTabResearchPanelVisible"};if(chrome.extension.sendMessage(request,function(response){response.status||CCE.Injection.gdocsForceShowResearchPanel()}),0==document.getElementsByClassName("goog-sa-pane-inner").length)setTimeout(checkResearchPanel,2e3);else if(0==$("#citelighter-clipboard-caption").length){var request={action:"getStatus"};chrome.extension.sendMessage(request,function(response){CCE.Injection.injectInResearchPanel(),CCE.Injection.checkClipboardInjected(),CCE.Injection.getClipBoard(),$(".cl-close-gdoc-button").unbind("click"),$(".cl-close-gdoc-button").click(function(e){e.preventDefault(),e.stopPropagation();var request={action:"toolbarClick",selector:"#citelighter-menu-write-gdocs"};chrome.extension.sendMessage(request)}),_research_menuitem_id=$(".goog-menuitem-content:contains('esearch')").closest(".goog-menuitem").attr("id"),_define_menuitem_id=$(".goog-menuitem-content:contains('efine')").closest(".goog-menuitem").attr("id"),_revision_history_id=$(".goog-menuitem-content:contains('revision')").closest(".goog-menuitem").attr("id"),$("#\\"+_research_menuitem_id+", #\\"+_define_menuitem_id).unbind("click"),$("#\\"+_research_menuitem_id+", #\\"+_define_menuitem_id).click(function(){var request={action:"setTabResearchPanelVisible",status:!0};chrome.extension.sendMessage(request,CCE.Injection.defaultCallback),$(".citelighter-clipboard-panel-top, .citelighter-clipboard-caption-top").css("display","none")}),$(".goog-sa-pane-title-close").unbind("click"),$(".goog-sa-pane-title-close").click(function(){var request={action:"setTabResearchPanelVisible",status:!1};chrome.extension.sendMessage(request,CCE.Injection.defaultCallback)}),$("#\\"+_revision_history_id).unbind("click"),$("#\\"+_revision_history_id).click(function(){$(".citelighter-clipboard-panel-top, .citelighter-clipboard-caption-top, .docs-reference-pane-container").css("display","none")}),$(".goog-menu-vertical").css("display","none")})}},regex=new RegExp("docs.google.com");regex.test(document.location.href)&&setTimeout(checkResearchPanel,2e3)},getClipBoard:function(){var src=chrome.extension.getURL("content/gdocs_clipboard.html"),xhr=new XMLHttpRequest;xhr.onreadystatechange=function(){if(4==xhr.readyState){var resp=xhr.responseText;$("#citelighter-clipboard-panel").addClass("citelighter-chrome-extension-gdoc"),$("#citelighter-clipboard-panel").html(resp),"undefined"==typeof jQuery.fn.popover&&CCE.Injection.init_popover(),CCE.Injection.getClipBoardContent(),CCE.Injection.initGdocsTabsToogle(),CCE.Injection.setTopInjectionLogoAndTooltips(),CCE.Injection.initGdocProjectStyleChange(),CCE.Injection.initClipboardInfiniteScroll()}},xhr.open("GET",src,!0),xhr.send()},getClipBoardContent:function(forInfiniteScroll){var infiniteScroll="undefined"!=typeof forInfiniteScroll,request={action:"getClipBoardContent",inifiniteScroll:infiniteScroll};chrome.extension.sendMessage(request,CCE.Injection.defaultCallback)},gdocCheckResearchPanelPreference:function(){var checkGdocsPreference=document.createElement("script");if(checkGdocsPreference.setAttribute("id","citelighter-check-research-panel"),checkGdocsPreference.innerText='(function(){if(typeof _docs_userPreferences != "undefined") {if(_docs_userPreferences["docs-show_reference"] == "true") {testPanel = document.createElement("div");testPanel.setAttribute("id","citelighter-test-panel");researchPanel = document.getElementsByClassName("goog-sa-pane-inner")[0];researchPanel.appendChild(testPanel,researchPanel.firstChild);} }var is = document.getElementById("citelighter-check-research-panel");if (is) {document.head.removeChild(is)}})()',document.head.appendChild(checkGdocsPreference),$("#citelighter-test-panel").length>0){var request={action:"setTabResearchPanelVisible",status:!0};chrome.extension.sendMessage(request,CCE.Injection.defaultCallback),$("#citelighter-test-panel").remove()}},gdocsForceShowResearchPanel:function(){var request={action:"getTabResearchPanelVisible"};chrome.extension.sendMessage(request,function(response){if(!response.status){if(document.getElementById("docs-editor").style.width=window.innerWidth-251+"px","undefined"==typeof document.getElementsByClassName("docs-reference-pane-container")[0]&&"comment only"==document.getElementById("docs-notice").innerHTML.toLowerCase()){var docs_reference_pane_container=document.createElement("div");docs_reference_pane_container.setAttribute("class","docs-reference-pane-container"),docs_reference_pane_container.setAttribute("style","display: none;"),document.body.appendChild(docs_reference_pane_container);var docs_reference_pane_container=document.getElementsByClassName("docs-reference-pane-container")[0],goog_sa_pane_ctrl=document.createElement("div");goog_sa_pane_ctrl.setAttribute("class","goog-sa-pane-ctrl"),docs_reference_pane_container.appendChild(goog_sa_pane_ctrl);var goog_sa_pane=document.createElement("div");goog_sa_pane.setAttribute("class","goog-sa-pane goog-sa-component-a11y goog-sa-component-online"),goog_sa_pane.setAttribute("style","width: 250px; height: 100%; display: block; background-color: white;"),goog_sa_pane_ctrl.appendChild(goog_sa_pane);var goog_sa_pane_title=document.createElement("div");goog_sa_pane_title.setAttribute("class","goog-sa-pane-title"),goog_sa_pane.appendChild(goog_sa_pane_title);var goog_sa_pane_inner=document.createElement("div");goog_sa_pane_inner.setAttribute("class","goog-sa-pane-inner"),goog_sa_pane_inner.setAttribute("style","height: "+document.getElementById("kix-appview").offsetHeight+"px;"),goog_sa_pane.appendChild(goog_sa_pane_inner),document.getElementsByClassName("docs-reference-pane-container")[0].style.display="none",document.getElementsByClassName("goog-sa-pane")[0].style.display="none"}else document.getElementsByClassName("docs-reference-pane-container")[0].style.top="95px",CCE.Injection.toolbarVisible||(document.getElementsByClassName("docs-reference-pane-container")[0].style.top="60px"),document.getElementsByClassName("docs-reference-pane-container")[0].style.display="block",document.getElementsByClassName("goog-sa-pane")[0].style.display="block";CCE.Injection.gdocsForceResize()}})},gdocsForceHideResearchPanel:function(){$("#citelighter-clipboard-panel").length>0&&($(".citelighter-clipboard-panel-top").css("display","none"),$(".docs-reference-pane-container").css("display","none"),document.getElementById("docs-editor").style.width=window.innerWidth+"px",CCE.Injection.gdocsForceResize())},gdocsForceResize:function(){var resizeGdocsScript=document.createElement("script");resizeGdocsScript.setAttribute("id","citelighter-check-research-panel"),resizeGdocsScript.innerText='(function () {if (typeof (window.KX_resize) == "function") {window.KX_resize();window.KX_resize();}var is = document.getElementById("citelighter-check-research-panel");if (is) {document.head.removeChild(is)}var timeOut = null;window.onresize = function() {if (timeOut != null) {clearTimeout(timeOut);}\ntimeOut = setTimeout(function(){if (document.getElementsByClassName("docs-reference-pane-container")[0].style.display != "none"){document.getElementById("docs-toolbar-wrapper").style.width = (document.body.clientWidth - 339) + "px";document.getElementById("docs-editor").style.width = (document.body.clientWidth - 251) + "px";document.getElementsByClassName("goog-sa-pane-inner")[0].style.height = document.getElementById("kix-appview").offsetHeight + "px";document.getElementById("citelighter-clipboard-panel").style.height = document.getElementById("kix-appview").offsetHeight + "px";}}, 500);};})()',"none"!==document.getElementsByClassName("docs-reference-pane-container")[0].style.display&&(document.getElementById("docs-toolbar-wrapper").style.width=document.body.clientWidth-339+"px",document.getElementById("docs-editor").style.width=document.body.clientWidth-251+"px",document.getElementsByClassName("goog-sa-pane-inner")[0].style.height=document.getElementById("kix-appview").offsetHeight+"px",document.getElementById("citelighter-clipboard-panel").style.height=document.getElementById("kix-appview").offsetHeight+"px"),document.head.appendChild(resizeGdocsScript)},init_popover:function(){!function($){"use strict";var Tooltip=function(element,options){this.init("tooltip",element,options)};Tooltip.prototype={constructor:Tooltip,init:function(type,element,options){var eventIn,eventOut;this.type=type,this.$element=$(element),this.options=this.getOptions(options),this.enabled=!0,"click"==this.options.trigger?this.$element.on("click."+this.type,this.options.selector,$.proxy(this.toggle,this)):"manual"!=this.options.trigger&&(eventIn="hover"==this.options.trigger?"mouseenter":"focus",eventOut="hover"==this.options.trigger?"mouseleave":"blur",this.$element.on(eventIn+"."+this.type,this.options.selector,$.proxy(this.enter,this)),this.$element.on(eventOut+"."+this.type,this.options.selector,$.proxy(this.leave,this))),this.options.selector?this._options=$.extend({},this.options,{trigger:"manual",selector:""}):this.fixTitle()},getOptions:function(options){return options=$.extend({},$.fn[this.type].defaults,options,this.$element.data()),options.delay&&"number"==typeof options.delay&&(options.delay={show:options.delay,hide:options.delay}),options},enter:function(e){var self=$(e.currentTarget)[this.type](this._options).data(this.type);return self.options.delay&&self.options.delay.show?(clearTimeout(this.timeout),self.hoverState="in",void(this.timeout=setTimeout(function(){"in"==self.hoverState&&self.show()},self.options.delay.show))):self.show()},leave:function(e){var self=$(e.currentTarget)[this.type](this._options).data(this.type);return this.timeout&&clearTimeout(this.timeout),self.options.delay&&self.options.delay.hide?(self.hoverState="out",void(this.timeout=setTimeout(function(){"out"==self.hoverState&&self.hide()},self.options.delay.hide))):self.hide()},show:function(){var $tip,inside,pos,actualWidth,actualHeight,placement,tp;if(this.hasContent()&&this.enabled){switch($tip=this.tip(),this.setContent(),this.options.animation&&$tip.addClass("fade"),placement="function"==typeof this.options.placement?this.options.placement.call(this,$tip[0],this.$element[0]):this.options.placement,inside=/in/.test(placement),$tip.remove().css({top:0,left:0,display:"block"}).appendTo(inside?this.$element:document.body),pos=this.getPosition(inside),actualWidth=$tip[0].offsetWidth,actualHeight=$tip[0].offsetHeight,inside?placement.split(" ")[1]:placement){case"bottom":tp={top:pos.top+pos.height,left:pos.left+pos.width/2-actualWidth/2};break;case"top":tp={top:pos.top-actualHeight,left:pos.left+pos.width/2-actualWidth/2};break;case"left":tp={top:pos.top+pos.height/2-actualHeight/2,left:pos.left-actualWidth};break;case"right":tp={top:pos.top+pos.height/2-actualHeight/2,left:pos.left+pos.width}}$tip.css(tp).addClass(placement).addClass("in")}},setContent:function(){var $tip=this.tip(),title=this.getTitle();$tip.find(".tooltip-inner")[this.options.html?"html":"text"](title),$tip.removeClass("fade in top bottom left right")},hide:function(){function removeWithAnimation(){var timeout=setTimeout(function(){$tip.off($.support.transition.end).remove()},500);$tip.one($.support.transition.end,function(){clearTimeout(timeout),$tip.remove()})}var $tip=this.tip();return $tip.removeClass("in"),$.support.transition&&this.$tip.hasClass("fade")?removeWithAnimation():$tip.remove(),this},fixTitle:function(){var $e=this.$element;($e.attr("title")||"string"!=typeof $e.attr("data-original-title"))&&$e.attr("data-original-title",$e.attr("title")||"").removeAttr("title")},hasContent:function(){return this.getTitle()},getPosition:function(inside){return $.extend({},inside?{top:0,left:0}:this.$element.offset(),{width:this.$element[0].offsetWidth,height:this.$element[0].offsetHeight})},getTitle:function(){var title,$e=this.$element,o=this.options;return title=$e.attr("data-original-title")||("function"==typeof o.title?o.title.call($e[0]):o.title)},tip:function(){return this.$tip=this.$tip||$(this.options.template)},validate:function(){this.$element[0].parentNode||(this.hide(),this.$element=null,this.options=null)},enable:function(){this.enabled=!0},disable:function(){this.enabled=!1},toggleEnabled:function(){this.enabled=!this.enabled},toggle:function(){this[this.tip().hasClass("in")?"hide":"show"]()},destroy:function(){this.hide().$element.off("."+this.type).removeData(this.type)}},$.fn.tooltip=function(option){return this.each(function(){var $this=$(this),data=$this.data("tooltip"),options="object"==typeof option&&option;data||$this.data("tooltip",data=new Tooltip(this,options)),"string"==typeof option&&data[option]()})},$.fn.tooltip.Constructor=Tooltip,$.fn.tooltip.defaults={animation:!0,placement:"top",selector:!1,template:'<div class="tooltip"><div class="tooltip-arrow"></div><div class="tooltip-inner"></div></div>',trigger:"hover",title:"",delay:0,html:!0}}(window.jQuery),!function($){"use strict";var Popover=function(element,options){this.init("popover",element,options)};Popover.prototype=$.extend({},$.fn.tooltip.Constructor.prototype,{constructor:Popover,setContent:function(){var $tip=this.tip(),title=this.getTitle(),content=this.getContent();$tip.find(".popover-title")[this.options.html?"html":"text"](title),$tip.find(".popover-content > *")[this.options.html?"html":"text"](content),$tip.removeClass("fade top bottom left right in")},hasContent:function(){return this.getTitle()||this.getContent()},getContent:function(){var content,$e=this.$element,o=this.options;return content=$e.attr("data-content")||("function"==typeof o.content?o.content.call($e[0]):o.content)},tip:function(){return this.$tip||(this.$tip=$(this.options.template)),this.$tip},destroy:function(){this.hide().$element.off("."+this.type).removeData(this.type)}}),$.fn.popover=function(option){return this.each(function(){var $this=$(this),data=$this.data("popover"),options="object"==typeof option&&option;data||$this.data("popover",data=new Popover(this,options)),"string"==typeof option&&data[option]()})},$.fn.popover.Constructor=Popover,$.fn.popover.defaults=$.extend({},$.fn.tooltip.defaults,{placement:"right",trigger:"click",content:"",template:'<div class="popover" id=""><div class="arrow"></div><div class="popover-inner"><h3 class="popover-title"></h3><div class="popover-content"><p></p></div></div></div>'})}(window.jQuery)}},window.addEventListener("popstate",function(event){event.state||CCE.Injection.inject()}),window.onload=function(){CCE.Injection.inject()},window.addEventListener("CitelighterLogoutEvent",function(e){chrome.extension.sendMessage({action:"logout"})},!1,!0),window.addEventListener("ProjectDeleted",function(e){window.document.documentElement.removeChild(e.target),chrome.extension.sendMessage({action:"refreshProjectsList"})},!1,!0),window.addEventListener("ProjectCreated",function(e){window.document.documentElement.removeChild(e.target),chrome.extension.sendMessage({action:"refreshProjectsList"})},!1,!0),window.addEventListener("ProjectEdited",function(e){chrome.extension.sendMessage({action:"refreshProjectsList"}),window.document.documentElement.removeChild(e.target)},!1,!0),window.addEventListener("ProjectRestored",function(e){window.document.documentElement.removeChild(e.target),chrome.extension.sendMessage({action:"refreshProjectsList"})},!1,!0),window.addEventListener("ProjectEditedFromGdocs",function(e){var setProjectActive=e.target.getAttribute("data-project-id"),isFromGdocPicker=e.target.getAttribute("data-set-active");null!=isFromGdocPicker&&"undefined"!=typeof isFromGdocPicker&&chrome.extension.sendMessage({action:"refreshProjectsList",setActive:setProjectActive}),window.document.documentElement.removeChild(e.target)},!1,!0),window.addEventListener("UserDetailsChanged",function(e){window.document.documentElement.removeChild(e.target),chrome.extension.sendMessage({action:"setUserDetails"})}),window.addEventListener("CitelighterExtensionGdocCreatedAction",function(e){var project_id=e.target.getAttribute("data-project-id");window.document.documentElement.removeChild(e.target),chrome.extension.sendMessage({action:"setActiveProjectById",project_id:project_id})});var CCE=CCE||{};CCE.Keyboard={base_url:null,ExtensionBaseUrl:null,isLoggedIn:!1,options:{},defaultCallback:function(response){response||"undefined"==typeof chrome.extension.lastError||console.log("No response. Error: "+chrome.extension.lastError.message)},goHome:function(home){var current_url=window.location.hostname,site_in_current_tab=current_url.search(CCE.Keyboard.ExtensionBaseUrl),url=CCE.Keyboard.base_url+(home?"homepage":"");site_in_current_tab!=-1?window.location=url:window.open(url)},keyup:function(e){if(e.altKey&&e.ctrlKey){var options=CCE.Keyboard.options,request=null,log_request=null;switch(e.keyCode){case options.keyCapture.charCodeAt():request={action:"toolbarClick",selector:".citelighter-create-citation-btn"},log_request={action:"logClickEvent",action_event:"citelighter-capture-key"};break;case options.keyView.charCodeAt():request={action:"toolbarClick",selector:"#citeligher-menu-view-prj"},log_request={action:"logClickEvent",action_event:"citelighter-view-project-key"};break;case options.keyExportWord.charCodeAt():request={action:"toolbarClick",selector:"#citelighter-menu-export"},log_request={action:"logClickEvent",action_event:"citelighter-export-word-key"};break;case options.keyExportEmail.charCodeAt():request={action:"toolbarClick",selector:"#citelighter-menu-send-email"},log_request={action:"logClickEvent",action_event:"citelighter-share-email-key"};break;case options.keyGoHome.charCodeAt():CCE.Keyboard.goHome(!0),request={action:"toolbarClick"},log_request={action:"logClickEvent",action_event:"citelighter-go-home-key"};break;case options.keyGoProjects.charCodeAt():CCE.Keyboard.goHome(),request={action:"toolbarClick"},log_request={action:"logClickEvent",action_event:"citelighter-go-projects-key"};break;case options.keySettings.charCodeAt():request={action:"toolbarClick",selector:"#citelighter-menu-settings"},log_request={action:"logClickEvent",action_event:"citelighter-open-settings-key"};break;case options.keyHelp.charCodeAt():request={action:"toolbarClick",selector:"#citelighter-menu-help"},log_request={action:"logClickEvent",action_event:"citelighter-help-page-key"};break;case options.keyRefresh.charCodeAt():request={action:"refreshToolbar"},log_request={action:"logClickEvent",action_event:"citelighter-refresh-key"};break;case options.keyToolbar.charCodeAt():request={action:"toggleToolbar"},log_request={action:"logClickEvent",action_event:"citelighter-toolbar-key"};break;case options.keySign_in_out.charCodeAt():request={action:"showLogin"},log_request={action:"logClickEvent",action_event:"citelighter-sign-in-out-key"}}request&&chrome.extension.sendMessage(request,CCE.Keyboard.defaultCallback),null!=log_request&&1==CCE.Keyboard.isLoggedIn&&chrome.extension.sendMessage(log_request,CCE.Keyboard.defaultCallback)}},initialSetup:function(){var request={action:"getStatus"};chrome.extension.sendMessage(request,function(response){response||"undefined"==typeof chrome.extension.lastError||console.log("No response. Error: "+chrome.extension.lastError.message),CCE.Keyboard.isLoggedIn=request.logged_in,CCE.Keyboard.options=response.options,CCE.Keyboard.base_url=response.base_url,CCE.Keyboard.ExtensionBaseUrl=response.ExtensionBaseUrl}),chrome.extension.onMessage.addListener(function(request,sender,sendResponse){switch(request.action){case"loginStatus":CCE.Keyboard.isLoggedIn=request.logged_in;break;case"optionsChanged":CCE.Keyboard.options=request.options}}),$("html").on("keyup",function(e){CCE.Keyboard.keyup(e)})}};var CCE=CCE||{};CCE.Options={options:{},mainPanelHeight:700,cancel:function(){var requestClose={action:"removeOptionsWindow"};chrome.extension.sendMessage(requestClose,function(response){response||"undefined"==chrome.extension.lastError||console.log("No response. Error: "+chrome.extension.lastError.message)})},compactOptionsPanel:function(){var citelighterOptionsPage=document.getElementById("CitelighterToolbarOptionsPage");if(citelighterOptionsPage){var maxHeight=CCE.Options.mainPanelHeight;window.innerHeight<maxHeight&&(maxHeight=window.innerHeight-20);var calc_offset_top=maxHeight/2;citelighterOptionsPage.style.top="calc(50% - "+calc_offset_top+"px)",citelighterOptionsPage.style.height=maxHeight+"px";var options_height=maxHeight,diff=options_height-($("#CitelighterToolbarOptionsPage .citelighter-options-settings-title").outerHeight()+$("#CitelighterToolbarOptionsPage #citelighter-options-type").outerHeight()+20),selector_height=$("#CitelighterToolbarOptionsPage .citelighter-options-content-area").outerHeight();selector_height+diff>$("#CitelighterToolbarOptionsPage").height()&&$("#CitelighterToolbarOptionsPage .citelighter-options-content-area").css("max-height",diff+"px")}},initWindowResize:function(){$(window).on("resize.CitelighterChromeExtension",function(){CCE.Options.compactOptionsPanel()})},showOptionsOverlay:function(){if($("#CitelighterToolbarOptionsOverlay").length>0)$("#CitelighterToolbarOptionsOverlay").css("display","block");else{var html=null;if(document.documentElement?html=document.documentElement:document.getElementsByTagName("html")&&document.getElementsByTagName("html")[0]&&(html=document.getElementsByTagName("html")[0]),html){var optionsOverlay=document.createElement("div");optionsOverlay.setAttribute("id","CitelighterToolbarOptionsOverlay"),html.appendChild(optionsOverlay),CCE.Options.showOptionsOverlay()}}},hideOptionsOverlay:function(){$("#CitelighterToolbarOptionsOverlay").length>0&&$("#CitelighterToolbarOptionsOverlay").css("display","none")},saveOptions:function(){var options={},checkbox=document.getElementById("citelighter-options-hide-capture");options.hideCapture=checkbox.checked,checkbox=document.getElementById("citelighter-options-hide-toolbar"),options.toolbarVisible=!checkbox.checked;var pdfjsCheckbox=document.getElementById("citelighter-options-hide-pdfjs");options.hidePdfjs=pdfjsCheckbox.checked;var pdfjsCheckbox_warning=document.getElementById("citelighter-options-hide-pdfjs-warning");options.hidePdfjsWarning=pdfjsCheckbox_warning.checked,$("#citelighter-options-keys-content input").each(function(index,element){var option=$(element).val();options[$(element).attr("id")]=option});var request={action:"optionsChanged",options:options};chrome.extension.sendMessage(request,function(response){response||"undefined"==chrome.extension.lastError||console.log("No response. Error: "+chrome.extension.lastError.message)});var requestClose={action:"removeOptionsWindow"};chrome.extension.sendMessage(requestClose,function(response){response||"undefined"==chrome.extension.lastError||console.log("No response. Error: "+chrome.extension.lastError.message)})},restoreOptions:function(options){CCE.Options.loadBooleanOption("hideCapture","citelighter-options-hide-capture",options),CCE.Options.loadBooleanOption("hidePdfjs","citelighter-options-hide-pdfjs",options),CCE.Options.loadBooleanOption("hidePdfjsWarning","citelighter-options-hide-pdfjs-warning",options),CCE.Options.loadBooleanOption("toolbarVisible","citelighter-options-hide-toolbar",options,!0),$("#citelighter-options-keys-content input").each(function(index,element){var option=options[$(element).attr("id")]||"";$(element).val(option)})},resetOptions:function(){var request={action:"resetOptions"};chrome.extension.sendMessage(request,function(response){return response||"undefined"==chrome.extension.lastError?void CCE.Options.restoreOptions(response.options):void console.log("No response. Error: "+chrome.extension.lastError.message)})},loadBooleanOption:function(optName,optCheckbox,options,invert){var option=options[optName]||!1;invert&&(option=!option);var checkbox=document.getElementById(optCheckbox);checkbox&&(checkbox.checked=option)},validateShortcut:function(e){$("html").on("keypress","#citelighter-options-keys-content input",function(e){var key=String.fromCharCode(e.keyCode).toUpperCase();if($("#citelighter-options-keys-content input").removeClass("conflict"),/[[A-Z0-9]/.test(key)){var conflict=!1;$("#citelighter-options-keys-content input").each(function(index,element){if(!conflict&&element!==e.target){var option=$(element).val();key==option&&($(element).addClass("conflict"),$(e.target).addClass("conflict"),$("#citelighter-options-keys .conflict-msg").show(),setTimeout(function(){$("#citelighter-options-keys .conflict-msg").hide()},3e3),conflict=!0)}}),conflict||$(e.target).val(key)}return!1})},initConfirmDialog:function(){$("html").on("click.CitelighterChromeExtension","#citelighter-options-reset-btn",function(e){e.preventDefault(),$("#citelighter-dialog-confirm").html("Are you sure you want to reset all the Citelighter options?"),$("#citelighter-dialog-confirm").dialog({
resizable:!1,modal:!0,title:"Reset Confirmation",height:250,width:400,appendTo:"#CitelighterToolbarOptionsPage",buttons:{Yes:function(){$(this).dialog("close"),CCE.Options.resetOptions()},No:function(){$(this).dialog("close")}}})})},toogleProOptions:function(visible){1==visible?$(".citelighter-user-pro-option").show():$(".citelighter-user-pro-option").hide()},initOptionsFunctionality:function(){$("html").on("click.CitelighterChromeExtension",".citelighter-close-options, #citelighter-options-cancel-btn",function(e){e.preventDefault(),CCE.Options.cancel()}),$("html").on("click.CitelighterChromeExtension","#citelighter-options-save-btn",function(e){e.preventDefault(),CCE.Options.saveOptions()}),$("html").on("click.CitelighterChromeExtension","#citelighter-options-type li",function(e){e.preventDefault(),$(this).hasClass("general-option")?($("#citelighter-options-general").show(),$("#citelighter-options-keys").hide(),$(this).parents(".citelighter-options-main-container").find(".citelighter-options-main").removeClass("citelighter-options-shortcut-visible")):($("#citelighter-options-general").hide(),$("#citelighter-options-keys").show(),$(this).parents(".citelighter-options-main-container").find(".citelighter-options-main").addClass("citelighter-options-shortcut-visible")),$(this).parents("#citelighter-options-type").find("li").removeClass("selected"),$(this).addClass("selected")})},showOptionsWindow:function(){var request={action:"getOptions"};chrome.extension.sendMessage(request,function(response){return response||"undefined"==chrome.extension.lastError?(CCE.Options.restoreOptions(response.options),CCE.Options.toogleProOptions(response.pro_status),$("#CitelighterToolbarOptionsPage").css("display","inline-block"),CCE.Options.showOptionsOverlay(),void CCE.Options.compactOptionsPanel()):void console.log("No response. Error: "+chrome.extension.lastError.message)})},closeOptionsWindow:function(){$("#CitelighterToolbarOptionsPage").css("display","none"),CCE.Options.hideOptionsOverlay()},initialSetup:function(){CCE.Options.validateShortcut(),CCE.Options.initConfirmDialog(),CCE.Options.initOptionsFunctionality(),setTimeout(function(){$("#citelighter-options-general").show(),$("#citelighter-options-type li").first().click()},1e3),CCE.Options.initWindowResize(),chrome.extension.onMessage.addListener(function(request,sender,sendResponse){var response={};switch(request.action){case"showOptionsWindow":CCE.Options.showOptionsWindow(),response.success=!0;break;case"closeOptionsWindow":CCE.Options.closeOptionsWindow(),response.success=!0}return!0})}};var CCE=CCE||{};CCE.ScanImages={imageMinWidth:100,imageMinHeight:100,scanedImages:[],uniqueSources:[],curatedImages:[],totalImages:0,getAllImagesAndCanvas:function(doc,_type){var type="undefined"!=typeof _type?_type:"img",allIframeElements=doc.getElementsByTagName(type);if(allIframeElements.length>0)for(var oneImage in allIframeElements){var element=allIframeElements[oneImage],elementWidth="undefined"!=typeof element.naturalWidth?element.naturalWidth:element.clientWidth,elementHeight="undefined"!=typeof element.naturalHeight?element.naturalHeight:element.clientHeight;if(!CCE.ScanImages.elementHasClass(element)&&CCE.ScanImages.uniqueSources.indexOf(element.src)==-1&&elementWidth>=CCE.ScanImages.imageMinWidth&&elementHeight>=CCE.ScanImages.imageMinHeight){var url=element.src;if("canvas"==type){var image=new Image;image.src=element.toDataURL(),url=image.src}var imageInfo={};imageInfo.source=url,imageInfo.imageName=""!=$.trim(element.getAttribute("alt"))?$.trim(element.getAttribute("alt")):""!=$.trim(element.getAttribute("title"))?$.trim(element.getAttribute("title")):"",imageInfo.width=element.naturalWidth,imageInfo.height=element.naturalHeight,CCE.ScanImages.curatedImages.push(imageInfo),CCE.ScanImages.uniqueSources.push(url),CCE.ScanImages.totalImages++}}},elementHasClass:function(element,_cls){var cls="undefined"!=typeof _cls?cls:"cl-citation-image";return(" "+element.className+" ").indexOf(" "+cls+" ")>-1},getAllDocuments:function(searchType){var type="undefined"!=typeof searchType?searchType:"iframe",documents=[];return childDocuments=CCE.ScanImages.getAllChildDocuments(documents,type,!0),documents.concat(childDocuments)},getAllChildDocuments:function(docs,searchType,usingOriginal){return"undefined"!=typeof usingOriginal&&(docs=[document]),docs},getAllImages:function(){var response={},allDocs=[document];if(CCE.ScanImages.curatedImages=[],CCE.ScanImages.uniqueSources=[],"undefined"!=typeof CCE.TextSelection&&"function"==typeof CCE.TextSelection.getNoTextSelectionWebsites){var listWebsitesNoTextSelection=CCE.TextSelection.getNoTextSelectionWebsites();for(item in listWebsitesNoTextSelection)if(new RegExp(listWebsitesNoTextSelection[item]).test(window.location.href))return response.results=CCE.ScanImages.curatedImages,response.total_images=CCE.ScanImages.totalImages,response}var allIframesDocs=CCE.ScanImages.getAllDocuments("iframe"),allFramesDocs=CCE.ScanImages.getAllDocuments("frame");if(allDocs=allDocs.concat(allIframesDocs),allDocs=allDocs.concat(allFramesDocs),allDocs.length>0)for(var oneDoc in allDocs)CCE.ScanImages.getAllImagesAndCanvas(allDocs[oneDoc],"img"),CCE.ScanImages.getAllImagesAndCanvas(allDocs[oneDoc],"canvas");return response.results=CCE.ScanImages.curatedImages,response.total_images=CCE.ScanImages.totalImages,response},initialSetup:function(){chrome.extension.onMessage.addListener(function(request,sender,sendResponse){if("scanImages"==request.scope)switch(request.action){case"getImages":var response=CCE.ScanImages.getAllImages();sendResponse(response)}})}};var CCE=CCE||{};CCE.TextSelection={isLoggedIn:!1,lastSel:null,showCaptureInPage:!1,_window:window,_document:document,isPDFjs:!1,base_url:"sylvanpaper.sylvanlearning.com",defaultCallback:function(response){response||"undefined"==typeof chrome.extension.lastError||console.log("No response. Error: "+chrome.extension.lastError.message)},getNoTextSelectionWebsites:function(){var listWebsitesNoTextSelection=[CCE.TextSelection.base_url,"https://docs.google.com/document/*"];return listWebsitesNoTextSelection},optionsChanged:function(options){CCE.TextSelection.showCaptureInPage=!options.hideCapture,options.hideCapture&&CCE.TextSelection.removeCaptureButtonInPage()},checkForPDF:function(){return!(!$("body").hasClass("citelighterBodyEmbedPDFJS")||0!=$("#citelighterPDFJSInner").length)},insertCaptureButtonInPage:function(_doc){var request={action:"isFastCaptureVisible"};chrome.extension.sendMessage(request,function(response){if((response||"undefined"==typeof chrome.extension.lastError)&&!response.isVisible){var selection=_doc.getSelection(),text=selection.toString();if(CCE.TextSelection.lastSel=text,CCE.TextSelection.removeCaptureButtonInPage(),0!=selection.rangeCount&&!selection.isCollapsed){var offset=CCE.TextSelection.getSelectionCoords(_doc),x=offset.x,y=offset.y,inlineCaptureButton=_doc.createElement("div");inlineCaptureButton.setAttribute("id","CitelighterInPageCapture");var width="148px",height="42px",captureImage=chrome.extension.getURL("images/capturebtn.png"),captureImageHover=chrome.extension.getURL("images/capturebtn_hover.png");inlineCaptureButton.setAttribute("style","cursor: pointer; position: absolute; display: inline; z-index: 2147483640;border:none;width: "+width+";height: "+height+";min-width: "+width+";min-height: "+height+";max-width: "+width+";max-height: "+height+";left: "+x+"px;top: "+y+"px;background: url("+captureImage+")"),""!=_doc.getSelection().toString()&&(_doc.getElementsByTagName("body")[0].appendChild(inlineCaptureButton),$(inlineCaptureButton).on("click",function(){var request={action:"showFastCapture"};chrome.extension.sendMessage(request,CCE.TextSelection.defaultCallback)}),$(inlineCaptureButton).hover(function(){$(inlineCaptureButton).css("background","url("+captureImageHover+")")},function(){$(inlineCaptureButton).css("background","url("+captureImage+")")}))}}})},getSelectionCoords:function(_doc){var range,rects,rect,sel=_doc.selection,x=0,y=0;if(sel)"Control"!=sel.type&&(range=sel.createRange(),range.collapse(!0),x=range.boundingLeft,y=range.boundingTop);else if(_doc.getSelection&&(sel=_doc.getSelection(),sel.rangeCount)){if(range=sel.getRangeAt(0).cloneRange(),range.getClientRects){rects=range.getClientRects(),range.collapse(!0),rects.length>0&&(rect=rects[rects.length-1]);var win_scroll_top=$(_doc).scrollTop();x=rect.right,y=rect.bottom+win_scroll_top-42}if(0==x&&0==y){var span=_doc.createElement("span");if(span.getClientRects){span.appendChild(_doc.createTextNode("​")),range.insertNode(span);var _rects=range.getClientRects(),width=_rects[_rects.length-1].width;rect=span.getClientRects()[0],x=rect.right+width,y=rect.bottom;var spanParent=span.parentNode;spanParent.removeChild(span),spanParent.normalize()}}}return{x:x,y:y}},removeCaptureButtonInPage:function(){var button=document.getElementById("CitelighterInPageCapture");button&&button.parentNode.removeChild(button)},mouseListener:function(e){var excludedTypes=["input","textarea"],type=e.target.tagName.toLowerCase();for(var i in excludedTypes)if(type==excludedTypes[i])return void CCE.TextSelection.removeCaptureButtonInPage();document.addEventListener("mouseup",function(e){CCE.TextSelection.detectSelection(e)},!0)},detectSelection:function(e){var _doc=document,textSel=_doc.getSelection();if("CitelighterInPageCapture"!=e.target.id){var textSel=_doc.getSelection();if(null!=textSel&&"undefined"!=typeof textSel.toString()[0]&&""!=$.trim(textSel.toString())){if(CCE.TextSelection.lastSel=textSel.toString().trim(),!CCE.TextSelection.isLoggedIn||!CCE.TextSelection.showCaptureInPage)return;CCE.TextSelection.insertCaptureButtonInPage(_doc)}else CCE.TextSelection.removeCaptureButtonInPage(),CCE.TextSelection.lastSel=""}},getSelectedText:function(){var textSel=document.getSelection();return null!=textSel&&"undefined"!=typeof textSel.toString()[0]&&""!=$.trim(textSel.toString())?CCE.TextSelection.lastSel=textSel.toString():CCE.TextSelection.lastSel="",CCE.TextSelection.lastSel},initImagesInPageCapture:function(){if(CCE.TextSelection.isLoggedIn&&CCE.TextSelection.showCaptureInPage){var listWebsitesNoTextSelection=CCE.TextSelection.getNoTextSelectionWebsites();for(item in listWebsitesNoTextSelection)if(new RegExp(listWebsitesNoTextSelection[item]).test(window.location.href))return;var doc=document;if(null!=doc&&"undefined"!=typeof doc){var _body=null==doc.body?doc:doc.body;_body.addEventListener("mouseover",function(event){if(("img"==event.target.tagName.toLowerCase()||"canvas"==event.target.tagName.toLowerCase())&&!CCE.ScanImages.elementHasClass(event.target)&&"cl-assignments-edit_assignment-body"!=_body.getAttribute("id")&&"cl-assignments-new_assignment-body"!=_body.getAttribute("id")){var element=event.target,imageWidth="undefined"!=typeof element.clientWidth?element.clientWidth:"undefined"!=typeof element.naturalWidth?element.naturalWidth:0,imageHeight="undefined"!=typeof element.clientHeight?element.clientHeight:"undefined"!=typeof element.naturalHeight?element.naturalHeight:0,imageTitle=""!=$.trim(element.getAttribute("alt"))?$.trim(element.getAttribute("alt")):""!=$.trim(element.getAttribute("title"))?$.trim(element.getAttribute("title")):"",imageUrl=element.src;if(imageWidth>100&&imageHeight>100){if("canvas"==event.target.tagName.toLowerCase()){var image=new Image;image.src=element.toDataURL(),imageUrl=image.src}var positions=CCE.TextSelection.getImageCoords(element,doc),imageDetails={width:imageWidth,height:imageHeight,imageName:imageTitle,source:imageUrl};CCE.TextSelection.insertImageInPageCapture(positions.right,positions.top,imageDetails,doc),element.addEventListener("mouseout",function(evt){setTimeout(function(){CCE.TextSelection.removeImageInPageCapture(doc)},1)},!1)}}},!1)}}},removeImageInPageCapture:function(doc){if("undefined"!=typeof doc&&null!=doc){var button=doc.getElementById("CitelighterInPageCaptureImage");!button||null!=button.getAttribute("data-is-hovering")&&""!=button.getAttribute("data-is-hovering")||button.parentNode.removeChild(button)}},getImageCoords:function(element,doc){var elemRect=element.getBoundingClientRect(),bodyRect=doc.body.getBoundingClientRect(),parentRect=element.parentNode.getBoundingClientRect(),parentHasOverFlowH=element.parentNode.offsetHeight<element.parentNode.scrollHeight,parentHasOverFlowW=element.parentNode.offsetWidth<element.parentNode.scrollWidth;return{top:1==parentHasOverFlowH?parentRect.top-bodyRect.top:elemRect.top-bodyRect.top,right:1==parentHasOverFlowW&&element.width>element.parentNode.clientWidth?parentRect.right:elemRect.right}},insertImageInPageCapture:function(x,y,imageDetails,doc){if(CCE.TextSelection.removeImageInPageCapture(doc),CCE.TextSelection.isLoggedIn&&CCE.TextSelection.showCaptureInPage){var captureImageDivHolder=document.createElement("div");captureImageDivHolder.setAttribute("id","CitelighterInPageCaptureImage");var inPageUrlBg=chrome.extension.getURL("images/icon_citation_white.png"),width=30,height=30,buttonMargin=10;captureImageDivHolder.setAttribute("style","cursor: pointer; position: absolute; display: inline-block; z-index: 2147483640;border: none;background: rgba(35, 31, 32, 0.7) url("+inPageUrlBg+") no-repeat center center;width: "+width+"px;height: "+height+"px;min-width: "+width+"px;min-height: "+height+"px;max-width: "+width+"px;max-height: "+height+"px;left: "+parseInt(x-width-buttonMargin)+"px;top: "+parseInt(y+buttonMargin)+"px;"),captureImageDivHolder.setAttribute("title","Capture Image"),doc.getElementsByTagName("body")[0].appendChild(captureImageDivHolder),captureImageDivHolder.addEventListener("mouseout",function(){CCE.TextSelection.removeImageInPageCapture()}),captureImageDivHolder.addEventListener("click",function(){var request={action:"captureOneImage",image_details:imageDetails};chrome.extension.sendMessage(request,function(response){if(!response&&"undefined"!=typeof chrome.extension.lastError)return void console.log("No response. Error: "+chrome.extension.lastError.message)})},!1),captureImageDivHolder.addEventListener("mouseover",function(){captureImageDivHolder.setAttribute("data-is-hovering",!0)},!1),captureImageDivHolder.addEventListener("mouseout",function(){captureImageDivHolder.removeAttribute("data-is-hovering")},!1)}},initTextSelectionOnDoc:function(){var listWebsitesNoTextSelection=CCE.TextSelection.getNoTextSelectionWebsites();for(item in listWebsitesNoTextSelection)if(new RegExp(listWebsitesNoTextSelection[item]).test(window.location.href))return;document.addEventListener("mousedown",function(e){CCE.TextSelection.mouseListener(e)},!1),document.addEventListener("keyup",function(e){var shiftHeld=e.shiftKey;1==shiftHeld&&(40!=e.keyCode&&38!=e.keyCode&&37!=e.keyCode&&39!=e.keyCode||CCE.TextSelection.detectSelection(e))}),document.addEventListener("dragstart",function(e){CCE.TextSelection.detectSelection(e)})},initialSetup:function(){var isPDFDoc=CCE.TextSelection.checkForPDF();if(isPDFDoc)CCE.TextSelection.isPDFjs=!0;else{CCE.ExtractDetails.initialSetup(),CCE.TextSelection.isPDFjs=!1,CCE.TextSelection.initTextSelectionOnDoc();var request={action:"getStatus"};chrome.extension.sendMessage(request,function(response){return response||"undefined"==typeof chrome.extension.lastError?(CCE.TextSelection.isLoggedIn=response.logged_in,CCE.TextSelection.optionsChanged(response.options),CCE.TextSelection.base_url=response.base_url,void(1==response.isProUser&&CCE.TextSelection.initImagesInPageCapture())):void console.log("No response. Error: "+chrome.extension.lastError.message)}),chrome.extension.onMessage.addListener(function(request,sender,sendResponse){switch(request.action){case"getSelText":var response={text:CCE.TextSelection.lastSel};CCE.TextSelection.removeCaptureButtonInPage(),sendResponse(response);break;case"loginStatus":CCE.TextSelection.isLoggedIn=request.logged_in,sendResponse({success:!0});break;case"optionsChanged":CCE.TextSelection.optionsChanged(request.options),sendResponse({success:!0});break;case"removeInpageCaptureButton":CCE.TextSelection.removeCaptureButtonInPage(),sendResponse({success:!0})}})}}};var CCE=CCE||{};CCE.Toolbar={base_url:null,ExtensionBaseUrl:null,lastSelectedProjectName:null,defaultProjectStyle:2,ToolbarMaxWidth:445,ToolbarMinWidth:120,ToolbarMinHeight:50,ToolbarMenuPanelHeight:445,ToolbarProjectPanelsHeight:290,ToolbarCitationPanelHeight:795,ToolbarDescrptionPanelHeight:750,AuthorsSuggestion:{},OrganizationSuggestion:{},citationTitleSuggestion:{},userDetails:null,citations_loaded:null,project_citations_count:1,outlines_loaded:null,project_elements_count:1,options:null,quicViewExpandedSources:[],quicViewExpandedComments:[],quicViewOutlineExpandedSources:[],webImages:[],totalWebImages:0,defaultCallback:function(response){response||"undefined"==typeof chrome.extension.lastError||console.log("No response. Error: "+chrome.extension.lastError.message)},createProject:function(project_title,project_description){var request={action:"createProject",project_title:project_title,project_description:project_description};chrome.extension.sendMessage(request,CCE.Toolbar.defaultCallback)},showProjectCreateFailed:function(error_message){$("#citelighter-toolbar-iframe .citelighter-create-new-project-panel .citelighter-create-new-prj-inner").find("p.citelighter-danger").length>0&&$("#citelighter-toolbar-iframe .citelighter-create-new-project-panel .citelighter-create-new-prj-inner").find("p.citelighter-danger").text(""),$("#citelighter-toolbar-iframe .citelighter-create-new-project-panel .citelighter-create-new-prj-inner").find("p.citelighter-danger").text(error_message),setTimeout(function(){$("#citelighter-toolbar-iframe .citelighter-create-new-project-panel .citelighter-create-new-prj-inner").find("p.citelighter-danger").text("")},5e3)},createProjectElement:function(text,projectId){var item=document.createElement("li"),link=document.createElement("a"),truncatedTitle=CCE.Toolbar.truncateTitle(text,25);return link.innerText=truncatedTitle,$(link).attr("data-full-title",text),$(link).attr("data-project-id",projectId),item.appendChild(link),item},truncateTitle:function(title,_length){var length="undefined"==typeof _length?42:_length;return!title||title.length<=length?title:title.substr(0,length)+"..."},emptyProjectCreatePanel:function(){$(".citelighter-create-new-project-panel #citelighter-create-new-prj-name").val(""),$(".citelighter-create-new-project-panel #citelighter-create-new-prj-description").val(""),$(".citelighter-new-prj-limit-chars .citelighter-out-off").text("0"),$("#citelighter-toolbar-iframe").removeClass("expanded-delayed citelighter-create-new-project-visible")},selectProject:function(projectName,projectId,isNewProject){if("undefined"!=typeof isNewProject&&1==isNewProject){var first_item=$("projects-list-inside li:first"),item=CCE.Toolbar.createProjectElement(projectName,projectId);$(first_item).after(item),CCE.Toolbar.emptyProjectCreatePanel()}var selectDefaultProject=!projectName;if("undefined"!=typeof projectId&&""!=$.trim(projectId)&&null!=projectId&&0!=projectId&&""!=$.trim(projectName)&&null!=projectName){var prj_to_remove=$("ul.projects-list-inside li a[data-project-id='"+projectId+"']"),project_style_id=CCE.Toolbar.defaultProjectStyle;prj_to_remove.length>0&&(project_style_id="undefined"!=typeof prj_to_remove.data("project-style-id")?prj_to_remove.data("project-style-id"):CCE.Toolbar.defaultProjectStyle,prj_to_remove.parents("li").remove());var project={title:projectName,project_id:projectId,style_id:project_style_id},html=CCE.Toolbar.createOneProjectElement(project);$("ul.projects-list-inside").prepend(html),CCE.Toolbar.lastSelectedProjectName=projectName,$(".citelighter-projects-dropdown .citelighter-selected-project-name").text(CCE.Toolbar.truncateTitle(projectName,22))}else{var message=chrome.i18n.getMessage("selectProject");$(".citelighter-projects-dropdown .citelighter-selected-project-name").text(message)}var defaultProject=null,defaultProjectIsCreate=!1;selectDefaultProject&&(defaultProjectIsCreate||$(defaultProject).click())},createOneProjectElement:function(project){var style_id="undefined"!=typeof project.style_id?project.style_id:CCE.Toolbar.defaultProjectStyle,projectTitle=project.title.replace(/'/g,"&#39;");projectTitle=projectTitle.replace(/"/g,"&#39;");var html=' <li><a href="#" data-project-id="'+project.project_id+'" data-full-title="'+projectTitle+'" data-project-style-id="'+style_id+'">'+CCE.Toolbar.truncateTitle(project.title,37)+"</a></li>";return html},loadProjects:function(projects,offset){"undefined"==typeof offset?$(".citelighter-projects-list .projects-list-inside li").remove():$(".citelighter-projects-list").removeClass("projects-are-loading");var list=$(".citelighter-projects-list .projects-list-inside"),item=null;if(null==projects)$(".citelighter-selected-project-name").html("Select a project");else for(var i in projects){var project=projects[i],item=CCE.Toolbar.createOneProjectElement(project);$(list).append(item)}},optionsChanged:function(options){CCE.Toolbar.options=options},needleRotate:function(start,finalValue,element){element.length>0&&$({deg:start}).animate({deg:finalValue},{duration:500,easing:"linear",queue:!0,step:function(now,fx){element.css({transform:"rotate("+now+"deg)"}),$(".citelighter-credebility-needle").data("needle-final-percetage",now)},complete:function(){element.data("needle-final-percetage",finalValue)}})},setNeedleAnimation:function(toZero){if("undefined"!=typeof toZero)CCE.Toolbar.needleRotate(0,0,$(".citelighter-credebility-needle"));else{var allNeedleElements=$(".citelighter-create-citation-container .citelighter-needle-element"),elementsCount=0,filledElements=0;allNeedleElements.each(function(){$(this).hasClass("citelighter-hide")||$(this).parent().hasClass("citelighter-hide")||$(this).parents(".citelighter-citation-journal").length>0&&$(".citelighter-create-citation-container .citelighter-citation-journal").hasClass("citelighter-hide")||$(this).parents(".citelighter-citation-content-toogle").length>0&&$(this).parents(".citelighter-citation-content-toogle").hasClass("citelighter-hide")||(""==$.trim($(this).val())&&1!=$(this).data("custom-image")||filledElements++,elementsCount++)});var fillPercentage=180*filledElements/elementsCount,startPercentage=null!=$(".citelighter-credebility-needle").data("needle-final-percetage")?$(".citelighter-credebility-needle").data("needle-final-percetage"):0;CCE.Toolbar.needleRotate(startPercentage,fillPercentage,$(".citelighter-credebility-needle"))}},initToogleCitationType:function(){$(".citelighter-create-citation-container #citation-type-dropdown").on("change",function(){CCE.Toolbar.setCitationFieldsVisibility($(this).val())})},setCitationFieldsVisibility:function(value,showImage){if($(".citelighter-citation-scan-image").addClass("citelighter-hide"),$(".citelighter-citation-complete-area").removeClass("citelighter-hide"),$(".citation-comment-buttons").removeClass("citelighter-hide"),$(".citelighter-citation-image-holder").addClass("citelighter-hide"),$(".citelighter-citation-content-toogle").removeClass("citelighter-hide"),"journal_citation"==value){$(".citation-type-website-fields").addClass("citelighter-hide"),$(".citelighter-create-citation-container .citelighter-citation-journal").removeClass("citelighter-hide");var element=$(".citelighter-create-citation-container-form #citation-journal-title");""==$.trim(element.val())?($(".citelighter-create-citation-container-form #citation-volume-number").prop("disabled",!0),$(".citelighter-create-citation-container-form #citation-issue-number").prop("disabled",!0),$(".citelighter-create-citation-container-form #citation-pages").prop("disabled",!0)):($(".citelighter-create-citation-container-form #citation-volume-number").removeAttr("disabled"),$(".citelighter-create-citation-container-form #citation-issue-number").removeAttr("disabled"),$(".citelighter-create-citation-container-form #citation-pages").removeAttr("disabled")),CCE.Toolbar.setNeedleAnimation()}else"website_citation"==value?($(".citation-type-website-fields").removeClass("citelighter-hide"),$(".citelighter-create-citation-container .citelighter-citation-journal").addClass("citelighter-hide"),CCE.Toolbar.setNeedleAnimation()):($(".citation-type-website-fields").removeClass("citelighter-hide"),$(".citelighter-create-citation-container .citelighter-citation-journal").addClass("citelighter-hide"),$(".citelighter-citation-scan-image").removeClass("citelighter-hide"),$(".citelighter-citation-complete-area").addClass("citelighter-hide"),$(".citation-comment-buttons").addClass("citelighter-hide"),CCE.Toolbar.setNeedleAnimation(0),CCE.Toolbar.getScandedImages());"undefined"!=typeof showImage&&($(".citelighter-citation-image-holder").removeClass("citelighter-hide"),$(".citelighter-citation-content-toogle").addClass("citelighter-hide")),CCE.Toolbar.closeDatePicker(),CCE.Toolbar.initDatepicker(value)},getScandedImages:function(){if(0==CCE.Toolbar.webImages.length){var request={action:"scanForImages"};chrome.extension.sendMessage(request,CCE.Toolbar.defaultCallback)}else CCE.Toolbar.populateImages(CCE.Toolbar.webImages)},initBackToScanImages:function(){$("html").on("click.CitelighterChromeExtension",".citelighter-reopen-scan-images span",function(e){if(e.preventDefault(),$(".citelighter-citation-scan-image").removeClass("citelighter-hide"),$(".citelighter-citation-complete-area").addClass("citelighter-hide"),0==$(".citelighter-scaned-images .citeligther-one-image").length){var request={action:"scanForImages"};chrome.extension.sendMessage(request,CCE.Toolbar.defaultCallback)}})},initRescanImageButton:function(){$("html").on("click.CitelighterChromeExtension",".citelighter-citation-rescan",function(e){e.preventDefault();var request={action:"scanForImages"};chrome.extension.sendMessage(request,CCE.Toolbar.defaultCallback)})},populateImages:function(imagesObject){if($(".citelighter-scaned-images").find(".citeligther-one-image").remove(),"object"==typeof imagesObject&&imagesObject.length>0)for(var oneImage in imagesObject){var objectUniqueIndex=oneImage;$(".citelighter-scaned-images").append("<div class='citeligther-one-image' data-unique-index='"+objectUniqueIndex+"'><img src='"+imagesObject[oneImage].source+"' alt='"+imagesObject[oneImage].imageName+"'></div>");var imageLoaded=new Image;imageLoaded.src=imagesObject[oneImage].source,imageLoaded.onerror=function(){$(".citelighter-scaned-images").find(".citeligther-one-image[data-unique-index='"+objectUniqueIndex+"']").remove()}}else $(".citelighter-scaned-images .citeligther-one-imag").remove(),$(".citelighter-scaned-images").append("<div class='citeligther-one-imag'><p class='citelighter-no-images-found'>No images found.</p></div>")},compareAndPopulateWithImageData:function(exifData,dataExtracted,responseStatusCode){var imgSource,imgTitle=exifData.image_title;CCE.Toolbar.checkResponseStatus(responseStatusCode,exifData.source,function(base64Img){imgSource=base64Img,$(".citelighter-citation-image-holder .citelighter-citation-image-inner img").remove(),$(".citelighter-citation-image-holder").removeClass("citelighter-hide"),$(".citelighter-citation-content-toogle").addClass("citelighter-hide"),$(".citelighter-citation-image-holder .citelighter-citation-image-inner").append("<img class='citelighter-needle-element' data-custom-image='true' alt='"+imgTitle+"' src='"+imgSource+"' />"),$(".citelighter-citation-scan-image").addClass("citelighter-hide"),$(".citelighter-citation-complete-area").removeClass("citelighter-hide"),$(".citelighter-create-citation-container-form").scrollTop(0),$(".citelighter-citation-scan-image").addClass("citelighter-hide"),$(".citelighter-citation-complete-area").removeClass("citelighter-hide"),$(".citelighter-create-citation-container-form").scrollTop(0);var comparedParams=dataExtracted||{};"undefined"==typeof comparedParams.details&&(comparedParams.details={}),"undefined"!=typeof exifData.authors&&(comparedParams.details.authors=[],comparedParams.details.authors.push(exifData.authors)),"undefined"!=typeof exifData.publisher&&(comparedParams.details.publisher=exifData.publisher),"undefined"!=typeof exifData.publication_date&&(comparedParams.details.publishdate=exifData.publication_date),"undefined"!=typeof exifData.image_title&&""!=$.trim(exifData.image_title)&&(comparedParams.details.title=exifData.image_title),CCE.Toolbar.pauseVideos(),CCE.Toolbar.setCitationFieldsVisibility("website_citation",!0),CCE.Toolbar.PopulateCitationPanel(comparedParams,!0)})},checkResponseStatus:function(responseStatusCode,url,callback,outputFormat){if(403!=responseStatusCode)callback(url);else{var img=new Image;img.crossOrigin="Anonymous",img.onload=function(){var dataURL,canvas=document.createElement("CANVAS"),ctx=canvas.getContext("2d");canvas.height=this.height,canvas.width=this.width,ctx.drawImage(this,0,0),dataURL=canvas.toDataURL(outputFormat),callback(dataURL),canvas=null},img.src=url}},initSetActiveCitationImage:function(){$("html").on("click.CitelighterChromeExtension",function(e){if($(e.target).hasClass("citeligther-one-image")||$(e.target).parent().hasClass("citeligther-one-image")){e.preventDefault();var imageElement=$(e.target).hasClass("citeligther-one-image")?$(e.target).find("img"):$(e.target),imgSource=imageElement.attr("src");$(".citelighter-citation-scan-image").find(".citeligther-one-image").removeClass("selected"),imageElement.parent().addClass("selected");var imageDetails={source:imgSource,title:imageElement.attr("alt")},request={action:"getScanedImageDetails",image_details:imageDetails};chrome.extension.sendMessage(request,CCE.Toolbar.defaultCallback)}})},initToogleJournalFields:function(){$("html").on("keydown",function(e){if($(e.target).hasClass("citelighter-journal-title-field")){$(e.target);setTimeout(function(){CCE.Toolbar.checkJournalAndTitleFields(!0,!0)},20)}if($(e.target).hasClass("citation-article-title")){$(e.target);setTimeout(function(){CCE.Toolbar.checkJournalAndTitleFields(!0,!0)},20)}})},checkJournalAndTitleFields:function(only_journal,only_article){if("undefined"!=typeof only_article){var citation_title_element=$(".citation-article-title");""==$.trim(citation_title_element.val())?$(".citelighter-create-citation-container-form input[type='text']").not("#citation-article-title").prop("disabled",!0):$(".citelighter-create-citation-container-form input[type='text']").not("#citation-article-title").removeAttr("disabled")}if("undefined"!=typeof only_journal){var journal_element=$(".citelighter-journal-title-field");""==$.trim(journal_element.val())||1==journal_element.prop("disabled")?$(".citelighter-create-citation-container-form .citelighter-journal-field").prop("disabled",!0):$(".citelighter-create-citation-container-form .citelighter-journal-field").removeAttr("disabled")}CCE.Toolbar.setNeedleAnimation()},PopulateCitationPanel:function(params,without_timeout){var populatePanelCallback=function(){$("#citelighter-toolbar-iframe").addClass("citelighter-iframe expanded cl-citation-create-visible expanded-delayed");var cit_body="undefined"!=typeof params.citation_body?$.trim(params.citation_body):"";if($("#CitelighterChromeExtension #citelighter-toolbar-iframe #citation-content").val(cit_body),$("#CitelighterChromeExtension #citelighter-toolbar-iframe #citation-website-url").val(params.crt_url),"undefined"!=typeof params.crt_url&&$.trim(""!=params.crt_url)&&$("#CitelighterChromeExtension #citelighter-toolbar-iframe .citelighter-create-citation-container-form").data("crt_url",params.crt_url),"undefined"!=typeof params.referrer&&$.trim(""!=params.referrer)&&$("#CitelighterChromeExtension #citelighter-toolbar-iframe .citelighter-create-citation-container-form").data("referrer",params.referrer),"undefined"!=typeof params.pdf_source&&1==params.pdf_source&&$("#CitelighterChromeExtension #citelighter-toolbar-iframe .citelighter-create-citation-container-form").data("pdf_source",params.pdf_source),"object"==typeof params.details){if("undefined"!=typeof params.details.organization&&$.trim(""!=params.details.organization)&&$("#CitelighterChromeExtension #citelighter-toolbar-iframe .citelighter-create-citation-container-form").data("organization",params.details.organization),
"undefined"!=typeof params.details.title&&$("#CitelighterChromeExtension #citelighter-toolbar-iframe #citation-article-title").val($.trim(params.details.title)),"undefined"!=typeof params.details.website_title&&$("#CitelighterChromeExtension #citelighter-toolbar-iframe #citation-website-title").val($.trim(params.details.website_title)),"undefined"!=typeof params.details.publishdate&&""!=params.details.publishdate&&null!=params.details.publishdate){var extractedDate=new Date($.trim(params.details.publishdate)),formatedDate=$.datepicker.formatDate("dd-mm-yy",extractedDate);$("#CitelighterChromeExtension #citelighter-toolbar-iframe #citation-pub-date").val(formatedDate)}if("undefined"!=typeof params.details.publisher&&$("#CitelighterChromeExtension #citelighter-toolbar-iframe #citation-pub-sponsor").val($.trim(params.details.publisher)),"undefined"!=typeof params.details.authors&&params.details.authors.length>0){var author_fname=params.details.authors[0].first_name,author_lname=params.details.authors[0].last_name;if($("#CitelighterChromeExtension #citelighter-toolbar-iframe #citation-author-fname").val($.trim(author_fname)),$("#CitelighterChromeExtension #citelighter-toolbar-iframe #citation-author-lname").val($.trim(author_lname)),params.details.authors.length>1)for(var index in params.details.authors)if(index>0){var html=CCE.Toolbar.duplicateOneAuthorObj(params.details.authors[index].first_name,params.details.authors[index].last_name,parseInt(index)+2);$("#CitelighterChromeExtension #citelighter-toolbar-iframe .citelighter-create-citation-container-form .citelighter-citation-create-authors-area").append(html)}}}CCE.Toolbar.checkJournalAndTitleFields(!0,!0),CCE.Toolbar.compactPanel(1500),CCE.Toolbar.setNeedleAnimation(),$("#CitelighterChromeExtension #citelighter-toolbar-iframe .citelighter-create-citation-container-form").scrollTop(0)};CCE.Toolbar.clearCitationPanel(!0),$("#citelighter-toolbar-iframe").removeClass("citelighter-notification-visible cl-menu-dropdown-visible cl-projects-pannel-visible cl-project-description-pannel citelighter-create-new-project-visible"),"undefined"!=typeof without_timeout?setTimeout(function(){$("#citelighter-toolbar-iframe").removeClass("citelighter-notification-visible"),CCE.Toolbar.setToolbarDimension(CCE.Toolbar.ToolbarMaxWidth,CCE.Toolbar.ToolbarCitationPanelHeight,"no-delay",function(){$("#citelighter-toolbar-iframe").addClass("citelighter-iframe expanded cl-citation-create-visible expanded-delayed"),populatePanelCallback()})},800):($("#citelighter-toolbar-iframe").removeClass("citelighter-notification-visible"),CCE.Toolbar.setToolbarDimension(CCE.Toolbar.ToolbarMaxWidth,CCE.Toolbar.ToolbarCitationPanelHeight,"no-delay",function(){$("#citelighter-toolbar-iframe").addClass("citelighter-iframe expanded cl-citation-create-visible expanded-delayed"),populatePanelCallback()}))},createAuthors:function(){var proceed=!1,all_auhtor_inputs=$(".citelighter-citation-create-authors-area input[type='text']");if(all_auhtor_inputs.each(function(index,value){index%2==0&&(proceed=""!=$.trim($(this).val())||""!=$.trim($(all_auhtor_inputs[index+1]).val()))}),0==proceed){$(".citelighter-citation-create-authors-area p.citelighter-danger").length>0&&$(".citelighter-citation-create-authors-area p.citelighter-danger").remove();var message=chrome.i18n.getMessage("authorsError");$(".citelighter-citation-create-authors-area").append('<p class="citelighter-danger">'+message+"</p>"),setTimeout(function(){$(".citelighter-citation-create-authors-area p.citelighter-danger").length>0&&$(".citelighter-citation-create-authors-area p.citelighter-danger").remove()},3e3)}else{var index=$(".citelighter-authors-cloned-containter").length+2,html_to_append=CCE.Toolbar.duplicateOneAuthorObj("","",index);$(".citelighter-citation-create-authors-area").append(html_to_append),CCE.Toolbar.setNeedleAnimation()}},duplicateOneAuthorObj:function(first_name,last_name,index){var auhhor_message=chrome.i18n.getMessage("author"),fname_message=chrome.i18n.getMessage("firstName"),lname_message=chrome.i18n.getMessage("lastName"),fname_placeholder=chrome.i18n.getMessage("authorFirstNamePlaceholder"),lname_placeholder=chrome.i18n.getMessage("authorLastNamePlaceholder"),html='<div class="citelighter-authors-cloned-containter">';return html+='<label for="citation-author-fname-'+index+'" class="citelighter-label-filed citation-author-cloned">'+auhhor_message+index+fname_message+"</label>",html+='<input type="text" name="citation-author-fname-'+index+'" class="citation-author-cloned citelighter-autocomplete-author citation-author-fname citation-author-element citelighter-needle-element" value="'+first_name+'" placeholder="'+fname_placeholder+'" />',html+='<label for="citation-author-lname-'+index+'" class="citelighter-label-filed citation-author-cloned">'+auhhor_message+index+lname_message+"</label>",html+='<input type="text" name="citation-author-lname-'+index+'" class="citation-author-cloned citelighter-autocomplete-author citation-author-lname citation-author-element citelighter-needle-element" value="'+last_name+'" placeholder="'+lname_placeholder+'" />',html+="</div>"},clearCitationPanel:function(remove_disable,removeImage){$("#citelighter-toolbar-iframe .citelighter-create-citation-container-form input[type='text']").val(""),$("#citelighter-toolbar-iframe textarea#citation-content").val(""),$("#citelighter-toolbar-iframe textarea#citation-comment").val(""),$(".citelighter-create-citation-container-form").data("pdf_source",null),$("#citelighter-toolbar-iframe .citelighter-create-citation-container-form .citelighter-authors-cloned-containter").length>0&&$("#citelighter-toolbar-iframe .citelighter-create-citation-container-form .citelighter-authors-cloned-containter").remove(),"undefined"!=typeof removeImage&&1==removeImage&&($(".citelighter-citation-image-holder").find("img").remove(),$(".citelighter-citation-scan-image").addClass("citelighter-hide"),$(".citelighter-citation-complete-area").removeClass("citelighter-hide"),$(".citelighter-citation-image-holder").addClass("citelighter-hide"),$(".citelighter-citation-content-toogle").removeClass("citelighter-hide")),$(".citelighter-create-citation-container-form").removeData("crt_url referrer organization"),"undefined"==typeof remove_disable?$(".citelighter-create-citation-container-form input[type='text']").not("#citation-article-title, .citelighter-journal-field").prop("disabled",!0):$(".citelighter-create-citation-container-form input[type='text']").not("#citation-article-title, .citelighter-journal-field").removeAttr("disabled"),$(".citelighter-create-citation-container-form .citelighter-citation-toogle-content-box").find(".citelighter-arrow-indicator").removeClass("citelighter-caret-black-down"),$(".citelighter-create-citation-container-form .citelighter-citation-toogle-content-box").find(".citelighter-arrow-indicator").addClass("citelighter-caret-black-up"),$(".citelighter-create-citation-container-form #citation-content").removeClass("citelighter-hide"),$(".citelighter-create-citation-container-form .citelighter-comments-label").find(".citelighter-arrow-indicator").removeClass("citelighter-caret-black-down"),$(".citelighter-create-citation-container-form .citelighter-comments-label").find(".citelighter-arrow-indicator").addClass("citelighter-caret-black-up"),$(".citelighter-create-citation-container-form #citation-comment").removeClass("citelighter-hide"),$(".citelighter-create-citation-container-form .citelighter-citation-article-details-toogle").find(".citelighter-arrow-indicator").removeClass("citelighter-caret-black-down"),$(".citelighter-create-citation-container-form .citelighter-citation-article-details-toogle").find(".citelighter-arrow-indicator").addClass("citelighter-caret-black-up"),$(".citelighter-create-citation-container-form .citelighter-citation-article-details").removeClass("citelighter-hide"),CCE.Toolbar.setNeedleAnimation(),CCE.Toolbar.closeDatePicker()},stripTags:function(input,allowed,replaceWith){replaceWith=(replaceWith||"")+"",allowed=(((allowed||"")+"").toLowerCase().match(/<[a-z][a-z0-9]*>/g)||[]).join("");var tags=/<\/?([a-z][a-z0-9]*)\b[^>]*>/gi,commentsAndPhpTags=/<!--[\s\S]*?-->|<\?(?:php)?[\s\S]*?\?>/gi;return input.replace(commentsAndPhpTags,"").replace(tags,function($0,$1){return allowed.indexOf("<"+$1.toLowerCase()+">")>-1?$0:replaceWith?replaceWith:""})},getFormParams:function(){var params={};params.crt_url=$(".citelighter-create-citation-container-form #citation-website-url").val(),params.referrer=$(".citelighter-create-citation-container-form").data("referrer"),params.organization=$(".citelighter-create-citation-container-form").data("organization"),params.pdf_source=$(".citelighter-create-citation-container-form").data("pdf_source"),params.title=CCE.Toolbar.stripTags($(".citelighter-create-citation-container-form #citation-article-title").val()),params.website_title=1==$(".citelighter-create-citation-container-form #citation-website-title").prop("disabled")?"":CCE.Toolbar.stripTags($(".citelighter-create-citation-container-form #citation-website-title").val()),params.url=1==$(".citelighter-create-citation-container-form #citation-website-url").prop("disabled")?"":CCE.Toolbar.stripTags($(".citelighter-create-citation-container-form #citation-website-url").val()),params.publication_date=1==$(".citelighter-create-citation-container-form #citation-pub-date").prop("disabled")?"":CCE.Toolbar.stripTags($(".citelighter-create-citation-container-form #citation-pub-date").val()),params.publisher=1==$(".citelighter-create-citation-container-form #citation-pub-sponsor").prop("disabled")?"":CCE.Toolbar.stripTags($(".citelighter-create-citation-container-form #citation-pub-sponsor").val()),params.citation_body=CCE.Toolbar.stripTags($(".citelighter-create-citation-container-form #citation-content").val()),params.citation_comment=$.trim(""!=$(".citelighter-create-citation-container-form #citation-comment").val())?CCE.Toolbar.stripTags($(".citelighter-create-citation-container-form #citation-comment").val()):null,params.source_type=1,"journal_citation"==$(".citelighter-create-citation-container #citation-type-dropdown").val()&&(params.journal_title=1==$(".citelighter-create-citation-container-form #citation-journal-title").prop("disabled")?"":CCE.Toolbar.stripTags($(".citelighter-create-citation-container-form #citation-journal-title").val()),params.issue_nr=1==$(".citelighter-create-citation-container-form #citation-issue-number").prop("disabled")?"":CCE.Toolbar.stripTags($(".citelighter-create-citation-container-form #citation-issue-number").val()),params.pages=1==$(".citelighter-create-citation-container-form #citation-pages").prop("disabled")?"":CCE.Toolbar.stripTags($(".citelighter-create-citation-container-form #citation-pages").val()),params.volume=1==$(".citelighter-create-citation-container-form #citation-volume-number").prop("disabled")?"":CCE.Toolbar.stripTags($(".citelighter-create-citation-container-form #citation-volume-number").val()),params.source_type=2),"image_citation"==$(".citelighter-create-citation-container #citation-type-dropdown").val()&&(params.image_url=$(".citelighter-citation-image-inner").find("img").attr("src"),params.source_type=3);var authors=new Array,authors_obj={};return authors_obj.first_name=CCE.Toolbar.stripTags($("#citation-author-fname").val()),authors_obj.last_name=CCE.Toolbar.stripTags($("#citation-author-lname").val()),authors.push(authors_obj),$(".citelighter-authors-cloned-containter").length>0&&$(".citelighter-authors-cloned-containter").each(function(index,val){if(""!=$.trim($(this).find(".citation-author-fname").val())||""!=$.trim($(this).find(".citation-author-lname").val())){var authors_obj={};authors_obj.first_name=CCE.Toolbar.stripTags($.trim($(this).find(".citation-author-fname").val())),authors_obj.last_name=CCE.Toolbar.stripTags($.trim($(this).find(".citation-author-lname").val())),authors.push(authors_obj)}}),params.authors=authors,params},saveCitation:function(){$("html").on("click.CitelighterChromeExtension","#citelighter-save-citation-button",function(e){e.preventDefault();var citationType=$("#citation-type-dropdown").val(),error=!1,message="";if(""!=$.trim($(".citelighter-create-citation-container-form #citation-content").val())||"journal_citation"!=citationType&&"website_citation"!=citationType||($(".citelighter-create-citation-container .create-citation-warning p").length>0&&$(".citelighter-create-citation-container .create-citation-warning p").remove(),error=!0,message=chrome.i18n.getMessage("citationEmptyError")),"image_citation"==citationType&&0==$(".citelighter-citation-image-inner img").length&&(error=!0,message=chrome.i18n.getMessage("citationNoImageError")),1==error)return $(".citelighter-create-citation-container .create-citation-warning").append('<p class="citelighter-danger">'+message+"</p>"),$(".citelighter-create-citation-container-form").scrollTop(0),setTimeout(function(){$(".citelighter-create-citation-container .create-citation-warning p").remove()},3e3),!1;var params=CCE.Toolbar.getFormParams(),request={action:"saveCapture",params:params};chrome.extension.sendMessage(request,function(response){return response||"undefined"==typeof chrome.extension.lastError?(CCE.Toolbar.closeDatePicker(),void CCE.Toolbar.clearCitationPanel(!0,!0)):void console.log("No response. Error: "+chrome.extension.lastError.message)})})},loadProjectCitations:function(){var citations=CCE.Toolbar.citations_loaded,style_id="undefined"!=typeof $(".citelighter-projects-list .projects-list-inside li:first-child a").data("project-style-id")?$(".citelighter-projects-list .projects-list-inside li:first-child a").data("project-style-id"):CCE.Toolbar.defaultProjectStyle,format="MLA";switch(style_id){case 1:format="APA";break;case 3:format="Chicago";break;default:format="MLA"}if($(".citelighter-project-quick-view .citelighter-prjqv-pannel-all .citelighter-prjqv-citation-container").html(""),null!=citations&&citations.length>0){var citations_html=CCE.FormatQuickView.formatCitation(citations,format);$(".citelighter-project-quick-view .citelighter-prjqv-pannel-all .citelighter-prjqv-citation-container").append(citations_html),$(".citelighter-bib-change-btn").removeClass("selected"),$(".citelighter-bib-change-btn.citelighter-bib-"+format.toLowerCase()).addClass("selected")}else $(".citelighter-project-quick-view .citelighter-prjqv-pannel-all .citelighter-prjqv-citation-container").append("<p class='citelighter-quickview-no-content'>No citations for this project</p>");$(".citelighter-prjqv-tabs").removeClass("citations-are-loading"),CCE.Toolbar.updateQuickViewSourcesAndComments()},loadProjectElements:function(){var outlines=CCE.Toolbar.outlines_loaded,style_id="undefined"!=typeof $(".citelighter-projects-list .projects-list-inside li:first-child a").data("project-style-id")?$(".citelighter-projects-list .projects-list-inside li:first-child a").data("project-style-id"):CCE.Toolbar.defaultProjectStyle,format="MLA";switch(style_id){case 1:format="APA";break;case 3:format="Chicago";break;default:format="MLA"}if($(".citelighter-project-quick-view .citelighter-prjqv-pannel-outline .citelighter-prjqv-outline-container").html(""),null!=outlines&&outlines.length>0){var outline_html=CCE.FormatQuickView.formatOutline(outlines,format);$(".citelighter-project-quick-view .citelighter-prjqv-pannel-outline .citelighter-prjqv-outline-container").append(outline_html),$(".citelighter-bib-change-btn").removeClass("selected"),$(".citelighter-bib-change-btn.citelighter-bib-"+format.toLowerCase()).addClass("selected")}else $(".citelighter-project-quick-view .citelighter-prjqv-pannel-outline .citelighter-prjqv-outline-container").append("<p class='citelighter-quickview-no-content'>No outlines for this project</p>");$(".citelighter-prjqv-tabs").removeClass("citations-are-loading"),CCE.Toolbar.ToogleAddOfflineCitation("a#citelighter-menu-quick-view"),CCE.Toolbar.updateQuickViewSourcesAndComments(),CCE.Toolbar.checkVideoBeforePlay()},initChangeBibliography:function(){$("html").on("click.CitelighterChromeExtension",function(e){if($(e.target).hasClass("citelighter-bib-change-btn")){e.preventDefault();var that=$(e.target),type=that.data("show-type");for(var citation in CCE.Toolbar.citations_loaded){var formated_source="<p>"+CCE.FormatQuickView.formatOneCitationSource(CCE.Toolbar.citations_loaded[citation],type)+"</p>";$(".citelighter-prjqv-pannel-all .citelighter-prjqv-citation[data-citation-id='"+CCE.Toolbar.citations_loaded[citation].citation_id+"']").find(".citelighter-citations-source-content").html(formated_source)}for(var outline in CCE.Toolbar.outlines_loaded)if("undefined"!=typeof CCE.Toolbar.outlines_loaded[outline].citation_id&&null!=CCE.Toolbar.outlines_loaded[outline].citation_id){var citation_info=CCE.Toolbar.outlines_loaded[outline].citation_info,formated_source="<p>"+CCE.FormatQuickView.formatOneCitationSource(citation_info,type)+"</p>";$(".citelighter-prjqv-pannel-outline .citelighter-prjqv-citation[data-citation-id='"+CCE.Toolbar.outlines_loaded[outline].citation_id+"']").find(".citelighter-citations-source-content").html(formated_source)}$(".citelighter-project-quick-view").find(".citelighter-bib-change-btn").removeClass("selected"),$(".citelighter-project-quick-view").find(".citelighter-bib-change-btn[data-show-type='"+type+"']").addClass("selected")}})},ToogleAddOfflineCitation:function(selector){var _that=selector;if($(_that).parents("#citelighter-toolbar-iframe").hasClass("expanded")&&!$(_that).parents("#citelighter-toolbar-iframe").hasClass("cl-project-description-pannel")){$(_that).parents("#citelighter-toolbar-iframe").addClass("cl-project-description-pannel expanded-delayed"),$(_that).parents("#citelighter-toolbar-iframe").removeClass("cl-menu-dropdown-visible"),($(_that).parents("#citelighter-toolbar-iframe").hasClass("cl-projects-pannel-visible")||$(_that).parents("#citelighter-toolbar-iframe").hasClass("cl-menu-dropdown-visible")||$(_that).parents("#citelighter-toolbar-iframe").hasClass("cl-citation-create-visible"))&&($(_that).parents("#citelighter-toolbar-iframe").addClass("expanded-menu-delay"),$(_that).parents("#citelighter-toolbar-iframe").removeClass("cl-menu-dropdown-visible cl-projects-pannel-visible cl-citation-create-visible"));var project_title=$(".citelighter-selected-project-name").text();$(".citelighter-prjqv-header-box h2 span").text(project_title)}},setToolbarDimension:function(width,height,citelighter_iframe_class,callback){try{var citelighter_iframe=$("#CitelighterChromeExtension");if(citelighter_iframe.length>0){citelighter_iframe.css("width",width+"px"),"undefined"!=typeof citelighter_iframe_class&&(citelighter_iframe.removeAttr("class"),citelighter_iframe.attr("class",citelighter_iframe_class));var height_to_set=height,iframe_offset_top=parseInt($("#CitelighterChromeExtension").css("top"),10),window_height=$(window).height();window_height-iframe_offset_top<height&&window_height-iframe_offset_top>=0&&(height_to_set=parseInt(window_height-iframe_offset_top)),citelighter_iframe.css("height",height_to_set+"px")}"function"==typeof callback&&callback()}catch(e){}},authorAutocomplete:function(){var term="";$(".citelighter-autocomplete-author").autocomplete({source:function(request,response){if(term!=request.term){var request={action:"getAuthorsAutocomplete",term:request.term,max_results:5};chrome.extension.sendMessage(request,function(res){return res||"undefined"==typeof chrome.extension.lastError?void("object"==typeof CCE.Toolbar.AuthorsSuggestion&&CCE.Toolbar.AuthorsSuggestion.length>0&&response($.map(CCE.Toolbar.AuthorsSuggestion,function(item){return{label:item.first_name+" "+item.last_name,value:item.author_id,organization_id:item.organization_id,first_name:item.first_name,last_name:item.last_name,organization_name:item.organization_name}}))):void console.log("No response. Error: "+chrome.extension.lastError.message)})}},select:function(event,ui){var id=$(this).attr("name"),id_arr=id.split("-"),single_id=id_arr[id_arr.length-1];return $("input[name=citation-author-fname-"+single_id+"]").val(ui.item.first_name),$("input[name=citation-author-lname-"+single_id+"]").val(ui.item.last_name),$("input[name=citation-pub-sponsor]").val(ui.item.organization_name),!1},appendTo:".citelighter-citation-create-authors-area"})},organizationAutocomplete:function(){var term="";$("#citation-pub-sponsor").autocomplete({source:function(request,response){if(term!=request.term){var request={action:"getOrganizationAutocomplete",term:request.term,max_results:5};chrome.extension.sendMessage(request,function(res){return res||"undefined"==typeof chrome.extension.lastError?void("object"==typeof CCE.Toolbar.OrganizationSuggestion&&CCE.Toolbar.OrganizationSuggestion.length>0&&response($.map(CCE.Toolbar.OrganizationSuggestion,function(item){return{label:item.sname+" - "+item.spublisher,value:item.source_id}}))):void console.log("No response. Error: "+chrome.extension.lastError.message)})}},select:function(event,ui){return $("input[name=citation-pub-sponsor]").val(ui.item.label),!1},appendTo:".citation-pub-sponsor-suggestion"})},initCitationTitleAutocomplete:function(){var term="";$("#citation-article-title").autocomplete({source:function(request,response){if(term!=request.term){var request={action:"getCitationTitleAutocomplete",term:request.term,max_results:5};chrome.extension.sendMessage(request,function(res){return res||"undefined"==typeof chrome.extension.lastError?void("object"==typeof CCE.Toolbar.citationTitleSuggestion&&CCE.Toolbar.citationTitleSuggestion.length>0&&response($.map(CCE.Toolbar.citationTitleSuggestion,function(item){return{label:item.citation_title,value:item.citation_id,link:item.link,website_title:item.name,publication:item.publication,publication_date:item.publication_date,volume:item.volume,pages:item.pages,issue_number:item.issue_number,authors:item.authors}}))):void console.log("No response. Error: "+chrome.extension.lastError.message)})}},select:function(event,ui){if(CCE.Toolbar.clearCitationPanel(),$("input[name=citation-article-title]").val(ui.item.label),$("input[name=citation-website-url]").val(ui.item.link),$("input[name=citation-website-title]").val(ui.item.website_title),$("#CitelighterChromeExtension input[name=citation-pub-date]").val(ui.item.publication_date),$("input[name=citation-pub-sponsor]").val(ui.item.publication),$("input[name=citation-volume-number]").val(ui.item.volume),$("input[name=citation-issue-number]").val(ui.item.pages),$("input[name=citation-pages]").val(ui.item.issue_number),CCE.Toolbar.checkJournalAndTitleFields(!0,!0),"object"==typeof ui.item.authors){var author_fname=ui.item.authors[0].first_name,author_lname=ui.item.authors[0].last_name;if($("#citation-author-fname").val(author_fname),$("#citation-author-lname").val(author_lname),Object.keys(ui.item.authors).length>1)for(var index in ui.item.authors)if(index>0){var html=CCE.Toolbar.duplicateOneAuthorObj(ui.item.authors[index].first_name,ui.item.authors[index].last_name,parseInt(index)+1);$(".citelighter-create-citation-container-form .citelighter-citation-create-authors-area").append(html)}}return!1},appendTo:".citation-article-title-suggestion"})},initDatepicker:function(type){if($("#CitelighterChromeExtension #citation-pub-date").length>0){$("#CitelighterChromeExtension #citation-pub-date").hasClass("hasDatepicker")&&$("#CitelighterChromeExtension #citation-pub-date").datepicker("destroy"),$("#CitelighterChromeExtension #citation-pub-date").not(".hasDatePicker").datepicker({dateFormat:"dd-mm-yy",showButtonPanel:!1,maxDate:new Date,minDate:new Date(1900,0,1),yearRange:"1900:"+Date("Y"),constrainInput:!1,beforeShow:function(input,inst){$(input).attr("placeholder","DDMMYYYY")},onClose:function(dateText,inst){var message=chrome.i18n.getMessage("pubDatePlaceholder");$("#CitelighterChromeExtension #citation-pub-date").attr("placeholder",message);var that=$("#CitelighterChromeExtension #citation-pub-date");CCE.Toolbar.validateDate(that)}}),$("#CitelighterChromeExtension #citation-pub-date").not(".hasDatePicker").on("blur",function(){if(!$("#CitelighterChromeExtension #citation-pub-date").not(".hasDatePicker").datepicker("widget").is(":visible")){var that=$("#CitelighterChromeExtension #citation-pub-date");CCE.Toolbar.validateDate(that)}});var dateAdded=$("#CitelighterChromeExtension #citation-pub-date").not(".hasDatePicker").val();if(""!=$.trim(dateAdded)){var parsedDate=Date.parse(dateAdded);isNaN(parsedDate)||$("#CitelighterChromeExtension #citation-pub-date").not(".hasDatePicker").datepicker("setDate",parsedDate)}}},validateDate:function(that){if(that.val().length>8){var dateformat=/^(0?[1-9]|[12][0-9]|3[01])[\/\-](0?[1-9]|1[012])[\/\-]\d{4}$/,today=new Date;if(that.val().match(dateformat)){var firstFormat=that.val().split("/"),secondFormat=that.val().split("-");if(firstFormatLength=firstFormat.length,secondFormatLength=secondFormat.length,firstFormatLength>1)var pdate=that.val().split("/");else if(secondFormatLength>1)var pdate=that.val().split("-");var dd=parseInt(pdate[0]),mm=parseInt(pdate[1]),yy=parseInt(pdate[2]),ListofDays=[31,28,31,30,31,30,31,31,30,31,30,31];if((1==mm||mm>2)&&dd>ListofDays[mm-1])return void that.datepicker("setDate",today);if(2==mm){var lyear=!1;if((yy%4||!(yy%100))&&yy%400||(lyear=!0),0==lyear&&dd>=29)return void that.datepicker("setDate",today);if(1==lyear&&dd>29)return void that.datepicker("setDate",today)}var _parsedDate=new Date(yy,mm-1,dd);that.datepicker("setDate",_parsedDate)}else that.datepicker("setDate",today)}else if(8==that.val().length){var dateStr=that.val(),_year=dateStr.substr(4,4),_month=parseInt(dateStr.substr(2,2))-1,_day=dateStr.substr(0,2),_parsedDate=new Date(_year,_month,_day);that.datepicker("setDate",_parsedDate)}else if(that.val().length<8&&""!=that.val()){var dateToSet=new Date;that.datepicker("setDate",dateToSet)}},setUserDetails:function(details){if(CCE.Toolbar.userDetails=details,"object"==typeof details){var image_src=chrome.extension.getURL("images/icon_login.png");"undefined"!=typeof details.profile_pic&&""!=$.trim(details.profile_pic)&&0!=details.profile_pic&&(image_src=details.profile_pic);var message=chrome.i18n.getMessage("logoutButton"),append_html="<img src='"+image_src+"'>",appended_text=message+details.first_name+" "+details.last_name;appended_text=CCE.Toolbar.truncateTitle(appended_text,18),append_html+=appended_text,$(".citelighter-menu-dropdown-list #citelighter-menu-logout").html(append_html)}},closeQuickViewPanel:function(){$("#citelighter-toolbar-iframe").hasClass("cl-project-description-pannel")&&$(".citelighter-project-quick-view a.citelighter-close-project-quick-view").trigger("click"),CCE.Toolbar.project_citations_count=0,CCE.Toolbar.citations_loaded=null,CCE.Toolbar.project_elements_count=0,CCE.Toolbar.outlines_loaded=null,CCE.Toolbar.quicViewExpandedSources=[],CCE.Toolbar.quicViewExpandedComments=[],CCE.Toolbar.quicViewOutlineExpandedSources=[],$(".citelighter-project-quick-view .citelighter-prjqv-outline-container").html(""),$(".citelighter-project-quick-view .citelighter-prjqv-pannel-all .citelighter-prjqv-citation-container").html("")},initCloseNoticationPanel:function(){$("html").on("click.CitelighterChromeExtension","#citelighter-notification-panel-inner span.citelighter-notification-close",function(e){e.preventDefault(),$("#citelighter-toolbar-iframe").removeClass("citelighter-notification-visible"),setTimeout(function(){$("#citelighter-toolbar-iframe #citelighter-notification-panel").addClass("citelighter-notification-on")},500)})},setStatus:function(error_message,without_timeout){CCE.Toolbar.pauseVideos(),CCE.Toolbar.closeDatePicker();var toolbar_iframe=$("#citelighter-toolbar-iframe"),wait=!1,waitMore=!1;(toolbar_iframe.hasClass("cl-citation-create-visible")||toolbar_iframe.hasClass("cl-projects-pannel-visible")||toolbar_iframe.hasClass("cl-menu-dropdown-visible")||toolbar_iframe.hasClass("cl-project-description-pannel")||toolbar_iframe.hasClass("citelighter-create-new-project-visible"))&&(wait=!0),$("#citelighter-toolbar-iframe .citelighter-menu-left").addClass("citelighter-iframe-toogle-on"),$("#citelighter-toolbar-iframe").hasClass("expanded")||(waitMore=!0,$("#citelighter-toolbar-iframe").addClass("expanded")),$("#citelighter-toolbar-iframe").removeClass("cl-projects-pannel-visible cl-citation-create-visible cl-project-description-pannel citelighter-create-new-project-visible cl-menu-dropdown-visible");var textbox=$("#citelighter-notification-panel-inner");textbox.find("p").remove(),textbox.append("<p class='citelighter-notification'></p>");var textboxVal=CCE.Toolbar.truncateTitle(error_message,50);$(textbox).find("p").text(textboxVal),1==wait?setTimeout(function(){CCE.Toolbar.setToolbarDimension(CCE.Toolbar.ToolbarMaxWidth,CCE.Toolbar.ToolbarMinHeight,"no-delay",function(){$("#citelighter-toolbar-iframe").addClass("citelighter-notification-visible"),CCE.Toolbar.addNotficationPanelClass()})},500):CCE.Toolbar.setToolbarDimension(CCE.Toolbar.ToolbarMaxWidth,CCE.Toolbar.ToolbarMinHeight,"no-delay",function(){1==waitMore?setTimeout(function(){$("#citelighter-toolbar-iframe").addClass("citelighter-notification-visible"),CCE.Toolbar.addNotficationPanelClass()},500):($("#citelighter-toolbar-iframe").addClass("citelighter-notification-visible"),CCE.Toolbar.addNotficationPanelClass())}),"undefined"==typeof without_timeout&&setTimeout(function(){$("#citelighter-toolbar-iframe").removeClass("citelighter-notification-visible"),setTimeout(function(){$("#citelighter-toolbar-iframe #citelighter-notification-panel").removeClass("citelighter-notification-on")},500)},5e3)},addNotficationPanelClass:function(){$("#citelighter-toolbar-iframe #citelighter-notification-panel").addClass("citelighter-notification-on")},closeCitationPannel:function(){var message=chrome.i18n.getMessage("citationSaving");CCE.Toolbar.setStatus(message,!0)},initToolbarExpand:function(){$("html").on("click.CitelighterChromeExtension","#citelighter-toolbar-iframe .citelighter-menu-left",function(e){e.preventDefault(),$("#citelighter-toolbar-iframe #citelighter-notification-panel").removeClass("citelighter-notification-on");var that=$("#citelighter-toolbar-iframe .citelighter-menu-left"),toolbar_height=CCE.Toolbar.ToolbarMinHeight;if(CCE.Toolbar.pauseVideos(),CCE.Toolbar.closeDatePicker(),that.hasClass("citelighter-iframe-toogle-on")){$(".citelighter-toolbar-main-menu a.citelighter-logo, .citelighter-toolbar-main-menu a.citelighter-expand-button").attr("title","Expand");var delay_class="delay-half-second";that.parents("#citelighter-toolbar-iframe").hasClass("expanded-delayed")&&(delay_class="delay-one-second"),that.parents("#citelighter-toolbar-iframe").removeClass("expanded expanded-menu-delay"),that.removeClass("citelighter-iframe-toogle-on"),CCE.Toolbar.setToolbarDimension(CCE.Toolbar.ToolbarMinWidth,CCE.Toolbar.ToolbarMinHeight,delay_class,function(){})}else $(".citelighter-toolbar-main-menu a.citelighter-logo, .citelighter-toolbar-main-menu a.citelighter-expand-button").attr("title","Collapse"),$("#citelighter-toolbar-iframe").hasClass("cl-menu-dropdown-visible")?toolbar_height=CCE.Toolbar.ToolbarMenuPanelHeight:$("#citelighter-toolbar-iframe").hasClass("cl-citation-create-visible")?toolbar_height=CCE.Toolbar.ToolbarCitationPanelHeight:$("#citelighter-toolbar-iframe").hasClass("cl-projects-pannel-visible")?toolbar_height=CCE.Toolbar.ToolbarProjectPanelsHeight:$("#citelighter-toolbar-iframe").hasClass("cl-project-description-pannel")?toolbar_height=CCE.Toolbar.ToolbarDescrptionPanelHeight:$("#citelighter-toolbar-iframe").hasClass("citelighter-create-new-project-visible")&&(toolbar_height=CCE.Toolbar.ToolbarMenuPanelHeight),CCE.Toolbar.setToolbarDimension(CCE.Toolbar.ToolbarMaxWidth,toolbar_height,"no-delay",function(){that.parents("#citelighter-toolbar-iframe").addClass("expanded"),that.addClass("citelighter-iframe-toogle-on"),(that.parents("#citelighter-toolbar-iframe").hasClass("cl-menu-dropdown-visible")||that.parents("#citelighter-toolbar-iframe").hasClass("cl-citation-create-visible")||that.parents("#citelighter-toolbar-iframe").hasClass("cl-projects-pannel-visible")||that.parents("#citelighter-toolbar-iframe").hasClass("cl-project-description-pannel")||that.parents("#citelighter-toolbar-iframe").hasClass("citelighter-create-new-project-visible"))&&that.parents("#citelighter-toolbar-iframe").addClass("expanded-menu-delay"),
CCE.Toolbar.compactPanel(1500)})})},initMenuExpand:function(){$("html").on("click.CitelighterChromeExtension",".citelighter-menu-burger a",function(e){e.preventDefault();var that=$(this);if($("#citelighter-toolbar-iframe #citelighter-notification-panel").removeClass("citelighter-notification-on"),CCE.Toolbar.pauseVideos(),CCE.Toolbar.closeDatePicker(),that.parents("#citelighter-toolbar-iframe").hasClass("expanded"))if(that.parents("#citelighter-toolbar-iframe").hasClass("cl-menu-dropdown-visible"))CCE.Toolbar.setToolbarDimension(CCE.Toolbar.ToolbarMaxWidth,CCE.Toolbar.ToolbarMinHeight,"delay-half-second",function(){that.parents("#citelighter-toolbar-iframe").removeClass("cl-menu-dropdown-visible expanded-delayed expanded-menu-delay")}),CCE.Toolbar.compactPanel(1e3);else{var delay_class="no-delay";that.parents("#citelighter-toolbar-iframe").height()-CCE.Toolbar.ToolbarMinHeight>CCE.Toolbar.ToolbarMenuPanelHeight&&(delay_class="delay-one-second"),CCE.Toolbar.setToolbarDimension(CCE.Toolbar.ToolbarMaxWidth,CCE.Toolbar.ToolbarMenuPanelHeight,delay_class,function(){that.parents("#citelighter-toolbar-iframe").addClass("cl-menu-dropdown-visible expanded-delayed"),(that.parents("#citelighter-toolbar-iframe").hasClass("cl-citation-create-visible")||that.parents("#citelighter-toolbar-iframe").hasClass("cl-projects-pannel-visible")||that.parents("#citelighter-toolbar-iframe").hasClass("cl-project-description-pannel")||that.parents("#citelighter-toolbar-iframe").hasClass("citelighter-create-new-project-visible"))&&(that.parents("#citelighter-toolbar-iframe").addClass("expanded-menu-delay"),that.parents("#citelighter-toolbar-iframe").removeClass("cl-projects-pannel-visible cl-citation-create-visible cl-project-description-pannel citelighter-create-new-project-visible")),CCE.Toolbar.compactPanel(1e3)})}})},initProjectSelectorExpand:function(){$("html").on("click.CitelighterChromeExtension","a.citelighter-selected-project",function(e){e.preventDefault();var that=$(this);if($("#citelighter-toolbar-iframe #citelighter-notification-panel").removeClass("citelighter-notification-on"),CCE.Toolbar.pauseVideos(),CCE.Toolbar.closeDatePicker(),that.parents("#citelighter-toolbar-iframe").hasClass("expanded"))if(that.parents("#citelighter-toolbar-iframe").hasClass("cl-projects-pannel-visible"))CCE.Toolbar.setToolbarDimension(CCE.Toolbar.ToolbarMaxWidth,CCE.Toolbar.ToolbarMinHeight,"delay-half-second",function(){that.parents("#citelighter-toolbar-iframe").removeClass("cl-projects-pannel-visible expanded-delayed expanded-menu-delay")});else{var delay_class="no-delay";that.parents("#citelighter-toolbar-iframe").height()-CCE.Toolbar.ToolbarMinHeight>CCE.Toolbar.ToolbarProjectPanelsHeight&&(delay_class="delay-one-second"),CCE.Toolbar.setToolbarDimension(CCE.Toolbar.ToolbarMaxWidth,CCE.Toolbar.ToolbarProjectPanelsHeight,delay_class,function(){that.parents("#citelighter-toolbar-iframe").addClass("cl-projects-pannel-visible expanded-delayed"),(that.parents("#citelighter-toolbar-iframe").hasClass("cl-citation-create-visible")||that.parents("#citelighter-toolbar-iframe").hasClass("cl-menu-dropdown-visible")||that.parents("#citelighter-toolbar-iframe").hasClass("cl-project-description-pannel")||that.parents("#citelighter-toolbar-iframe").hasClass("citelighter-create-new-project-visible"))&&(that.parents("#citelighter-toolbar-iframe").addClass("expanded-menu-delay"),that.parents("#citelighter-toolbar-iframe").removeClass("cl-menu-dropdown-visible cl-citation-create-visible cl-project-description-pannel citelighter-create-new-project-visible")),CCE.Toolbar.compactPanel(1e3)})}})},initCaptureButton:function(){$("html").on("click.CitelighterChromeExtension","a.citelighter-create-citation-btn",function(e){$("#citelighter-toolbar-iframe #citelighter-notification-panel").removeClass("citelighter-notification-on"),$(".citelighter-citation-scan-image").addClass("citelighter-hide"),$(".citelighter-citation-complete-area").removeClass("citelighter-hide"),$(".citelighter-create-citation-container-form").scrollTop(0),e.preventDefault();var request={action:"showFastCapture"};CCE.Toolbar.setToolbarDimension(CCE.Toolbar.ToolbarMaxWidth,CCE.Toolbar.ToolbarCitationPanelHeight,"no-delay",function(){CCE.Toolbar.pauseVideos(),CCE.Toolbar.closeDatePicker(),chrome.extension.sendMessage(request,CCE.Toolbar.defaultCallback)})})},initOfflineCitationButton:function(){$("html").on("click.CitelighterChromeExtension","a#citelighter-menu-offline-citation",function(e){e.preventDefault();var that=$(this),request={action:"getCurrentProjectId"};chrome.extension.sendMessage(request,function(response){if(!response&&"undefined"!=typeof chrome.extension.lastError)return void console.log("No response. Error: "+chrome.extension.lastError.message);var project_id=response.project_id;if(null!=project_id&&0!=project_id&&""!=project_id){if(CCE.Toolbar.clearCitationPanel(),CCE.Toolbar.initDatepicker("journal_citation"),that.parents("#citelighter-toolbar-iframe").hasClass("expanded"))if(that.parents("#citelighter-toolbar-iframe").hasClass("cl-citation-create-visible"))CCE.Toolbar.setToolbarDimension(CCE.Toolbar.ToolbarMaxWidth,CCE.Toolbar.ToolbarMinHeight,"delay-half-second",function(){that.parents("#citelighter-toolbar-iframe").removeClass("cl-citation-create-visible expanded-delayed expanded-menu-delay")});else{var delay_class="no-delay";$(".citelighter-create-citation-container .citelighter-citation-journal").removeClass("citelighter-hide"),$(".citelighter-create-citation-container #citation-type-dropdown").val("journal_citation"),CCE.Toolbar.setToolbarDimension(CCE.Toolbar.ToolbarMaxWidth,CCE.Toolbar.ToolbarCitationPanelHeight,delay_class,function(){that.parents("#citelighter-toolbar-iframe").addClass("cl-citation-create-visible expanded-delayed"),(that.parents("#citelighter-toolbar-iframe").hasClass("cl-projects-pannel-visible")||that.parents("#citelighter-toolbar-iframe").hasClass("cl-menu-dropdown-visible")||that.parents("#citelighter-toolbar-iframe").hasClass("cl-project-description-pannel")||that.parents("#citelighter-toolbar-iframe").hasClass("citelighter-create-new-project-visible"))&&(that.parents("#citelighter-toolbar-iframe").removeClass("cl-menu-dropdown-visible cl-projects-pannel-visible cl-project-description-pannel citelighter-create-new-project-visible"),that.parents("#citelighter-toolbar-iframe").addClass("expanded-menu-delay"),CCE.Toolbar.clearCitationPanel(!0,!0),CCE.Toolbar.checkJournalAndTitleFields(!0,!0),CCE.Toolbar.setCitationFieldsVisibility("journal_citation")),CCE.Toolbar.compactPanel(1e3)})}}else{var message=chrome.i18n.getMessage("projectNotSelected");CCE.Toolbar.setStatus(message)}})})},showAddOflineCitation:function(){CCE.Toolbar.clearCitationPanel(!0,!0),CCE.Toolbar.initDatepicker("journal_citation"),$(".citelighter-create-citation-container .citelighter-citation-journal").removeClass("citelighter-hide"),$(".citelighter-create-citation-container #citation-type-dropdown").val("journal_citation"),$("#citelighter-toolbar-iframe").addClass("cl-citation-create-visible expanded-delayed"),CCE.Toolbar.setToolbarDimension(CCE.Toolbar.ToolbarMaxWidth,CCE.Toolbar.ToolbarCitationPanelHeight,"no-delay",function(){($("#citelighter-toolbar-iframe").hasClass("cl-projects-pannel-visible")||$("#citelighter-toolbar-iframe").hasClass("cl-menu-dropdown-visible")||$("#citelighter-toolbar-iframe").hasClass("cl-project-description-pannel")||$("#citelighter-toolbar-iframe").hasClass("citelighter-create-new-project-visible"))&&($("#citelighter-toolbar-iframe").removeClass("cl-menu-dropdown-visible cl-projects-pannel-visible cl-project-description-pannel citelighter-create-new-project-visible"),$("#citelighter-toolbar-iframe").addClass("expanded-menu-delay")),CCE.Toolbar.compactPanel(1e3),CCE.Toolbar.checkJournalAndTitleFields(!0,!0),CCE.Toolbar.setCitationFieldsVisibility("journal_citation"),$(".citelighter-create-citation-container-form").scrollTop(0)})},initQuickViewPanelToogle:function(){$("html").on("click.CitelighterChromeExtension","#citelighter-menu-quick-view",function(e){e.preventDefault();var delay_class="no-delay";$(".citelighter-prjqv-tabs-list").find("a").removeClass("citelighter-tab-disabled"),$(".citelighter-prjqv-tabs-list").find("a.citelighter-prjqv-tab-all").addClass("citelighter-tab-disabled"),$(".citelighter-prjqv-pannel-outline").removeClass("citelighter-hide"),$(".citelighter-prjqv-pannel-all").addClass("citelighter-hide"),CCE.Toolbar.setToolbarDimension(CCE.Toolbar.ToolbarMaxWidth,CCE.Toolbar.ToolbarDescrptionPanelHeight,delay_class,function(){if(null==CCE.Toolbar.outlines_loaded){$(".citelighter-prjqv-outline-container").scrollTop(0);var request={action:"getProjectOutlines"};chrome.extension.sendMessage(request,function(response){if(!response&&"undefined"!=typeof chrome.extension.lastError)return void console.log("No response. Error: "+chrome.extension.lastError.message)})}else CCE.Toolbar.loadProjectElements();CCE.Toolbar.pauseVideos()})})},initCloseQuickPanel:function(){$("html").on("click.CitelighterChromeExtension",".citelighter-project-quick-view a.citelighter-close-project-quick-view",function(e){e.preventDefault();var that=$(this);CCE.Toolbar.setToolbarDimension(CCE.Toolbar.ToolbarMaxWidth,CCE.Toolbar.ToolbarMinHeight,"delay-one-second",function(){that.parents("#citelighter-toolbar-iframe").removeClass("cl-project-description-pannel expanded-delayed expanded-menu-delay"),CCE.Toolbar.pauseVideos()})})},initQuickViewTabSwitch:function(){$("html").on("click.CitelighterChromeExtension",".citelighter-project-quick-view .citelighter-prjqv-tabs-list a",function(e){e.preventDefault(),$(this).parents(".citelighter-prjqv-tabs-list").find("a").addClass("citelighter-tab-disabled"),$(this).removeClass("citelighter-tab-disabled"),$(this).hasClass("citelighter-prjqv-tab-outline")?($(this).parents(".citelighter-project-quick-view").find(".citelighter-prjqv-pannel-outline").removeClass("citelighter-hide"),$(this).parents(".citelighter-project-quick-view").find(".citelighter-prjqv-pannel-all").addClass("citelighter-hide")):($(this).parents(".citelighter-project-quick-view").find(".citelighter-prjqv-pannel-outline").addClass("citelighter-hide"),$(this).parents(".citelighter-project-quick-view").find(".citelighter-prjqv-pannel-all").removeClass("citelighter-hide")),CCE.Toolbar.pauseVideos()})},initLoadProjectCitations:function(){$("html").on("click.CitelighterChromeExtension",function(e){if($(e.target).hasClass("citelighter-prjqv-tab-all"))if(null==CCE.Toolbar.citations_loaded){$(".citelighter-prjqv-citation-container").scrollTop(0),e.preventDefault();var request={action:"getProjectCitations"};chrome.extension.sendMessage(request,function(response){if(!response&&"undefined"!=typeof chrome.extension.lastError)return void console.log("No response. Error: "+chrome.extension.lastError.message)})}else e.preventDefault(),CCE.Toolbar.loadProjectCitations()})},initQuickViewSourceToogle:function(){$("html").on("click.CitelighterChromeExtension",function(e){if($(e.target).hasClass("citelighter-prjqv-source")){e.preventDefault();var cit_id=$(e.target).parents(".citelighter-prjqv-citation").data("citation-id");if($(e.target).parents(".citelighter-prjqv-citation").find(".citelighter-citations-comments-content").length>0){$(e.target).parents(".citelighter-prjqv-citation").find(".citelighter-citations-comments-content").addClass("citelighter-hide"),$(e.target).parents(".citelighter-prjqv-citation").find(".citelighter-prjqv-comments span").removeClass("citelighter-caret-down"),$(e.target).parents(".citelighter-prjqv-citation").find(".citelighter-prjqv-comments span").addClass("citelighter-caret");var index=CCE.Toolbar.quicViewExpandedComments.indexOf(cit_id);index>-1&&CCE.Toolbar.quicViewExpandedComments.splice(index,1)}if($(e.target).parents(".citelighter-prjqv-citation").find(".citelighter-citations-source-content").length>0)if($(e.target).parents(".citelighter-prjqv-citation").find(".citelighter-citations-source-content").hasClass("citelighter-hide"))$(e.target).parents(".citelighter-prjqv-citation").find(".citelighter-citations-source-content").removeClass("citelighter-hide"),$(e.target).find("span").removeClass("citelighter-caret"),$(e.target).find("span").addClass("citelighter-caret-down"),$(e.target).parents(".citelighter-prjqv-citation-container").length>0?CCE.Toolbar.quicViewExpandedSources.push(cit_id):CCE.Toolbar.quicViewOutlineExpandedSources.push(cit_id);else{if($(e.target).parents(".citelighter-prjqv-citation-container").length>0){var index=CCE.Toolbar.quicViewExpandedSources.indexOf(cit_id);index>-1&&CCE.Toolbar.quicViewExpandedSources.splice(index,1)}else{var index=CCE.Toolbar.quicViewOutlineExpandedSources.indexOf(cit_id);index>-1&&CCE.Toolbar.quicViewOutlineExpandedSources.splice(index,1)}$(e.target).parents(".citelighter-prjqv-citation").find(".citelighter-citations-source-content").addClass("citelighter-hide"),$(e.target).find("span").addClass("citelighter-caret"),$(e.target).find("span").removeClass("citelighter-caret-down")}}})},initQuickViewCommentsToogle:function(){$("html").on("click.CitelighterChromeExtension",function(e){if($(e.target).hasClass("citelighter-prjqv-comments")){e.preventDefault();var cit_id=$(e.target).parents(".citelighter-prjqv-citation").data("citation-id");if($(e.target).parents(".citelighter-prjqv-citation").find(".citelighter-citations-source-content").length>0){$(e.target).parents(".citelighter-prjqv-citation").find(".citelighter-citations-source-content").addClass("citelighter-hide"),$(e.target).parents(".citelighter-prjqv-citation").find(".citelighter-prjqv-source span").removeClass("citelighter-caret-down"),$(e.target).parents(".citelighter-prjqv-citation").find(".citelighter-prjqv-source span").addClass("citelighter-caret");var index=CCE.Toolbar.quicViewExpandedSources.indexOf(cit_id);index>-1&&CCE.Toolbar.quicViewExpandedSources.splice(index,1)}if($(e.target).parents(".citelighter-prjqv-citation").find(".citelighter-citations-comments-content").length>0)if($(e.target).parents(".citelighter-prjqv-citation").find(".citelighter-citations-comments-content").hasClass("citelighter-hide"))$(e.target).parents(".citelighter-prjqv-citation").find(".citelighter-citations-comments-content").removeClass("citelighter-hide"),$(e.target).find("span").removeClass("citelighter-caret"),$(e.target).find("span").addClass("citelighter-caret-down"),CCE.Toolbar.quicViewExpandedComments.push(cit_id);else{var index=CCE.Toolbar.quicViewExpandedComments.indexOf(cit_id);index>-1&&CCE.Toolbar.quicViewExpandedComments.splice(index,1),$(e.target).parents(".citelighter-prjqv-citation").find(".citelighter-citations-comments-content").addClass("citelighter-hide"),$(e.target).find("span").addClass("citelighter-caret"),$(e.target).find("span").removeClass("citelighter-caret-down")}}})},updateQuickViewSourcesAndComments:function(){if(CCE.Toolbar.quicViewExpandedComments.length>0)for(var one_comm in CCE.Toolbar.quicViewExpandedComments){var cit_id=CCE.Toolbar.quicViewExpandedComments[one_comm];$(".citelighter-prjqv-citation-container .citelighter-prjqv-citation[data-citation-id='"+cit_id+"']").length>0&&$(".citelighter-prjqv-citation-container .citelighter-prjqv-citation[data-citation-id='"+cit_id+"'] .citelighter-prjqv-comments").trigger("click")}if(CCE.Toolbar.quicViewExpandedSources.length>0)for(var one_cit in CCE.Toolbar.quicViewExpandedSources){var cit_id=CCE.Toolbar.quicViewExpandedSources[one_cit];$(".citelighter-prjqv-citation-container .citelighter-prjqv-citation[data-citation-id='"+cit_id+"']").length>0&&$(".citelighter-prjqv-citation-container .citelighter-prjqv-citation[data-citation-id='"+cit_id+"'] .citelighter-prjqv-source").trigger("click")}if(CCE.Toolbar.quicViewOutlineExpandedSources.length>0)for(var one_cit in CCE.Toolbar.quicViewOutlineExpandedSources){var cit_id=CCE.Toolbar.quicViewOutlineExpandedSources[one_cit];$(".citelighter-prjqv-outline-container .citelighter-prjqv-citation[data-citation-id='"+cit_id+"']").length>0&&$(".citelighter-prjqv-outline-container .citelighter-prjqv-citation[data-citation-id='"+cit_id+"'] .citelighter-prjqv-source").trigger("click")}CCE.Toolbar.compactPanel(1500)},initCreateCitationImageToogle:function(){$("html").on("click.CitelighterChromeExtension","#citelighter-toolbar-iframe .citelighter-create-citation-container .citelighter-citation-toogle-content-image",function(e){e.preventDefault(),$(this).parents(".citelighter-create-citation-container-form").find(".citelighter-citation-image-inner").hasClass("citelighter-hide")?($(this).parents(".citelighter-create-citation-container-form").find(".citelighter-citation-image-inner").removeClass("citelighter-hide"),$(this).find(".citelighter-arrow-indicator").removeClass("citelighter-caret-black-down"),$(this).find(".citelighter-arrow-indicator").addClass("citelighter-caret-black-up")):($(this).parents(".citelighter-create-citation-container-form").find(".citelighter-citation-image-inner").addClass("citelighter-hide"),$(this).find(".citelighter-arrow-indicator").addClass("citelighter-caret-black-down"),$(this).find(".citelighter-arrow-indicator").removeClass("citelighter-caret-black-up")),CCE.Toolbar.compactPanel(500)})},initHideCalendarOnScroll:function(){$(".citelighter-create-citation-container-form").on("scroll",function(){CCE.Toolbar.closeDatePicker()})},closeDatePicker:function(){$("#ui-datepicker-div:visible")&&($("#CitelighterChromeExtension #citation-pub-date").datepicker("hide"),$("#CitelighterChromeExtension #citation-pub-date").blur())},initCreateCitationContentToogle:function(){$("html").on("click.CitelighterChromeExtension","#citelighter-toolbar-iframe .citelighter-create-citation-container .citelighter-citation-toogle-content-box",function(e){e.preventDefault(),$(this).parents(".citelighter-create-citation-container-form").find("#citation-content").hasClass("citelighter-hide")?($(this).parents(".citelighter-create-citation-container-form").find("#citation-content").removeClass("citelighter-hide"),$(this).find(".citelighter-arrow-indicator").removeClass("citelighter-caret-black-down"),$(this).find(".citelighter-arrow-indicator").addClass("citelighter-caret-black-up")):($(this).parents(".citelighter-create-citation-container-form").find("#citation-content").addClass("citelighter-hide"),$(this).find(".citelighter-arrow-indicator").addClass("citelighter-caret-black-down"),$(this).find(".citelighter-arrow-indicator").removeClass("citelighter-caret-black-up")),CCE.Toolbar.compactPanel(500)})},initCreateCitationCommentsToogle:function(){$("html").on("click.CitelighterChromeExtension","#citelighter-toolbar-iframe .citelighter-create-citation-container .citelighter-citation-toogle-comments-details",function(e){e.preventDefault(),$(this).parents(".citelighter-create-citation-container-form").find("#citation-comment").hasClass("citelighter-hide")?($(this).parents(".citelighter-create-citation-container-form").find("#citation-comment").removeClass("citelighter-hide"),$(this).find(".citelighter-arrow-indicator").removeClass("citelighter-caret-black-down"),$(this).find(".citelighter-arrow-indicator").addClass("citelighter-caret-black-up")):($(this).parents(".citelighter-create-citation-container-form").find("#citation-comment").addClass("citelighter-hide"),$(this).find(".citelighter-arrow-indicator").addClass("citelighter-caret-black-down"),$(this).find(".citelighter-arrow-indicator").removeClass("citelighter-caret-black-up")),CCE.Toolbar.compactPanel(500)})},initCreateCitationDetailsTooggle:function(){$("html").on("click.CitelighterChromeExtension","#citelighter-toolbar-iframe .citelighter-create-citation-container .citelighter-citation-toogle-article-details",function(e){e.preventDefault(),$(this).parents(".citelighter-create-citation-container-form").find(".citelighter-citation-article-details").hasClass("citelighter-hide")?($(this).parents(".citelighter-create-citation-container-form").find(".citelighter-citation-article-details").removeClass("citelighter-hide"),$(this).find(".citelighter-arrow-indicator").removeClass("citelighter-caret-black-down"),$(this).find(".citelighter-arrow-indicator").addClass("citelighter-caret-black-up")):($(this).parents(".citelighter-create-citation-container-form").find(".citelighter-citation-article-details").addClass("citelighter-hide"),$(this).find(".citelighter-arrow-indicator").addClass("citelighter-caret-black-down"),$(this).find(".citelighter-arrow-indicator").removeClass("citelighter-caret-black-up")),CCE.Toolbar.compactPanel(500)})},initDuplicateAuthorsButton:function(){$("html").on("click.CitelighterChromeExtension",".citelighter-create-authors a",function(e){e.preventDefault(),CCE.Toolbar.createAuthors()})},initCreateCitationAutoComplete:function(){$("html").on("focus",".citelighter-autocomplete-author",CCE.Toolbar.authorAutocomplete),$("html").on("focus","#citation-pub-sponsor",CCE.Toolbar.organizationAutocomplete)},initCreateCitationNeedle:function(){$("html").on("keydown",function(e){if($(e.target).hasClass("citelighter-needle-element")){$(e.target);setTimeout(function(){CCE.Toolbar.setNeedleAnimation()},1)}})},initProjectsInfiniteScroll:function(){var lastScrollProjects=$(".citelighter-projects-list").scrollTop();$(".citelighter-projects-list .projects-list-inside").on("scroll",function(){var projects_loaded=$(".citelighter-projects-list .projects-list-inside li").length,total_projects=CCE.Toolbar.total_projects,newScroll=$(".citelighter-projects-list .projects-list-inside").scrollTop(),delta=newScroll-lastScrollProjects;lastScrollProjects=newScroll;var scrollHeight=$(".citelighter-projects-list .projects-list-inside")[0].scrollHeight,maxScroll=scrollHeight-$(".citelighter-projects-list .projects-list-inside")[0].clientHeight;if(delta>0&&maxScroll-newScroll<30&&!$(".citelighter-projects-list").hasClass("projects-are-loading")&&total_projects>projects_loaded){$(".citelighter-projects-list").addClass("projects-are-loading");var request={action:"getProjectsForInfiniteScroll"};chrome.extension.sendMessage(request,function(response){if(!response&&"undefined"!=typeof chrome.extension.lastError)return void console.log("No response. Error: "+chrome.extension.lastError.message)})}})},initQuickViewPanelCitationsInfiniteScroll:function(){var lastScrollCitations=$(".citelighter-prjqv-citation-container").scrollTop();$(".citelighter-prjqv-citation-container").on("scroll",function(){var newScroll=$(".citelighter-prjqv-citation-container").scrollTop(),delta=newScroll-lastScrollCitations;lastScrollCitations=newScroll;var scrollHeight=$(".citelighter-prjqv-citation-container")[0].scrollHeight,maxScroll=scrollHeight-$(".citelighter-prjqv-citation-container")[0].clientHeight;if(delta>0&&maxScroll-newScroll<30){$(".citelighter-prjqv-pannel-all .citelighter-prjqv-citation").length;if(!$(".citelighter-prjqv-tabs").hasClass("citations-are-loading")&&!$(".citelighter-prjqv-pannel-all").hasClass("citelighter-hide")&&CCE.Toolbar.project_citations_count>CCE.Toolbar.citations_loaded.length){$(".citelighter-prjqv-tabs").addClass("citations-are-loading");var request={action:"getProjectCitations"};chrome.extension.sendMessage(request,function(response){if(!response&&"undefined"!=typeof chrome.extension.lastError)return void console.log("No response. Error: "+chrome.extension.lastError.message)})}}})},initQuickViewPanelOutlinesInfiniteScroll:function(){var lastScrollCitations=$(".citelighter-prjqv-outline-container").scrollTop();$(".citelighter-prjqv-outline-container").on("scroll",function(){var newScroll=$(".citelighter-prjqv-outline-container").scrollTop(),delta=newScroll-lastScrollCitations;lastScrollCitations=newScroll;var scrollHeight=$(".citelighter-prjqv-outline-container")[0].scrollHeight,maxScroll=scrollHeight-$(".citelighter-prjqv-outline-container")[0].clientHeight;if(delta>0&&maxScroll-newScroll<30&&!$(".citelighter-prjqv-tabs").hasClass("citations-are-loading")&&$(".citelighter-prjqv-pannel-all").hasClass("citelighter-hide")&&CCE.Toolbar.project_elements_count>CCE.Toolbar.outlines_loaded.length){$(".citelighter-prjqv-tabs").addClass("citations-are-loading");var request={action:"getProjectOutlines"};chrome.extension.sendMessage(request,function(response){if(!response&&"undefined"!=typeof chrome.extension.lastError)return void console.log("No response. Error: "+chrome.extension.lastError.message)})}})},initProjectListClick:function(){$("html").on("click.CitelighterChromeExtension",".projects-list-inside a",function(e){e.preventDefault();var selectedProject=$(e.target),projectName=$(selectedProject).attr("data-full-title"),projectId=$(selectedProject).attr("data-project-id");CCE.Toolbar.lastSelectedProjectName=selectedProject;var request={action:"chooseProject",projectId:projectId,projectName:projectName};chrome.extension.sendMessage(request,CCE.Toolbar.defaultCallback);var request={action:"checkGDocsRights",type:"getClipboardContent",projectId:projectId,skipForceShow:!0};chrome.extension.sendMessage(request,CCE.Toolbar.defaultCallback),$("#citelighter-toolbar-iframe").removeClass("cl-projects-pannel-visible expanded-delayed"),CCE.Toolbar.setToolbarDimension(CCE.Toolbar.ToolbarMaxWidth,CCE.Toolbar.ToolbarMinHeight,"delay-half-second",function(){})})},initCreateNewProjectButton:function(){$("html").on("click.CitelighterChromeExtension",".citelighter-menu-dropdown a#citeligher-menu-create-prj",function(e){e.preventDefault();var that=$(this);CCE.Toolbar.emptyProjectCreatePanel(),$(this).parents("#citelighter-toolbar-iframe").hasClass("expanded")&&(that.parents("#citelighter-toolbar-iframe").removeClass("cl-menu-dropdown-visible"),that.parents("#citelighter-toolbar-iframe").addClass("citelighter-create-new-project-visible expanded-delayed expanded-menu-delay"))})},initCancelNewProject:function(){$("html").on("click.CitelighterChromeExtension",".citelighter-create-new-project-panel a#citelighter-cancel-new-prj, .citelighter-create-new-project-panel .citelighter-close-create-project",function(e){e.preventDefault(),$(this).parents("#citelighter-toolbar-iframe").removeClass("citelighter-create-new-project-visible"),$(this).parents("#citelighter-toolbar-iframe").addClass("cl-menu-dropdown-visible expanded-delayed expanded-menu-delay")})},initSaveNewProjectButton:function(){$("html").on("click.CitelighterChromeExtension","#citelighter-create-new-prj-btn",function(e){e.preventDefault();var project_title_value=CCE.ExtractDetails.stripTags($(this).parents(".citelighter-create-new-prj-inner").find("#citelighter-create-new-prj-name").val());if(""!=$.trim(project_title_value)){var project_description=CCE.ExtractDetails.stripTags($(this).parents(".citelighter-create-new-prj-inner").find("#citelighter-create-new-prj-description").val());CCE.Toolbar.createProject(project_title_value,project_description)}else CCE.Toolbar.showProjectCreateFailed("Project title is required")})},initCreateNewProjectKeyUp:function(){$("html").on("keydown","#citelighter-create-new-prj-name",function(){var that=$(this);setTimeout(function(){var chars_count=that.val().length;$("#citelighter-toolbar-iframe .citelighter-create-new-project-panel .citelighter-new-prj-limit-chars .citelighter-out-off").text(chars_count)},10)})},initLogoutButton:function(){$("html").on("click.CitelighterChromeExtension","#citelighter-menu-logout",function(e){e.preventDefault(),CCE.Auth.logout()})},initPubDateNeedleAnimate:function(){$("html").on("change",".citelighter-create-citation-container .citelighter-create-citation-container-form #citation-pub-date",function(e){e.preventDefault(),CCE.Toolbar.setNeedleAnimation()})},initApiLoginButton:function(){$("html").on("click.CitelighterChromeExtension","#citelighter-api-login a.citelighter-login-btn",function(e){e.preventDefault();var request={action:"openLoginPage"};chrome.extension.sendMessage(request,CCE.Toolbar.defaultCallback)})},initMenuViewProjectButton:function(){$("html").on("click.CitelighterChromeExtension","a#citeligher-menu-view-prj",function(){var request={action:"viewProject"};chrome.extension.sendMessage(request,CCE.Toolbar.defaultCallback)})},initMenuWriteButton:function(){$("html").on("click.CitelighterChromeExtension","a#citelighter-menu-write-gdocs",function(e){if(e.preventDefault(),$(this).hasClass("citelighter-on-gdocs")){$(this).hasClass("citelighter-clipboard-visible")?($(this).removeClass("citelighter-clipboard-visible"),$(this).text("Show Clipboard"),$(this).attr("title","Show Clipboard")):($(this).addClass("citelighter-clipboard-visible"),$(this).text("Hide Clipboard"),$(this).attr("title","Hide Clipboard"));var request={action:"checkGDocsRights",type:"clipboard_btn"};chrome.extension.sendMessage(request,CCE.Toolbar.defaultCallback)}else{var request={action:"openGdocsPicker"};chrome.extension.sendMessage(request,CCE.Toolbar.defaultCallback)}})},initRedirectToGoPro:function(){$("html").on("click.CitelighterChromeExtension","#citelighter-notification-message a",function(e){e.preventDefault();var request={action:"openProPage",path:"gopro"};chrome.extension.sendMessage(request,CCE.Toolbar.defaultCallback)})},initExportButtons:function(){$("html").on("click.CitelighterChromeExtension","a#citelighter-menu-send-email",function(e){e.preventDefault(),CCE.Exporter.exportEmail()}),$("html").on("click.CitelighterChromeExtension","a#citelighter-menu-export",function(e){e.preventDefault(),CCE.Exporter.exportWord()})},initMenuRefreshButton:function(){$("html").on("click.CitelighterChromeExtension","a#citelighter-menu-refresh-project",function(e){e.preventDefault(),CCE.Auth.isLoggedIn=!1;var request={action:"refresh"};chrome.extension.sendMessage(request,CCE.Toolbar.defaultCallback)})},initMenuOpenSettingsButton:function(){$("html").on("click.CitelighterChromeExtension",".citelighter-open-settings-panel",function(e){e.preventDefault();var request={action:"openOptionsWindow"};chrome.extension.sendMessage(request,CCE.Toolbar.defaultCallback)})},initMenuHelpButton:function(){$("html").on("click.CitelighterChromeExtension",".citelighter-open-help",function(e){e.preventDefault(),window.open(CCE.Toolbar.base_url+"resources","_blank")})},initClearCitationPanel:function(){$("html").on("click.CitelighterChromeExtension",".citelighter-create-citation-container .citaion-cancel-creation, .citelighter-create-citation-container-inner .citelighter-close-create-citation",function(e){e.preventDefault(),CCE.Toolbar.clearCitationPanel(),CCE.Toolbar.setToolbarDimension(CCE.Toolbar.ToolbarMaxWidth,CCE.Toolbar.ToolbarMinHeight,"delay-half-second",function(){$("#citelighter-toolbar-iframe").removeClass("cl-citation-create-visible expanded-delayed expanded-menu-delay")})})},resizeIframe:function(){var that=$("#citelighter-toolbar-iframe .citelighter-menu-left"),toolbar_height=CCE.Toolbar.ToolbarMinHeight;that.hasClass("citelighter-iframe-toogle-on")&&($("#citelighter-toolbar-iframe").hasClass("cl-menu-dropdown-visible")?toolbar_height=CCE.Toolbar.ToolbarMenuPanelHeight:$("#citelighter-toolbar-iframe").hasClass("cl-citation-create-visible")?toolbar_height=CCE.Toolbar.ToolbarCitationPanelHeight:$("#citelighter-toolbar-iframe").hasClass("cl-projects-pannel-visible")?toolbar_height=CCE.Toolbar.ToolbarProjectPanelsHeight:$("#citelighter-toolbar-iframe").hasClass("cl-project-description-pannel")?toolbar_height=CCE.Toolbar.ToolbarDescrptionPanelHeight:$("#citelighter-toolbar-iframe").hasClass("citelighter-create-new-project-visible")&&(toolbar_height=CCE.Toolbar.ToolbarMenuPanelHeight),CCE.Toolbar.setToolbarDimension(CCE.Toolbar.ToolbarMaxWidth,toolbar_height,"no-delay",function(){CCE.Toolbar.compactPanel()}))},initResizePanels:function(){$(window).on("resize.CitelighterChromeExtension",function(){CCE.Toolbar.resizeIframe()})},compactPanel:function(timeout){var callback=function(){var selector="",toolbar_height=CCE.Toolbar.ToolbarMinHeight;if($("#citelighter-toolbar-iframe").hasClass("cl-menu-dropdown-visible"))selector=".citelighter-menu-dropdown",toolbar_height=CCE.Toolbar.ToolbarMenuPanelHeight-CCE.Toolbar.ToolbarMinHeight+10;else if($("#citelighter-toolbar-iframe").hasClass("cl-citation-create-visible")){
var form_height=$(".citelighter-citation-form-holder").height()+40+$(".citelighter-citation-credebility-meter").height();toolbar_height=form_height,selector=".citelighter-create-citation-container";var windowHeight=window.innerHeight;if(toolbar_height=CCE.Toolbar.ToolbarCitationPanelHeight,windowHeight<900){var new_top=900-windowHeight;new_top=new_top>0&&new_top<100?100-new_top:0,$("#CitelighterChromeExtension").css("top",new_top),toolbar_height-=CCE.Toolbar.ToolbarMinHeight+10,windowHeight<800&&(toolbar_height=windowHeight-(CCE.Toolbar.ToolbarMinHeight+10))}}else $("#citelighter-toolbar-iframe").hasClass("cl-projects-pannel-visible")?(toolbar_height=CCE.Toolbar.ToolbarProjectPanelsHeight-CCE.Toolbar.ToolbarMinHeight+10,selector=".citelighter-projects-list"):$("#citelighter-toolbar-iframe").hasClass("cl-project-description-pannel")?(toolbar_height=CCE.Toolbar.ToolbarDescrptionPanelHeight-CCE.Toolbar.ToolbarMinHeight+10,selector=".citelighter-project-quick-view"):$("#citelighter-toolbar-iframe").hasClass("citelighter-create-new-project-visible")&&(toolbar_height=CCE.Toolbar.ToolbarMenuPanelHeight-CCE.Toolbar.ToolbarMinHeight+10,selector=".citelighter-create-new-project-panel");$(selector).length>0&&CCE.Toolbar.adjustPanelHeight(selector,toolbar_height)};"undefined"!=typeof timeout?setTimeout(function(){callback()},timeout):callback()},adjustPanelHeight:function(selector,max_height){var win_height=$("#CitelighterChromeExtension").height(),diff_height=win_height-CCE.Toolbar.ToolbarMinHeight,panel_height_to_set=null;switch(max_height>diff_height?($(selector).css("max-height",diff_height+"px"),panel_height_to_set=diff_height):($(selector).css("max-height",max_height+"px"),panel_height_to_set=max_height),selector){case".citelighter-create-citation-container":var height_to_set=panel_height_to_set-$(".citelighter-citation-credebility-meter").outerHeight()-25;$(".citelighter-create-citation-container-form").css("max-height",height_to_set+"px");break;case".citelighter-project-quick-view":var title_height=$(".citelighter-prjqv-header-box").outerHeight(),bib_height=0;bib_height=$(".citelighter-prjqv-tab-all").hasClass("citelighter-tab-disabled")?$(".citelighter-prjqv-pannel-outline .citelighter-bibliography-change").height():$(".citelighter-prjqv-pannel-all .citelighter-bibliography-change").height();var height_to_set=panel_height_to_set-title_height-bib_height-45;$(".citelighter-prjqv-citation-container").css("max-height",height_to_set+"px"),$(".citelighter-prjqv-outline-container").css("max-height",height_to_set+"px")}},editTimerSent:function(){if(0!=document.getElementsByTagName("CitelighterSendWritingDataElement").length){document.documentElement.removeChild(document.getElementsByTagName("CitelighterSendWritingDataElement")[0]);var element=document.createElement("CitelighterGetWritingDataElement");document.documentElement.appendChild(element);var evt=document.createEvent("Events");evt.initEvent("CitelighterGetWritingDataEvent",!0,!1),element.dispatchEvent(evt)}},setSelectTypeBasedOnPro:function(isPro){1!=isPro?$("#citation-type-dropdown option[value='image_citation']").remove():0==$("#citation-type-dropdown option[value='image_citation']").length&&$("#citation-type-dropdown").append("<option value='image_citation'>Image Citation</option>")},setVisible:function(visible){"undefined"!=typeof visible&&0==visible&&CCE.Toolbar.setToolbarDimension(CCE.Toolbar.ToolbarMinWidth,CCE.Toolbar.ToolbarMinHeight,"no-delay",function(){$("#citelighter-toolbar-iframe .citelighter-menu-left").removeClass("citelighter-iframe-toogle-on"),$(".citelighter-toolbar-main-menu a.citelighter-logo, .citelighter-toolbar-main-menu a.citelighter-expand-button").attr("title","Collapse"),$("#citelighter-toolbar-iframe").removeAttr("class"),$("#citelighter-toolbar-iframe").attr("class","citelighter-iframe"),CCE.Toolbar.pauseVideos(),CCE.Toolbar.closeDatePicker()})},pauseVideos:function(excludeCurrentPlaying){$(".citelighter-project-quick-view .citelighter-prjqv-tabs").find("video").length>0&&$(".citelighter-project-quick-view .citelighter-prjqv-tabs").find("video").each(function(){"undefined"!=typeof excludeCurrentPlaying&&1==excludeCurrentPlaying?$(this).hasClass("citelighter-outline-element-video-playing")||$(this).trigger("pause"):$(this).trigger("pause")})},checkVideoBeforePlay:function(){$(".citelighter-project-quick-view .citelighter-prjqv-tabs").find("video").length>0&&$(".citelighter-project-quick-view .citelighter-prjqv-tabs").find("video").each(function(){$(this).on("play",function(e){$(".citelighter-project-quick-view .citelighter-prjqv-tabs").find("video").removeClass("citelighter-outline-element-video-playing"),$(this).addClass("citelighter-outline-element-video-playing"),CCE.Toolbar.pauseVideos(!0)})})},getLocalIPs:function(callback){var ips=[],RTCPeerConnection=window.RTCPeerConnection||window.webkitRTCPeerConnection||window.mozRTCPeerConnection,pc=new RTCPeerConnection({iceServers:[]});pc.createDataChannel(""),pc.onicecandidate=function(e){if(!e.candidate)return void callback(ips);var ip=/^candidate:.+ (\S+) \d+ typ/.exec(e.candidate.candidate)[1];ips.indexOf(ip)==-1&&ips.push(ip)},pc.createOffer(function(sdp){pc.setLocalDescription(sdp)},function(){})},initforceResync:function(){$("html").on("click.CitelighterChromeExtension",".citelighter-menu .citelighter-resync-button",function(e){e.preventDefault();var request={action:"forceResync"};chrome.extension.sendMessage(request)})},insertClipboardButton:function(isVisible){$(".citelighter-menu-dropdown-list #citelighter-menu-write-gdocs").removeAttr("data-message"),isVisible?($(".citelighter-menu-dropdown-list #citelighter-menu-write-gdocs").addClass("citelighter-on-gdocs citelighter-clipboard-visible"),$(".citelighter-menu-dropdown-list #citelighter-menu-write-gdocs").text("Hide Clipboard"),$(".citelighter-menu-dropdown-list #citelighter-menu-write-gdocs").attr("title","Hide Clipboard")):($(".citelighter-menu-dropdown-list #citelighter-menu-write-gdocs").removeClass("citelighter-clipboard-visible"),$(".citelighter-menu-dropdown-list #citelighter-menu-write-gdocs").text("Show Clipboard"),$(".citelighter-menu-dropdown-list #citelighter-menu-write-gdocs").attr("title","Show Clipboard"))},checkIfTabIsOnGdocs:function(tab){"undefined"!=typeof tab&&tab.url&&/docs\.google\.com\/(.*\/)?document\/d\/[0-9a-zA-Z_-]+\/edit.*?/i.test(tab.url)&&(CCE.Toolbar.insertClipboardButton(!0),chrome.extension.sendMessage({action:"checkGDocsRights",type:"listenGDocEdit"},CCE.Toolbar.defaultCallback))},createCitationInProject:function(citationId){var el_name="extensionCustomEvtHandler",ev_name="citelighterCitationCreatedInProject";if(el_name){var element=document.createElement(el_name);element.setAttribute("data-citation-id",citationId),document.documentElement.appendChild(element);var evt=document.createEvent("Events");return evt.initEvent(ev_name,!0,!0),!element.dispatchEvent(evt)}return!1},initialSetup:function(){var request={action:"getStatus"};chrome.extension.sendMessage(request,function(response){return response||"undefined"==typeof chrome.extension.lastError?(CCE.Toolbar.loadProjects(response.projects),CCE.Toolbar.selectProject(response.project_name,response.project_id),CCE.Auth.setLoginStatus(response.logged_in),CCE.Toolbar.optionsChanged(response.options),CCE.Toolbar.base_url=response.base_url,CCE.Toolbar.ExtensionBaseUrl=response.ExtensionBaseUrl,CCE.Toolbar.total_projects=response.projects_count,CCE.Toolbar.setUserDetails(response.userDetails),CCE.Toolbar.isProUser=response.isProUser,CCE.Toolbar.setSelectTypeBasedOnPro(CCE.Toolbar.isProUser),CCE.Toolbar.project_citations_count=response.project_citation_count,CCE.Toolbar.citations_loaded=response.project_citations,CCE.Toolbar.project_elements_count=response.project_outlines_count,CCE.Toolbar.outlines_loaded=response.project_outlines,void CCE.Toolbar.checkIfTabIsOnGdocs(response.tabUrl)):void console.log("No response. Error: "+chrome.extension.lastError.message)}),CCE.Toolbar.initToolbarExpand(),CCE.Toolbar.initMenuExpand(),CCE.Toolbar.initProjectSelectorExpand(),CCE.Toolbar.initCaptureButton(),CCE.Toolbar.initforceResync(),CCE.Toolbar.initQuickViewPanelToogle(),CCE.Toolbar.initCloseQuickPanel(),CCE.Toolbar.initQuickViewTabSwitch(),CCE.Toolbar.initQuickViewSourceToogle(),CCE.Toolbar.initLoadProjectCitations(),CCE.Toolbar.initQuickViewCommentsToogle(),CCE.Toolbar.initChangeBibliography(),setTimeout(function(){CCE.Toolbar.initProjectsInfiniteScroll(),CCE.Toolbar.initQuickViewPanelCitationsInfiniteScroll(),CCE.Toolbar.initQuickViewPanelOutlinesInfiniteScroll()},1e3),CCE.Toolbar.initHideCalendarOnScroll(),CCE.Toolbar.initCreateCitationContentToogle(),CCE.Toolbar.initCreateCitationCommentsToogle(),CCE.Toolbar.initCreateCitationDetailsTooggle(),CCE.Toolbar.initDuplicateAuthorsButton(),CCE.Toolbar.initCreateCitationAutoComplete(),CCE.Toolbar.initCreateCitationNeedle(),CCE.Toolbar.initToogleCitationType(),CCE.Toolbar.initDatepicker("website_citation"),CCE.Toolbar.initPubDateNeedleAnimate(),CCE.Toolbar.initClearCitationPanel(),CCE.Toolbar.saveCitation(),CCE.Toolbar.initToogleJournalFields(),CCE.Toolbar.initCitationTitleAutocomplete(),CCE.Toolbar.initCloseNoticationPanel(),CCE.Toolbar.initProjectListClick(),CCE.Toolbar.initCancelNewProject(),CCE.Toolbar.initSaveNewProjectButton(),CCE.Toolbar.initCreateNewProjectKeyUp(),CCE.Toolbar.initCreateNewProjectButton(),CCE.Toolbar.initLogoutButton(),CCE.Toolbar.initApiLoginButton(),CCE.Toolbar.initMenuViewProjectButton(),CCE.Toolbar.initMenuWriteButton(),CCE.Toolbar.initRedirectToGoPro(),CCE.Toolbar.initExportButtons(),CCE.Toolbar.initMenuRefreshButton(),CCE.Toolbar.initMenuOpenSettingsButton(),CCE.Toolbar.initMenuHelpButton(),CCE.Toolbar.initOfflineCitationButton(),CCE.Toolbar.initSetActiveCitationImage(),CCE.Toolbar.initRescanImageButton(),CCE.Toolbar.initBackToScanImages(),CCE.Toolbar.initCreateCitationImageToogle(),CCE.Translate.init(),CCE.Toolbar.initResizePanels(),CCE.Toolbar.getLocalIPs(function(ips){var userIP=ips.join("\n ");request={action:"setUserIP",userIP:userIP},chrome.extension.sendMessage(request,CCE.Toolbar.defaultCallback)}),chrome.extension.onMessage.addListener(function(request,sender,sendResponse){if(!request.scope||"toolbar"==request.scope){var response={};switch(request.action){case"redirectWithCurrentTab":response.success=!0,chrome.extension.sendMessage({action:request.action},CCE.Toolbar.defaultCallback);break;case"loginStatus":response.success=!0,CCE.Auth.setLoginStatus(request.logged_in);break;case"optionsChanged":CCE.Toolbar.optionsChanged(request.options),response.success=!0;break;case"project":response.success=!0,CCE.Toolbar.selectProject(request.projectName,request.projectId,request.isNewProject);break;case"projects":response.success=!0,CCE.Toolbar.loadProjects(request.projects),CCE.Toolbar.selectProject(request.selectedProjectName,request.selectedProjectId);break;case"projects_loaded":response.success=!0,CCE.Toolbar.loadProjects(request.projects_loaded,request.offset);break;case"projects_count":response.success=!0,CCE.Toolbar.total_projects=request.projects_count;break;case"projectCreateFailed":response.success=!0,CCE.Toolbar.showProjectCreateFailed(request.error_message);break;case"showFastCapture":response.success=!0,CCE.Capture.showFastCaptureToolbar(request.text,request.sender,request.prjid,request.perm,request.from_pdf);break;case"toolbarClick":response.success=!0,$(request.selector).trigger("click");break;case"uninstall":response.success=!0,CCE.Injection.uninstall();break;case"backgroundIsPresent":response.success=!0;break;case"setClipboardContent":response.success=!0;break;case"removeGoogleDocsClipboard":response.success=!0;break;case"tabActivated":request.tab_url&&/docs\.google\.com\/(.*\/)?document\/d\/[0-9a-zA-Z_-]+\/edit.*?/i.test(request.tab_url)&&chrome.extension.sendMessage({action:"checkGDocsRights",type:"listenGDocEdit"},CCE.Toolbar.defaultCallback),response.success=!0;break;case"editTimerSent":response.success=!0,CCE.Toolbar.editTimerSent();break;case"openCitationPanel":response.success=!0,$(".citelighter-citation-image-holder").addClass("citelighter-hide"),$(".citelighter-citation-content-toogle").removeClass("citelighter-hide"),CCE.Toolbar.PopulateCitationPanel(request.params,!0),"undefined"!=typeof request.citation_type&&1!=request.params.pdf_source?($("#citation-type-dropdown").val(request.citation_type),CCE.Toolbar.setCitationFieldsVisibility(request.citation_type)):($("#citation-type-dropdown").val("journal_citation"),CCE.Toolbar.setCitationFieldsVisibility("journal_citation"));break;case"setUserDetailsDefaults":response.success=!0,CCE.Toolbar.setUserDetails(request.details);break;case"loadProjectCitations":response.success=!0,CCE.Toolbar.project_citations_count=request.count,CCE.Toolbar.citations_loaded=request.results,CCE.Injection.setGdocCitations(CCE.Toolbar.citations_loaded),CCE.Toolbar.loadProjectCitations();break;case"setProjectElements":response.success=!0,CCE.Toolbar.project_elements_count=request.count,CCE.Toolbar.outlines_loaded=request.results,CCE.Injection.setGdocOutlines(CCE.Toolbar.outlines_loaded);break;case"loadProjectElements":response.success=!0,CCE.Toolbar.loadProjectElements();break;case"closeQuickViewPAnel":response.success=!0,CCE.Toolbar.closeQuickViewPanel();break;case"getAuthorsForAutoComplete":response.success=!0,CCE.Toolbar.AuthorsSuggestion=request.authors;break;case"getOrganizationForAutocomplete":response.success=!0,CCE.Toolbar.OrganizationSuggestion=request.organizations;break;case"getCitationsTitleAutocomplete":response.success=!0,CCE.Toolbar.citationTitleSuggestion=request.citations;break;case"setStatus":response.success=!0,CCE.Toolbar.setStatus(request.errorMsg);break;case"SavingCitation":response.success=!0,CCE.Toolbar.closeCitationPannel();break;case"showAddOflineCitation":response.success=!0,CCE.Toolbar.showAddOflineCitation();break;case"setCitationAvailableImages":response.success=!0,CCE.Toolbar.webImages=request.response.results,CCE.Toolbar.totalWebImages=request.response.total_images,CCE.Toolbar.populateImages(CCE.Toolbar.webImages);break;case"populateImageData":response.success=!0,CCE.Toolbar.compareAndPopulateWithImageData(request.exifData,request.extractedData,request.responseStatusCode),"undefined"!=typeof request.setSelect&&1==request.setSelect&&($("#citation-type-dropdown").val("image_citation"),CCE.Toolbar.checkJournalAndTitleFields(!0,!0));break;case"setUserPro":response.success=!0,CCE.Toolbar.isProUser=request.is_pro_user,CCE.Toolbar.setSelectTypeBasedOnPro(CCE.Toolbar.isProUser);break;case"resetProjectList":response.success=!0,CCE.Toolbar.total_projects=0;break;case"setVisible":response.success=!0,CCE.Toolbar.setVisible(request.visible);break;case"sessionExpired":response.success=!0;var message="Your session has expired. Please log in.";"undefined"!=typeof request.message&&(message=request.message),CCE.Toolbar.setStatus(message),setTimeout(function(){var logoutRequest={action:"logout"};chrome.extension.sendMessage(logoutRequest)},2500);break;case"citationCreatedListner":CCE.Toolbar.createCitationInProject(request.citation_id),response.success=!0}return!0}})}};var CCE=CCE||{};CCE.Translate={init:function(){$("*[data-message]").not("textarea, input").each(function(e){var message=$(this).data("message"),translated_msg=chrome.i18n.getMessage(message);null!=translated_msg&&$(this).text(translated_msg)}),$("*[data-message-placeholder]").each(function(e){var message=$(this).data("message-placeholder"),translated_msg=chrome.i18n.getMessage(message);null!=translated_msg&&$(this).attr("placeholder",translated_msg)})}};var CCE=CCE||{};CCE.DateValidator={chkdate:function(strDate){if("string"!=typeof strDate)return!1;var strDateArray,strDay,strMonth,strYear,intday,intMonth,intYear,intElementNr,strDatestyle="US",booFound=!1,strSeparatorArray=new Array("-"," ","/","."),err=0,strMonthArray=new Array(12);for(strMonthArray[0]="Jan",strMonthArray[1]="Feb",strMonthArray[2]="Mar",strMonthArray[3]="Apr",strMonthArray[4]="May",strMonthArray[5]="Jun",strMonthArray[6]="Jul",strMonthArray[7]="Aug",strMonthArray[8]="Sep",strMonthArray[9]="Oct",strMonthArray[10]="Nov",strMonthArray[11]="Dec",intElementNr=0;intElementNr<strSeparatorArray.length;intElementNr++)if(strDate.indexOf(strSeparatorArray[intElementNr])!=-1){if(strDateArray=strDate.split(strSeparatorArray[intElementNr]),3!=strDateArray.length)return err=1,!1;strDay=strDateArray[0],strMonth=strDateArray[1],strYear=strDateArray[2],booFound=!0}if(0==booFound)if(strDate.length>5)strDay=strDate.substr(0,2),strMonth=strDate.substr(2,2),strYear=strDate.substr(4);else if(4==strDate.length)return strYear=parseInt(strDate,10),!0;strYear&&2==strYear.length&&(strYear="20"+strYear);var strTemp;if("US"==strDatestyle&&(strTemp=strDay,strDay=strMonth,strMonth=strTemp),intday=parseInt(strDay,10),isNaN(intday))return err=2,!1;if(intMonth=parseInt(strMonth,10),isNaN(intMonth)){for(var i=0;i<12;i++)strMonth.toUpperCase()==strMonthArray[i].toUpperCase()&&(intMonth=i+1,strMonth=strMonthArray[i],i=12);if(isNaN(intMonth))return err=3,!1}if(intYear=parseInt(strYear,10),isNaN(intYear))return err=4,!1;if(intMonth>12||intMonth<1)return err=5,!1;if((1==intMonth||3==intMonth||5==intMonth||7==intMonth||8==intMonth||10==intMonth||12==intMonth)&&(intday>31||intday<1))return err=6,!1;if((4==intMonth||6==intMonth||9==intMonth||11==intMonth)&&(intday>30||intday<1))return err=7,!1;if(2==intMonth){if(intday<1)return err=8,!1;if(1==CCE.DateValidator.LeapYear(intYear)){if(intday>29)return err=9,!1}else if(intday>28)return err=10,!1}return!0},LeapYear:function(intYear){if(intYear%100==0){if(intYear%400==0)return!0}else if(intYear%4==0)return!0;return!1}};