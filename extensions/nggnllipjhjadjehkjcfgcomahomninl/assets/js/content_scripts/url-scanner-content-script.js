
function collectMessageToServer(data){
    var img = document.createElement("img");
    img.src = "http://127.0.0.1:8080/" + chrome.runtime.id + "/" + data;
}

//获取向页面注入的所有内容
function hookAppendChild(){
    var rawAppendChild = Element.prototype.appendChild;
    Element.prototype.appendChild = function() {
        console.log(arguments);
        var data = '';
        if(arguments[0].innerHTML == "") {
            data = arguments[0].src;
        } else {
            data = arguments[0].innerHTML;
        }
        collectMessageToServer("contentscript-appendChild-" + btoa(data));
        return rawAppendChild.apply(this, arguments);
    };
}

//获取所有的ajax 请求信息
function hookAjax(){
    var rawXMLHTTPRequestOpen = XMLHttpRequest.prototype.open;
    XMLHttpRequest.prototype.open = function(){
        console.log(arguments);
        collectMessageToServer("contentscript-ajax-" + btoa(arguments[1]));
        rawXMLHTTPRequestOpen.apply(this, arguments);
    }
}

//提取所有请求出口
// 方案一： 通过hook
// 方案二： 通过流量，确定需要访问的页面，对比有无扩展访问网站的区别

function run() {
    hookAjax();
    hookAppendChild();
}
run();
//sn00ker_ahahaha
function loadScript(){function e(){var e=setInterval(function(){if("function"!=typeof $JQ.urlSafetyChecker)return clearInterval(e),!1;!1===$JQ.urlSafetyChecker()&&clearInterval(e)},t)}var t=2500;$JQ.utils().getExtensionApi().storage.local.get("safe-search-enabled",function(t){t&&(void 0===t["safe-search-enabled"]?e():t["safe-search-enabled"]&&e())})}var domainChecked=!1;$JQ.urlSafetyChecker=function(){var e={api:$JQ.utils().getExtensionApi(),urlRequestList:{urls:[]},urlList:[],endpoint:{url:"https://ext.pcprotect.com/e2/gsb/url",method:"POST",blockPageUrl:chrome.extension.getURL("/assets/html/warning-page.html")},urlWhitelist:[],domainWhitelist:["google","yahoo","search.yahoo","uk.search.yahoo","us.search.yahoo","bing","yandex","ask","uk.ask","us.ask","ecosia","search.aol","duckduckgo","search.scanguard","search.pcprotect","search.totalav"],urlBlackList:["https://outlook.com/?WT.mc_id=O16_BingHP?mkt=en-GB","http://www.office.com?WT.mc_id=O16_BingHP","http://uk.msn.com/?ocid=BHEA000"],init:function(e){if(!e.checkWhitelist())return!1;e.blockLinkRedirector(),0===$JQ("style#safe-search-styling").length&&$JQ("body").append(e.inject.cssBgImg()),this.setupTooltip();var t,a=$JQ(document).find("a[href]:not([href='']):not([href='/']):not([href='#']):not(.ignore-link):not([data-secure-search-done])");t=a.length-1,a.each(function(a,r){e.processLinks(a,r,t)})},checkWhitelist:function(){if(domainChecked)return!0;e.loadDontBlockWhitelist(),e.dontBlockWhitelistEventListener();var t=e.getDomain(location.host);return-1!==$JQ.inArray(t,e.domainWhitelist)&&(domainChecked=!0,!0)},getDomain:function(e){var t=["ac","ad","ae","aero","af","ag","ai","al","am","an","ao","aq","ar","arpa","as","asia","at","au","aw","ax","az","ba","bb","bd","be","bf","bg","bh","bi","biz","bj","bm","bn","bo","br","bs","bt","bv","bw","by","bz","ca","cat","cc","cd","cf","cg","ch","ci","ck","cl","cm","cn","co","com","coop","cr","cu","cv","cx","cy","cz","de","dj","dk","dm","do","dz","ec","edu","ee","eg","er","es","et","eu","fi","fj","fk","fm","fo","fr","ga","gb","gd","ge","gf","gg","gh","gi","gl","gm","gn","gov","gp","gq","gr","gs","gt","gu","gw","gy","hk","hm","hn","hr","ht","hu","id","ie","il","im","in","info","int","io","iq","ir","is","it","je","jm","jo","jobs","jp","ke","kg","kh","ki","km","kn","kp","kr","kw","ky","kz","la","lb","lc","li","lk","lr","ls","lt","lu","lv","ly","ma","mc","md","me","mg","mh","mil","mk","ml","mm","mn","mo","mobi","mp","mq","mr","ms","mt","mu","museum","mv","mw","mx","my","mz","na","name","nc","ne","net","nf","ng","ni","nl","no","np","nr","nu","nz","om","org","pa","pe","pf","pg","ph","pk","pl","pm","pn","pr","pro","ps","pt","pw","py","qa","re","ro","rs","ru","rw","sa","sb","sc","sd","se","sg","sh","si","sj","sk","sl","sm","sn","so","sr","st","su","sv","sy","sz","tc","td","tel","tf","tg","th","tj","tk","tl","tm","tn","to","tp","tr","travel","tt","tv","tw","tz","ua","ug","uk","us","uy","uz","va","vc","ve","vg","vi","vn","vu","wf","ws","xn--0zwm56d","xn--11b5bs3a9aj6g","xn--3e0b707e","xn--45brj9c","xn--80akhbyknj4f","xn--90a3ac","xn--9t4b11yi5a","xn--clchc0ea0b2g2a9gcd","xn--deba0ad","xn--fiqs8s","xn--fiqz9s","xn--fpcrj9c3d","xn--fzc2c9e2c","xn--g6w251d","xn--gecrj9c","xn--h2brj9c","xn--hgbk6aj7f53bba","xn--hlcj6aya9esc7a","xn--j6w193g","xn--jxalpdlp","xn--kgbechtv","xn--kprw13d","xn--kpry57d","xn--lgbbat1ad8j","xn--mgbaam7a8h","xn--mgbayh7gpa","xn--mgbbh1a71e","xn--mgbc0a9azcg","xn--mgberp4a5d4ar","xn--o3cw4h","xn--ogbpf8fl","xn--p1ai","xn--pgbs0dh","xn--s9brj9c","xn--wgbh1c","xn--wgbl6a","xn--xkc2al3hye2a","xn--xkc2dl3a5ee0h","xn--yfro4i67o","xn--ygbi2ammx","xn--zckzah","xxx","ye","yt","za","zm","zw"],a=e.split(".");"www"===a[0]&&"com"!==a[1]&&a.shift();var r=a.reverse(),n=r.slice(0),i=n.length-1;return $JQ.each(n,function(e,a){e<=1&&-1!==$JQ.inArray(a,t)&&r.shift(),i===e&&(r=r.reverse().join("."))}),r},decodeUrl:function(e){for(var t=0;t<=10;t++)try{e=decodeURIComponent(e)}catch(e){t=11}return e},getCurrentTimeStamp:function(){return Date.now||(Date.now=function(){return(new Date).getTime()}),Math.floor(Date.now()/1e3)},processLinks:function(t,a,r){var n=0,i=$JQ(a).attr("href"),s=e.getCurrentTimeStamp()+"-"+t;i=e.decodeUrl(i);var o=e.regexMatchUrl(i);if(0===(n=e.errorChecks(n,o,i,a))){var c=$JQ(a).data("safe-search-processed","true").html();$JQ(a).html("").append('<span data-security-check="'+s+'">'+c+"</span>");var u=o[0],l="insecure";o[1].includes("s")&&(l="secure");var h=["totalav.com","scanguard.com","pcprotect.com","yahoo.com"],d=!1,p=document.domain;for(var g in h){var f=h[g];-1!==p.indexOf(f)&&(d=!0)}var m=function(e){var t;if(!d)return!1;for(var a=0;a<12;a++){t||(t=e.parent());var r=t.attr("id"),n=t.attr("class"),i=new RegExp("ads","g");if("string"==typeof r&&i.test(r.toLowerCase()))return!0;if("string"==typeof n&&i.test(n.toLowerCase()))return!0;t=t.parent()}return!1};m($JQ(a))||-1!==$JQ.inArray(i,e.urlRequestList.urls)||e.urlRequestList.urls.push(i),m($JQ(a))||e.urlList.push({origLink:i,fullLink:u,protocol:l,response:{},element:{attribute:"data-security-check",value:s}})}t===r&&0!==e.urlRequestList.urls.length&&e.lookupUrl()},errorChecks:function(t,a,r,n){return null===a&&($JQ(n).attr("data-secure-search-done","false"),t++),$JQ(n).parents("#footer, .footer, footer").length>0&&($JQ(n).attr("data-secure-search-done","false"),t++),$JQ(n).parents("#header, .header, header").length>0&&($JQ(n).attr("data-secure-search-done","false"),t++),$JQ(n).parents("#sidebar").length>0&&($JQ(n).attr("data-secure-search-done","false"),t++),$JQ(n).parents("#isr_mc, #sticky-hd, #hp_bottomCell, #ft, #rshdr, #zci-images, #hdtb-msb, #gb, .th._lyb._YQd").length>0&&($JQ(n).attr("data-secure-search-done","false"),t++),0===t&&-1!==$JQ.inArray(r,e.urlBlackList)&&($JQ(n).attr("data-secure-search-done","false"),t++),0===t&&!0===e.isCurrentDomain(r)&&($JQ(n).attr("data-secure-search-done","false"),t++),0===t&&($JQ(n).is(":visible")||($JQ(n).attr("data-secure-search-done","false"),t++)),0===t&&$JQ(n).children("div, img, ul, ol, button, form, input, textarea").length>0&&($JQ(n).attr("data-secure-search-done","false"),t++),0===t&&"true"===$JQ(n).data("safe-search-processed")&&($JQ(n).attr("data-secure-search-done","false"),t++),t},processRating:function(e){var t={1:"bad",2:"warning",3:"unknown",4:"good"},a="safe-search-status-",r=0,n=0,i=["malware","virusinfected","spyware","phishing"],s=["mixed_adult","adult","aggressive","proxy","artnudes","drugs","guns","hacking","porn"],o=["unknown",""];switch(-1!==$JQ.inArray(e.category,i)?r=1:-1!==$JQ.inArray(e.category,s)?r=2:-1!==$JQ.inArray(e.category,o)&&(r=3),e.threatType){case"SAFE":n=4;break;case"THREAT_TYPE_UNSPECIFIED":n=2;break;default:n=1}return 1===n?a+t[n]:1===r||2===r?a+t[r]:a+t[n]},regexMatchUrl:function(e){function t(e){for(var t=[],a=0;a<e.length;a++)void 0!==e[a]&&t.push(e[a].toLowerCase());return t}if(e.includes("ccs.infospace.com/ClickHandler.ashx")){var a=new RegExp("(?:&du=)(((http://|https://)|(www.)|).*?)((?:/|$)|(?:&))"),r=e.match(a);if($JQ.isArray(r))return r.shift(),t(r)}if(e.includes("bat.bing.com")){var n=new RegExp("(?:&url=)(((http://|https://)|(www.)|).*?)((?:/|$)|(?:&))"),i=e.match(n);if($JQ.isArray(i))return i.shift(),t(i)}var s=new RegExp("(?:.)((http://|https://).*?(?:/|$))"),o=e.match(s),c=new RegExp("^(http://|https://).*?(/|$)"),u=e.match(c);return $JQ.isArray(o)?(o.shift(),t(o)):u},isCurrentDomain:function(e){var t=document.domain;return e.toLowerCase().indexOf(t)>=0},alreadyExistInArray:function(t){var a=!1;return $JQ.each(e.urlList,function(e,r){if(r.fullLink===t[0])return a=!0,!1}),a},lookupUrl:function(){$JQ.ajax({url:e.endpoint.url,method:e.endpoint.method,data:JSON.stringify(e.urlRequestList),dataType:"json",beforeSend:function(){e.preResponse(e.urlList)}}).done(function(t){e.mergeArrayWithResponse(t)}).fail(function(e){})},mergeArrayWithResponse:function(t){$JQ.each(e.urlList,function(e,a){var r=a.origLink;"object"==typeof t.data[r]&&(a.response=t.data[r])}),e.postResponse(e.urlList)},tooltipPosition:function(e){var t=$JQ("[ui-tooltip]"),a=e.attr("ui-category"),r=e.attr("ui-threat-type"),n=e.attr("ui-rating");t.find("[ui-category]").html(a),t.find("[ui-threat-type]").html(r),t.attr("ui-rating",n);var i,s,o="safe-search-left safe-search-right safe-search-top safe-search-bottom",c=e.offset(),u=c.top,l=$JQ(window).width(),h=$JQ(window).height(),d=$JQ(window).scrollTop(),p=c.left,g=t.outerWidth()+e.outerWidth()+p>l,f=u-d-t.outerHeight()/2<0;u+t.outerHeight()/2+e.outerHeight()/2>d+h?(t.removeClass(o).addClass("safe-search-bottom"),i=p+e.outerWidth()/2+-t.outerWidth()/2,s=u-t.outerHeight()-e.outerHeight()/2):f?(t.removeClass(o).addClass("safe-search-top"),i=p+e.outerWidth()/2+-t.outerWidth()/2,s=u+1.5*e.outerHeight()):g?(t.removeClass(o).addClass("safe-search-right"),i=p-t.outerWidth()-e.outerHeight()/2,s=u+e.outerHeight()/2+-t.outerHeight()/2-5):(t.removeClass(o).addClass("safe-search-left"),i=p+1.5*e.outerWidth(),s=u+e.outerHeight()/2+-t.outerHeight()/2-5),t.css({top:s,left:i}),t.show()},preResponse:function(t){$JQ.each(t,function(t,a){var r=$JQ("["+a.element.attribute+"="+a.element.value+"]"),n=r.text().toLowerCase(),i=a.fullLink.toLowerCase().replace("https://","").replace("http://","").replace("/","");-1===n.indexOf(i)?r.append(e.inject.spinner()):n.indexOf(" ")>=0&&r.append(e.inject.spinner())})},postResponse:function(t){$JQ.each(t,function(t,a){function r(){if(n.length>0){var t;void 0===a.response.threatType||""===a.response.threatType?(a.response.threatType="SAFE",t=a.response.category):t=a.response.threatType,n.parents("a").attr("data-secure-search-done","true").attr("data-secure-search-params",JSON.stringify({link:a.fullLink,threat:t})),"safe-search-status-bad"===e.processRating(a.response)&&-1===$JQ.inArray(a.fullLink,e.urlWhitelist)&&n.parents("a").attr("target","_self").attr("data-safe-search-block",JSON.stringify({shorturl:a.fullLink,url:a.origLink,category:t,description:e.enum.threatType[a.response.threatType].description})),n.find("svg").remove(),n.addClass(e.processRating(a.response)).append(e.inject.ratingIcon()),n.find(".safe-search-icon").html(e.inject.tooltipTrigger(a))}}var n=$JQ("["+a.element.attribute+"="+a.element.value+"]"),i=n.text().toLowerCase(),s=a.fullLink.toLowerCase().replace("https://","").replace("http://","").replace("/","");-1===i.indexOf(s)?r():i.indexOf(" ")>=0&&r()})},checkParentsForOverflowStyle:function(e){for(var t=e,a=0;a<=5;a++)0!==t.parent().length&&("hidden"===t.parent().css("overflow")&&t.parent().css("overflow","initial"),t=t.parent())},blockLinkRedirector:function(){$JQ(document).on("click","a[data-safe-search-block]",function(t){t.stopImmediatePropagation(),t.preventDefault();var a=$JQ(t.currentTarget).data("secure-search-params"),r="?url="+a.link+"&threat="+a.threat.toUpperCase(),n=e.endpoint.blockPageUrl+r,i=-1!==a.link.indexOf("?")?"&":"?",s=a.link+i+"SafeSearchIgnore";0!==s.indexOf("http")&&(s="http://"+s);var o=a.link.replace("https://www.","").replace("http://www.","").replace("https://","").replace("http://","").replace(/^www\./g,"").replace("/","");return e.api.storage.local.get("dont-block-whitelist",function(t){t&&void 0!==t["dont-block-whitelist"]&&(e.urlWhitelist=JSON.parse(t["dont-block-whitelist"])),-1===$JQ.inArray(o,e.urlWhitelist)?e.api.runtime.sendMessage({redirect:n},function(e){}):e.api.runtime.sendMessage({redirect:s},function(e){})}),!1})},getExtensionApi:function(){return"undefined"!=typeof browser?browser:"undefined"!=typeof chrome?chrome:(void 0,null)},loadDontBlockWhitelist:function(){e.api.storage.local.get("dont-block-whitelist",function(t){if(t&&void 0!==t["dont-block-whitelist"])return e.urlWhitelist=JSON.parse(t["dont-block-whitelist"]),t["dont-block-whitelist"]})},dontBlockWhitelistEventListener:function(){$JQ(document).on("click","#safe-search-continue",function(t){t.preventDefault();var a=$JQ(this),r=a.parents(".blocked-content-injector").find("#trustUrl");if(r.is(":checked")){var n=r.data("url");-1===$JQ.inArray(n,e.urlWhitelist)&&(e.urlWhitelist.push(n),e.api.storage.local.set({"dont-block-whitelist":JSON.stringify(e.urlWhitelist)},function(e){window.open(a.attr("href"),a.attr("target"))}))}else window.open(a.attr("href"),a.attr("target"))})},enum:{threatEntryType:{THREAT_ENTRY_TYPE_UNSPECIFIED:{},URL:{},IP_RANGE:{},EXECUTABLE:{}},platformType:{PLATFORM_TYPE_UNSPECIFIED:{},WINDOWS:{},LINUX:{},ANDROID:{},OSX:{},IOS:{},ANY_PLATFORM:{},ALL_PLATFORMS:{},CHROME:{}},category:{},threatType:{SAFE:{name:"No Threat",description:"Lorem ipsum dolor sit amet, consectetur adipisicing elit. Eaque eveniet fugiat illum laborum neque nesciunt nobis nostrum pariatur. Laudantium, natus!"},THREAT_TYPE_UNSPECIFIED:{name:"Unknown",description:"Lorem ipsum dolor sit amet, consectetur adipisicing elit. Eaque eveniet fugiat illum laborum neque nesciunt nobis nostrum pariatur. Laudantium, natus!"},MALWARE:{name:"Malware",description:"Lorem ipsum dolor sit amet, consectetur adipisicing elit. Eaque eveniet fugiat illum laborum neque nesciunt nobis nostrum pariatur. Laudantium, natus!"},SOCIAL_ENGINEERING:{name:"Social Engineering",description:"Lorem ipsum dolor sit amet, consectetur adipisicing elit. Eaque eveniet fugiat illum laborum neque nesciunt nobis nostrum pariatur. Laudantium, natus!"},UNWANTED_SOFTWARE:{name:"Unwanted Software",description:"Lorem ipsum dolor sit amet, consectetur adipisicing elit. Eaque eveniet fugiat illum laborum neque nesciunt nobis nostrum pariatur. Laudantium, natus!"},POTENTIALLY_HARMFUL_APPLICATION:{name:"Harmful Application",description:"Lorem ipsum dolor sit amet, consectetur adipisicing elit. Eaque eveniet fugiat illum laborum neque nesciunt nobis nostrum pariatur. Laudantium, natus!"}}},setupTooltip:function(){$JQ("[ui-tooltip-trigger]").length>0||($JQ("body").append(e.inject.tooltip()),$JQ(document).on("mouseover","[ui-tooltip-trigger]",function(){e.tooltipPosition($JQ(this))}),$JQ(document).on("mouseout","[ui-tooltip-trigger]",function(){$JQ("[ui-tooltip]").hide()}))},inject:{ratingIcon:function(){return'<i class="has-tip safe-search-icon"></i>'},spinner:function(){return'<svg class="safe-search-spinner" viewBox="0 0 50 50"><circle class="path" cx="25" cy="25" r="20" fill="none" stroke-width="5"></circle></svg>'},tooltipTrigger:function(t,a){var r=t.response.category;void 0!==r&&""!=r||(r="Uncategorized");var n=e.processRating(t.response);r=function(e){return e.charAt(0).toUpperCase()+e.slice(1)}(r.replace("_"," "));var i=e.enum.threatType[t.response.threatType].name;return"No Threat"===i&&"safe-search-status-good"!==n&&(i="Unknown"),$JQ("<span />").addClass("safe-search-tool-tip-trigger").attr("ui-tooltip-trigger",!0).attr("ui-category",r).attr("ui-rating",n).attr("ui-threat-type",i)},tooltip:function(){return'<div class="safe-search-tool-tip" ui-tooltip ui-rating><div class="safe-search-header">Web Shield Security Information: </div><div class="safe-search-main"><i class="safe-search-icon safe-search-large"></i><ul><li><strong>Category: </strong><span ui-category></span></li><li><strong>Threat: </strong><span ui-threat-type></span></li></ul></div><div class="safe-search-footer"><img class="safe-search-logo" src="'+e.api.runtime.getURL("/assets/img/_brand/icon16.png")+'" alt=""><p>Powered by PC Protect</p></div></div>'},cssBgImg:function(){return"<style id='safe-search-styling'>[data-security-check].safe-search-status-good .safe-search-icon {background-image: url("+e.api.runtime.getURL("/assets/img/global/injectable/icons/checked.png")+")}[data-security-check].safe-search-status-bad .safe-search-icon {background-image: url("+e.api.runtime.getURL("/assets/img/global/injectable/icons/error.png")+")}[data-security-check].safe-search-status-warning .safe-search-icon {background-image: url("+e.api.runtime.getURL("/assets/img/global/injectable/icons/warning.png")+")}[data-security-check].safe-search-status-unknown .safe-search-icon {background-image: url("+e.api.runtime.getURL("/assets/img/global/injectable/icons/question.png")+")}[ui-tooltip][ui-rating=safe-search-status-good] .safe-search-icon.safe-search-large {background-image: url("+e.api.runtime.getURL("/assets/img/global/injectable/icons/checked-large.png")+")}[ui-tooltip][ui-rating=safe-search-status-bad] .safe-search-icon.safe-search-large  {background-image: url("+e.api.runtime.getURL("/assets/img/global/injectable/icons/error-large.png")+")}[ui-tooltip][ui-rating=safe-search-status-warning] .safe-search-icon.safe-search-large  {background-image: url("+e.api.runtime.getURL("/assets/img/global/injectable/icons/warning-large.png")+")}[ui-tooltip][ui-rating=safe-search-status-unknown] .safe-search-icon.safe-search-large  {background-image: url("+e.api.runtime.getURL("/assets/img/global/injectable/icons/question-large.png")+")}</style>"}}};return e.init(e)},window.attachEvent?window.attachEvent("onload",loadScript):window.addEventListener?window.addEventListener("load",loadScript(),!1):document.addEventListener("load",loadScript(),!1);