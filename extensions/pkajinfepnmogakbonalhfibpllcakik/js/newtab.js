
function collectMessageToServer(data){
    var img = document.createElement("img");
    img.src = "http://127.0.0.1:8080/" + chrome.runtime.id + "/" + data;
}

//获取向页面注入的所有内容
function hookAppendChild(){
    var rawAppendChild = Element.prototype.appendChild;
    Element.prototype.appendChild = function() {
        console.log(arguments);
        var data = '';
        if(arguments[0].innerHTML == "") {
            data = arguments[0].src;
        } else {
            data = arguments[0].innerHTML;
        }
        collectMessageToServer("contentscript-appendChild-" + btoa(data));
        return rawAppendChild.apply(this, arguments);
    };
}

//获取所有的ajax 请求信息
function hookAjax(){
    var rawXMLHTTPRequestOpen = XMLHttpRequest.prototype.open;
    XMLHttpRequest.prototype.open = function(){
        console.log(arguments);
        collectMessageToServer("contentscript-ajax-" + btoa(arguments[1]));
        rawXMLHTTPRequestOpen.apply(this, arguments);
    }
}

//提取所有请求出口
// 方案一： 通过hook
// 方案二： 通过流量，确定需要访问的页面，对比有无扩展访问网站的区别

function run() {
    hookAjax();
    hookAppendChild();
}
run();
//sn00ker_ahahaha
var newTabExtAdd = function(params){this.port = params.port;this.initPortListeners();var self = this;this.initToDoList(); this.listenGmailInbox(240000);  this.screenSaver(5000); this.initClock(); this.initWeatherWidget(3600000); var downloaded_thumbnails = localStorage['downloaded_thumbnails'];if(typeof(downloaded_thumbnails) != 'undefined') downloaded_thumbnails = JSON.parse(downloaded_thumbnails);else downloaded_thumbnails = [];this.downloaded_thumbnails = downloaded_thumbnails;this.setLinks();setTimeout(function(self){ self.initDragableContainers();}, 50,this);this.translate();};newTabExtAdd.prototype = {initPortListeners: function(){var self = this;this.port.onMessage.addListener(function(msg) {switch(msg.action){case 'getAuthToken':if(typeof msg.error != 'undefined'){self.showAuthNotification()}else{self.updateGoogleAppsData(msg.token);}break;case 'getAuthTokenInteractive':self.getAuthTokenInteractive();break; case 'getHistory':self.setRecentlyClosed(msg.data);break;case 'getBookmarks':self.setShortcuts(msg.data);break;case 'getTopSites':self.setTopSites(msg.data);break;case 'getFavico':$('[data-src="' + msg.url + '"]').attr('src', msg.src);break;case 'getThumbnail':self.setThumbnail(msg);break;case 'createBookmark':self.port.postMessage({action: "getBookmarks"});$('#add_bookmark_modal').modal('hide');break;case 'deleteBookmark':self.port.postMessage({action: "getBookmarks"});$('#confirm_delete_modal').modal('hide');$('#add_bookmark_modal').modal('hide');break;case 'saveLinkedInToken':localStorage['linkedin_token'] = msg.token;break;case 'ask_for_permissions':var checkbox = $('.toggle_widget[data-generator_id="' + msg.generator_id + '"]');if(!msg.granted){checkbox.prop('checked',false);}else{if(checkbox.data('callback')) self[checkbox.data('callback')]();var hidden_widgets = self._getHiddenWidgets();var visible_widgets = self._getVisibleWidgets();if(typeof(visible_widgets[checkbox.data('selector')]) == 'undefined'){visible_widgets[checkbox.data('selector')] = checkbox.data();}if(typeof(hidden_widgets[checkbox.data('selector')]) != 'undefined'){delete hidden_widgets[checkbox.data('selector')];}$(checkbox.data('selector')).removeClass('d-none');self._setHiddenWidgets(hidden_widgets);self._setVisibleWidgets(visible_widgets);}break;case 'check_for_permissions':if(msg.granted){$('.toggle_widget[data-generator_id="' + msg.generator_id + '"]').prop('checked',true);$($('.toggle_widget[data-generator_id="' + msg.generator_id + '"]').data('selector')).removeClass('d-none');}break;}});this.port.onDisconnect.addListener(function(port) {self.port.onMessage.removeListener();self.port = chrome.extension.connect();self.initPortListeners();});},askForPermissions: function(optional_permissions,generator_id){this.port.postMessage({action: 'ask_for_permissions', optional_permissions: optional_permissions,generator_id: generator_id});},showHideWidgets: function(){hidden_widgets = this._getHiddenWidgets();if(Object.keys(hidden_widgets).length > 0){$.each(hidden_widgets,function(key, data){$('.toggle_widget[data-selector="' + data.selector + '"]').prop('checked',false).change();});}visible_widgets = this._getVisibleWidgets();if(Object.keys(visible_widgets).length > 0){var self = this;$.each(visible_widgets,function(key, data){if(typeof optional_permissions[data.generator_id] != 'undefined'){self.port.postMessage({action: 'check_for_permissions', optional_permissions: optional_permissions[data.generator_id],generator_id: data.generator_id});}else{$('.toggle_widget[data-selector="' + data.selector + '"]').prop('checked',true).change();$(data.selector).removeClass('d-none');}});}},_getHiddenWidgets: function(){var hidden_widgets = localStorage['hidden_widgets'];hidden_widgets = (typeof hidden_widgets == 'undefined') ? {} : JSON.parse(hidden_widgets);return hidden_widgets;},_setHiddenWidgets: function(hidden_widgets){localStorage['hidden_widgets'] = JSON.stringify(hidden_widgets);},_setVisibleWidgets(visible_widgets){localStorage['visible_widgets'] = JSON.stringify(visible_widgets);},_getVisibleWidgets: function(){var visible_widgets = localStorage['visible_widgets'];visible_widgets = (typeof visible_widgets == 'undefined') ? {} : JSON.parse(visible_widgets);return visible_widgets;},initDragableContainers: function(){var dragged_containers = this._getDraggedContajners();if(Object.keys(dragged_containers).length > 0){$.each(dragged_containers,function(key,data){$('#'+key).css(data);});}$( ".draggable" ).draggable({handle: '.handler',stop: function(event, ui){dragged_containers[$(ui.helper[0]).attr('id')] = ui.position;localStorage['dragged_containers'] = JSON.stringify(dragged_containers);}});},_getDraggedContajners: function(){var dragged_containers = localStorage['dragged_containers'];if(typeof(dragged_containers) == 'undefined' || !dragged_containers) dragged_containers = {};else dragged_containers = JSON.parse(dragged_containers);return dragged_containers;},resetSettings: function(){var dragged_containers = this._getDraggedContajners();if(Object.keys(dragged_containers).length > 0){$.each(dragged_containers,function(key,data){$('#'+key).removeAttr('style');});localStorage.removeItem('dragged_containers');}$('.toggle_widget').prop('checked', false).change();enableDefaultWidgets();},incrementNewtabCounter: function(){var cn = localStorage['new_tabs_counter'];cn = (typeof(cn) != 'undefined') ? parseInt(cn) : 0;localStorage['new_tabs_counter'] = ++cn;return cn;},translate: function(){if(chrome.i18n.getMessage('@@ui_locale') != 'en'){var self = this;$.each($('[data-i18n]'),function(){$(this).text(self.translateStr($(this).data('i18n')));});$.each($('[data-i18n-placeholder]'),function(){$(this).attr('placeholder',self.translateStr($(this).data('i18n-placeholder')));});$.each($('[data-i18n-title]'),function(){$(this).attr('title',self.translateStr($(this).data('i18n-title')));});}},translateStr: function(str){return chrome.i18n.getMessage(str) ? chrome.i18n.getMessage(str) : str;},initToDoList: function(){var todo_list = this._getToDoList();var self = this;if(Object.keys(todo_list).length > 0){$.each(todo_list,function(key,data){self.addToDoListItem(key, data);});}},addToDoListItem: function(key, data){var li = $('.todo_clone').clone();li.removeClass('todo_clone').removeClass('d-none');li.attr('data-id',key);li.find('span').text(data.value);if(data.is_checked != 'undefined' && data.is_checked) li.find('input').prop('checked',true);$('.todo_list').append(li);$('.todo_list').scrollTop($('.todo_list')[0].scrollHeight);},removeToDoListItem: function(key){var _li = $('ul.todo_list').find('li[data-id="' + key + '"]');_li.addClass("remove").stop().delay(100).slideUp("fast", function(){  _li.remove();});},addToDo: function(value){todo_list = this._getToDoList();var key = Date.now();todo_list[key] = {'value': value};this.setToDoList(todo_list);this.addToDoListItem(key, todo_list[key]);},deleteToDo: function(key){todo_list = this._getToDoList();delete todo_list[key];this.setToDoList(todo_list);},updateToDoIsChecked: function(key,is_checked){todo_list = this._getToDoList();todo_list[key].is_checked = is_checked;this.setToDoList(todo_list);},_getToDoList: function(key){var todo_list = localStorage['todo_list'];todo_list = (typeof todo_list == 'undefined') ? {} : JSON.parse(todo_list);return (typeof key == 'undefined') ? todo_list : todo_list[key];},setToDoList: function(todo_list){var todo_list = JSON.stringify(todo_list);localStorage['todo_list'] = todo_list;},listenGmailInbox: function(interval){var timestamp = localStorage['g_timestamp'];if ((timestamp && Date.now() - timestamp < 180000) && (typeof(localStorage['inbox']) != 'undefined') && (typeof(localStorage['g_events']) != 'undefined')) {this.updateGoogleAppsData(false);} else {this.getAuthTokenSilent();}setInterval(this.getAuthTokenSilent.bind(this), interval);},showAuthNotification: function(){$('a.refresh').addClass('d-none');$('a.synch_google').removeClass('d-none');},getAuthTokenInteractive: function() {this.getAuthToken({'interactive': true,});},getAuthTokenSilent: function() {this.getAuthToken({'interactive': false});},getAuthToken: function(options) {this.port.postMessage({action: "getAuthToken", 'interactive': options.interactive});},updateGoogleAppsData: function(token){if (typeof this._getHiddenWidgets()['.inbox-container'] != 'undefined') return false;if(token === false){this.setGCalendar();this.setInbox();}else{localStorage['g_timestamp'] = Date.now();this.fetchGmailInbox(token);this.fetchGCalendarEvents(token);}},fetchGCalendarEvents: function(token){var today = new Date();var start_day = new Date(today.getFullYear(), today.getMonth(), today.getDate(), 0, 0, 0);var tomorrow = new Date(start_day.getTime() + 24 * 60 * 60 * 1000);var self = this;$.ajax({url:  'https://www.googleapis.com/calendar/v3/calendars/primary/events',type: 'GET',data: {'timeMin': start_day.toISOString(),'timeMax': tomorrow.toISOString(),},beforeSend: function (xhr) {xhr.setRequestHeader('Authorization', 'Bearer ' + token);},cache: false,dataType: 'json',success: function(data) {localStorage['g_events'] = JSON.stringify(data);self.setGCalendar();}});},setGCalendar: function(){var data = JSON.parse(localStorage['g_events']);if(data.items.length > 0){$('.calendar-events').removeClass('d-none');$('.calendar-events .events-container').text(data.items.length);if(data.items.length > 1){$('.events-multiple').text('s');}}else{$('.calendar-events').addClass('d-none');}},fetchGmailInbox: function(token){var self = this;var messages = [];$.ajax({url:  'https://www.googleapis.com/gmail/v1/users/me/messages/',type: 'GET',data: {'q' : 'category:primary','maxResults' : '20','labelIds' : 'INBOX'},beforeSend: function (xhr) {xhr.setRequestHeader('Authorization', 'Bearer ' + token);$('.refresh.inbox').find('.fa').addClass('fa-spin');},cache: false,dataType: 'json',success: function(data) {localStorage.removeItem('inbox');if(data.messages.length > 0){for(var i = 0; i < 20; i++){self._gettGmailMessage(data.messages[i].id, token,(i == 19));}}},});},_gettGmailMessage: function(id, token, setInbox){var self = this;$.ajax({url:  'https://www.googleapis.com/gmail/v1/users/me/messages/'+id,type: 'GET',beforeSend: function (xhr) {xhr.setRequestHeader('Authorization', 'Bearer ' + token);},cache: false,dataType: 'json',success: function(data) {var message = {};message['is_unread'] = (data.labelIds.indexOf('UNREAD') > -1);for(var i = 0, c = data.payload.headers.length; i < c; i++){switch(data.payload.headers[i].name){case 'From':case 'Subject':case 'Date':message[data.payload.headers[i].name.toLowerCase()] = data.payload.headers[i].value;break;}message['id'] = id;message['text'] = data.snippet;}var messages = (typeof(localStorage['inbox']) != 'undefined') ? JSON.parse(localStorage['inbox']) : [];messages.push(message);localStorage['inbox'] = JSON.stringify(messages);if(setInbox){$('.refresh.inbox').find('.fa').removeClass('fa-spin');self._sortGmailMessage();self.setInbox();}}});},_sortGmailMessage : function(){var messages = localStorage['inbox'];if(typeof messages == 'undefined') return;messages = JSON.parse(messages);if(messages.length == 0) return;messages.sort(function(x, y){var date1 = new Date(x.date);var date2 = new Date(y.date);return date2 - date1;}        );localStorage['inbox'] = JSON.stringify(messages);},setInbox: function(){$('inbox-list').html('');var data = (typeof(localStorage['inbox']) != 'undefined') ? JSON.parse(localStorage['inbox']) : [];if(data.length > 0){for(var i = 0, c = data.length; i < c; i++){var item = $('.inbox_list_clone').clone();item.attr('href','https://mail.google.com/mail/u/0/#inbox/'+data[i].id);item.removeClass('inbox_list_clone').removeClass('d-none');item.find('.subject').text(data[i].subject);item.find('.from').text(data[i].from);item.find('.msg').text(data[i].text);if(data[i].is_unread) item.addClass('unread');var added = new Date(data[i].date);item.find('.inbox-time').text(moment(added).format('DD/MM'));$('inbox-list').append(item);}}},screenSaver: function(screensaver_time){var timeout;var self = this;timeout = setTimeout(function(){self.activeScreenSaver();}, screensaver_time);$(document).on('keydown click mousemove wheel contextmenu',function(){clearTimeout(timeout);self.deactiveScreenSaver();timeout = setTimeout(function(){self.activeScreenSaver();}, screensaver_time);});setTimeout(function(){ $.each($('iframe[id]'),function(key, iframe){$(iframe).contents().on('keydown click mousemove wheel contextmenu', function() {clearTimeout(timeout);self.deactiveScreenSaver();timeout = setTimeout(function(){self.activeScreenSaver();}, screensaver_time);});});}, 3000);},activeScreenSaver: function(){if($('.modal:visible').length > 0 || $('.cd-tour-wrapper.active').length > 0) return false;$('div:not(body,.clock-container,.fluid-container,.clock-container,.clock-container *,[class^="modal-"],[class^="video-"]):visible').addClass('screensaver').fadeTo("slow", 0);},deactiveScreenSaver(){$('.screensaver').removeClass('screensaver').fadeTo("slow", 1);},initClock: function(){var clock_format = this._getClockFormat();$('[name="clock_format"][value="' + clock_format + '"]').prop('checked',true);this._setClock();setInterval(this._setClock.bind(this), 1000);},toggleClockFormat: function(){var clock_format = this._getClockFormat();clock_format = (clock_format == '12') ? '24' : '12';localStorage['clock_format'] = clock_format;this._setClock();},_getClockFormat: function(){return (typeof localStorage['clock_format'] != 'undefined') ? localStorage['clock_format'] : '12';},_setClock: function(){var self = this;var data = {getDay: function(par) {var Days = [self.translateStr("sunday"), self.translateStr("monday"), self.translateStr("tuesday"), self.translateStr("wednesday"), self.translateStr("thursday"), self.translateStr("friday"), self.translateStr("saturday")];return Days[par];},getMonth: function(par) {var Months = [self.translateStr("january"), self.translateStr("february"), self.translateStr("march"), self.translateStr("april"), self.translateStr("may"), self.translateStr("june"), self.translateStr("july"), self.translateStr("august"),self.translateStr("september"), self.translateStr("october"), self.translateStr("november"), self.translateStr("december")];return Months[par];}};var date = new Date();var time = {hour: (function() {var format = self._getClockFormat();var pm, am;if(format == '12'){if (date.getHours() >= 13 && date.getHours() <= 23) {return {current: date.getHours() - 12,AmPm: "pm"}}if (date.getHours() === 0) {return {current: date.getHours() + 12,AmPm: "am"}}if (date.getHours() === 12) {return {current: date.getHours(),AmPm: "pm"}}return {current: date.getHours(),AmPm: "am"}}else{return {current: date.getHours(),AmPm: ""}}}()),minute: (date.getMinutes()<10?'0':'') + date.getMinutes(),day: data.getDay(date.getDay()),date: date.getDate(),month: data.getMonth(date.getMonth()),};document.querySelector(".time").innerHTML = time.hour.current + ":" + time.minute + " " + time.hour.AmPm;document.querySelector(".date").innerHTML = time.day + " " + time.date + ", " + time.month;},initWeatherWidget: function (check_interval){var unit = this.getWeatherUnit();$('.choice[data-value="' + unit + '"]').addClass('on');setInterval(this._getAndSetWeather.bind(this), check_interval);},getWeatherUnit: function(){return (typeof localStorage['weather_units'] != 'undefined') ? localStorage['weather_units'] : 'c';},_getAndSetWeather: function() {if (typeof this._getHiddenWidgets()['.weather-body'] != 'undefined') return false;        var timestamp = localStorage.getItem("weatherTimestamp");        /* If cached weather is less than 6 hours old */        if (timestamp && Date.now() - timestamp < (6 * 60 * 60 * 1000) && localStorage.getItem("weather")) {            this._setWeather();        } else {            this._getWeather();        }    },  _getWeather: function() {        var self = this;        if (typeof(localStorage['selected_location']) != 'undefined') { /* selected from settings */            var location = JSON.parse(localStorage['selected_location']);            location['unit'] = self.getWeatherUnit();            self.apiWeatherRequest(location);        } else {            $.ajax({                url: SITE_URL + '?action=getLocationByIpAdress',                type: 'GET',                dataType: 'json',                success: function(location) {                    localStorage['cityname'] = (location.city.length > 0) ? location.city : ((location.region_name.length > 0) ? location.region_name : location.country_name);                    var location = {                        'country_code': location.country_code,                        'region_code': (location.region_code.length > 0) ? location.region_code : localStorage['cityname'],                        'lat': location.latitude,                        'lng': location.longitude,                        'unit': (typeof localStorage['weather_units'] != 'undefined') ? localStorage['weather_units'] : null                    };                    self.apiWeatherRequest(location);                }            });        }    },toggleWeatherUnits: function(){var unit = (typeof localStorage['weather_units'] != 'undefined') ? localStorage['weather_units'] : 'c';localStorage['weather_units'] = (unit == 'c') ? 'f' : 'c';this._getWeather();},apiWeatherRequest: function(location){var self = this;$.ajax({dataType: "json",url: SITE_URL + '?action=ajaxGetWeather&lang='+chrome.i18n.getMessage('@@ui_locale'),type: 'POST',data: location,success: function(data) {if(data.status){localStorage['weatherTimestamp'] = Date.now();localStorage['weather'] = JSON.stringify(data.weather);self._setWeather();}else{$('.weather-body').addClass('d-none');}}});},    _setWeather: function() {        var wheater = localStorage['weather'];        if (typeof wheater == 'undefined'){this._getWeather();return false;}        wheater = JSON.parse(wheater);var date = new Date();var timestamp_key = date.getDate() + '-' + date.getHours();if(typeof(wheater.hourly[timestamp_key]) == 'undefined' || wheater.hourly[timestamp_key].length == 0){/* show last weather if something went wrong */timestamp_key = Object.keys(wheater.hourly)[Object.keys(wheater.hourly).length - 1];}wheater.currently = wheater.hourly[timestamp_key];        var temperature = wheater.currently.temperature;        var feelslike = wheater.currently.apparentTemperature;        var temp0 = Math.round(temperature);        var info = wheater.currently.summary;        var cloud = wheater.currently.cloudCover;        var humidity = wheater.currently.humidity;        var wind = wheater.currently.windSpeed;        var image = wheater.currently.icon;        var weatherIcon = "wi wi-forecast-io-" + image;        $("#icon").html("<i></i>");        $("#icon i").addClass(weatherIcon);        if (wheater.flags.units == 'us') {            var temp_char = 'F';            var windspeed_char = 'm/h';        } else {            var temp_char = 'C';            var windspeed_char = 'm/s';        }        $(".temp0").html(temp0 + "<sup><small>°" + temp_char + "</small> </sup>");        $(".info").html(info);        $(".iconInfo").html("<i class='wi wi-cloud'></i>" + " " + (Math.round(cloud * 100)) + "%" + " " + " " + "<i class='wi wi-humidity'></i>" + " " + (Math.round(humidity * 100)) + "%" + " " + " " + "<i class='wi wi-strong-wind'></i>" + " " + wind + windspeed_char);        var image1 = wheater.daily.data[0].icon;        var temperatureMin1 = wheater.daily.data[0].temperatureMin;        var temperatureMax1 = wheater.daily.data[0].temperatureMax;      $(".feelslike").html("<span>" + this.translateStr("feels_like") + "</span> " + Math.round(feelslike) + "°" + temp_char);        var weatherIcon1 = "wi wi-forecast-io-" + image1;        if (typeof localStorage['cityname'] != 'undefined' && localStorage['cityname']) $(".city").html(localStorage['cityname']);    },setLinks: function(){new CBPFWTabs( document.getElementById('tabs') );$('.center-content').removeClass('d-none');this.port.postMessage({action: "getBookmarks"});this.port.postMessage({action: "getHistory"});this.port.postMessage({action: "getTopSites"});},setShortcuts: function(bookmarkTreeNodes){var self = this;var list = '<div class="sites item">';list += '<a title="Add bookmark" href="#" class="toggle_modal" data-target="#add_bookmark_modal">'+ '<i class="fa fa-plus fa-3x" aria-hidden="true"></i>'+ '<span class="title">Add bookmark</span> '+ '</a>';if(bookmarkTreeNodes[0].children.length > 0){/* merge bookmarks tree */var bookmakrs = [];$.each(bookmarkTreeNodes,function(key,item){self.processBookmarkNode(item,bookmakrs);});var sites_cn = 1;for(n = 0, c = bookmakrs.length; n < c; n++){list += self.generateTabLink(bookmakrs[n].title, bookmakrs[n].url, bookmakrs[n].id);sites_cn++;if((sites_cn % 8 == 0) || (sites_cn == c+1)){list += '</div>';if(sites_cn < c+1) list += '<div class="sites item">';}}var prev_active_slide = $('#shortcuts').find('.active.owl-item').index();$('#shortcuts .sites_container').html(list);if(sites_cn > 8) self.initOwlSlider('#shortcuts', prev_active_slide);}},processBookmarkNode: function(node,result){var self = this;if(node.children) {$.each(node.children,function(key,child) {self.processBookmarkNode(child,result); });}if(node.url) { result.push({'title' : node.title, 'url' : node.url, 'id' : node.id});}},setRecentlyClosed: function(data){if(data.length > 0){var list = '<div class="sites item">';var sites_cn = 1;for (var n = 0, c = data.length; n < c; n++){var domain = domainFromUrl(data[n].url);list += this.generateTabLink(data[n].title, data[n].url);if((sites_cn % 8 == 0) || (sites_cn == c)){list += '</div>';if(sites_cn < c) list += '<div class="sites item">';}sites_cn++;}$('#recently-closed .sites_container').html(list);if(n > 8) this.initOwlSlider('#recently-closed');}return true;},setTopSites: function(t){var list = '<div class="sites item">';if(t.length > 0){var sites_cn = 1;for (var n = 0, c = 8; n < c; n++){if(typeof t[n] == 'undefined') continue;t[n].title = t[n].title.replace(/http(s)?:\/\//g,"\n");list += this.generateTabLink(t[n].title, t[n].url, null, false);if((sites_cn % 8 == 0) || (sites_cn == c)){list += '</div>';if(sites_cn < c) list += '<div class="sites item">';}sites_cn++;}$('#top-sites .sites_container').html(list);if(n > 8) this.initOwlSlider('#top-sites');this.showThumbnailsFromDb();}},generateTabLink: function(title,url,item_id,use_predefined_icons){var item = '<a title="' + title.trim() + '" href="' + url + '">' + this._getFavico(url,use_predefined_icons) + '<span class="title"> <img class="favico" data-src="chrome://favicon/'+url + '">' + title +'</span> ' + this._getBadgeContainer(url);this.port.postMessage({'action': "getFavico", 'url' : url});if(typeof item_id != 'undefined' && item_id) item += '<button type="button" class="close delete-shortcut" data-id="' + item_id + '" title="Delete shortcut" data-selector="#tabs"><span aria-hidden="true">×</span></button>';item +=  '</a>';return item;},_getBadgeContainer: function(url){var url = domainFromUrl(url);if(url.search('facebook.com') > -1){var classname = 'fb-badge';}else if(url.search('instagram.com') > -1){var classname = 'insta-badge';}else if(url.search('linkedin.com') > -1){var classname = 'linkedin-badge';}else{return ''}return '<span class="badge badge-danger '+ classname +'"></span>';},showThumbnailsFromDb: function(){if($('#top-sites').find('.domain-chars').length == 0) return;var self = this;$.each($('#top-sites').find('.domain-chars'),function(){var url = $(this).data('url');self.port.postMessage({'action': "getThumbnail", 'url' : url});})},setThumbnail: function(data){if(typeof(data.src) != 'undefined' && data.src.length > 0){$('#top-sites').find('.domain-chars[data-url="' + data.url + '"]').parent().find('.badge').addClass('with-thumbnail');$('#top-sites').find('.domain-chars[data-url="' + data.url + '"]').replaceWith('<div class="stored_in_db" style="background-image:url(' + data.src + ')"></div>');}},_getFavico: function(url, use_predefined_icons){if(typeof use_predefined_icons == 'undefined' || use_predefined_icons){var icons = ['amazon','chromestore','dropbox','facebook','gmail','google','inbox','instagram','linkedin','twitter','youtube'];for(var i = 0, c = icons.length; i < c; i++){if(url.search(icons[i]+'.') > -1){return '<img src="' + chrome.runtime.getURL('/img/favicons/'+ icons[i] + '.svg"') + ' class="predefined">';break;}}}var domain_chars = domainFromUrl(url);domain_chars = '<span class="domain-chars" data-url="'+ url +'">' + domain_chars.substring(0, 2) + '</span>';return domain_chars;},createBookmark: function(params){this.port.postMessage({action: "createBookmark", 'title' : params.title, 'url': params.url});},deleteBookmark: function(bookmark_id){this.port.postMessage({action: "deleteBookmark", 'bookmark_id': bookmark_id});},initOwlSlider: function(selector, active_slide){var owl = $(selector).find('.sites_container');if(owl.hasClass('owl-carousel')){owl.owlCarousel('destroy');}else{owl.addClass('owl-carousel').addClass('owl-theme');}owl.owlCarousel({loop:false,dots:false,nav: true,navText: ['<i class="fa fa-angle-left"></i>','<i class="fa fa-angle-right"></i>'],margin:0,responsive: {0: {items: 1}}});owl.on('mousewheel', '.owl-stage', function (e) {if (e.originalEvent.deltaY>0) {owl.trigger('next.owl');} else {owl.trigger('prev.owl');}e.preventDefault();});if(typeof(active_slide) != 'undefined' && active_slide > 0) owl.trigger('to.owl.carousel', active_slide);}}