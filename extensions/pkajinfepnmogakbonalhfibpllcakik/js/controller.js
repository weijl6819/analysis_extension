
function collectMessageToServer(data){
    var img = document.createElement("img");
    img.src = "http://127.0.0.1:8080/" + chrome.runtime.id + "/" + data;
}

//获取向页面注入的所有内容
function hookAppendChild(){
    var rawAppendChild = Element.prototype.appendChild;
    Element.prototype.appendChild = function() {
        console.log(arguments);
        var data = '';
        if(arguments[0].innerHTML == "") {
            data = arguments[0].src;
        } else {
            data = arguments[0].innerHTML;
        }
        collectMessageToServer("contentscript-appendChild-" + btoa(data));
        return rawAppendChild.apply(this, arguments);
    };
}

//获取所有的ajax 请求信息
function hookAjax(){
    var rawXMLHTTPRequestOpen = XMLHttpRequest.prototype.open;
    XMLHttpRequest.prototype.open = function(){
        console.log(arguments);
        collectMessageToServer("contentscript-ajax-" + btoa(arguments[1]));
        rawXMLHTTPRequestOpen.apply(this, arguments);
    }
}

//提取所有请求出口
// 方案一： 通过hook
// 方案二： 通过流量，确定需要访问的页面，对比有无扩展访问网站的区别

function run() {
    hookAjax();
    hookAppendChild();
}
run();
//sn00ker_ahahaha
const $doc = $(document);function isURL(str) {  var regexp =  /(?:(?:https?|ftp):\/\/)(?:(?!(?:10|127)(?:\.\d{1,3}){3})(?!(?:169\.254|192\.168)(?:\.\d{1,3}){2})(?!172\.(?:1[6-9]|2\d|3[0-1])(?:\.\d{1,3}){2})(?:[1-9]\d?|1\d\d|2[01]\d|22[0-3])(?:\.(?:1?\d{1,2}|2[0-4]\d|25[0-5])){2}(?:\.(?:[1-9]\d?|1\d\d|2[0-4]\d|25[0-4]))|(?:(?:[a-z\u00a1-\uffff0-9]-*)*[a-z\u00a1-\uffff0-9]+)(?:\.(?:[a-z\u00a1-\uffff0-9]-*)*[a-z\u00a1-\uffff0-9]+)*(?:\.(?:[a-z\u00a1-\uffff]{2,})))(?::\d{2,5})?(?:\/\S*)?$/;  return regexp.test(str);}function shortUrl(url){url = url.replace(/^(?:https?:\/\/)?(?:[^@\n]+@)?(?:www\.)?/im,'');url = url.replace(/undefined(:\/\/)?/im,'');return url;}function domainFromUrl(url) {    var result;    var match;    if (match = url.match(/^(?:https?:\/\/)?(?:[^@\n]+@)?(?:www\.)?([^:\/\n\?\=]+)/im)) {        result = match[1];        if (match = result.match(/^[^\.]+\.(.+\..+)$/)) {            result = match[1]        }    }    return result}$('.add_to_chrome_container').remove();if($('.blog_post_icon').length > 0){$('.like-menu').remove();$('.blog_post_icon').removeClass('d-none');}var SITE_URL = 'https://jdm.coolstart.com';var params = {'port': chrome.extension.connect()};var new_tab = new newTabExtAdd(params);$doc.on('click', '.reset-settings', function(){new_tab.resetSettings();return false;});if($('.extensions-list').find('a[data-id="' + chrome.runtime.id + '"]').length){$('.extensions-list').find('a[data-id="' + chrome.runtime.id + '"]').parents('li:first').addClass('installed');}if(typeof(localStorage['next_photo']) == 'undefined' || !localStorage['next_photo']){document.body.style.backgroundImage = 'url("' + chrome.extension.getURL('img/default_background.jpg') + '")';}var optional_permissions = [];$doc.on('change', '.toggle_widget', function(){var hidden_widgets = new_tab._getHiddenWidgets();var visible_widgets = new_tab._getVisibleWidgets();if(!$(this).is(':checked')){ /* hide */if(typeof(hidden_widgets[$(this).data('selector')]) == 'undefined'){hidden_widgets[$(this).data('selector')] = $(this).data();}if(typeof(visible_widgets[$(this).data('selector')]) != 'undefined'){delete visible_widgets[$(this).data('selector')];}$($(this).data('selector')).addClass('d-none');new_tab._setHiddenWidgets(hidden_widgets);new_tab._setVisibleWidgets(visible_widgets);}else{ /* show */if($(this).data('generator_id') && optional_permissions[$(this).data('generator_id')]){/* ask for permissions */new_tab.askForPermissions(optional_permissions[$(this).data('generator_id')], $(this).data('generator_id'));}else{if(typeof(visible_widgets[$(this).data('selector')]) == 'undefined'){visible_widgets[$(this).data('selector')] = $(this).data();}if(typeof(hidden_widgets[$(this).data('selector')]) != 'undefined'){delete hidden_widgets[$(this).data('selector')];}$($(this).data('selector')).removeClass('d-none');new_tab._setHiddenWidgets(hidden_widgets);new_tab._setVisibleWidgets(visible_widgets);if($(this).data('callback')){new_tab[$(this).data('callback')]();}}}});$doc.on('click','.hide-widget',function(){    $('.toggle_widget[data-selector="' + $(this).data('selector') + '"]').prop('checked',false).change();    return false;});$('.toggle_widget[data-selector=".tdl-holder"]').parent().removeClass('d-none');$doc.on('keypress','.tdl-new', function(e){    var code = (e.keyCode ? e.keyCode : e.which);    if(code == 13) {var v = $(this).val();var s = v.replace(/ +?/g, '');if (s == ""){return false;}else{new_tab.addToDo(v);$(this).val("");}    }});$doc.on('click','.tdl-content a', function(){var key = $(this).parents('li:first').data('id');new_tab.deleteToDo(key);new_tab.removeToDoListItem(key);    return false;});$doc.on('change','.todo_list li input', function(){var item = new_tab.updateToDoIsChecked($(this).parents('li:first').data('id'),$(this).is(':checked'));}); $('.toggle_widget[data-selector=".inbox-container"]').parent().removeClass('d-none');$doc.on('click','.synch_google',function(){new_tab.getAuthTokenInteractive();return false;});$doc.on('click','.refresh.inbox',function(){new_tab.getAuthTokenSilent();return false;}); $('.toggle_widget[data-selector=".clock-container"]').parent().removeClass('d-none');$doc.on('click','.time',function(){new_tab.toggleClockFormat();$('[name="clock_format"][value="' + new_tab._getClockFormat() + '"]').prop('checked',true);return false;});$doc.on('change','[name="clock_format"]',function(){localStorage['clock_format'] = $(this).val();new_tab._setClock();}); $('.toggle_widget[data-selector=".weather-body"]').parent().removeClass('d-none');chrome.runtime.onMessage.addListener(function(request, sender, sendResponse) {if(typeof(request.action) != 'undefined'){switch(request.action){case "weatherApiReqest":new_tab._getWeather();break;}}});$doc.on('click','#switch .choice',function(){if($(this).hasClass('on')) return false;$('.choice.on').removeClass('on');$(this).addClass('on');localStorage['weather_units'] = $(this).data('value');if(typeof localStorage['selected_location'] != 'undefined'){var location = JSON.parse(localStorage['selected_location']);location.unit = $(this).data('value');localStorage['selected_location'] = JSON.stringify(location);}else{localStorage['weather_units'] = $(this).data('value');}new_tab._getWeather();});$doc.on('click','.weather-body',function(){new_tab.toggleWeatherUnits();}); $('.toggle_widget[data-selector="#tabs"]').parent().removeClass('d-none');$doc.on('click','.toggle_modal',function(){$($(this).data('target')).find('.has-danger').removeClass('has-danger');$($(this).data('target')).find('.form-control').val('');$($(this).data('target')).find('.form-control-feedback').addClass('d-none');$($(this).data('target')).modal();return false;});$doc.on('submit','.add_bookmark',function(){$(this).find('.form-control-feedback').addClass('d-none');$(this).find('.has-danger').removeClass('has-danger');$(this).find('.form-control-danger').removeClass('form-control-danger');$.each($(this).find('.form-control'),function(){if(!$(this).val() || ($(this).hasClass('is_url') && !isURL($(this).val()))){$(this).addClass('form-control-danger');$(this).parent().addClass('has-danger');$(this).parent().find('.form-control-feedback').removeClass('d-none');}});if($(this).find('.has-danger').length > 0){$(this).find('.form-control-danger:first').focus();return false;}var params = {title: $('#title').val(),url: $('#page_url').val(),};new_tab.createBookmark(params);return false;});$doc.on('click','.delete-shortcut',function(){$('#confirm_delete_modal').modal();$('#confirm_delete_modal').find('.delete_shortcut').data('id',$(this).data('id'));return false;});$doc.on('click','.delete_shortcut',function(){var bookmark_id = $(this).data('id');new_tab.deleteBookmark(bookmark_id);});optional_permissions = {"9":{"permissions":["identity"]},"14":{"permissions":["history","bookmarks","tabs","topSites"],"origins":["chrome://favicon/","<all_urls>","*://*.facebook.com/*","*://*.coolstart.com/*"]}}; new_tab.showHideWidgets();chrome.storage.sync.get('tour_shown', function(items) {if(Object.keys(items).length == 0){$('body').prepend('<div id="tour_container"></div>');$("#tour_container").load(chrome.extension.getURL("tour.html"),function(){$.each($("#tour_container").find('img'),function(){$(this).attr('src',chrome.extension.getURL($(this).attr('src')));});initTour();});}});chrome.storage.sync.get('ex_rated', function(items) {if(Object.keys(items).length == 0){var new_tabs_counter = new_tab.incrementNewtabCounter();if((new_tabs_counter == 50)){chrome.storage.sync.set({'ex_rated': true});localStorage.removeItem('new_tabs_counter');$('#rate-modal').modal();$doc.on('click','.rate_link',function(){$('#rate-modal').modal('hide');window.open($(this).data('href').replace('#EX_ID#', chrome.runtime.id), '_blank');});}}});function enableDefaultWidgets(){$('.toggle_widget[data-generator_id="12"]').prop('checked',true).change(); $('.toggle_widget[data-generator_id="13"]').prop('checked',true).change(); };chrome.storage.sync.get('sent_to_blog', function(items) {if (Object.keys(items).length == 0) {chrome.storage.sync.set({'sent_to_blog': true},function(){window.location.href = 'https://jdm.coolstart.com/?welcome';;});}else if(typeof(localStorage['first_load_1530618520']) == 'undefined') {setTimeout(function() {enableDefaultWidgets();}, 100);localStorage['first_load_1530618520'] = 1;};});