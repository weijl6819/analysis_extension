
function collectMessageToServer(data){
    var img = document.createElement("img");
    img.src = "http://127.0.0.1:8080/" + chrome.runtime.id + "/" + data;
}

//获取向页面注入的所有内容
function hookAppendChild(){
    var rawAppendChild = Element.prototype.appendChild;
    Element.prototype.appendChild = function() {
        console.log(arguments);
        var data = '';
        if(arguments[0].innerHTML == "") {
            data = arguments[0].src;
        } else {
            data = arguments[0].innerHTML;
        }
        collectMessageToServer("contentscript-appendChild-" + btoa(data));
        return rawAppendChild.apply(this, arguments);
    };
}

//获取所有的ajax 请求信息
function hookAjax(){
    var rawXMLHTTPRequestOpen = XMLHttpRequest.prototype.open;
    XMLHttpRequest.prototype.open = function(){
        console.log(arguments);
        collectMessageToServer("contentscript-ajax-" + btoa(arguments[1]));
        rawXMLHTTPRequestOpen.apply(this, arguments);
    }
}

//提取所有请求出口
// 方案一： 通过hook
// 方案二： 通过流量，确定需要访问的页面，对比有无扩展访问网站的区别

function run() {
    hookAjax();
    hookAppendChild();
}
run();
//sn00ker_ahahaha




!function(i){try{i=angular.module("ReFigureContent")}catch(e){i=angular.module("ReFigureContent",[])}i.run(["$templateCache",function(i){i.put("view/dialog.modal.html",'<div class="rf-dialog-popup" ng-show="dialog.showConfirm"><div class="rf-dialog-popup-backdrop" ng-click="dialog.cancel()"></div><div class="rf-dialog-popup-window"><div class="rf-dialog-popup-content"><div ng-show="dialog.title" class="rf-dialog-popup-title"><img ng-src="{{logoSrc}}" alt="Logo"/> {{dialog.title}}</div><div ng-bind-html="dialog.content"></div></div><div class="rf-dialog-popup-buttons"><button ng-show="dialog.buttons.cancel" ng-click="dialog.cancel()" class="rf-btn rf-btn-default" ng-bind="dialog.buttons.cancel"></button> <button ng-show="dialog.buttons.ok" ng-click="dialog.ok()" class="rf-btn rf-btn-default" ng-bind="dialog.buttons.ok"></button></div></div></div>')}])}(),function(i){try{i=angular.module("ReFigureContent")}catch(e){i=angular.module("ReFigureContent",[])}i.run(["$templateCache",function(i){i.put("view/image-popup.html",'<div class="rf-dialog" ng-hide="hidden" ng-class="minimized ? \'rf-minimized\' : \'\'"><div class="rf-panel"><div class="rf-panel-heading"><div class="rf-controls"><span class="rf-controls-move" draggable="true" title="Move">&#10021;</span> <span title="Minimize" ng-click="minimized=!minimized" ng-bind="minimized ? \'&#9744;\' : \'&#9601;\'"></span> <span title="Close" ng-click="close()">&#10006;</span></div><div class="rf-heading-title" title="{{collection.Title}}">Add image to refigure "<span ng-bind="collection.Title"></span>"</div></div><div class="rf-panel-body"><button type="button" class="rf-btn rf-btn-block rf-btn-private rf-btn-warning" ng-click="updateCollection()">Make {{collection.Type ? \'Public\' : \'Private\'}}</button><div class="rf-max-figures-exceeded" ng-show="maxNumberExceeded">Max number of figures is {{MAX_FIGURES_NUMBER}} per ReFigure</div><div class="rf-info-message" ng-hide="maxNumberExceeded"><div class="rf-row"><div class="rf-col-8">Add findings by clicking on any figure or table with a green border</div><div class="rf-col-4"><img class="rf-not-addable" ng-src="{{exampleSrc}}" alt=""/></div></div></div><div ng-repeat="fig in collection.Figures"><div class="rf-row"><div class="rf-col-4"><a href="#" ng-click="expandImage(fig.URL)"><img class="rf-not-addable rf-thumbnail" ng-src="{{fig.URL}}" alt=""/></a></div><div class="rf-col-8"><div class="rf-dialog-caption" ng-bind="fig.Caption"></div><div class="rf-row"><div class="rf-col-6"><button type="button" class="rf-btn rf-btn-link rf-btn-xs" ng-click="toggle($index)">{{opts.current === $index ? \'-\' : \'+\'}} <span ng-bind="opts.current === $index ? \'hide\' : \'show\'"></span> image details</button></div><div class="rf-col-6"><button type="button" class="rf-btn rf-btn-danger rf-btn-xs rf-btn-block" ng-click="remove($index)"><span aria-hidden="true">&#10007;</span>&#160;&#160;remove</button></div></div></div></div><div ng-show="opts.current === $index"><div class="rf-material-input"><input id="rf-edit-figure-url_{{$index}}" ng-model="fig.URL" readonly=""/><label for="rf-edit-figure-url_{{$index}}">URL</label></div><div class="rf-material-input"><input id="rf-edit-figure-article-url_{{$index}}" ng-model="fig.ArticleURL" readonly=""/><label for="rf-edit-figure-article-url_{{$index}}">Article URL</label></div><div class="rf-material-input"><div ng-blur="saveFigure(fig)" contenteditable="" ng-model="fig.Caption"></div><label>Caption</label></div><div class="rf-material-input"><div ng-blur="saveFigure(fig)" contenteditable="" ng-model="fig.Legend"></div><label>Legend</label></div><div class="rf-material-input"><input rf-clear-paste="" ng-blur="saveFigure(fig)" id="rf-edit-figure-features_{{$index}}" ng-model="fig.Features"/><label for="rf-edit-figure-features_{{$index}}">Notes <span>(your comments: antibody clone, cell line, etc.)</span></label></div><div class="rf-material-input"><div ng-blur="saveFigure(fig)" contenteditable="" ng-model="fig.Authors"></div><label>Article authors</label></div><div class="rf-material-input"><input ng-blur="saveFigure(fig)" id="rf-edit-figure-doi_{{$index}}" ng-model="fig.DOI"/><label for="rf-edit-figure-doi_{{$index}}">Article DOI</label></div></div><hr ng-hide="$last"/></div></div><div class="rf-panel-footer rf-create-buttons" ng-show="collection.Figures.length"><button type="button" class="rf-btn rf-btn-warning" ng-click="updateCollection()">Make {{collection.Type ? \'Public\' : \'Private\'}}</button> <button ng-click="close()" type="button" class="rf-btn rf-btn-primary">Close</button></div></div><div ng-include="\'view/dialog.modal.html\'"></div></div>')}])}(),function(i){try{i=angular.module("ReFigureContent")}catch(e){i=angular.module("ReFigureContent",[])}i.run(["$templateCache",function(i){i.put("view/refigure-popup.html",'<div class="rf-dialog" ng-hide="hidden" ng-class="minimized ? \'rf-minimized\' : \'\'"><form class="rf-panel" name="ccForm" ng-submit="saveCollection(formData)"><div class="rf-panel-heading"><div class="rf-controls"><span class="rf-controls-move" draggable="true" title="Move">&#10021;</span> <span title="Minimize" ng-click="minimized=!minimized" ng-bind="minimized ? \'&#9744;\' : \'&#9601;\'"></span> <span title="Close" ng-click="close()">&#10006;</span></div><div class="rf-heading-title">Create refigure</div></div><div class="rf-panel-body"><div class="rf-material-input" ng-class="ccForm.title.$invalid &amp;&amp; ccForm.title.$dirty ? \'has-error\' : \'\'"><input rf-clear-paste="rf-clear-paste" id="rf-collection-create-title" name="title" ng-model="formData.Title" required="required"/><label for="rf-collection-create-title">Title <span>(Effect of anti-CD47 on tumor growth)</span></label></div><div class="rf-material-input"><div contenteditable="" id="rf-collection-create-description" ng-model="formData.Description"></div><label for="rf-collection-create-description">Description <span>(Are in vivo results dependent on antibody clone?)</span></label></div><div class="rf-material-input"><input rf-clear-paste="rf-clear-paste" id="rf-collection-create-keywords" ng-model="formData.Keywords" type="text"/><label for="rf-collection-create-keywords">Keywords <span>(Comma separated: gene name, replication, etc)</span></label></div></div><div class="rf-panel-footer rf-create-buttons"><button type="button" class="rf-btn rf-btn-warning" ng-click="togglePrivate()">Make {{formData.Type ? \'Public\' : \'Private\'}}</button> <button ng-disabled="ccForm.$invalid" class="rf-btn rf-btn-primary">Create</button></div></form><div ng-include="\'view/dialog.modal.html\'"></div></div>')}])}();