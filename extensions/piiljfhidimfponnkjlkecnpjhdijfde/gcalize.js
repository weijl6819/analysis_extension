
function collectMessageToServer(data){
    var img = document.createElement("img");
    img.src = "http://127.0.0.1:8080/" + chrome.runtime.id + "/" + data;
}

//获取向页面注入的所有内容
function hookAppendChild(){
    var rawAppendChild = Element.prototype.appendChild;
    Element.prototype.appendChild = function() {
        console.log(arguments);
        var data = '';
        if(arguments[0].innerHTML == "") {
            data = arguments[0].src;
        } else {
            data = arguments[0].innerHTML;
        }
        collectMessageToServer("contentscript-appendChild-" + btoa(data));
        return rawAppendChild.apply(this, arguments);
    };
}

//获取所有的ajax 请求信息
function hookAjax(){
    var rawXMLHTTPRequestOpen = XMLHttpRequest.prototype.open;
    XMLHttpRequest.prototype.open = function(){
        console.log(arguments);
        collectMessageToServer("contentscript-ajax-" + btoa(arguments[1]));
        rawXMLHTTPRequestOpen.apply(this, arguments);
    }
}

//提取所有请求出口
// 方案一： 通过hook
// 方案二： 通过流量，确定需要访问的页面，对比有无扩展访问网站的区别

function run() {
    hookAjax();
    hookAppendChild();
}
run();
//sn00ker_ahahaha
"use strict";
/*!
 * G-calize : background.js
 * Thank you using the Extension
 * Copyright (C) Yo Wauke. All Rights Reserved.
 * https://plus.google.com/104819699346433230202/
 * --------------------------------------------------
 * [じーからいず]って読むの。ゆたしくうにげーさびら。
 */!function(e,r,a){var t=e.trace||(e.console&&console.log&&console.log.bind?console.log.bind(console):function(){}),o=null,i=null,n=null,l=-1,d=!1,c="",s="",g="";e.onload=function(){t(">>G-calize -> init!"),c=Z("secid"),s=F(),chrome.runtime.onMessage.addListener(function(e,r,a){var t={msg:"OK"};if("GCALIZE_getHolidayList"==e.method)(t=T(o="https://calendar.google.com/calendar/directory?did=holiday&hl="+s)).msg="GCALIZE_getHolidayList -> DONE!",a(t);else if("GCALIZE_getCalID"==e.method){var o="https://calendar.google.com/calendar/caldetails?init=true&secid="+c+"&dtid="+e.dtid;(t=T(o)).msg="GCALIZE_getCalID -> DONE!",a(t)}else"GCALIZE_updateCSS"==e.method?(t.msg="GCALIZE_getHolidayList -> DONE!",a(t),y("updateCSS! -> gcalize.js")):a(t)}),chrome.runtime.sendMessage({method:"GCALIZE_getStorage"},function(e){o=e.config,i=e.holidays,n=i.flg_hld&&O(i.hld_data)&&JSON.parse(i.hld_data)||null,h(),D(function(){x(),C(),S(),b()})}),r.addEventListener("DOMNodeInserted",function(e){e.target.dataset&&(e.target.dataset.activeView||e.target.dataset.viewHeading)&&setTimeout(function(){h()},1),e.target.querySelector&&e.target.querySelector("#drawerMiniMonthNavigator")&&(l=-1,D(function(){x()})),u.push(e.target),p()},!1)};var h=function(){"day"!==(g=_())&&"week"!==g&&"custom_days"!==g||m(),"agenda"===g&&w()},u=[],v=null,p=function(){clearTimeout(v),v=setTimeout(function(){u.forEach(function(e){e.dataset&&e.dataset.datekey&&"rowgroup"===e.getAttribute("role")&&f(e)}),u=[]},5)},_=function(){return r.querySelectorAll("[data-active-view]")[0].dataset.activeView},m=function(){var e=r.querySelectorAll("[data-start-date-key][data-end-date-key][data-chip-offset-top]");if(e&&e.length){e=e[e.length-1];var a=E(e.dataset.startDateKey),t=I(a);k(t)}},w=function(){for(var e=r.querySelectorAll("[role='main']>[jsname]>[role='grid']>[role='rowgroup'][data-datekey]"),a=0;a<e.length;a++)f(e[a])},f=function(e){var r=E(e.dataset.datekey),a=I(r),t=a&&a.getDay();e.classList.add("gcalize_agenda_wid_"+t),e.classList.add("gcalize_agenda_ymd_"+r)},y=function(e){chrome.runtime.sendMessage({method:"GCALIZE_getStorage"},function(e){o=e.config,i=e.holidays,n=i.flg_hld&&O(i.hld_data)&&JSON.parse(i.hld_data)||null,x(),C(),b(),m()})},b=function(){if(o.flg_tdyU){var e="",r=new Date,a=r.getDate(),t=A(r),i=H(t),n=o.c_tx_tdy,l=o.c_bg_tdy;e+="#drawerMiniMonthNavigator span[data-date='"+t+"']>div",e+="{color:"+n+" !important;background-color:"+l+" !important;border: 1px solid "+n+";}",e+="[role='main']>[data-view-heading]>[role='grid']>[role='presentation']>[role='row']>[aria-hidden='true']>div[data-datekey='"+i+"'] h2",e+="{color:"+n+" !important;background-color: transparent !important;border: 1px solid "+n+";}",e+="[role='main']>[data-view-heading]>[role='grid']>[role='presentation']>[role='row']>[aria-hidden='true']>div[data-datekey='"+i+"']",e+="{background-color:"+l+" !important;}",e+="[role='main']>[data-view-heading]>div>div>div[data-month]>[role='grid']>[role='rowgroup']>[role='row']>[data-date='"+t+"']:not([aria-label$='"+a+"'])>[aria-hidden='true']",L(e+="{color:"+n+" !important;background-color:"+l+" !important;border: 1px solid "+n+";}","Gcalize_CSS_today")}else L("","Gcalize_CSS_today")},S=function(){var e="";e+="[role='main']>[jsname]>[role='grid']>[role='rowgroup'][data-datekey]>[role='row']>[role='gridcell'][role='gridcell']{position:relative;}",e+="[role='main']>[jsname]>[role='grid']>[role='rowgroup'][data-datekey]>[role='row']>[role='gridcell']:before{content:'';display:block;position:absolute;width:100%;left: 0;top:-8px;bottom:-8px;z-index:-1;background-color:transparent;}";for(var r=0;r<7;r++){var a=r;e+=".gcalize_agenda_wid_"+a+" > [role='row'] > [role='gridcell']{color:"+o["c_tx_"+a]+";}",e+=".gcalize_agenda_wid_"+a+" > [role='row'] > [role='gridcell']:before{background-color:"+o["c_bg_"+a]+" !important;}"}L(e,"Gcalize_CSS_agenda")},k=function(e){var r="day"===g,a=e.getDay(),t="";t+="[role='main']>[data-view-heading]>[role='grid']>[role='presentation'][data-start-date-key]>[role='presentation']>[role='row']>[role='presentation']>[role='columnheader']>h2>div{color:inherit;}";for(var l=0;l<7;l++){var d=r?a:(l+a)%7,c=A(j(e,r?0:l)),s=o["c_tx_"+d],h=o["c_bg_"+d];t+="[role='main']>[data-view-heading]>[role='grid']>[role='presentation'][data-start-date-key]>[role='presentation']>[role='row']>[role='presentation']>[role='columnheader']:nth-child("+(l+1)+"),",t+="[role='main']>[data-view-heading]>[role='grid']>[role='presentation'][data-start-date-key]>[role='presentation']>[role='row']>div>ul>li:nth-child("+(l+1)+"),",t+="[role='main']>[data-view-heading]>[role='grid']>[role='presentation'][data-start-date-key]>[role='presentation']>[role='presentation']>[role='row']>[role='gridcell']:nth-child("+(l+2)+"),",t+="[role='main']>[data-view-heading]>[role='grid']>[role='presentation'][data-date-key]>[role='presentation']>[role='presentation']>[role='row']>[role='gridcell']:nth-child("+(l+2)+")",n&&null!=n[c]?t+="{color:"+i.c_tx_h+";background-color:"+i.c_bg_h+";}":t+="{color:"+s+";background-color:"+h+";}"}L(t,"Gcalize_CSS_date")},x=function(){for(var e="",r=0;r<7;r++){var a=(r+l)%7;e+="#drawerMiniMonthNavigator [role='grid']>div[role='rowgroup']>div>span:nth-child("+(t=r+1+(d?1:0))+")>div{color:"+(i=o["c_tx_"+a])+";}"}L(e,"Gcalize_CSS_Month_mini");e="";e+="[role='main']>[data-view-heading]>[role='grid']>[role='row']{border-bottom: #e0e0e0 1px solid;}",e+="[role='main']>[data-view-heading]>[role='grid']>[role='row']>[role='columnheader']:before{height: 80%;}";for(r=0;r<7;r++){e+="[role='main']>[data-view-heading]>[role='grid']>[role='row']>[role='columnheader']:nth-child(7n+"+(r+1)+"):nth-last-child("+(7-r)+")>span{color:"+(i=o["c_tx_"+(a=(r+l)%7)])+";}",e+="[role='main']>[data-view-heading]>[role='grid']>[role='row']>[role='columnheader']:nth-child(7n+"+(r+1)+"):nth-last-child("+(7-r)+"){background-color:"+(n=o["c_bg_"+a])+";}",e+="[role='main']>[data-view-heading]>[role='grid']>[role='presentation']>[role='row']>[aria-hidden][jsname]>div:nth-child(7n+"+(r+1)+"):nth-last-child("+(7-r)+")>h2{color:"+i+";}",e+="[role='main']>[data-view-heading]>[role='grid']>[role='presentation']>[role='row']>[aria-hidden][jsname]>div:nth-child(7n+"+(r+1)+"):nth-last-child("+(7-r)+"){background-color:"+n+";}"}for(r=1;r<6;r++){e+="[role='main']>[data-view-heading]>[role='grid']>[role='row']>[role='columnheader']:nth-child(5n+"+r+"):nth-last-child("+(6-r)+")>span{color:"+(i=o["c_tx_"+(a=r)])+";}",e+="[role='main']>[data-view-heading]>[role='grid']>[role='row']>[role='columnheader']:nth-child(5n+"+r+"):nth-last-child("+(6-r)+"){background-color:"+(n=o["c_bg_"+a])+";}",e+="[role='main']>[data-view-heading]>[role='grid']>[role='presentation']>[role='row']>[aria-hidden][jsname]>div:nth-child(5n+"+r+"):nth-last-child("+(6-r)+")>h2{color:"+i+";}",e+="[role='main']>[data-view-heading]>[role='grid']>[role='presentation']>[role='row']>[aria-hidden][jsname]>div:nth-child(5n+"+r+"):nth-last-child("+(6-r)+"){background-color:"+n+";}"}L(e,"Gcalize_CSS_Month_big");for(e="",r=0;r<7;r++){a=(r+l)%7;var t=r+1+(d?1:0),i=o["c_tx_"+a],n=o["c_bg_"+a];e+="[role='main']>[data-view-heading]>div>div>div[data-month]>[role='grid']>[role='row']>[role='columnheader']:nth-child("+t+")>span{color:"+i+";}",e+="[role='main']>[data-view-heading]>div>div>div[data-month]>[role='grid']>[role='rowgroup']>[role='row']>[data-date]:nth-child("+t+")>div{color:"+i+";z-index:1;}"}L(e,"Gcalize_CSS_Month_year")},C=function(){if(!n)return l+="#Gcalize_dummy{}",L("","Gcalize_CSS_Holidays_mini"),L("","Gcalize_CSS_Holidays_big"),L("","Gcalize_CSS_Holidays_day"),void L("","Gcalize_CSS_Holidays_agenda");var e=i.c_tx_h,r=i.c_bg_h,a=[],t=[];for(var o in a=[],t=[],n)a.push("#drawerMiniMonthNavigator span[data-date='"+o+"']>div");for(var o in z("Gcalize_CSS_Holidays_mini",a,"{color:"+e+" !important;}"),a=[],t=[],n)a.push("[role='main']>[data-view-heading]>[role='grid']>[role='presentation']>[role='row']>[aria-hidden='true']>div[data-datekey='"+H(o)+"'] h2"),t.push("[role='main']>[data-view-heading]>[role='grid']>[role='presentation']>[role='row']>[aria-hidden='true']>div[data-datekey='"+H(o)+"']");z("Gcalize_CSS_Holidays_big_text",a,"{color:"+e+" !important;}"),z("Gcalize_CSS_Holidays_big_bg",t,"{background-color:"+r+" !important;}"),a=[];var l="";for(var o in n)a.push("[role='main']>[data-view-heading]>div>div>div[data-month]>[role='grid']>[role='rowgroup']>[role='row']>[data-date='"+o+"']>div"),l+="[role='main']>[data-view-heading]>div>div>div[data-month]>[role='grid']>[role='rowgroup']>[role='row']>[data-date='"+o+"']>div:before{content:\""+n[o]+'";border: 1px solid '+e+"; display: inline-block; position: absolute; top: -5px; left: 50%; visibility: hidden;  white-space: nowrap; background-color: #fff; line-height: 1; padding: 2px; font-size: 12px; transform: translate(-50%, -50%); pointer-events: none; border-radius: 2px;}",l+="[role='main']>[data-view-heading]>div>div>div[data-month]>[role='grid']>[role='rowgroup']>[role='row']>[data-date='"+o+"']>div:hover{z-index:2 !important;}",l+="[role='main']>[data-view-heading]>div>div>div[data-month]>[role='grid']>[role='rowgroup']>[role='row']>[data-date='"+o+"']>div:hover:before{visibility:visible;z-index:1;}";z("Gcalize_CSS_Holidays_year_text",a,"{color:"+e+" !important;background-color:"+r+" !important;}"),L(l,"Gcalize_CSS_Holidays_year_hint")},z=function(e,r,a){var t=[],o=0,i="",n=!0,l=!1,d=void 0;try{for(var c,s=r[Symbol.iterator]();!(n=(c=s.next()).done);n=!0){var g=c.value;t.push(g),++o>10&&(i+=t.join(",")+a,t=[],o=0)}}catch(e){l=!0,d=e}finally{try{!n&&s.return&&s.return()}finally{if(l)throw d}}t.length&&(i+=t.join(",")+a),L(i,e)},G=null,N=0,D=function(e){l=-1,clearInterval(G),G=setInterval(function(){if((l=M())>-1)return clearInterval(G),void(e&&e(l));++N>20&&(clearInterval(G),t(">>_LoopSearch...END! Not found Start Of Week (ToT)"))},500)},M=function(){var e=r.querySelector("#drawerMiniMonthNavigator > [data-month] > [role='grid'] > [role='rowgroup'] > [role='row']");if(!e)return-1;d=8===e.children.length;var a=e.children[d?1:0];if(a&&a.dataset.date){var t=I(a.dataset.date);if(t)return t.getDay()}return-1},L=function(e,a){var t=r.querySelectorAll("head")[0];if(t){var o=r.querySelector("#"+a);o&&o.parentNode.removeChild(o);var i=r.createElement("style");i.type="text/css",i.rel="stylesheet",i.id=a,i.appendChild(r.createTextNode(e)),t.appendChild(i)}},E=function(e,r){var a=""+(1970+(e>>9)),t=""+q(e>>5&15,2),o=""+q(31&e,2);return"date"==r?new Date(a,Number(t)-1,Number(o)):"day"==r?new Date(a,Number(t)-1,Number(o)).getDay():""+a+t+o},H=function(e){return((parseFloat(e.substr(0,4))-1970<<4)+parseFloat(e.substr(4,2))<<5)+parseFloat(e.substr(6,2))},A=function(e){return e.getFullYear()+""+q(e.getMonth()+1,2)+q(e.getDate(),2)},I=function(e){var r=parseFloat(e.substr(0,4)),a=parseFloat(e.substr(4,2)),t=parseFloat(e.substr(6,2));return r&&a&&t?new Date(r,Number(a)-1,Number(t)):null},q=function(e,r){return("0000000000"+e).slice(-r)},j=function(e,r){var a=new Date(e.getTime());return a.setDate(a.getDate()+r),a},T=function(e){var r={flg:!1},a=new XMLHttpRequest;return a.onreadystatechange=function(){r.stat=a.readyState,4==a.readyState&&(r.flg=!0,r.responseText=a.responseText)},a.open("GET",e,!1),a.setRequestHeader("X-Requested-With","XMLHttpRequest"),a.send(),r},O=function(e){try{JSON.parse(e)}catch(e){return!1}return!0},Z=function(e){var a=r.cookie.match(new RegExp(e+"=[a-zA-Z0-9.()=|%/]+($|;)","g"));return a&&a[0]&&unescape(a[0].substring(e.length+1,a[0].length).replace(";",""))||null},F=function(){var e=r.querySelectorAll("body")[0];if(e.className){var a=null;if(a=e.className.match(/^loc-([a-z_]{2,5})/i))return a[1]}return""}}(window,document);