infinity.modules["weather-add"]=new Vue({el:"#weather-add",data:{weatherInput:"",queryCitys:[],isSearchingCity:!1,lang:infinity.lang,location:infinity.setting("location"),defaultQueryCitys:[{city:infinity.i18n("new_delhi"),lat:28.60733,lon:77.203506,woeid:28743736},{city:infinity.i18n("london"),lat:51.507702,lon:-.12797,woeid:44418},{city:infinity.i18n("newyork"),lat:40.71455,lon:-74.007118,woeid:2459115},{city:infinity.i18n("tokyo"),lat:35.670479,lon:139.740921,woeid:1118370},{city:infinity.i18n("shanghai"),lat:31.247709,lon:121.472618,woeid:2151849},{city:infinity.i18n("sydney"),lat:-33.856281,lon:151.020966,woeid:1105779}],showLoading:!1,showLoadingAdding:!1,showAddError:!1,showNoCity:!1},created:function(){},methods:{show:function(){$("#weather-add").show(),$(".w-input")[0].focus()},hide:function(){$("#weather-add").hide()},queryWeather:function(e,t,i){var n=this,r="https://query.yahooapis.com/v1/public/yql?q=select * from weather.forecast where woeid="+t+"&format=json";$.getJSON(r,function(r){var a=n.handleWeatherResult(e,t,r);i(a)}).fail(function(){infinity.with("info",function(e){e.show(infinity.i18n("network_error_please_try_later"),!0),n.showLoadingAdding=!1})})},checknonSearch:function(){var e=this,t=e.weatherInput;if(e.showAddError=!1,e.showNoCity=!1,""===t)return e.queryCitys=[],void(e.showLoading=!1)},searchCity:function(e){var t=this,i=t.weatherInput;if(""!=i){t.queryCitys=[],t.showAddError=!1,t.showAddError=!1,t.showNoCity=!1;var n=infinity.url+"search-city?city="+encodeURIComponent(i)+"&lang="+t.lang+"&rt="+(new Date).getTime();t.showLoading=!0,t.isSearchingCity&&t.isSearchingCity.abort(),t.isSearchingCity=$.getJSON(n,function(e){200==e.status?(t.queryCitys=e.citys,e.citys&&0==e.citys.length&&(t.showNoCity=!0)):(t.queryCitys=[],t.showAddError=!0),t.isSearchingCity=!1,t.showLoading=!1},function(){t.queryCitys=[],t.showAddError=!0,t.isSearchingCity=!1,t.showLoading=!1})}},addCity:function(e){var t=this;if(!t.showLoadingAdding){var i=e.city,n=e.woeid;t.showLoadingAdding=!0,t.queryWeather(i,n,function(e){if(e){var n=infinity.get("infinity-weather");n.citys.unshift(e),infinity.set("infinity-weather",n),infinity.sendMessage("addWeatherCityDone"),t.showLoadingAdding=!1,infinity.with("info",function(e){e.show(i+" "+infinity.i18n("added"),!0)}),$("#weather-add").fadeOut(100)}else infinity.with("alert",function(e){e.show(infinity.i18n("network_error_please_try_later"),function(){t.showLoadingAdding=!1})})})}},handleWeatherResult:function(e,t,i){var n={name:e,woeid:t};if(0==i.query.count)return!1;var r={};r.cityName=i.query.results.channel.location.city,r.time=i.query.results.channel.lastBuildDate,r.Rtemp=i.query.results.channel.item.condition.temp,r.weather=i.query.results.channel.item.condition.code,r.weatherName=i.query.results.channel.item.forecast[0].text,r.Htemp=i.query.results.channel.item.forecast[0].high,r.Ltemp=i.query.results.channel.item.forecast[0].low,r.wind=i.query.results.channel.wind.speed;var a=1.609344*r.wind;r.wind=a<1?0:1<=a&&a<5?1:5<=a&&a<11?2:11<=a&&a<19?3:19<=a&&a<28?4:28<=a&&a<38?5:38<=a&&a<49?6:49<=a&&a<61?7:61<=a&&a<74?8:74<=a&&a<88?9:88<=a&&a<102?10:102<=a&&a<117?11:a>=117?12:0,r.week=i.query.results.channel.item.forecast[0].day,r.humidity=i.query.results.channel.atmosphere.humidity,r.pressure=i.query.results.channel.atmosphere.pressure,r.weather in usWeatherDict?(r.weatherIcon=usWeatherDict[r.weather].img,r.weatherColor=usWeatherDict[r.weather].color):(r.weatherIcon="sunny.png",r.weatherColor="#27CDFF"),n.today=r,n.days=[];for(var o=1;o<=4;o++){var s={weather:i.query.results.channel.item.forecast[o].code,Ltemp:i.query.results.channel.item.forecast[o].low,Htemp:i.query.results.channel.item.forecast[o].high,weatherName:i.query.results.channel.item.forecast[o].text,week:i.query.results.channel.item.forecast[o].day,date:i.query.results.channel.item.forecast[o].date};s.weather in usWeatherDict?(s.weatherIcon=usWeatherDict[s.weather].img,s.weatherColor=usWeatherDict[s.weather].color):(s.weatherIcon="sunny.png",s.weatherColor="#27CDFF"),n.days.push(s)}return{status:200,desc:"OK",data:n}}}});