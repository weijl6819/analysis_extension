"use strict";infinity.modules.history=new Vue({el:"#history-box",data:{items:[],lastItem:null,queryString:"",maxResults:100,showLoading:!1,showNoSearch:!1,showNoMore:!1,showNoAny:!1,historyDates:[],leftzoom:infinity.get("infinity-settings").settingLeftSlideZoom/100},created:function(){var t=this;t.onsearch=$.debounce(300,!1,this.search),$("#history-box").on("transitionend",function(e){e.target.className.indexOf("sildeBox")>=0&&(e.target.className.indexOf("slide-show")>=0?(t.isInit||(t.init(),t.isInit=!0),$(".history-search")[0].focus(),$(".history-splash").hide(),$(".history-content").show()):($("#history-box").hide(),$(".history-content").removeClass("infinity-fadeIn-8")))}),$(document).on("click","#history-cover",function(e){e.preventDefault(),t.hide()})},methods:{show:function(){$("#history-cover,#history-box").show(),$("#history-box").addClass("slide-show slide-box-shadow")},hide:function(){$("#history-box").removeClass("slide-show slide-box-shadow"),$("#history-cover").hide()},init:function(){var t,e=this;t={text:this.queryString,startTime:0,maxResults:this.maxResults/2},chrome.history.search(t,function(s){0==s.length&&(e.showNoAny=!0);for(var i=0;i<s.length;i++){var o=e.matchDate(s[i].lastVisitTime);s[i].dateShow=o.show,s[i].dateText=o.text}e.items=s,e.lastItem=s[t.maxResults-1]})},scroll:function(t){var e,s,i=this;s=t.target.clientHeight,e=t.target.scrollHeight,s+t.target.scrollTop==e&&(i.lastItem?(i.showLoading=!0,setTimeout(function(){i.queryNext()},300)):i.showNoMore=!0)},searched:function(){this.items=[],this.historyDates=[],this.showLoading=!0,this.showNoSearch=!1,this.showNoMore=!1,this.showNoAny=!1,this.onsearch()},search:function(){var t=this,e={text:t.queryString,startTime:(new Date).getTime()-6048e5,maxResults:t.maxResults};chrome.history.search(e,function(s){if(t.showLoading=!1,s.length){for(var i=0;i<s.length;i++){var o=t.matchDate(s[i].lastVisitTime);s[i].dateShow=o.show,s[i].dateText=o.text}t.items=s,t.lastItem=s[e.maxResults-1]}else t.showNoSearch=!0})},queryNext:function(){var t=this,e={text:t.queryString,maxResults:t.maxResults,startTime:0,endTime:t.lastItem.lastVisitTime};chrome.history.search(e,function(s){t.showLoading=!1;for(var i in s){var o=t.matchDate(s[i].lastVisitTime);s[i].dateShow=o.show,s[i].dateText=o.text,t.items.push(s[i])}t.lastItem=s[e.maxResults-1],s.length||(t.showNoMore=!0)})},clearHistory:function(){var t=this;infinity.with("confirm",function(e){e.show(infinity.i18n("sure_clear"),[infinity.i18n("clear"),infinity.i18n("give_up")],function(e){e&&chrome.history.deleteAll(function(){t.showNoAny=!0,t.items=[]})},"clear")})},deleteItem:function(t,e){var s=this;t.preventDefault(),t.stopPropagation(),chrome.history.deleteUrl({url:e.url},function(){s.init()})},open:function(t,e){t.preventDefault(),infinity.open("history",e.url,t)},formatDate:function(t){var e,s,i,o,n;return e=new Date(t),s=e.getHours(),i=s>=12?"PM":"AM",o=s>=12?s-12:s,n=("0"+e.getMinutes()).substr(-2),o+":"+n+" "+i},matchDate:function(t){var e=new Date(t),s=e.toLocaleDateString(),i=e.getFullYear()+("0"+(e.getMonth()+1)).substr(-2)+("0"+e.getDate()).substr(-2),o=new Date,n=o.getFullYear()+("0"+(o.getMonth()+1)).substr(-2)+("0"+o.getDate()).substr(-2);return-1==this.historyDates.indexOf(i)?(this.historyDates.push(i),i==n?{show:!0,text:infinity.i18n("today")}:parseInt(n)-parseInt(i)==1?{show:!0,text:infinity.i18n("yestoday")}:{show:!0,text:s}):{show:!1,text:""}}}});