!function(){var n="infinity-bg-static";window.bgStatic={init:function(){var i=this;i.isSyncing=!1,infinity.onMessage("updateStatic",function(){i.sync()}),chrome.alarms.onAlarm.addListener(function(e){e&&e.name===n&&i.sync()})},checkAlarm:function(){var i=this;chrome.alarms.get(n,function(n){n||i.sync()})},sync:function(){var i=this;if(!i.isSyncing){i.isSyncing=!0;var e=[i.syncSearch(),i.syncDiscoveries(),i.syncOfficalIcons()];Promise.all(e).then(function(){chrome.alarms.create(n,{delayInMinutes:720}),i.isSyncing=!1},function(){chrome.alarms.create(n,{delayInMinutes:10}),i.isSyncing=!1})}},syncSearch:function(){return new Promise(function(n,i){$.ajax({url:infinity.staticUrl+"apis/search/russia-default-search-engines.json",dataType:"json",cache:!1}).done(function(e){var t=infinity.get("infinity-searchs");if(t){e=infinity.i18nTranslate(e),t.all=t.all.map(function(n){var i=_.find(e,function(i){return i.seId===n.seId});return i||n});var s=t.current,a=_.find(e,function(n){return n.seId===s.seId});a&&(t.current=a),infinity.set("infinity-searchs",t),infinity.set("infinity-default-search-engines",e),infinity.sendMessage("infinity-onBroadcast-searchUpdate",{tabId:null}),infinity.sendMessage("infinity-onBroadcast-searchAddUpdate",{tabId:null}),infinity.doSyncData(),n()}else i()}).fail(i)})},syncDiscoveries:function(){return new Promise(function(n,i){$.ajax({url:infinity.staticUrl+"apis/discovery/discoveries/index.json",dataType:"json",cache:!1}).done(function(i){infinity.set("infinity-discoveries",i),infinity.sendMessage("updateDiscoveries"),n()}).fail(i)})},syncOfficalIcons:function(){return new Promise(function(n,i){$.ajax({url:infinity.staticUrl+"apis/icons/russia-offical-icons.json",dataType:"json",cache:!1}).done(function(i){infinity.get("infinity-offical-icons",!0,function(n){function e(e){if(!n)return!0;if(n.apiVersion!==i.apiVersion)return!0;var t=n.sites[e];return!t||t.version!==i.sites[e].version}function t(n){for(var t,s=0,c=a.length;s<c;s++){for(var r=a[s],f=i.sites[r],o=f.match,u=0,y=o.length;u<y;u++)if(-1!==n.indexOf(o[u])&&e(r)){t=f;break}if(t)break}return t}function s(n){var i=t(n.url);return!!i&&(n.url=i.replace,i.isReplaceSiteName&&(n.name=i.name),!0)}var a=Object.keys(i.sites);if(1===i.apiVersion){var c=infinity.get("infinity-icons");if(!c)return;var r=!1;c.forEach(function(n){n.forEach(function(n){s(n)&&(r=!0)})}),r&&(infinity.set("infinity-icons",c),bgIcon.setIconsFlat(),infinity.sendMessage("reloadIcon"),infinity.doSyncIcon()),infinity.set("infinity-offical-icons",i,!0)}}),n()}).fail(i)})}}}();