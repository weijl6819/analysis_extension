"use strict";var backupSocket=io.connect("https://ws.infinitynewtab.com/backup",{transports:["websocket"]}),bgSync={data:{backupAjax:{auto:{icon:!1,data:!1,wallpaper:!1},user:{icon:!1,data:!1,wallpaper:!1}},recoveryAjax:{auto:{icon:!1,data:!1,wallpaper:!1},user:{icon:!1,data:!1,wallpaper:!1}},checkSyncAjax:!1},backupSocket:function(){backupSocket.on("connect",function(){void 0;var n=infinity.get("infinity-user"),i={type:"checkIsNeedSync",uid:n.uid,secret:n.secret,time:n["auto-backup"]};backupSocket.emit("toServer",i)}),backupSocket.on("toClient",function(n){var i=n;void 0,200==i.status&&1==i.isNeedSync&&infinity.setting("isAutoSync")&&bgSync.checkAutoSync(),200==i.status&&i.hasOwnProperty("changeAutoSyncStatus")&&bgSync.checkAutoSyncStatus()})},init:function(){try{var n=this;n.backupSocket(),infinity.init("infinity-sync-status",!1),n.unLockNewTabSync(),infinity.init("infinity-waiting-backup",{data:!1,icon:!1,wallpaper:!1}),infinity.onsyncIcon=function(){infinity.isLogin()&&infinity.setting("isAutoSync")&&n.autoBackup("icon")},infinity.onsyncData=function(){infinity.isLogin()&&infinity.setting("isAutoSync")&&(void 0,n.autoBackup("data"))},infinity.onsyncWallpaper=function(){infinity.isLogin()&&infinity.setting("isAutoSync")&&n.autoBackup("wallpaper")},infinity.doSyncIcon=_.debounce(infinity.onsyncIcon,2e3),infinity.doSyncData=_.debounce(infinity.onsyncData,2e3),infinity.doSyncWallpaper=_.debounce(infinity.onsyncWallpaper,2e3),n.onAutoBackup(),n.onUserBackUp(),n.onUserRecovery(),n.onNetReConnect()}catch(n){}},onNetReConnect:function(){var n=this;infinity.onNetConnect(function(){n.checkAutoSync(),n.checkAutoSyncStatus()})},checkWaitingBackup:function(n){var i=infinity.get("infinity-waiting-backup");"icon"==n&&i.icon&&infinity.doSyncIcon(),"data"==n&&i.data&&infinity.doSyncData(),"wallpaper"==n&&i.wallpaper&&infinity.doSyncWallpaper()},onAutoBackup:function(){infinity.onMessage("autoBackup",function(n){if(!self.lockSync){if("icon"==n.type)return void infinity.doSyncIcon();if("data"==n.type)return void infinity.doSyncData();if("wallpaper"==n.type)return void infinity.doSyncWallpaper()}})},lockNewTabSync:function(){this.lockSync=!0,infinity.set("infinity-sync-status",!0),infinity.sendMessage("toSyncStatus")},unLockNewTabSync:function(){this.lockSync=!1,infinity.set("infinity-sync-status",!1),infinity.sendMessage("toSyncStatus")},onUserBackUp:function(){var n=this;infinity.onMessage("userBackup",function(){n.doUserBackUp()})},doUserBackUp:function(){var n=this;if(!n.lockSync){n.lockNewTabSync();for(var i=["data","icon","wallpaper"],t=0,e=0;e<i.length;e++)n.backupToCloud("auto",i[e],function(n){var i=n.backupTime,t=infinity.get("infinity-user");i>t["auto-backup"]&&(t["auto-backup"]=i,infinity.set("infinity-user",t))},function(){},function(){(t+=1)==i.length&&(infinity.sendMessage("userBackupDone"),n.unLockNewTabSync())})}},getUserData:function(n,i){if("data"==n){var t={"infinity-searchs":infinity.get("infinity-searchs"),"infinity-notes":infinity.get("infinity-notes"),"infinity-todos":infinity.get("infinity-todos"),"infinity-settings":infinity.get("infinity-settings")},t=Base64.encode(JSON.stringify(t));i&&i(t)}if("icon"==n){var e=infinity.get("infinity-icons"),t=(_.flattenDeep(e).length,Base64.encode(JSON.stringify(e)));i&&i(t)}if("wallpaper"==n){var a=infinity.get("infinity-bg");infinity.get("infinity-wallpaper",!0,function(n){-1!=n.originalSrc.indexOf("blob:")?a.src=n.src:a.src=n.originalSrc;var t=Base64.encode(JSON.stringify(a));i&&i(t)})}},backupAjax:function(n,i,t,e,a,c){void 0;var o=this;o.data.backupAjax[n][i]&&o.data.backupAjax[n][i].abort();var s=infinity.get("infinity-user");s.isLogin&&(o.data.backupAjax[n][i]=$.ajax({url:infinity.url+"user/backup/?uid="+s.uid+"&secret="+s.secret,type:"POST",dataType:"json",data:{uid:s.uid,secret:s.secret,backupType:n,text:t,dataType:i}}).done(function(n){e&&e(n)}).fail(function(){a&&a()}).always(function(){c&&c()}))},backupToCloud:function(n,i,t,e,a){var c=this;this.getUserData(i,function(o){c.backupAjax(n,i,o,t,e,a)})},autoBackup:function(n){var i=this;i.backupToCloud("auto",n,function(t){var e=parseInt(t.backupTime),a=infinity.get("infinity-user");e>a["auto-backup"]&&(a["auto-backup"]=e),a["auto-backup-"+t.dataType]=e,infinity.set("infinity-user",a);var c={type:"broadcastSync",uid:a.uid,secret:a.secret,time:a["auto-backup"]};i.clearWaitingBackup(n);try{backupSocket.emit("toServer",c)}catch(n){}},function(){i.addWaitingBackup(n)},function(){infinity.sendMessage("autoBackupDone")})},addWaitingBackup:function(n){var i=infinity.get("infinity-waiting-backup");i[n]=!0,infinity.set("infinity-waiting-backup",i)},clearWaitingBackup:function(n){var i=infinity.get("infinity-waiting-backup");i[n]=!1,infinity.set("infinity-waiting-backup",i)},checkAutoSyncStatus:function(){var n=infinity.get("infinity-user");n.isLogin&&$.ajax({url:infinity.url+"user/get-my-info/",type:"GET",dataType:"json",data:{uid:n.uid,secret:n.secret,t:(new Date).getTime()+Math.random().toString(16).substring(2)}}).done(function(n){n.data.isOpenAutoSync?infinity.setting("isAutoSync",!0):infinity.setting("isAutoSync",!1),infinity.sendMessage("settingIsAutoSyncDone")})},checkAutoSync:function(){var n=this,i=infinity.get("infinity-user");i.isLogin&&(n.checkSyncAjax&&n.checkSyncAjax.abort(),n.checkSyncAjax=$.ajax({url:infinity.url+"user/get-my-info/",type:"GET",dataType:"json",data:{uid:i.uid,secret:i.secret,t:(new Date).getTime()+Math.random().toString(16).substring(2)}}).done(function(t){var e=t.data,a=parseInt(i["auto-backup-data"]),c=parseInt(i["auto-backup-icon"]),o=parseInt(i["auto-backup-wallpaper"]);e["auto-backup-data"]>a?setTimeout(function(){n.doRecovery("auto","data",null,null,function(){infinity.sendMessage("auto-recevory-success")})},1e3):n.checkWaitingBackup("data"),e["auto-backup-icon"]>c?setTimeout(function(){n.doRecovery("auto","icon",null,null,function(){infinity.sendMessage("auto-recevory-success")})},1e3):n.checkWaitingBackup("icon"),e["auto-backup-wallpaper"]>o?setTimeout(function(){n.doRecovery("auto","wallpaper",null,null,function(){infinity.sendMessage("auto-recevory-success")})},1e3):n.checkWaitingBackup("wallpaper")}))},onUserRecovery:function(){var n=this;infinity.onMessage("userRecovery",function(){if(!n.lockSync){n.lockNewTabSync();var i=["icon","data","wallpaper"],t=0;infinity.sendMessage("recovery-percent",{progress:1});for(var e=0;e<i.length;e++)n.doRecovery("auto",i[e],function(e){if(!e.success)return void 0,infinity.sendMessage("recovery-failed"),void n.unLockNewTabSync();var a=99;1==(t+=1)&&(a=parseInt(45*Math.random()+10)),2==t&&(a=parseInt(34*Math.random()+56)),infinity.sendMessage("recovery-percent",{progress:a}),t==i.length&&(n.unLockNewTabSync(),infinity.sendMessage("infinity-recevory-success"))},function(i){n.unLockNewTabSync(),infinity.sendMessage("recovery-failed")},function(){})}})},doRecovery:function(n,i,t,e,a){var c=this;c.recoveryFromCloud(n,i,function(e){if(void 0,200==e.status){var a=infinity.get("infinity-user");"auto"==n&&(a["auto-backup-"+i]=e.data.auto[i]),e.backupTime>a[n+"-backup"]&&(a[n+"-backup"]=e.backupTime),infinity.set("infinity-user",a),"data"==i&&c.onRecoveryData(e.data.settingData,function(n){n?(infinity.sendMessage("updateSettingView"),infinity.sendMessage("updateNotesView",{tabid:null}),infinity.sendMessage("updateSearchView"),infinity.sendMessage("updateTodosView"),infinity.onMessage("settingAllStyleRefresh"),t&&t({success:!0,desc:"success"})):t&&t({success:!1,desc:"unknown error"}),c.clearWaitingBackup("data")}),"icon"==i&&c.onRecoveryIcon(e.data.iconData,function(n){n?(infinity.sendMessage("reloadIcon"),t&&t({success:!0,desc:"success"})):t&&t({success:!1,desc:"unknown error"}),c.clearWaitingBackup("icon")}),"wallpaper"==i&&c.onRecoveryWallpaper(e.data.wallpaperData,function(n){n?(infinity.sendMessage("setWallpaperDone"),t&&t({success:!0,desc:"success"})):t&&t({success:!1,desc:"unknown error:maybe network"}),c.clearWaitingBackup("wallpaper")})}},function(){e&&e({success:!1,desc:"network error"})},function(){a&&a({complete:!0,desc:"complete"})})},onRecoveryData:function(n,i){try{var n=JSON.parse(Base64.decode(n)),t=infinity.get("infinity-settings"),e=n["infinity-settings"];for(var a in t)e.hasOwnProperty(a)||(e[a]=t[a]);e.settingMainZoom=t.settingMainZoom,e.settingLeftSlideZoom=t.settingLeftSlideZoom,e.isAutoSync=t.isAutoSync,infinity.set("infinity-settings",e),infinity.set("infinity-notes",n["infinity-notes"]),infinity.set("infinity-searchs",n["infinity-searchs"]),infinity.set("infinity-todos",n["infinity-todos"]),infinity.sendMessage("reSetting"),t.row==e.row&&t.column==e.column||infinity.sendMessage("reLayout"),infinity.sendMessage("setStyleAfterRevovery"),i&&i(!0)}catch(n){i&&i(!1)}},onRecoveryIcon:function(n,i){var t=JSON.parse(Base64.decode(n));infinity.set("infinity-icons",t),i&&i(!0)},onRecoveryWallpaper:function(n,i){try{var t=JSON.parse(Base64.decode(n)),e=t.type,a=t.src,c=t.color;infinity.setWallpaper(e,a,c,0,function(n){n.error?i&&i(!1):i&&i(!0)})}catch(n){i&&i(!1)}},recoveryFromCloud:function(n,i,t,e,a){var c=this,o=infinity.get("infinity-user");o.isLogin&&(c.data.backupAjax[n][i]&&c.data.backupAjax[n][i].abort(),c.data.recoveryAjax[n][i]=$.ajax({url:infinity.url+"user/recovery/",type:"GET",dataType:"json",data:{uid:o.uid,secret:o.secret,backupType:n,dataType:i,t:(new Date).getTime()+Math.random().toString(16).substring(2)}}).done(function(n){t&&t(n)}).fail(function(){e&&e()}).always(function(){a&&a()}))}};