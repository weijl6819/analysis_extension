var dataDownloader;var settings;var isScrolling=false;var scrollTimerHandle;var firstRun=false;var authorityExpanded=false;var mapEventInProgress=false;$(document).ready(function(e){if(navigator.onLine){settings=new Settings;initGoogleAnalytics();try{_gaq.push(['_trackEvent','App','Started',settings.appVersion])}catch(e){}firstRun=truthy(getStoredValue('firstRun')||true);if(firstRun){setStoredValue('firstRun','false');try{_gaq.push(['_trackEvent','App','FirstRun',settings.appVersion])}catch(e){}}var visitCount=parseInt(getStoredValue('visitCount'))||0;visitCount++;setStoredValue('visitCount',visitCount.toString());try{_gaq.push(['_trackEvent','App','VisitCount',visitCount.toString()])}catch(e){}debug('Settings',settings);createAndHideContentDivs();registerHandleBarHelpers();configureMenuAndButtonVisbility();configureDimensions();var test='';if(settings.appName.indexOf('TEST')>0)test='TEST';$('#appVersion').html('<span>'+settings.appVersion+'</span><br/><span>'+test+'</span>');var creditHeight=$('#appVersion').height();$('#appVersion').css({'padding-bottom':(creditHeight-5).toString()+'px'});if(isChromeExtension){var w=window['chrome'].extension.getBackgroundPage();dataDownloader=w['dataDownloader'];var newData=dataDownloader.CurrentData();if(firstDataLoad||(newData.authorityData!=null&&newData.authorityData.hasChanged||newData.alertData!=null&&newData.alertData.hasChanged||newData.layerData!=null&&newData.layerData.hasChanged||newData.videoData!=null&&newData.videoData.hasChanged||newData.newsData!=null&&newData.newsData.hasChanged||newData.forecastData!=null&&newData.forecastData.hasChanged)){DataChanged(newData)}else{DataUnchanged(newData)}}else{dataDownloader=new DataDownloader(DataChanged,DataUnchanged);dataDownloader.Start()}$('#facebookLink').attr('href',settings.facebookLink);$('#facebookLink').attr('title','Visit the '+$.trim(settings.appName.replace('(TEST)',''))+' facebook feed');$('#twitterLink').attr('href',settings.twitterLink);$('#twitterLink').attr('title','Visit the '+$.trim(settings.appName.replace('(TEST)',''))+' twitter page');$('#websiteLink').html(settings.websiteLinkText);$('#websiteLink2').attr('href',settings.websiteLink);$('#networkCreditDiv').css({'background-color':settings.websiteLinkTextBgColor,color:settings.websiteLinkTextColor});$('#websiteLink').css({'background-color':settings.websiteLinkTextBgColor,color:settings.websiteLinkTextColor});$('#websiteLink a').css({'background-color':settings.websiteLinkTextBgColor,color:settings.websiteLinkTextColor});$('#creditIcon').attr('src',settings.websiteLinkIcon);if($.trim(settings.facebookLink)==""){$('#facebookLink').remove()}if($.trim(settings.twitterLink)==""){$('#twitterLink').remove()}setTimeout(function(){var menuImg=$('ul#menu li img');var menuLi=$('ul#menu li');var menuLiSelImg=$('ul#menu li.selected img');switch(settings.leftMenuSpacing){case LeftMenuSpacing.COMFORTABLE:menuImg.css({'margin-top':'15px'});menuLiSelImg.css({'margin-top':'15px'});menuLi.css({height:'51px'});break;case LeftMenuSpacing.COSY:menuImg.css({'margin-top':'11px'});menuLiSelImg.css({'margin-top':'11px'});menuLi.css({height:'41px'});break;case LeftMenuSpacing.COMPACT:menuImg.css({'margin-top':'8px'});menuLiSelImg.css({'margin-top':'8px'});menuLi.css({height:'36px'});break}},100)}else{throw new Error('No internet connection!');}});function CompileBandingStripTemplate(id){var html='';var source=$('#banding-template').html();var template=Handlebars.compile(source);html=template({A:id==1,B:id==2,C:id==3,D:id==4,E:id==5});return html}function IsLeftMenuButtonHidden(buttonId){var buttonHidden=false;if(!settings.hideLeftMenu&&settings.hiddenLeftMenuButtons.length>0){$.each(settings.hiddenLeftMenuButtons,function(index,bid){if(buttonId===bid){buttonHidden=true;return false}})}if(settings.hideLeftMenu){buttonHidden=true}return buttonHidden}function DataChanged(result){debug('DataChanged',result);if($('#loader').is(':visible')){$('#loader').hide()}LeftPanelSelectNone();if(!IsLeftMenuButtonHidden(LeftMenuButton.LIST)&&(firstDataLoad||result.authorityData.hasChanged)){RenderListButtonContent(true)}if(!IsLeftMenuButtonHidden(LeftMenuButton.MAP)&&(firstDataLoad||result.layerData.hasChanged||result.authorityData.hasChanged)){RenderMapsButtonContent(true)}if(!IsLeftMenuButtonHidden(LeftMenuButton.ALERT)&&(firstDataLoad||result.alertData.hasChanged)){RenderAlertsButtonContent(true)}if(!IsLeftMenuButtonHidden(LeftMenuButton.VIDEO)&&(firstDataLoad||result.videoData.hasChanged)){RenderVideoButtonContent(true)}if(!IsLeftMenuButtonHidden(LeftMenuButton.NEWS)&&(firstDataLoad||result.newsData.hasChanged)){RenderNewsButtonContent(true)}if(!IsLeftMenuButtonHidden(LeftMenuButton.GUIDE)){RenderGuideButtonContent(firstDataLoad)}if(!IsLeftMenuButtonHidden(LeftMenuButton.FORECAST)&&(firstDataLoad||result.forecastData.hasChanged==true)){RenderForecastButtonContent(true)}BeforeLeftButtonClicked(settings.selectedLeftButton);if(!IsLeftMenuButtonHidden(LeftMenuButton.ALERT)&&result.alertData.hasChanged&&result.alertData.objects.length>0&&settings.showAlertsOnNew){LeftPanelButtonClicked(LeftMenuButton.ALERT)}else{LeftPanelButtonClicked(settings.selectedLeftButton)}if(firstDataLoad){configureButtonClickHandler()}firstDataLoad=false}function DataUnchanged(result){if($('#loader').is(':visible')){$('#loader').hide()}}function CompileAccordionTemplate(){var html='';if(dataDownloader!=null){var currentData=dataDownloader.CurrentData();if(currentData!=null&&currentData.authorityData!=null&&currentData.authorityData.objects!=null){var source=$("#accordion-template").html();var template=Handlebars.compile(source);var objs=currentData.authorityData;html=template(objs)}}return html}function CompileGuideTemplate(){var html=$("#guide-template").html();return html}function CompileAlertsTemplate(){var html='';if(dataDownloader!=null){var currentData=dataDownloader.CurrentData();if(currentData!=null&&currentData.alertData!=null&&currentData.alertData.objects!=null){var source=$("#alerts-template").html();var template=Handlebars.compile(source);for(var s=0;s<currentData.alertData.objects.length;s++){var alertSite=currentData.alertData.objects[s];for(var l=0;l<currentData.authorityData.objects.authorities.length;l++){var la=currentData.authorityData.objects.authorities[l];for(var ls=0;ls<la.Site.length;ls++){var site=la.Site[ls];if(alertSite.sitecode==site.SiteCode){alertSite.laid=parseInt(la.LocalAuthorityCode);alertSite.MeanSite=(parseInt(la.LocalAuthorityCode)==settings.meanLaId);break}}}}html=template(currentData.alertData)}}return html}function CompileMapsTemplate(){var html='';if(dataDownloader!=null){var currentData=dataDownloader.CurrentData();if(currentData!=null){var source=$("#maps-template").html();var template=Handlebars.compile(source);html=template(currentData.layerData)}}return html}function CompileMeansTemplate(){var html='';if(dataDownloader!=null){var currentData=dataDownloader.CurrentData();if(currentData!=null&&currentData.authorityData!=null&&currentData.authorityData.objects!=null){var source=$("#means-template").html();var template=Handlebars.compile(source);html=template(currentData.authorityData.objects.authorities)}}return html}function CompileVideoTemplate(){var html='';if(dataDownloader!=null){var currentData=dataDownloader.CurrentData();if(currentData!=null&&currentData.videoData!=null&&currentData.videoData.objects!=null){var source=$("#video-template").html();var template=Handlebars.compile(source);html=template({embedFlashVideos:settings.embedFlashVideos,videos:currentData.videoData.objects})}}return html}function CompileNewsTemplate(){var html='';if(dataDownloader!=null){var currentData=dataDownloader.CurrentData();if(currentData!=null&&currentData.newsData!=null&&currentData.newsData.objects!=null){var source=$("#newz-template").html();var template=Handlebars.compile(source);html=template(currentData.newsData)}}return html}function CompileForecastTemplate(){var html='';if(dataDownloader!=null){var currentData=dataDownloader.CurrentData();if(currentData!=null&&currentData.forecastData!=null&&currentData.forecastData.objects!=null){var source=$("#forecast-template").html();var template=Handlebars.compile(source);html=template(currentData.forecastData)}}return html}function CompileSpeciesMapTemplate(data){var html='';if(data!=null){var source=$("#species-map-template").html();var template=Handlebars.compile(source);html=template(data)}return html}function ShowModerateSites(){$("#NoModeratesMessage").show();$("#MeansContent").hide();$("#accordion2").hide();$("#accordion1").show();updateAuthorityButtonSetWidth()}function ShowSiteMeans(){$("#MeansContent").show();$("#NoModeratesMessage").hide();$("#accordion1").hide();$("#accordion2").hide();updateAuthorityButtonSetWidth()}function ShowAllSites(){$("#MeansContent").hide();$("#NoModeratesMessage").hide();$("#accordion1").hide();$("#accordion2").show();updateAuthorityButtonSetWidth()}function AuthorityButtonSetClicked(e){var buttonId=e.currentTarget.id;switch(ListMenuButton[buttonId]){case ListMenuButton.MODERATE:ShowModerateSites();try{_gaq.push(['_trackEvent','ListView','Clicked','ModerateButton'])}catch(e){}break;case ListMenuButton.MEAN:ShowSiteMeans();try{_gaq.push(['_trackEvent','ListView','Clicked','MeansButton'])}catch(e){}break;case ListMenuButton.AUTHORITIES:ShowAllSites();focusLocalAuthorityInAccordionIfRequired(LeftMenuButton.LIST);try{_gaq.push(['_trackEvent','ListView','Clicked','AuthoritiesButton'])}catch(e){}break}settings.startAuthorityButtonSet=ListMenuButton[buttonId]}function LeftPanelSelectNone(){$('#menu').find('[class*="selected"]').removeClass('selected');$('.contentDiv').hide(0)}function LeftPanelButtonClicked(clickedButtonId,previousButtonId,forceRedraw){if(previousButtonId===void 0){previousButtonId=undefined}if(forceRedraw===void 0){forceRedraw=false}$('#menu').find('[class*="selected"]').removeClass('selected');$('.contentDiv').hide(0).promise().then(function(){var contentId='#'+LeftMenuButton[clickedButtonId]+'Content';var forceRefresh=!($(contentId).children().length>0);if(forceRedraw)forceRefresh=true;if(forceRedraw)debug('FORCE refresh of '+contentId);switch(clickedButtonId){case LeftMenuButton.LIST:RenderListButtonContent(forceRefresh);break;case LeftMenuButton.MAP:RenderMapsButtonContent(forceRefresh);break;case LeftMenuButton.GUIDE:RenderGuideButtonContent(forceRefresh);break;case LeftMenuButton.VIDEO:RenderVideoButtonContent(forceRefresh);break;case LeftMenuButton.ALERT:RenderAlertsButtonContent(forceRefresh);break;case LeftMenuButton.NEWS:RenderNewsButtonContent(forceRefresh);break;case LeftMenuButton.FORECAST:RenderForecastButtonContent(forceRefresh);break;case LeftMenuButton.TWITTER:RenderTwitterButtonContent(forceRefresh);break}settings.selectedLeftButton=clickedButtonId;$('#'+LeftMenuButton[clickedButtonId]).addClass('selected');$(contentId).show(0,function(){AfterLeftButtonClicked(clickedButtonId,previousButtonId)})})}function BeforeLeftButtonClicked(clickedButtonId,previousButtonId){if(previousButtonId===void 0){previousButtonId=undefined}if(previousButtonId){settings.scrollTops[previousButtonId]=$('#scrollPanel').scrollTop();if(previousButtonId==LeftMenuButton.VIDEO){HideAllFlashFrames()}}configureDimensions()}function AfterLeftButtonClicked(clickedButtonId,previousButtonId){if(previousButtonId===void 0){previousButtonId=undefined}var contentId='#'+LeftMenuButton[clickedButtonId]+'Content';var previousScrollTop=settings.scrollTops[clickedButtonId]||0;var currentScrollTop=$('#scrollPanel').scrollTop();if(previousScrollTop!=currentScrollTop){$('#scrollPanel').scrollTop(previousScrollTop)}if(previousButtonId==LeftMenuButton.VIDEO){HideAllFlashFrames()}$('#bandingDiv').html('');$('#bandingDiv').hide();switch(clickedButtonId){case LeftMenuButton.LIST:$('#bandingDiv').html(CompileBandingStripTemplate(1));$('#bandingDiv').show();updateAuthorityButtonSetWidth();focusLocalAuthorityInAccordionIfRequired(clickedButtonId);break;case LeftMenuButton.MAP:MapMenuItemClicked(settings.selectedMapOption.layerType,settings.selectedMapOption.layerSpecies);$('#bandingDiv').show();break;case LeftMenuButton.GUIDE:break;case LeftMenuButton.VIDEO:ConfigureFlashVideoFrames();break;case LeftMenuButton.ALERT:if(isChromeExtension){var hostObj=getHostObj();hostObj.browserAction.setBadgeText({text:''});hostObj.browserAction.setTitle({title:settings.appName})}break;case LeftMenuButton.NEWS:break;case LeftMenuButton.FORECAST:focusCurrentForecast();$('#bandingDiv').html(CompileBandingStripTemplate(1));$('#bandingDiv').show();break;case LeftMenuButton.TWITTER:break}configureDimensions();if(safariObjSupported()){var links=$('body').find('a');links.unbind();links.click(function(e){var anchor=$(e.currentTarget);var href=anchor.attr('href')||'';var target=anchor.attr('target')||'';if(href.length>1){e.preventDefault();getSafariObj().application.activeBrowserWindow.openTab().url=href}})}}function configureMapsButtonSet(){$(".mapMenuItem").unbind();$(".mapsButton").unbind();$(".mapMenuItem").removeClass('selectedMenuItem');$(".mapsButton").removeClass('selectedMenuItem');$(".mapsButton").button({icons:{secondary:"ui-icon-triangle-1-s"}});$(".mapsButton").each(function(index,elem){var el=$(elem);var layerType=el.attr('data-type');el.removeClass('selectedMenuItem');if(layerType===LayerType[settings.selectedMapOption.layerType]){el.addClass('selectedMenuItem')}});$(".mapsButton").click(function(evt){var button=$(evt.currentTarget);var menu=button.next();var show=true;if(menu.is(':visible')){show=false}$('body').find('[role="menu"]').hide();if(show){$(document).one("click",function(evt){menu.hide()});if(menu.attr('role')===undefined){menu.buttonset().menu();menu.css({'z-index':999999999,'max-width':button.innerWidth()-6,width:button.innerWidth()-6,'font-size':'12px'});$(".mapMenuItem").removeClass('selectedMenuItem');$(".mapsButton").removeClass('selectedMenuItem');menu.children().each(function(idx,ele){var li=$(ele);var a=li.find('a').first();var layerCode=a.attr('data-code');var layerType=a.attr('data-type');if(layerCode===LayerSpecies[settings.selectedMapOption.layerSpecies]&&layerType===LayerType[settings.selectedMapOption.layerType]){a.addClass('selectedMenuItem');a.closest('ul').prev().addClass('selectedMenuItem');return false}});$(".mapMenuItem").css({'padding-left':'0px','padding-right':'0px'})}menu.show();menu.position({my:"left top",at:"left bottom",of:button});return false}});$(".mapMenuItem").on("click",function(evt){var menuItem=$(evt.currentTarget);if(!menuItem.hasClass('selectedMenuItem')){$(".mapMenuItem").removeClass('selectedMenuItem');$(".mapsButton").removeClass('selectedMenuItem');var menuItem=$(evt.currentTarget);menuItem.closest('ul').prev().addClass('selectedMenuItem');menuItem.addClass('selectedMenuItem');var layerCode=menuItem.attr('data-code');var layerType=menuItem.attr('data-type');MapMenuItemClicked(LayerType[layerType],LayerSpecies[layerCode])}});if(settings.hideMapButtonSet){$('#mapsButtonSet').hide()}}function GetTargetLayer(layerType,layerSpecies){var layers=dataDownloader.CurrentData().layerData;var targetLayer={IsHourly:true,LayerType:'hourly',layercode:'site',mapId:'',showOpacitySlider:false};if(layers!=null&&layers.objects!=null){for(var i=0;i<layers.objects.length;i++){var layer=layers.objects[i];if(layer.layercode==LayerSpecies[layerSpecies]&&layer.LayerType.toUpperCase()==LayerType[layerType]){targetLayer=layer;targetLayer.showOpacitySlider=true;break}}}targetLayer.mapId=targetLayer.LayerType.toLowerCase()+'-'+targetLayer.layercode.toLowerCase();return targetLayer}function MapMenuItemClicked(layerType,layerSpecies){trackMapButtonClick(layerType,layerSpecies);settings.selectedMapOption.setSelectedMap(layerType,layerSpecies);if(layerType==LayerType.HOURLY){var bandingId=2;if(layerSpecies==LayerSpecies.SITE){bandingId=1}$('#bandingDiv').html(CompileBandingStripTemplate(bandingId))}else if(layerType==LayerType.ANNUAL&&layerSpecies==LayerSpecies.NO2){$('#bandingDiv').html(CompileBandingStripTemplate(3))}else if(layerType==LayerType.ANNUAL&&layerSpecies==LayerSpecies.PM10){$('#bandingDiv').html(CompileBandingStripTemplate(4))}else if(layerType==LayerType.ANNUAL&&layerSpecies==LayerSpecies.PM25){$('#bandingDiv').html(CompileBandingStripTemplate(5))}var targetLayer=GetTargetLayer(layerType,layerSpecies);var mapDiv=$("div[id='"+targetLayer.mapId+"']");$('#mapContent').children('div').hide(0);if(mapDiv.length>0){mapDiv.show()}else{var html=$(CompileSpeciesMapTemplate(targetLayer));$('#mapContent').append($(html));var mapId=targetLayer.mapId;var root=$('#MAPContent').find("div[id='"+mapId+"']");var speciesMapBand=root.find("div[class='speciesMapBand']");var scrollPanel=$('#scrollPanel');var iH=40;var iW=640;var sW=scrollPanel.width()-10;var ratio=(sW/iW);speciesMapBand.find('img').width(iW*ratio);speciesMapBand.find('img').height(iH*ratio);var speciesMap=root.find("div[class='speciesMap']");var h1=scrollPanel.innerHeight();var ot=0;if(speciesMap!=null&&speciesMap.offset()!=null){ot=speciesMap.offset().top}speciesMap.css({height:h1-ot+15,width:scrollPanel.width()-10});var greyscaleMap=[{stylers:[{saturation:-80}]}];var greyMapType=new google.maps.StyledMapType(greyscaleMap,{name:"Greyscale"});var mapOptions={streetViewControl:false,disableDoubleClickZoom:false,draggable:true,keyboardShortcuts:false,mapTypeControl:true,scrollwheel:false,zoomControl:true,noClear:false,maxZoom:20,minZoom:5,panControl:false,zoomControlOptions:{style:google.maps.ZoomControlStyle.SMALL,position:google.maps.ControlPosition.LEFT_TOP},zoom:9,center:new google.maps.LatLng(51.507674,-0.138016),mapTypeControlOptions:{mapTypeIds:[google.maps.MapTypeId.ROADMAP,'greyscale']}};var map2=new google.maps.Map(speciesMap[0],mapOptions);map2.mapTypes.set('greyscale',greyMapType);map2.setMapTypeId('greyscale');if(layerSpecies==LayerSpecies.SITE){map2.setCenter(new google.maps.LatLng(51.507674,-0.138016));if(settings.selectedMapOption.layerSpecies==LayerSpecies.SITE&&settings.selectedMapOption.IsHourly){var data=dataDownloader.CurrentData().authorityData.objects.authorities;var markers=new Array;var markerId=0;var bounds=new google.maps.LatLngBounds;$.each(data,function(i,la){if(la.Site.length>0&&parseInt(la.LocalAuthorityCode)!=settings.meanLaId){$.each(la.Site,function(s,site){var loc=new google.maps.LatLng(site.Latitude,site.Longitude);var pinTitle=la.LocalAuthorityName+' - '+site.SiteName;var laTOrNotT='';if(la.maxIndexSource=='Trigger'){laTOrNotT='T'}var ico='images/aqMap/aqMap'+laTOrNotT+site.maxIndex+'.png';markers[markerId]=new google.maps.Marker({position:loc,title:pinTitle,icon:ico,clickable:true});markers[markerId].setZIndex(site.maxIndex);bounds.extend(markers[markerId].position);markerId++})}});for(var i=0;i<markers.length;i++){google.maps.event.addListener(markers[i],'click',MarkerClicked);markers[i].setMap(map2)};map2.setCenter(bounds.getCenter());map2.fitBounds(bounds);setTimeout(function(){var zoomLevel=map2.getZoom();zoomLevel=zoomLevel+1;map2.setZoom(zoomLevel);var fitsAll=true;var bounds2=map2.getBounds();for(var ii=0;ii<markers.length;ii++){if(bounds2&&!bounds2.contains(markers[ii].getPosition())){fitsAll=false;break}}if(fitsAll==false){map2.setZoom(zoomLevel-1)}},750);function dragend1(){if(!mapEventInProgress){mapEventInProgress=true;if(map2!=null&&markers!=null){var exists=false;var bounds2=new google.maps.LatLngBounds;var mapBounds66=map2.getBounds();for(var ic=0;ic<markers.length;ic++){bounds2.extend(markers[ic].position);if(mapBounds66!=null&&mapBounds66.contains(markers[ic].getPosition())){exists=true;break}}if(exists==false){map2.fitBounds(bounds2)}}mapEventInProgress=false}}google.maps.event.addListener(map2,'dragend',dragend1);function zoomChanged1(){if(!mapEventInProgress){mapEventInProgress=true;if(map2!=null&&markers!=null){var exists=false;var bounds3=new google.maps.LatLngBounds;var mapBounds55=map2.getBounds();for(var y=0;y<markers.length;y++){bounds3.extend(markers[y].position);if(mapBounds55&&mapBounds55.contains(markers[y].getPosition())){exists=true;break}}if(exists==false){map2.fitBounds(bounds3)}}mapEventInProgress=false}}google.maps.event.addListener(map2,'zoom_changed',zoomChanged1)}}else if(targetLayer!=null&&targetLayer.LayerUrl!=null&&targetLayer.LayerUrl.length>0){var dynamap=new gmaps.ags.MapOverlay(targetLayer.LayerUrl,{name:'ArcGIS',opacity:0.5});dynamap.setMap(map2);var opContainer=root.find('div[class="opContainer"]');var slider=root.find('div[class="bar"]');var bar=root.find('div[class="slider"]');var range=slider.width()-bar.width();map2.controls[google.maps.ControlPosition.TOP_RIGHT].push(opContainer[0]);var opSlider=new ExtDraggableObject(bar[0],{restrictY:true,container:slider[0]});var opacity=0.5;opSlider.setValueX((range*opacity));opContainer.zIndex(999);setTimeout(function(){opContainer.show()},500);google.maps.event.addListener(opSlider,'drag',function(evt){if(!mapEventInProgress){mapEventInProgress=true;var op=opSlider.left()/range;dynamap.setOpacity(op);speciesMap.css({height:h1-ot+15,width:scrollPanel.width()-10});mapEventInProgress=false}});google.maps.event.addDomListener(root.find('div[class="less"]')[0],'click',function(){var op=Math.max(dynamap.getOpacity()-0.1,0);dynamap.setOpacity(op);opSlider.setValueX(range*op)});google.maps.event.addDomListener(root.find('div[class="more"]')[0],'click',function(){var op=Math.min(dynamap.getOpacity()+0.1,1);dynamap.setOpacity(op);opSlider.setValueX(range*op)})}}}function focusLocalAuthorityInAccordionIfRequired(clickedButtonId){debug('focusLocalAuthorityInAccordionIfRequired - Checking if an LA needs to be expanded...');if(!authorityExpanded&&settings.startLAId>0&&settings.selectedLeftButton==LeftMenuButton.LIST){debug('focusLocalAuthorityInAccordionIfRequired - Starting to expand LA '+settings.startLAId+'...');var contentId='#'+LeftMenuButton[clickedButtonId]+'Content';debug('contentId: '+contentId);var allDivs=$(contentId).find('#accordion2').find('div[data-laid]');var div=$(contentId).find('#accordion2').find('div[data-laid="'+settings.startLAId+'"]').first();var h3=$(contentId).find('#accordion2').find('h3[data-laid="'+settings.startLAId+'"]').first();var idx=allDivs.index(div);if(idx>=0){debug('focusLocalAuthorityInAccordionIfRequired - Expanding accordion band at index '+idx+'...');$("#accordion2").accordion({active:idx});var scrollTop=h3.offset().top-h3.height();$('#scrollPanel').scrollTop(scrollTop);authorityExpanded=true;debug('focusLocalAuthorityInAccordionIfRequired-LA should now be expanded and visible.')}}}function focusCurrentForecast(){var allH3=$('#forecastAccordion').find('h3[data-current]');var h3=$('#forecastAccordion').find('h3[data-current="true"]').first();var idx=allH3.index(h3);if(idx>=0){$("#forecastAccordion").accordion({active:idx})}}function ConfigureFlashVideoFrames(){if(settings.embedFlashVideos){var images=$('.videoImg img');images.click(function(evt){var sender=$(evt.currentTarget);var imgParent=sender.closest('.videoImg').first();var parent=sender.closest('.videoMedia').first();var flash=parent.find('.videoFlash').first();var flashFrame=flash.find('.flashFrame').first();var dataSrc=flashFrame.attr('data-src');flashFrame.attr('src',dataSrc);flashFrame.height(sender.height());flashFrame.load(function(evt){if(settings.selectedLeftButton==LeftMenuButton.VIDEO){imgParent.hide();flash.show()}})})}}function HideAllFlashFrames(){var flashFrames=$('#VIDEOContent').find('.flashFrame');flashFrames.unbind();$('#VIDEOContent').find('.videoFlash').hide(0);var srcAttr=flashFrames.attr('src');if(srcAttr&&srcAttr.length>0){flashFrames.removeAttr('src')}$('#VIDEOContent').find('.videoImg').show(0)}function RenderMapsButtonContent(forceRefresh){if(forceRefresh===void 0){forceRefresh=false}var contentId='#'+LeftMenuButton[LeftMenuButton.MAP]+'Content';if(forceRefresh){$(contentId).find('*').remove();$(contentId).html('');var html=CompileMapsTemplate();$(contentId).html(html);configureMapsButtonSet()}}function RenderAlertsButtonContent(forceRefresh){if(forceRefresh===void 0){forceRefresh=false}var contentId='#'+LeftMenuButton[LeftMenuButton.ALERT]+'Content';if(forceRefresh){$(contentId).find('*').remove();$(contentId).html('');var html=CompileAlertsTemplate();$(contentId).html(html)}}function RenderTwitterButtonContent(forceRefresh){if(forceRefresh===void 0){forceRefresh=false}var contentId='#'+LeftMenuButton[LeftMenuButton.TWITTER]+'Content';if(forceRefresh){$(contentId).find('*').remove();$(contentId).html('');var html='';html+='<a class="twitter-timeline" data-dnt="true" data-tweet-limit="10" data-chrome="noheader nofooter noborders" data-show-replies="false" data-screen-name="'+settings.twitterId+'" data-widget-id="411982480883716097"></a>';html+='<script>!function (d, s, id) { var js, fjs = d.getElementsByTagName(s)[0], p = /^http:/.test(d.location) ? \'http\' : \'https\'; if (!d.getElementById(id)) { js = d.createElement(s); js.id = id; js.src = p + "://platform.twitter.com/widgets.js"; fjs.parentNode.insertBefore(js, fjs); } }(document, "script", "twitter-wjs");</script>';$(contentId).html(html)}}function RenderNewsButtonContent(forceRefresh){if(forceRefresh===void 0){forceRefresh=false}var contentId='#'+LeftMenuButton[LeftMenuButton.NEWS]+'Content';if(forceRefresh){$(contentId).find('*').remove();$(contentId).html('');var html=CompileNewsTemplate();var htmlElement=$(html);htmlElement.find('script').remove();var stringWithoutScripts=htmlElement.wrap("<div>").parent().html();$(contentId).append(stringWithoutScripts);var allNewsImages=$('.newsDescription').find('img');allNewsImages.hide(0);var maxImgWidth=$('#NEWSContent').width()-25;$.each(allNewsImages,function(idx,item){$(item).removeAttr('width');$(item).removeAttr('height');$(item).css('margin-bottom','5px');$(item).show(0,function(){var imgElement=$(item).get(0);if((imgElement.width>=(maxImgWidth/2))&&(imgElement.width>=(imgElement.height*2))){$(item).css('width',maxImgWidth)}else{$(item).css('margin-right','10px');$(item).attr('align','left');$(item).css('max-width',(maxImgWidth/2)+'px')}})});$('.newsDescription').find('ul').children('br').remove();$('.newsDescription ul').wrap('<div style="clear:both;"></div>');var allLinks=$('.newsList').find('a');allLinks.attr('target','_blank')}}function RenderForecastButtonContent(forceRefresh){if(forceRefresh===void 0){forceRefresh=false}var contentId='#'+LeftMenuButton[LeftMenuButton.FORECAST]+'Content';if(forceRefresh){$(contentId).find('*').remove();$(contentId).html('');var html=CompileForecastTemplate();$(contentId).html(html);$("#forecastAccordion").accordion({animate:false,collapsible:true,heightStyle:'content',header:"h3",icons:{header:"ui-icon-plus",headerSelected:"ui-icon-minus"},active:false})}}function RenderVideoButtonContent(forceRefresh){if(forceRefresh===void 0){forceRefresh=false}var contentId='#'+LeftMenuButton[LeftMenuButton.VIDEO]+'Content';if(forceRefresh){$(contentId).find('*').remove();$(contentId).html('');var html=CompileVideoTemplate();$(contentId).html(html)}}function RenderListButtonContent(forceRefresh){if(forceRefresh===void 0){forceRefresh=false}var contentId='#'+LeftMenuButton[LeftMenuButton.LIST]+'Content';if(forceRefresh){$(contentId).find('*').remove();$(contentId).html('');var accordionHtml=CompileAccordionTemplate();$(contentId).html(accordionHtml);$("#accordion1").hide();$("#accordion2").hide();$("#accordion1").accordion({activate:trackAccordionClick,animate:false,collapsible:true,heightStyle:'content',header:"h3",icons:{header:"ui-icon-plus",headerSelected:"ui-icon-minus"},active:false});$("#accordion2").accordion({activate:trackAccordionClick,animate:false,collapsible:true,heightStyle:'content',header:"h3",icons:{header:"ui-icon-plus",headerSelected:"ui-icon-minus"},active:false});$('#accordion1').off();$('#accordion2').off();$('#accordion1').on("accordionactivate",AccordionChange);$('#accordion2').on("accordionactivate",AccordionChange);var meansHtml=CompileMeansTemplate();$('#MeansContent').html(meansHtml);if(!settings.hideAuthorityButtonSet){$('#listMode').buttonset();$('#listMode').find('[type="radio"]').click(function(e){AuthorityButtonSetClicked(e)})}switch(settings.startAuthorityButtonSet){case ListMenuButton.MODERATE:ShowModerateSites();break;case ListMenuButton.MEAN:ShowSiteMeans();break;case ListMenuButton.AUTHORITIES:ShowAllSites();break}updateAuthorityButtonSetWidth()}}function RenderGuideButtonContent(forceRefresh){if(forceRefresh===void 0){forceRefresh=false}var contentId='#'+LeftMenuButton[LeftMenuButton.GUIDE]+'Content';if(forceRefresh){$(contentId).find('*').remove();$(contentId).html('');var html=CompileGuideTemplate();$(contentId).html(html);$("#accordion3").accordion({animate:false,collapsible:true,heightStyle:'content',header:"h3",icons:{header:"ui-icon-plus",headerSelected:"ui-icon-minus"},active:0})}}function AccordionChange(event,ui){var targetElement=$(ui.newPanel[0]);if(targetElement.length>0){if(targetElement.children().length==0){var selectedLaId=parseInt(targetElement[0].attributes['data-laid'].value);var las=dataDownloader.CurrentData().authorityData.objects.authorities;var la=null;for(var laIdx=0;laIdx<las.length;laIdx++){if(las[laIdx].LocalAuthorityCode==selectedLaId){la=las[laIdx];break}}if(la!=null){var source=$("#accordion-content-template").html();var template=Handlebars.compile(source);var accordionContentHtml=template(la);targetElement.html('');targetElement.html(accordionContentHtml);var siteList=targetElement.find('[data-sitecode]');siteList.each(function(){$(this).off('click');$(this).click({la:la,site:la.getSiteFromSiteCode(this.attributes['data-sitecode'].value)},SiteClicked)});var myOptions={streetViewControl:false,mapTypeControl:false,draggable:true,keyboardShortcuts:false,scrollwheel:false,zoomControl:true,noClear:false,mapTypeId:google.maps.MapTypeId.ROADMAP,styles:[{stylers:[{saturation:-80}]}],zoomControlOptions:{style:google.maps.ZoomControlStyle.SMALL,position:google.maps.ControlPosition.LEFT_TOP}};var mapDiv=$(this).find('[data-laid="'+la.LocalAuthorityCode+'"][class="mapCanvas"]')[0];var mapA=new google.maps.Map(mapDiv,myOptions);var bounds=new google.maps.LatLngBounds;var m=new Array(la.Site.length);for(var s=0;s<la.Site.length;s++){var loc=new google.maps.LatLng(la.Site[s].Latitude,la.Site[s].Longitude);var ico='images/aqMap/aqMap'+la.IndexPrefix+la.Site[s].maxIndex+'.png';var pinTitle=la.Site[s].sitename;m[s]=new google.maps.Marker({position:loc,title:pinTitle,icon:ico});m[s].setZIndex(la.Site[s].maxIndex);m[s].setMap(mapA);google.maps.event.addListener(m[s],'click',MarkerClicked);bounds.extend(m[s].position)}if(la.Site.length>0){mapA.fitBounds(bounds)}else{mapA.setCenter(new google.maps.LatLng(la.LaCentreLatitude,la.LaCentreLongitude))}google.maps.event.addListener(mapA,'dragend',function(){if(!mapEventInProgress){mapEventInProgress=true;if(mapA&&mapA!=null){var exists=false;var bounds=mapA.getBounds();if(bounds&&bounds!=null){for(var midx=0;midx<m.length;midx++){if(bounds.contains(m[midx].getPosition())){exists=true;break}}if(exists==false){mapA.setCenter(m[0].getPosition())}}}mapEventInProgress=false}});var zoomchanged2=function(){if(!mapEventInProgress){mapEventInProgress=true;if(mapA&&mapA!=null){var exists=false;var bounds=mapA.getBounds();if(bounds&&bounds!=null){for(var midx=0;midx<m.length;midx++){if(bounds.contains(m[midx].getPosition())){exists=true;break}}if(exists==false){mapA.setCenter(m[0].getPosition())}}}mapEventInProgress=false}};google.maps.event.addListener(mapA,'zoom_changed',zoomchanged2);updateAuthorityButtonSetWidth()}}}}function updateAuthorityButtonSetWidth(){if(!settings.hideAuthorityButtonSet){var buttonWidth=Math.floor($('#content').width()/3);$('#listMode').buttonset().find('label').css('width',buttonWidth.toString()+'px')}}function MarkerClicked(e){if(!mapEventInProgress){mapEventInProgress=true;var clickedLatLng=e.latLng;var las=dataDownloader.CurrentData().authorityData.objects.authorities;for(var laIdx=0;laIdx<las.length;laIdx++){for(var s=0;s<las[laIdx].Site.length;s++){var loc=new google.maps.LatLng(las[laIdx].Site[s].Latitude,las[laIdx].Site[s].Longitude);if(loc.lat()==clickedLatLng.lat()&&loc.lng()==clickedLatLng.lng()){SiteClicked({data:{la:las[laIdx],site:las[laIdx].Site[s]}});break}}}mapEventInProgress=false}}function SiteClicked(e){var source=$("#site-details-template").html();var template=Handlebars.compile(source);var html=template(e.data);var site=e.data.site;var hc=getIndexHexColor(site.maxIndex);try{_gaq.push(['_trackEvent','Site','Clicked',site.sitename])}catch(e){}$('#mask-overlay').html(html);var h=$(window).height();var w=$(window).width();var l=settings.hideLeftMenu?0:55;var ps=$('#mask-overlay').css('padding-left');var pi=parseInt(ps.replace('px',''))*2;var bls=$('#mask-overlay').css('border-left-width');var bli=parseInt(bls.replace('px',''))*2||0;var cdh=0;$('#mask-overlay').css({height:(h-pi-bli-cdh)+'px',width:(w-pi-bli-l)+'px',top:'0px',left:l+'px','border-color':hc});$('#mask').css({height:(h-cdh)+'px',width:(w)+'px',top:'0px',left:'0px','background-color':hc});$('#mask').fadeTo('fast',0.4);$('#mask-overlay').fadeIn('fast',function(){var mapDiv=$(this).find('[class="mapCanvas"]')[0];var t=$(mapDiv).position().top;var mh=(h-pi-bli-cdh)-t-10;$(mapDiv).height(mh);var siteLoc=new google.maps.LatLng(site.Latitude,site.Longitude);var myOptions={center:siteLoc,streetViewControl:false,mapTypeControl:false,draggable:false,keyboardShortcuts:false,scrollwheel:false,zoomControl:true,noClear:false,maxZoom:20,minZoom:8,zoom:17,mapTypeId:google.maps.MapTypeId.ROADMAP,styles:[{stylers:[{saturation:-80}]}],zoomControlOptions:{style:google.maps.ZoomControlStyle.SMALL,position:google.maps.ControlPosition.LEFT_TOP}};var mapB=new google.maps.Map(mapDiv,myOptions);var m=new google.maps.Marker({position:siteLoc,clickable:false});m.setMap(mapB);google.maps.event.addListener(mapB,'dragend',function(){if(!mapEventInProgress){mapEventInProgress=true;if(mapB!=null&&siteLoc!=null){if(!mapB.getBounds().contains(siteLoc)){mapB.setCenter(siteLoc)}}mapEventInProgress=false}});var zoomchanged3=function(){if(!mapEventInProgress){mapEventInProgress=true;if(mapB!=null&&siteLoc!=null){if(!mapB.getBounds().contains(siteLoc)){mapB.setCenter(siteLoc)}}mapEventInProgress=false}};google.maps.event.addListener(mapB,'zoom_changed',zoomchanged3)});$('#closeButton').click(HideMask);$('#mask').click(HideMask)}function HideMask(e){$('#closeButton').off();$('#mask').off();$('#mask-overlay').fadeOut('fast');$('#mask').fadeOut('fast',function(){$('#mask-overlay').html('')})}function initGoogleAnalytics(){try{_gaq.push(['_setAccount',settings.googleAnalyticsId]);_gaq.push(['_setDomainName','none']);var page=$.trim('/'+window.location.pathname.toLowerCase()+window.location.search).replace('//','/');_gaq.push(['_trackPageview',page])}catch(e){}}function createAndHideContentDivs(){for(var leftButtonEnum in LeftMenuButton){var isName=parseInt(leftButtonEnum)>=0;if(isName){var contentId=LeftMenuButton[leftButtonEnum]+'Content';$('#content').append('<div id="'+contentId+'" class="contentDiv"></div>');$(contentId).remove('*');$(contentId).html('');$(contentId).hide()}}}function registerHandleBarHelpers(){Handlebars.registerHelper('getAccordionButtonSet',function(){var html='';html+='<input type="radio" id="MODERATE" name="listModeGroup" '+((settings.startAuthorityButtonSet==ListMenuButton.MODERATE)?'checked="checked"':'')+'/><label for="MODERATE">Moderate</label>';html+='<input type="radio" id="MEAN" name="listModeGroup" '+((settings.startAuthorityButtonSet==ListMenuButton.MEAN)?'checked="checked"':'')+'/><label for="MEAN">Means</label>';html+='<input type="radio" id="AUTHORITIES" name="listModeGroup" '+((settings.startAuthorityButtonSet==ListMenuButton.AUTHORITIES)?'checked="checked"':'')+'/><label for="AUTHORITIES">Authorities</label>';return new Handlebars.SafeString(html)})}function configureMenuAndButtonVisbility(){if(settings.hideLeftMenu){$('#leftColumn').hide();$('#rightColumn').css({left:'0px'})}else{$('#leftColumn').show();$('#contentRoot').css({position:'absolute',left:'55px'});if(settings.hiddenLeftMenuButtons.length>0){$.each(settings.hiddenLeftMenuButtons,function(index,buttonId){$('#'+LeftMenuButton[buttonId]).hide()})}}}function configureDimensions(){var creditOffset=0;if($('#bandingDiv').is(':visible')){creditOffset=$('#bandingDiv').outerHeight()}if(settings.hideLeftMenu){$('#bandingDiv').css('margin-left','0px')}else{$('#bandingDiv').width($(window).width()-parseInt($('#bandingDiv').css('margin-left').replace('px','')))}var scrollHeight=$(window).height()-$('#scrollPanel').position().top-creditOffset;$('#scrollPanel').css({height:scrollHeight+'px'});if(settings.hideLeftMenu){$('#networkCreditDiv').width($('#rightColumn').width())}else{$('#networkCreditDiv').width($('#rightColumn').width()-$('#leftColumn').width())}}function configureButtonClickHandler(){$('#menu').find('[class*="tab"]').off('click');$('#menu').find('[class*="tab"]').click(function(evt){var targetElement=evt.currentTarget;var currentButton=settings.selectedLeftButton;var targetId=targetElement.id;var targetButton=LeftMenuButton[targetId];if(targetButton!=currentButton){doAsync(function(){trackSideBarButtonClick(targetButton)});BeforeLeftButtonClicked(targetButton,currentButton);LeftPanelButtonClicked(targetButton,currentButton)}})}function trackAccordionClick(event,ui){if('length'in ui.newPanel&&ui.newPanel['length']!==null){if(ui.newPanel.length===1){var header=ui.newHeader.first();var laid=parseInt(header.attr('data-laid'));var laName='Unknown';var data=dataDownloader.CurrentData().authorityData.objects.authorities;for(var l=0;l<data.length;l++){var la=data[l];if(parseInt(la.LocalAuthorityCode)===laid){laName=la.LocalAuthorityName;break}}try{_gaq.push(['_trackEvent','Accordion','Clicked',laName])}catch(e){}}}}function trackMapButtonClick(layerType,layerSpecies){var trackName;trackName=(LayerSpecies[layerSpecies]+LayerType[layerType]+'Button');trackName=trackName.replace('HOURLY','Hourly').replace('ANNUAL','Annual').replace('NO2','No2').replace('COMBINED','Combined').replace('SITEHourlyButton','SitesButton');try{_gaq.push(['_trackEvent','MapView','Clicked',trackName])}catch(e){}}function trackSideBarButtonClick(targetButton){var trackName='UnknownView';switch(targetButton){case(LeftMenuButton.ALERT):trackName='AlertsView';break;case(LeftMenuButton.FORECAST):trackName='ForecastView';break;case(LeftMenuButton.GUIDE):trackName='GuideView';break;case(LeftMenuButton.LIST):trackName='ListView';break;case(LeftMenuButton.MAP):trackName='MapView';break;case(LeftMenuButton.NEWS):trackName='NewsView';break;case(LeftMenuButton.VIDEO):trackName='VideosView';break;case(LeftMenuButton.TWITTER):trackName='TwitterView';break}try{_gaq.push(['_trackEvent','SideBar','Clicked',trackName])}catch(e){}}