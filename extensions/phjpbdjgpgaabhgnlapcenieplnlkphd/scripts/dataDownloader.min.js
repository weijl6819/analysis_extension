var DataDownloader=(function(){function DataDownloader(changedCallback,unchangedCallback){this.changedCallback=changedCallback;this.unchangedCallback=unchangedCallback;this.authorityData=null;this.alertData=null;this.layerData=null;this.videoData=null;this.newsData=null;this.forecastData=null;this.downloadCount=6;this.remainingCount=this.downloadCount;this.authoritiesDownloader=new AuthoritiesDownloader(settings.authoritiesUrl);this.alertsDownloader=new AlertsDownloader(settings.alertsUrl);this.layersDownloader=new LayersDownloader(settings.layersUrl);this.videoDownloader=new VideoDownloader(settings.videosUrl);this.newsDownloader=new NewsDownloader(settings.newsUrl);this.forecastDownloader=new ForecastDownloader(settings.forecastUrl)}DataDownloader.prototype.CurrentData=function(){return{authorityData:this.authorityData,alertData:this.alertData,layerData:this.layerData,videoData:this.videoData,newsData:this.newsData,forecastData:this.forecastData}};DataDownloader.prototype.SetAuthorityData=function(data){this.authorityData=data};DataDownloader.prototype.SetAlertData=function(data){this.alertData=data};DataDownloader.prototype.SetLayerData=function(data){this.layerData=data};DataDownloader.prototype.SetVideoData=function(data){this.videoData=data};DataDownloader.prototype.SetNewsData=function(data){this.newsData=data};DataDownloader.prototype.SetForecastData=function(data){this.forecastData=data};DataDownloader.prototype.derementRemainingCount=function(){if(this.remainingCount>0){this.remainingCount--}return this.remainingCount};DataDownloader.prototype.resetDownloadTimer=function(context){var mins=moment().minutes()-1;var waitMins=0;if(!settings.updateEveryMinute){waitMins=Math.max(1,settings.ttl);if(waitMins<=0){waitMins=5}}else{waitMins=1}var interval=1000*60*waitMins;debug('Next download @ '+moment().add('m',waitMins).format('HH:mm:ss')+'; waitMins='+waitMins+'; minute='+moment().minutes()+'; interval='+interval);if(this.timerHandle){clearTimeout(this.timerHandle)}this.timerHandle=setTimeout(function(){$('#loader').show();context.DownloadAllData()},interval)};DataDownloader.prototype.Start=function(){this.remainingCount=this.downloadCount;this.DownloadAllData()};DataDownloader.prototype.DownloadAllData=function(){var ctx=this;this.resetDownloadTimer(ctx);this.remainingCount=ctx.downloadCount;var getAlerts=true;var getLayers=true;var getAuthorities=true;var getNews=true;var getVideos=true;var getForecast=true;if(!settings.hideLeftMenu&&settings.hiddenLeftMenuButtons.length>0){$.each(settings.hiddenLeftMenuButtons,function(index,buttonId){if(buttonId==LeftMenuButton.ALERT){ctx.remainingCount--;getAlerts=false}else if(buttonId==LeftMenuButton.LIST){ctx.remainingCount--;getAuthorities=false}else if(buttonId==LeftMenuButton.MAP){ctx.remainingCount--;getLayers=false}else if(buttonId==LeftMenuButton.NEWS){ctx.remainingCount--;getNews=false}else if(buttonId==LeftMenuButton.VIDEO){ctx.remainingCount--;getVideos=false}else if(buttonId==LeftMenuButton.FORECAST){ctx.remainingCount--;getForecast=false}})}else if(settings.hideLeftMenu){ctx.remainingCount=1;getAlerts=false;getLayers=false;getNews=false;getVideos=false;getForecast=false;if(settings.selectedLeftButton==LeftMenuButton.ALERT){getAlerts=true;ctx.remainingCount++}else if(settings.selectedLeftButton==LeftMenuButton.FORECAST){getForecast=true;ctx.remainingCount++}else if(settings.selectedLeftButton==LeftMenuButton.MAP){getLayers=true;ctx.remainingCount++}else if(settings.selectedLeftButton==LeftMenuButton.NEWS){getNews=true;ctx.remainingCount++}else if(settings.selectedLeftButton==LeftMenuButton.VIDEO){getVideos=true;ctx.remainingCount++}}if(getAuthorities){ctx.authoritiesDownloader.Download()}if(getLayers){ctx.layersDownloader.Download()}if(getVideos){ctx.videoDownloader.Download()}if(getNews){ctx.newsDownloader.Download()}if(getAlerts){ctx.alertsDownloader.Download()}if(getForecast){ctx.forecastDownloader.Download()}};DataDownloader.prototype.DownloadCompleted=function(data,downloader){if(downloader instanceof AuthoritiesDownloader){dataDownloader.SetAuthorityData(data)}else if(downloader instanceof AlertsDownloader){dataDownloader.SetAlertData(data)}else if(downloader instanceof LayersDownloader){dataDownloader.SetLayerData(data)}else if(downloader instanceof VideoDownloader){dataDownloader.SetVideoData(data)}else if(downloader instanceof NewsDownloader){dataDownloader.SetNewsData(data)}else if(downloader instanceof ForecastDownloader){dataDownloader.SetForecastData(data)}var remain=dataDownloader.derementRemainingCount();if(remain==0){this.resetDownloadTimer(dataDownloader);var newData=dataDownloader.CurrentData();if(firstDataLoad||(newData.authorityData!=null&&newData.authorityData.hasChanged||newData.alertData!=null&&newData.alertData.hasChanged||newData.layerData!=null&&newData.layerData.hasChanged||newData.videoData!=null&&newData.videoData.hasChanged||newData.newsData!=null&&newData.newsData.hasChanged||newData.forecastData!=null&&newData.forecastData.hasChanged)){dataDownloader.lastChangedUtc=moment.utc().toDate();dataDownloader.changedCallback(newData)}else{dataDownloader.unchangedCallback(newData)}}};return DataDownloader}())