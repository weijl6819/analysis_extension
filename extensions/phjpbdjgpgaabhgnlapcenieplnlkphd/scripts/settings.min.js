var isSafariExtension=(window.location.protocol.toLowerCase()=='safari-extension:');var isChromeExtension=(window.location.protocol.toLowerCase()=='chrome-extension:');var isExtensionBackgroundPage=(document.location.href.toLowerCase().indexOf('extensionBg.html')>0);var configFile='';var state="live";var network="london";$.ajax({dataType:"json",cache:false,url:getPrefixedUrl('configuration/state.txt')+"?t="+parseInt((new Date).getTime().toString().substring(0,10)).toString(),async:false}).always(function(json){state=json.appState.toLowerCase()});if(isChromeExtension||isSafariExtension){$.ajax({dataType:"json",cache:false,url:getPrefixedUrl('manifest.json')+"?t="+parseInt((new Date).getTime().toString().substring(0,10)).toString(),async:false}).always(function(json){if(json.short_name.toLowerCase().indexOf('london')>=0){network='london'}else if(json.short_name.toLowerCase().indexOf('sussex')>=0){network='sussex'}});configFile=getPrefixedUrl('configuration/configuration_'+state+'_extension_'+network+'.txt')}else{var loc=window.location;var locVal=decodeURI((RegExp('network'+'='+'(.+?)(&|$)','i').exec(loc.search)||[,null])[1]);if(locVal&&locVal!=='null'){network=locVal}else{var hostName=window.location.href.toLowerCase();if(hostName.indexOf('londonair.org.uk')>=0){network='london'}else if(hostName.indexOf('sussex-air.net')>=0){network='sussex'}else{network='london'}debug('No network param was found so was set to '+network+'.')}configFile=getPrefixedUrl('configuration/configuration_'+state+'_iframe_'+network+'.txt')}var LeftMenuButton;(function(LeftMenuButton){LeftMenuButton[LeftMenuButton["LIST"]=0]="LIST";LeftMenuButton[LeftMenuButton["MAP"]=1]="MAP";LeftMenuButton[LeftMenuButton["GUIDE"]=2]="GUIDE";LeftMenuButton[LeftMenuButton["VIDEO"]=3]="VIDEO";LeftMenuButton[LeftMenuButton["ALERT"]=4]="ALERT";LeftMenuButton[LeftMenuButton["NEWS"]=5]="NEWS";LeftMenuButton[LeftMenuButton["FORECAST"]=6]="FORECAST";LeftMenuButton[LeftMenuButton["TWITTER"]=7]="TWITTER"})(LeftMenuButton||(LeftMenuButton={}));var ListMenuButton;(function(ListMenuButton){ListMenuButton[ListMenuButton["MODERATE"]=0]="MODERATE";ListMenuButton[ListMenuButton["MEAN"]=1]="MEAN";ListMenuButton[ListMenuButton["AUTHORITIES"]=2]="AUTHORITIES"})(ListMenuButton||(ListMenuButton={}));var LayerType;(function(LayerType){LayerType[LayerType["HOURLY"]=0]="HOURLY";LayerType[LayerType["ANNUAL"]=1]="ANNUAL"})(LayerType||(LayerType={}));var LayerSpecies;(function(LayerSpecies){LayerSpecies[LayerSpecies["SITE"]=0]="SITE";LayerSpecies[LayerSpecies["COMBINED"]=1]="COMBINED";LayerSpecies[LayerSpecies["NO2"]=2]="NO2";LayerSpecies[LayerSpecies["O3"]=3]="O3";LayerSpecies[LayerSpecies["PM25"]=4]="PM25";LayerSpecies[LayerSpecies["PM10"]=5]="PM10"})(LayerSpecies||(LayerSpecies={}));var LeftMenuSpacing;(function(LeftMenuSpacing){LeftMenuSpacing[LeftMenuSpacing["COMFORTABLE"]=0]="COMFORTABLE";LeftMenuSpacing[LeftMenuSpacing["COSY"]=1]="COSY";LeftMenuSpacing[LeftMenuSpacing["COMPACT"]=2]="COMPACT"})(LeftMenuSpacing||(LeftMenuSpacing={}));function getIndexHexColor(idx){switch(parseInt(idx)){case 1:return'#A5CF7C';case 2:return'#6AA940';case 3:return'#2B8200';case 4:return'#DFB386';case 5:return'#E68A45';case 6:return'#EE5F00';case 7:return'#F30000';case 8:return'#C60000';case 9:return'#990000';case 10:return'#000000';default:return'#CCCCCC'}}function localStorageSupported(){try{return'localStorage'in window&&window['localStorage']!==null}catch(e){return false}}function setStoredValue(key,value){if(localStorageSupported()){try{localStorage.setItem(key,value)}catch(e){}}else{$.cookie(key,value)}}function getStoredValue(key){if(localStorageSupported()){return localStorage.getItem(key)}else{return $.cookie(key)}}function truthy(ty){var isTrue=false;if(ty===true){isTrue=true}else if(ty==='true'){isTrue=true}else if(ty==='1'){isTrue=true}else if(ty===1){isTrue=true}return isTrue}function consoleSupported(){try{return'console'in window&&window['console']!==null}catch(e){return false}}function chromeObjSupported(){try{return'chrome'in window&&window['chrome']!==null}catch(e){return false}}function safariObjSupported(){try{return'safari'in window&&window['safari']!==null}catch(e){return false}}function getChromeObj(){var c;if(chromeObjSupported()){c=window['chrome']}return c}function getSafariObj(){var c;if(safariObjSupported()){c=window['safari']}return c}function getHostObj(){if(chromeObjSupported()){return getChromeObj()}if(safariObjSupported()){return getSafariObj()}}function error(msg,o){if(o===void 0){o=undefined}try{if(consoleSupported()){var cnsl;if(safariObjSupported()){cnsl=window['safari'].extension.globalPage.contentWindow.console}else{cnsl=window['console']}if(cnsl!==undefined&&cnsl.error!==undefined){if(o===undefined){cnsl.error(moment().format('DD/MM/YY HH:mm:ss')+': '+msg)}else{cnsl.error(moment().format('DD/MM/YY HH:mm:ss')+': '+msg,[o])}}}}catch(err){}}function debug(msg,o){if(o===void 0){o=undefined}try{if(consoleSupported()){var cnsl;if(safariObjSupported()){cnsl=window['safari'].extension.globalPage.contentWindow.console}else{cnsl=window['console']}if(cnsl!==undefined&&cnsl.debug!==undefined){if(o===undefined){cnsl.debug(moment().format('DD/MM/YY HH:mm:ss')+': '+msg)}else{cnsl.debug(moment().format('DD/MM/YY HH:mm:ss')+': '+msg,[o])}}}}catch(err){}}function doAsync(work,args,callback,delay){var handle=setTimeout(function(){var result=work(args||null);if(callback!=null){if(args)callback(result,args);else callback(result)}},delay||0,args);return handle}var SelectedMapOption=(function(){function SelectedMapOption(){this.layerType=LayerType.HOURLY;this.layerSpecies=LayerSpecies.SITE}SelectedMapOption.prototype.IsHourly=function(){return this.layerType==LayerType.HOURLY};SelectedMapOption.prototype.IsAnnual=function(){return this.layerType==LayerType.ANNUAL};SelectedMapOption.prototype.setSelectedMap=function(type,species){this.layerType=type;this.layerSpecies=species};return SelectedMapOption}());function getUrlWithProtocol(url,useHttps){url=$.trim(url);url=url.replace('https://','//');url=url.replace('http://','//');var p=window.location.protocol;if(p.toLowerCase().indexOf('http')<0){if(useHttps){p='https:'}else{p='http:'}}else{p=''}return p+url}function getPrefixedUrl(url){if($.trim(url).length>0&&url.indexOf('//')<0){var loc=document.location.protocol+window.location.href.replace(window.location.protocol,'');var idx=loc.lastIndexOf('/');var urlPrefix=loc.substr(0,idx+1);return urlPrefix+url}else{return url}}var Stopwatch=(function(){function Stopwatch(start){if(start===void 0){start=false}this.elapsedMiliseconds=0;if(start){this.Start()}}Stopwatch.prototype.Start=function(){this.elapsedMiliseconds=0;this.startTime=(new Date).getTime()};Stopwatch.prototype.Stop=function(){this.endTime=(new Date).getTime();this.elapsedMiliseconds=this.endTime-this.startTime};return Stopwatch}());var Settings=(function(){function Settings(){this.ttl=0;this.selectedMapOption=new SelectedMapOption;this.updateEveryMinute=false;this.useHttps=false;var config;$.ajax({dataType:"json",cache:false,url:configFile+"?t="+parseInt((new Date).getTime().toString().substring(0,10)).toString(),async:false}).always(function(json){debug('config',json);config=json});this.appName=config.appName;this.appVersion=config.appVersion;this.updateEveryMinute=truthy(this.getURLParam('updateEveryMinute',config.updateEveryMinute));this.googleAnalyticsId=config.googleAnalyticsId;this.facebookLink=config.facebookLink;this.twitterId=config.twitterId;this.twitterLink=config.twitterLink;this.websiteLink=config.websiteLink;this.websiteLinkText=config.websiteLinkText;this.websiteLinkTextBgColor=config.websiteLinkTextBgColor;this.websiteLinkTextColor=config.websiteLinkTextColor;this.websiteLinkIcon=config.websiteLinkIcon;this.newsPlaceholderImage=config.newsPlaceholderImage;this.showLAIds=truthy(this.getURLParam('showLAIds',config.showLAIds));this.logoPath=config.logoPath;this.meanLaId=config.meanLaId;this.leftMenuSpacing=LeftMenuSpacing[this.getURLParam('leftMenuSpacing',config.leftMenuSpacing)];this.hideLeftMenu=truthy(this.getURLParam('hideLeftMenu',config.hideLeftMenu));this.hideAuthorityButtonSet=truthy(this.getURLParam('hideAuthorityButtonSet',config.hideAuthorityButtonSet));this.hideMapButtonSet=truthy(this.getURLParam('hideMapButtonSet',config.hideMapButtonSet));this.showAlertsOnNew=truthy(this.getURLParam('showAlertsOnNew',config.showAlertsOnNew));this.embedFlashVideos=truthy(this.getURLParam('embedflash',config.embedFlashVideos));this.startLAId=Math.max(0,parseInt(this.getURLParam('startLAId',config.startLAId)));this.maxNewsItemsToDisplay=parseInt(this.getURLParam('maxNewsItemsToDisplay',config.maxNewsItemsToDisplay));this.hiddenLeftMenuButtons=this.parseHiddenButtonsParam(config.hiddenLeftMenuButtons);this.startAuthorityButtonSet=ListMenuButton[this.getURLParam('startAuthorityButtonSet',config.startAuthorityButtonSet)];this.selectedLeftButton=LeftMenuButton[this.getURLParam('startLeftButton',config.selectedLeftButton)];this.selectedMapOption.setSelectedMap(LayerType[config.setSelectedMap[0]],LayerSpecies[config.setSelectedMap[1]]);this.useHttps=config.useHttps;this.authoritiesUrl=getUrlWithProtocol(getPrefixedUrl(config.authoritiesUrl),this.useHttps);this.alertsUrl=getUrlWithProtocol(getPrefixedUrl(config.alertsUrl),this.useHttps);this.layersUrl=getUrlWithProtocol(getPrefixedUrl(config.layersUrl),this.useHttps);this.newsUrl=getUrlWithProtocol(getPrefixedUrl(config.newsUrl),this.useHttps);this.forecastUrl=getUrlWithProtocol(getPrefixedUrl(config.forecastUrl),this.useHttps);this.videosUrl=config.videosUrl;this.scrollTops=new Array;if(safariObjSupported()===true){this.embedFlashVideos=false}if(isExtensionBackgroundPage){this.hideLeftMenu=false;this.selectedLeftButton=LeftMenuButton.LIST;this.hiddenLeftMenuButtons=[LeftMenuButton.FORECAST,LeftMenuButton.GUIDE,LeftMenuButton.MAP,LeftMenuButton.NEWS,LeftMenuButton.VIDEO]}if(this.isIE(7,'lte')){debug('Crappy browser detected! <= IE7')}}Settings.prototype.isIE=function(version,comparison){if(version===void 0){version=''}if(comparison===void 0){comparison=''}var $div=$('<div style="display:none;"/>').appendTo($('body'));$div.html('<!--[if '+(comparison||'')+' IE '+(version||'')+']><a>&nbsp;</a><![endif]-->');var ieTest=$div.find('a').length;$div.remove();return ieTest};Settings.prototype.parseHiddenButtonsParam=function(hidden){hidden=hidden||'';if($.trim(hidden).toUpperCase()==='NONE'){hiddenButtons=[]}else{var hiddenButtons=[];var hide=$.trim(this.getURLParam('hiddenMenuButtons',''));if($.trim(hide).toUpperCase()==='NONE'){hiddenButtons=[];return hiddenButtons}else if($.trim(hide).length>0){hidden=hide}var hiddenArray=hidden.replace(',,',',').split(',');$.each(hiddenArray,function(idx,item){if(item){var btnStr=$.trim(item);var b=LeftMenuButton[btnStr.toUpperCase()];if(b){hiddenButtons[hiddenButtons.length]=LeftMenuButton[btnStr.toUpperCase()]}}})}return hiddenButtons};Settings.prototype.getURLParam=function(name,defaultValue){var returnValue=defaultValue;var loc=window.location;var locVal=decodeURI((RegExp(name+'='+'(.+?)(&|$)','i').exec(loc.search)||[,null])[1]);if(locVal&&locVal!=='null'){returnValue=locVal}return returnValue};return Settings}())