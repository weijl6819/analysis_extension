var firstDataLoad=true;var XmlDownloader=(function(){function XmlDownloader(Url){this.Url=Url}XmlDownloader.prototype.DownloadCallback=function(o){if(o!=null&&o.hash!=null){if(this instanceof AuthoritiesDownloader){setStoredValue('authorityHash',o.hash)}else if(this instanceof AlertsDownloader){setStoredValue('alertHash',o.hash)}else if(this instanceof LayersDownloader){setStoredValue('layerHash',o.hash)}else if(this instanceof VideoDownloader){setStoredValue('videoHash',o.hash)}else if(this instanceof NewsDownloader){setStoredValue('newsHash',o.hash)}else if(this instanceof ForecastDownloader){setStoredValue('forecastHash',o.hash)}}};XmlDownloader.prototype.Download=function(){if(this.Url!=null&&$.trim(this.Url).length>0){var t=parseInt((new Date).getTime().toString().substring(0,10));var xmlUrl=this.Url;debug('Getting Data: '+xmlUrl.toLowerCase());if(xmlUrl.indexOf('?')>0){xmlUrl=xmlUrl+'&t='+t}else{xmlUrl=xmlUrl+'?t='+t}var dataType='text';if(xmlUrl.indexOf('callback=')>0||xmlUrl.indexOf('googleapis')>0){dataType='json'}var me=this;var sw=new Stopwatch(true);if(navigator.onLine===true){$.ajax({type:'GET',dataType:dataType,cache:false,url:xmlUrl,success:function(a,b){debug('ajax.success',[a,b]);var obj=me.parseResponse(a);me.DownloadCallback(obj)},error:function(a,b,c){error('ajax.error',[a,b,c]);me.DownloadCallback(null);var err=new Error(a.status.toString()+' '+c+' '+xmlUrl);throw err;},complete:function(a,b){sw.Stop();var cmd=['_trackTiming','App','DataDownload',sw.elapsedMiliseconds.toString(),xmlUrl.toLowerCase(),'100'];try{_gaq.push(cmd)}catch(e){}}})}}else{this.DownloadCallback(null)}};XmlDownloader.prototype.getPreviousHash=function(){var prev='';if(this instanceof AuthoritiesDownloader){prev=getStoredValue('authorityHash')||''}else if(this instanceof AlertsDownloader){prev=getStoredValue('alertHash')||''}else if(this instanceof LayersDownloader){prev=getStoredValue('layerHash')||''}else if(this instanceof VideoDownloader){prev=getStoredValue('videoHash')||''}else if(this instanceof NewsDownloader){prev=getStoredValue('newsHash')||''}else if(this instanceof ForecastDownloader){prev=getStoredValue('forecastHash')||''}return prev};XmlDownloader.prototype.parseResponse=function(xmlTxt){if(xmlTxt){var objects=[];var xd=null;if($.isXMLDoc(xmlTxt)){xd=xmlTxt;objects=this.ParseXmlToObj($(xd),undefined)}else{try{xd=$.parseXML($.trim(xmlTxt));objects=this.ParseXmlToObj($(xd),undefined)}catch(e){xd=null;try{objects=xmlTxt}catch(e2){error(e2)}}}var hash=hex_md5(xmlTxt);var previousHash=this.getPreviousHash();var hasChanged=(previousHash!=hash);return{hasChanged:hasChanged,hash:hash,objects:objects}}else{return null}};XmlDownloader.prototype.ParseXmlToObj=function(xmlObj,currentObject){if(currentObject===undefined){currentObject={}}var ctx=this;var recurseNode=true;var childNodes=$(xmlObj).children();for(var index=0;index<childNodes.length;index++){var node=childNodes[index];var nodeName=$.trim(node.nodeName.replace(':','_'));var nodeNameNoNamespace=$.trim(node.nodeName.substr(node.nodeName.indexOf(':')+1));var nodeNamespace=$.trim(node.nodeName.substr(0,node.nodeName.indexOf(':')));var siblings=$(node).siblings().filter(function(){var n=$.trim(this.nodeName.substr(0,this.nodeName.indexOf(':')));var x=$.trim(this.nodeName.substr(this.nodeName.indexOf(':')+1));return x===nodeNameNoNamespace&&nodeNamespace===n});var childrenCount=$(node).children().length;var siblingObj;if(siblings.length>0){if(currentObject[nodeName]===undefined){currentObject[nodeName]=[]}var sIdx=currentObject[nodeName].length;currentObject[nodeName][sIdx]={};siblingObj=currentObject[nodeName][sIdx];if(childrenCount==0&&$(node).text()!=null&&node.attributes!=null&&node.attributes.length>0&&node.firstChild!=null&&$.trim($(node).text()).length>0){siblingObj[node.nodeName]=$(node).text()}ctx.AddAttributesToThisObject(node,siblingObj);ctx.ParseXmlToObj(node,siblingObj);recurseNode=false}else{if(childrenCount>0){currentObject[nodeName]={};ctx.AddAttributesToThisObject(node,currentObject[nodeName]);ctx.ParseXmlToObj(node,currentObject[nodeName]);recurseNode=false}else{recurseNode=false;if(node.attributes!=null&&node.attributes.length>0){currentObject[nodeName]={};ctx.AddAttributesToThisObject(node,currentObject[nodeName])}else{currentObject[nodeName]=$(node).text()}}}if(recurseNode){ctx.AddAttributesToThisObject(node,currentObject);ctx.ParseXmlToObj(node,currentObject)}}return currentObject};XmlDownloader.prototype.AddAttributesToThisObject=function(node,obj){if(obj!=null){$.each(node.attributes,function(i,attr){var name=attr.name.replace(':','_');var value=attr.value;obj[name]=value})}return obj};return XmlDownloader}())