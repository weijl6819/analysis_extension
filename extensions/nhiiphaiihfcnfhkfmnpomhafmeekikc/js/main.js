var Crossrider=(function(){var n;var d;var g;var b;var l;var q;_onMessage=function(y,x,v){try{var z=y.action;var w=!(InternalMessaging.responseLater);if(z&&typeof(this[z])==="function"){var B=y.params&&typeof(y.params["push"])==="function"?y.params:[];if(y.hasOwnProperty("passCallback")&&y.passCallback===true){B.push(v);isCallbackPassed=true;}else{if(y.hasOwnProperty("passSuccessFailure")&&y.passSuccessFailure===true){B.push(y.onSuccess);B.push(y.onFailure);}}if(z==="addUserScripts"||z==="getAppData"){B.push(x.tab);}if(z==="request"){B.push(InternalMessaging.responseLater);}w=this[z].apply(this,B);return w;}}catch(A){Reports.error(new ErrorMessage(A,"Crossrider->_onRequest"));}};var h=function(v){try{for(var w in TableNames){if(w.toLowerCase().indexOf("length")<0){if(TableNames[w]===v){return v;}}}return TableNames.USER_COOKIES;}catch(x){Reports.error(new ErrorMessage(x,"Crossrider->getTableName"));}};var r=function(w,v,x){v=this.getTableName(v);if(n[v][w]){CookieStore.unsetCookie(w,v,function(){delete n[v][w];_broadcastAllTabs("unsetCookie",[w,v]);if(x){x();}});}return InternalMessaging.responseLater;};var u=function(z,A,v,x,w,C){try{x=h(x);if(z==="mysite"){return;}var y=new Date().getTime(),v=new Date(v).getTime();if(y>v){if(n[x][z]){r(z,x);}}else{CookieStore.setCookie(z,A,v,x,function(){n[x][z]={value:A,expires:v};_broadcastAllTabs("updateCookie",[z,n[x][z],x],w);if(C){C();}},function(){_broadcastAllTabs("unsetCookie",[z,x]);});}return InternalMessaging.responseLater;}catch(B){Reports.error(new ErrorMessage(B,"Crossrider->getTableName"));}};var p=function(w){try{for(var v in w){if(w.hasOwnProperty(v)){Crossrider._cookies[v]=w[v]||{};}}if(!Crossrider._cookies[TableNames.USER_COOKIES].hasOwnProperty("mysite")){Crossrider._cookies[TableNames.USER_COOKIES].mysite={};}}catch(x){LogFile.write("file: main.js, function: _copyDBCookiesToMemory, error: "+x.message);Reports.error(new ErrorMessage(x,"_copyDBCookiesToMemory"));}};var o=function(){LogFile.write("_showThankyouPage");try{var v=false;var w=ExtensionDataStore.getManifest();if(n[TableNames.USER_COOKIES].hasOwnProperty("InstallationThankYouPage")){if(n[TableNames.USER_COOKIES]["InstallationThankYouPage"].value){v=true;}}if(w&&w.thanksurl&&!v){chrome.tabs.create({url:w.thanksurl},function(){});}}catch(x){Reports.error(new ErrorMessage(x,"Crossrider->_showThankyouPage"));}};var f=function(y){LogFile.write("_setInstallationTime");try{var w=n[TableNames.USER_COOKIES]["InstallationTime"];if(typeof(w)==="undefined"){w=Math.round((new Date()).getTime()/1000);var v=new Date(2030,1,1,0,0,0,0);u("InstallationTime",w,v,TableNames.USER_COOKIES,undefined,y);return;}if(typeof y==="function"){LogFile.write("_setInstallationTime, no need to set");y();}}catch(x){Reports.error(new ErrorMessage(x,"Crossrider->_setInstallationTime"));}};var t=function(y){LogFile.write("_setInstallationData");var v=function(B,F){var E;var G=Crossrider.manifest.crossrider;var D=false;var A=function(){var H=F;if(typeof H!=="string"){H=F[F.length-1];}return H;};var z=function(){var J,H,I;try{if(typeof F==="string"){if(G.hasOwnProperty(F)){J=G[F];}}else{J=G;for(H=0;H<F.length;H++){I=F[H];if(J.hasOwnProperty(I)){J=J[I];}else{J=undefined;}}}}catch(K){}return J;};var C=function(){return(!Crossrider._cookies[B].hasOwnProperty(A())&&(typeof z()!=="undefined"));};return function(J){try{if(C()){var H=new Date(2030,1,1,0,0,0,0);Crossrider.setCookie(A(),z(),H,B,E,J);return;}LogFile.write("_setInstallationData, no need to set "+F+" ...");J();}catch(I){Reports.error(new ErrorMessage(I,"Crossrider->_setInstallationDataFunctionCreator"));}};};var x=[];x.push(v(TableNames.USER_COOKIES,"InstallerParams"));x.push(v(TableNames.USER_COOKIES,"InstallationThankYouPage"));x.push(v(TableNames.USER_COOKIES,"chrome_enabled"));x.push(v(TableNames.INTERNAL_DB,"installer"));x.push(v(TableNames.INTERNAL_DB,["installer","InstallerIdentifiers"]));try{Utils.FunctionsRunner.parallel(x,y);}catch(w){Reports.error(new ErrorMessage(w,"Crossrider->_setInstallationData"));}};var c=function(){LogFile.write("_loadBackgroundScript");try{if(Crossrider.debug){var x=Crossrider.manifest.crossrider.background_script;if(!(/^https?\:\/\//.test(x))){x=chrome.extension.getURL(x);}var y;var v=true;Crossrider._bg_script={value:Utils.fetchScript(x,y,v),version:Crossrider.manifest.backgroundver};return;}Crossrider._bgCode=ExtensionDataStore.getBackgroundCode();if(!Crossrider._bgCode){return false;}var w=ExtensionDataStore.getBackgroundPlugins();if(!w){return false;}var A="\n\n"+w+"\n\n"+Crossrider._bgCode+"\n\n";try{Crossrider._cr_crossrider_ready_to_run_the_user_background_code=new Function(A);return true;}catch(z){Crossrider._cr_crossrider_ready_to_run_the_user_background_code=function(){};UserReport.error(new ErrorMessage(z,"background.js"));return false;}}catch(z){LogFile.write("_loadBackgroundScript, error: "+z.message);Reports.error(new ErrorMessage(z,"Crossrider->_loadBackgroundScript"));return false;}};var m=function(){LogFile.write("_loadUserScript");try{if(Crossrider.debug){var w=Crossrider.manifest.crossrider.user_script;if(!(/^https?\:\/\//.test(w))){w=chrome.extension.getURL(w);}var x;var v=true;Crossrider._userCode=Utils.fetchScript(w,x,v);}else{Crossrider._userCode=ExtensionDataStore.getPageCode();return Crossrider._userCode!==null;}}catch(y){Reports.error(new ErrorMessage(y,"Crossrider->_loadUserScript"));}};var s=function(){try{LogFile.write("_initAppAPI");window.appAPI=new AppApi();window.appAPI.init(Crossrider._cookies);if(!Crossrider._loadUserScript()||!Crossrider._loadBackgroundScript()){LogFile.write("_initAppAPI, error: code missing");UpdateManager.updateNedded();return;}Utils.FunctionsRunner.parallel([Crossrider._setInstallationData,Crossrider._setInstallationTime],function(){var w=document.createEvent("Events");w.initEvent("cr_ready",true,false);document.dispatchEvent(w);Crossrider._isBgFinishInit=true;if(Crossrider.debug){return;}if(!localStorage.alreadyRan){Reports.install();Reports.dailyStats();Crossrider._showThankyouPage();localStorage.alreadyRan=true;}});}catch(v){LogFile.write(v.message);Reports.error(new ErrorMessage(v,"Crossrider->_initAppAPI"));}};var k=function(z){LogFile.write("_initStorage");try{var x;var w=GetSyncDBTableNamesArray();for(var v=0;v<w.length;++v){currentTableName=w[v];Crossrider._cookies[currentTableName]={};}CookieStore.init(this.appID,w,function(){CookieStore.getCookies(function(A){p(A);z();},[TableNames.USER_COOKIES,TableNames.INTERNAL_DB]);});}catch(y){Reports.error(new ErrorMessage(y,"Crossrider->_initStorage"));}};var j=function(){LogFile.write("_initInternalMessaging");if(typeof(chrome.runtime||chrome.extension).onMessage==="undefined"){chrome.extension.onMessage.addListener(_onMessageHandler);}else{(chrome.runtime||chrome.extension).onMessage.addListener(_onMessageHandler);}};var a=function(){LogFile.write("_loadLocalManifest");try{d=Utils.getExtensionId();g=Utils.getChromeManifest();var v=Utils.getCrossriderManifestJson();g.crossrider=(v&&v.hasOwnProperty("crossrider"))?v.crossrider:{};g.platform="CH";b=g.crossrider.debug=false;l=g.crossrider.appID;if((localStorage.hasOwnProperty("forceDebug")&&(localStorage.getItem("forceDebug")==="true"))&&localStorage.hasOwnProperty("internaldebug_userCode")&&localStorage.hasOwnProperty("internaldebug_backgroundCode")){b=g.crossrider.debug=true;g.crossrider.user_script=localStorage.getItem("internaldebug_userCode");g.crossrider.background_script=localStorage.getItem("internaldebug_backgroundCode");}if(g.crossrider.hasOwnProperty("is_staging")){q=g.crossrider.is_staging;}}catch(w){Reports.error(new ErrorMessage(w,"Crossrider->_loadLocalManifest"));}};var i=function(v){removeExpiredCookies(TableNames.USER_COOKIES);removeExpiredCookies(TableNames.INTERNAL_DB);removeExpiredCookiesAsync(TableNames.DB_ASYNC,v);};refreshMemoryCookiesFromDB=function(v){CookieStore.getCookies(function(w){Crossrider._copyDBCookiesToMemory(w);v();},[TableNames.USER_COOKIES,TableNames.INTERNAL_DB]);return InternalMessaging.responseLater;};(function e(){LogFile.write("init");try{a();Crossrider._initInternalMessaging();Crossrider.events.tabClosed.addEventListener(function(y,x){delete Crossrider._tabsUrlsByIds[y];delete Crossrider._framesUrlsByIds[y];});Crossrider._bic=Utils.setUniqueID();var w=[Crossrider._initStorage,ExtensionDataStore.onStoreReady,UpdateManager.onUpdateComplete];Utils.FunctionsRunner.parallel(w,Crossrider._initAppAPI);}catch(v){LogFile.write("in the catch",v.message);}}());return{};}());
