var ExtensionDataStore=(function(){var o=Utils;var I=Consts;var j=StorageWrapper;var D=false;var t=new Delegate();var m=false;var d=new Delegate();var B;function p(L,J,K){this.name="CodeFileMissingException";this.message="Missing code was found";this.fileName=(L||"");this.filePath=(J||"");this.functionName=(K||"");}p.prototype=new Error();var y=function(J){if((chrome.runtime||chrome.extension)&&(chrome.runtime||chrome.extension).getURL){J=(chrome.runtime||chrome.extension).getURL(J);}else{if(chrome.extension&&chrome.extension.getURL){J=chrome.extension.getURL(J);}}var K=new XHR({url:J,method:"get",async:false});return K.send();};var A=function(){B={pluginsJson:null,manifest:null,pluginsCode:{},userCode:{background:null,extension:null},enabledPlugins:null,pluginsOrderdLists:{},extensionPluginsCode:null,backgroundPluginsCode:null,popupPluginsCode:null};};var f=function(M){var J=B.pluginsCode;var K="plugin"+M.id+"_exception";var L=[];if(!J[M.id]){return null;}L.push("try {");L.push(J[M.id]+"\n\n");L.push("}catch(e){if (typeof Reports !== 'undefined' && typeof ErrorMessage !== 'undefined'){"+((M.id<1000000)?("Reports.error(new ErrorMessage(e, 'exception was caught plugin ' + '"+M.name+"' + ' id ' + "+M.id+"));"):"")+"}}\n\n");return L.join("");};var c=function(L){pluginsOrderdLists=B.pluginsOrderdLists[L];var N="";var M;for(var K=0;K<pluginsOrderdLists.length;K++){M=pluginsOrderdLists[K];var J=f(M);if(J===""||J===null){N=null;break;}N+=J;}return N;};var H=function(K){var J=function(L,M){return function(N){j.set(L,M,N);};};o.FunctionsRunner.parallel([J(I.PAGE_PLUGIN_CODE_KEY,r()),J(I.PAGE_CODE_KEY,l())],K);};var n=function(){LogFile.write("file: extensionDataStore.js, function: _storeReadyHandler");D=true;t.invokeOnce();};var E=function(J){LogFile.write("file: extensionDataStore.js, function: _storeErrorHandler");m=true;d.invokeOnce(J);};var h=function(Q){var K=function(){var R,S;if(!B.userCode.background){B.userCode.background=y("/extensionData/userCode/background.js");}if(!B.userCode.extension){B.userCode.extension=y("/extensionData/userCode/extension.js");}};var P=function(){var S=B.pluginsOrderdLists;for(var R in S){if(S.hasOwnProperty(R)){S[R].forEach(function(U,T){if(!B.pluginsCode[U.id]){B.pluginsCode[U.id]=y("/extensionData/plugins/"+U.id+".js");if(!I.IS_EVAL_BLOCKED){try{new Function(B.pluginsCode[U.id]);}catch(V){B.pluginsCode[U.id]="(function(){}())";}}}});}}};var M=function(){LogFile.write("file: extensionDataStore.js, function: _loadPluginsJson");var R;if(!B.pluginsJson){R=y("/extensionData/plugins.json");if(typeof R!=="string"||R.length===0){throw new p("plugins.json","/extensionData/plugins.json");}B.pluginsJson=JSON.parse(R);}};var N=function(S){LogFile.write("file: extensionDataStore.js, function: _loadManifest");var T,R;if(!B.manifest){if(S===null){throw new p("manifest.xml","/extensionData/manifest.xml","_loadManifest");}B.manifest=S;}};var L=function(S){for(var R in S){if(S.hasOwnProperty(R)){B[R]=S[R];}}};var O=function(R,S){if(!S&&!R){throw new p("manifest.xml","/extensionData/manifest.xml","_isStorageDataUpToDate");}if(S&&!R){return true;}if(!S||parseInt(R.ver,10)>parseInt(S.ver,10)){j.removeExtensionData();return false;}return true;};var J=function(){LogFile.write("file: extensionDataStore.js, function: _getLocalManifest");var R=y("/extensionData/manifest.xml");if(!R){Reports.error(new ErrorMessage(new Error("request for manifest.xml fail"),"ExtensionDataStore->_loadData->_getLocalManifest, _request error"));return null;}var S=o.parseManifestXML(R);if(!S){Reports.error(new ErrorMessage(new Error("parse of manifest.xml fail"),"ExtensionDataStore->_loadData->_getLocalManifest, parse error"));return null;}return S;};LogFile.write("file: extensionDataStore.js, function: _loadData");A();j.get("extensionData",function(S){try{LogFile.write("file: extensionDataStore.js, function: _loadData, _storage.get callback");var R=J();if(S&&S.extensionData&&O(R,S.extensionData.manifest)){L(S.extensionData);}N(R);M();B.enabledPlugins=o.getEnabledPlugins(B.pluginsJson);B.pluginsOrderdLists=o.generatePluginsOrderLists(B.pluginsJson);P();K();H(function(){Q();});}catch(T){if(T instanceof p){Reports.error(new ErrorMessage(T,"ExtensionDataStore->_loadData->"+T.functionName+", "+T.fileName+" is missing"));E({message:I.FILE_MISSING});return;}Reports.error(new ErrorMessage(T,"ExtensionDataStore->_loadData"));}});};var g=function(K,J){K.manifest=B.manifest;v(K,function(L){z();a(J);k(J);});};var z=function(){LogFile.write("file: extensionDataStore.js, function: reload");D=false;h(n);};var v=function(J,K){LogFile.write("file: extensionDataStore.js, function: setNewExtensionData");j.get("extensionData",function(M){LogFile.write("file: extensionDataStore.js, function: setNewExtensionData, _storage.get callback");if(M&&M.extensionData){J.pluginsJson=J.pluginsJson||M.extensionData.pluginsJson;J.manifest=J.manifest||M.extensionData.manifest;J.userCode=J.userCode||{};J.userCode.background=J.userCode.background||M.extensionData.userCode.background;J.userCode.extension=J.userCode.extension||M.extensionData.userCode.extension;J.pluginsCode=J.pluginsCode||{};if(M.extensionData.pluginsCode){for(var L in M.extensionData.pluginsCode){if(M.extensionData.pluginsCode.hasOwnProperty(L)){if(!J.pluginsCode[L]){J.pluginsCode[L]=M.extensionData.pluginsCode[L];}}}}}j.setExtensionData(J,K);});};var u=function(J){if(typeof J==="number"&&B&&B.pluginsCode&&B.pluginsCode[J]){return B.pluginsCode[J];}return"";};var w=function(){return B.pluginsOrderdLists;};var C=function(){return B.enabledPlugins;};var b=function(){return B.manifest;};var l=function(){return B.userCode.extension;};var F=function(){return B.userCode.background;};var e=function(){if(!B.popupPluginsCode){B.popupPluginsCode=c(I.PluginTypes.POPUP);}return B.popupPluginsCode;};var x=function(){if(!B.backgroundPluginsCode){B.backgroundPluginsCode=c(I.PluginTypes.BACKGROUND);}return B.backgroundPluginsCode;};var r=function(){if(!B.extensionPluginsCode){B.extensionPluginsCode=c(I.PluginTypes.APP_CODE);}return B.extensionPluginsCode;};var a=function(J){if(D){J();}else{t.addObserver(J);}return ExtensionDataStore;};var k=function(J){if(m){J();}else{d.addObserver(J);}return ExtensionDataStore;};var G=function(J,L,K){pluginsCode={};pluginsCode[J]=L;g({pluginsJson:B.pluginsJson,pluginsCode:pluginsCode,userCode:{extension:l()}},K);};var s=function(J,K){g({userCode:{extension:J}},K);};var q=function(J,K){g({userCode:{background:J}},K);};(function i(){h(n);})();return{setBgCode:q,setPageCode:s,setPluginCode:G,onStoreError:k,onStoreReady:a,getPagePlugins:r,getBackgroundPlugins:x,getPopupPlugins:e,getPageCode:l,getBackgroundCode:F,getManifest:b,getEnabledPlugins:C,getPluginsOrderdLists:w,getPluginById:u,setNewExtensionData:v,reload:z,_getExtensionData:function(){return B;}};}());
