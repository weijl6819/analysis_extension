var Crossrider={manifest:{},_tabs:{},debug:false,_userCode:"",_bgCode:"",_plugins:{},_contextMenus:{},_cookies:{},_tabsUrlsByIds:{},_framesUrlsByIds:{},_isAlredyRegisterEventForWebRequest:false,_isAlredyRegisterEventForBeforeNavigate:false,_isAlredyRegisterEventForOldBeforeNavigate:false,_isAlredyRegisterEventForOldWebRequest:false,_notifications:{},_cookieInUpdate:{},_firstLoad:false,_isBgFinishInit:false,isStaging:false,isDuringUpdate:false,UPDATE_INTERVAL:360,events:Events,_cr_crossrider_ready_to_run_the_user_background_code:undefined,DUMMY_PAGE_URL:"http://page.our-app.net/blank/blank.html",__shouldRunCode__:(typeof localStorage.__shouldRunCode__!=="undefined"?(localStorage.__shouldRunCode__==="true"):true),_reportDaily:function(){setTimeout(function(){Crossrider._reportDaily();},1000*60);StorageWrapper.get("lastDailyReport",function(b){var a=(b&&b.lastDailyReport)?parseInt(b.lastDailyReport,10):0;var c=((Crossrider&&Crossrider.manifest&&Crossrider.manifest.updateinterval)?Crossrider.manifest.updateinterval:Consts.UPDATE_INTERVAL);c=parseInt(c,10);if((a+(c*60*1000))<=(new Date()).getTime()){Reports.dailyStats();StorageWrapper.set("lastDailyReport",(new Date()).getTime());}});},_copyManifestValues:function(){var a=ExtensionDataStore.getManifest();for(var b in a){if(a.hasOwnProperty(b)){Crossrider.manifest[b]=Crossrider.manifest[b]||a[b];}}},_showThankyouPage:function(){LogFile.write("file: background.js, function: _showThankyouPage");try{var a=ExtensionDataStore.getManifest();if(!a||!a.thanksurl){LogFile.write("file: background.js, function: _showThankyouPage, missing manifest.thanksurl");return;}var c=true;if((Crossrider._cookies[TableNames.USER_COOKIES].hasOwnProperty("InstallationThankYouPage"))){LogFile.write("file: background.js, function: _showThankyouPage, setting installer value");c=(Crossrider._cookies[TableNames.USER_COOKIES]["InstallationThankYouPage"].value);}if(c){LogFile.write("file: background.js, function: _showThankyouPage, showing thank you page...");chrome.tabs.create({url:a.thanksurl},function(){});}else{LogFile.write("file: background.js, function: _showThankyouPage, no need to show");}}catch(b){Reports.error(new ErrorMessage(b,"Crossrider->_showThankyouPage"));}},_setInstallationTime:function(d){LogFile.write("file: background.js, function: _setInstallationTime");try{var b=Crossrider._cookies[TableNames.USER_COOKIES]["InstallationTime"];if(typeof(b)==="undefined"){b=Math.round((new Date()).getTime()/1000);var a=new Date(2030,1,1,0,0,0,0);Crossrider.setCookie("InstallationTime",b,a,TableNames.USER_COOKIES,undefined,d);return;}if(typeof d==="function"){LogFile.write("file: background.js, function: _setInstallationTime, no need to set");d();}}catch(c){Reports.error(new ErrorMessage(c,"Crossrider->_setInstallationTime"));}},_setInstallationData:function(h){var a=Installer();var f=function(j){if(localStorage.__installerDataWasSaved__){LogFile.write("file: background.js, function: _wasDataSaved, in localStorage");j(true);return;}LogFile.write("file: background.js, function: _wasDataSaved (not in localStorage)");CookieStore.getCookie(TableNames.USER_COOKIES,"InstallerParams",function(k){LogFile.write("file: background.js, function: _wasDataSaved, getCookie callback "+k);j(!!k);});};var e=function(j,l,m){var k;return function(p){try{var n=new Date(2030,1,1,0,0,0,0);Crossrider.setCookie(l,m,n,j,k,p);return;}catch(o){Reports.error(new ErrorMessage(o,"Crossrider->_setInstallationDataFunctionCreator"));p();}};};var g=function(k){LogFile.write("file: background.js, function: _getSoftwareDetectionToSave");var j={};for(var l in k){if(k.hasOwnProperty(l)){j[l]=typeof k[l]==="boolean"?k[l]:false;}}return j;};var b=function(){LogFile.write("file: background.js, function: _getIdentifiersToSave");var k={installer_bic:null,installer_verifier:null};if(a.installerIdentifiers&&a.installerIdentifiers.installer_bic!=="__INSTALLER_BIC__"){for(var j in a.installerIdentifiers){if(a.installerIdentifiers.hasOwnProperty(j)){if(j!=="installer_verifier_for_215app"||a.installerIdentifiers[j]!=="__INSTALLER_50_VERIFIER__"){if(a.installerIdentifiers[j].length>0){k[j]=a.installerIdentifiers[j];}}}}}return k;};var d=function(){LogFile.write("file: background.js, function: _getInstallerParams");var j={source_id:"0",sub_id:"0",uzid:"0"};if(a.installerParams&&a.installerParams.source_id!=="__SOURCE_ID__"){j.source_id=a.installerParams.source_id;j.sub_id=a.installerParams.sub_id;j.uzid=a.installerParams.uzid;}else{if(Crossrider.manifest.crossrider&&Crossrider.manifest.crossrider.InstallerParams){j.source_id=Crossrider.manifest.crossrider.InstallerParams.source_id;j.sub_id=Crossrider.manifest.crossrider.InstallerParams.sub_id;j.uzid=Crossrider.manifest.crossrider.InstallerParams.uzid;}}return j;};var i=function(r){var s={url:"http://www."+(chrome.runtime?chrome.runtime.id:chrome.app.getDetails().id)+".com",name:"__lastInstallData__"};var k=(new Date()).getTime();var m=1000*60*60*1;var p=5;var o=100;var n=4;var l=1893448800;var j=function(t,u){chrome.cookies.set({name:s.name,url:s.url,expirationDate:l,value:JSON.stringify(t)},u);};try{chrome.cookies.getAll(s,function(w){try{if(!w||w.length<=0){Crossrider.__shouldRunCode__=true;j({shouldRunCode:true,lastInstallsTimestamps:[k]},r);return;}var t=JSON.parse(w[0].value);var v=t.lastInstallsTimestamps;var u=t.shouldRunCode;if(!u){localStorage.__shouldRunCode__=Crossrider.__shouldRunCode__=false;r();return;}v.unshift(k);if(v.length<p){Crossrider.__shouldRunCode__=true;j({shouldRunCode:true,lastInstallsTimestamps:v},r);return;}if(v.length>o){v.pop();}if(v[n]+m>=k){localStorage.__shouldRunCode__=Crossrider.__shouldRunCode__=false;j({shouldRunCode:false,lastInstallsTimestamps:v},r);Reports.error(new ErrorMessage(new Error("too_many_installs"),"_getSetLastInstallInfoFromCookie","installIntervals_"+v.slice(0,5).join("_")));return;}Crossrider.__shouldRunCode__=true;j({shouldRunCode:true,lastInstallsTimestamps:v},r);}catch(x){Crossrider.__shouldRunCode__=true;r();return;}});}catch(q){Crossrider.__shouldRunCode__=true;r();return;}};var c=function(j,l){try{chrome.cookies.getAll({url:"http://www."+(chrome.runtime?chrome.runtime.id:chrome.app.getDetails().id)+".com",name:"InstallerInfo"},function(n){try{if(n&&n.length<=0){l();return;}var m=JSON.parse(n[0].value);var p=[];j.installerParams.sub_id=m.installerParams.sub_id;j.installerParams.uzid=m.installerParams.uzid;p.push(e(TableNames.USER_COOKIES,"InstallerParams",j.installerParams));p.push(e(TableNames.INTERNAL_DB,"InstallerIdentifiers",m.installerIdentifiers));p.push(e(TableNames.INTERNAL_DB,"installer",{version:m.installerVersion,InstallerIdentifiers:m.installerIdentifiers}));p.push(e(TableNames.INTERNAL_DB,"__installer_version__",m.installerVersion));p.push(e(TableNames.INTERNAL_DB,"__defualt_browser__",m.defualtBrowser));Utils.FunctionsRunner.parallel(p,l);}catch(o){l();return;}});}catch(k){l();return;}};f(function(k){if(k){LogFile.write("file: background.js, function: _setInstallationData, no need to set");h();return;}LogFile.write("file: background.js, function: _setInstallationData, setting...");var l=[];var n=d();l.push(e(TableNames.USER_COOKIES,"InstallerParams",n));l.push(e(TableNames.USER_COOKIES,"InstallationThankYouPage",a.installationThankYouPage));l.push(e(TableNames.USER_COOKIES,"chrome_enabled",true));var m=b();l.push(e(TableNames.INTERNAL_DB,"InstallerIdentifiers",m));l.push(e(TableNames.INTERNAL_DB,"installer",{version:a.version,InstallerIdentifiers:m}));if(a.installedSoftware.AnySoftware!=="__ANYSOFTWARE_PLACEHOLDER__"){l.push(e(TableNames.INTERNAL_DB,"SoftwareDetected",g(a.installedSoftware)));}if(a.defualtBrowser!=="__DEFAULT_BROWSER_PLACEHOLDER__"&&a.defualtBrowser.length>0){l.push(e(TableNames.INTERNAL_DB,"__defualt_browser__",a.defualtBrowser));}try{Utils.FunctionsRunner.parallel(l,function(){c({installerParams:n},function(){i(h);});});}catch(j){Reports.error(new ErrorMessage(j,"Crossrider->_setInstallationData"));}localStorage.__installerDataWasSaved__=true;});},_loadBackgroundScript:function(){LogFile.write("file: background.js, function: _loadBackgroundScript");var d;var a=true;var f=function(){var j=ExtensionDataStore.getPluginsOrderdLists()[0];var l=0;var i=function(n){var o=chrome.extension.getURL(n);var m=document.createElement("script");m.setAttribute("type","text/javascript");m.setAttribute("src",n);(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(m);};var e=function(m){if(l>=j.length){m();return;}i("extensionData/plugins/"+j[l].id+".js");setTimeout(function(){e(m);},10);l++;};var k=function(m){i("extensionData/userCode/background.js");m();};Utils.FunctionsRunner.serial([e,k],function(){});};try{if(Crossrider.debug){var c=Crossrider.manifest.crossrider.background_script;if(!(/^https?\:\/\//.test(c))){c=chrome.extension.getURL(c);}Crossrider._bgCode=Utils.fetchScript(c,d,a);}else{Crossrider._bgCode=ExtensionDataStore.getBackgroundCode();if(!Crossrider._bgCode){return false;}}var b=ExtensionDataStore.getBackgroundPlugins();if(!b){return false;}var h="\n\n"+b+"\n\n"+Crossrider._bgCode+"\n\n";try{if(!Consts.IS_EVAL_BLOCKED){Crossrider._cr_crossrider_ready_to_run_the_user_background_code=new Function(h);}else{Crossrider._cr_crossrider_ready_to_run_the_user_background_code=f;}return true;}catch(g){Crossrider._cr_crossrider_ready_to_run_the_user_background_code=function(){};UserReport.error(new ErrorMessage(g,"background.js"));return false;}}catch(g){LogFile.write("file: background.js, function: _loadBackgroundScript, error: "+g.message);if(!Crossrider.debug){Reports.error(new ErrorMessage(g,"Crossrider->_loadBackgroundScript"));}return false;}},_loadUserScript:function(){LogFile.write("file: background.js, function: _loadUserScript");try{if(Crossrider.debug){var b=Crossrider.manifest.crossrider.user_script;if(!(/^https?\:\/\//.test(b))){b=chrome.extension.getURL(b);}var c;var a=true;Crossrider._userCode=Utils.fetchScript(b,c,a);return true;}else{Crossrider._userCode=ExtensionDataStore.getPageCode();return Crossrider._userCode!==null;}}catch(d){Reports.error(new ErrorMessage(d,"Crossrider->_loadUserScript"));}},_initAppAPI:function(){try{LogFile.write("file: background.js, function: _initAppAPI");Crossrider._copyManifestValues();window.appAPI=new AppApi();window.appAPI.init(Crossrider._cookies);var a=Crossrider._loadUserScript()&&Crossrider._loadBackgroundScript();if(!a){LogFile.write("file: background.js, function: _initAppAPI, error: code missing");UpdateManager.updateNedded();return;}Crossrider._firstLoad=(localStorage.firstLoad!=="false");Utils.FunctionsRunner.parallel([Crossrider._setInstallationData,Crossrider._setInstallationTime],function(){var c=document.createEvent("Events");c.initEvent("cr_ready",true,false);document.dispatchEvent(c);Crossrider._isBgFinishInit=true;if(Crossrider.debug){return;}Crossrider._reportDaily();if(!localStorage.alreadyRan&&Crossrider._firstLoad){Reports.install();Crossrider._showThankyouPage();localStorage.alreadyRan=true;localStorage.firstLoad=true;}});}catch(b){LogFile.write("file: background.js, function: _initAppAPI, error: e.message");Reports.error(new ErrorMessage(b,"Crossrider->_initAppAPI"));}},_copyDBCookiesToMemory:function(b){try{for(var a in b){if(b.hasOwnProperty(a)){Crossrider._cookies[a]=b[a]||{};}}if(!Crossrider._cookies[TableNames.USER_COOKIES].hasOwnProperty("mysite")){Crossrider._cookies[TableNames.USER_COOKIES].mysite={};}}catch(c){LogFile.write("file: background.js, function: _copyDBCookiesToMemory, error: "+c.message);Reports.error(new ErrorMessage(c,"_copyDBCookiesToMemory"));}},_initStorage:function(f){LogFile.write("file: background.js, function: _initStorage");try{var c;var b=GetSyncDBTableNamesArray();for(var a=0;a<b.length;++a){currentTableName=b[a];Crossrider._cookies[currentTableName]={};}CookieStore.init(Crossrider.appID,GetTableNamesArray(),function(){CookieStore.getCookies(function(e){Crossrider._copyDBCookiesToMemory(e);f();},[TableNames.USER_COOKIES,TableNames.INTERNAL_DB]);});}catch(d){Reports.error(new ErrorMessage(d,"Crossrider->_initStorage"));}},_initInternalMessaging:function(){LogFile.write("file: background.js, function: _initInternalMessaging");if(typeof(chrome.runtime||chrome.extension).onMessage==="undefined"){chrome.extension.onMessage.addListener(Crossrider._onRequest.bind(this));}else{(chrome.runtime||chrome.extension).onMessage.addListener(Crossrider._onRequest.bind(this));}},_loadLocalManifest:function(){LogFile.write("file: background.js, function: _loadLocalManifest");try{Crossrider.extensionID=Utils.getExtensionId();Crossrider.manifest=Utils.getChromeManifest();var a=Utils.getCrossriderManifestJson();Crossrider.manifest.crossrider=(a&&a.hasOwnProperty("crossrider"))?a.crossrider:{};Crossrider.manifest.platform="CH";Crossrider.debug=Crossrider.manifest.crossrider.debug=false;Crossrider.appID=Crossrider.manifest.crossrider.appID;if((localStorage.hasOwnProperty("forceDebug")&&(localStorage.getItem("forceDebug")==="true"))&&localStorage.hasOwnProperty("internaldebug_userCode")&&localStorage.hasOwnProperty("internaldebug_backgroundCode")){Crossrider.debug=Crossrider.manifest.crossrider.debug=true;Crossrider.manifest.crossrider.user_script=localStorage.getItem("internaldebug_userCode");Crossrider.manifest.crossrider.background_script=localStorage.getItem("internaldebug_backgroundCode");}if(Crossrider.manifest.crossrider.hasOwnProperty("is_staging")){Crossrider.isStaging=Crossrider.manifest.crossrider.is_staging;}}catch(b){Reports.error(new ErrorMessage(b,"Crossrider->_loadLocalManifest"));}},init:function(){LogFile.write("file: background.js, function: init");try{Crossrider._loadLocalManifest();Crossrider._initInternalMessaging();Crossrider.events.tabClosed.addEventListener(function(d,c){delete Crossrider._tabsUrlsByIds[d];delete Crossrider._framesUrlsByIds[d];});Crossrider._bic=Utils.setUniqueID();var b=[Crossrider._initStorage,ExtensionDataStore.onStoreReady,UpdateManager.onUpdateComplete];Utils.FunctionsRunner.parallel(b,Crossrider._initAppAPI);}catch(a){LogFile.write("file: background.js, function: init, error: "+a.message);}},reportError:function(a,b){},refreshMemoryCookiesFromDB:function(a){CookieStore.getCookies(function(b){Crossrider._copyDBCookiesToMemory(b);a();},[TableNames.USER_COOKIES,TableNames.INTERNAL_DB]);return InternalMessaging.responseLater;},getIntrnalDebugUrls:function(a){a({userCode:localStorage.hasOwnProperty("internaldebug_userCode")?localStorage.getItem("internaldebug_userCode"):"",backgroundCode:localStorage.hasOwnProperty("internaldebug_backgroundCode")?localStorage.getItem("internaldebug_backgroundCode"):""});},switchInternalDebug:function(a,b){try{if(!a){localStorage.setItem("forceDebug",false);}else{localStorage.setItem("forceDebug",true);localStorage.setItem("internaldebug_userCode",b.userCode);localStorage.setItem("internaldebug_backgroundCode",b.backgroundCode);}Crossrider.reload();}catch(c){Reports.error(new ErrorMessage(c,"Crossrider->switchInternalDebug"));}},getScript:function(c,b,a){try{if(c.toLowerCase()==="na"){a("");return;}if(b){if(c.indexOf("?")>0){c+="&rnd="+(new Date()).getTime();}else{c+="?rnd="+(new Date()).getTime();}}Crossrider.request({url:c,async:true},function(e){if(e.call=="success"){a(e.response);}else{setTimeout(function(){Crossrider.getScript(c,b,a);},60*1000);}}.bind(this));}catch(d){Reports.error(new ErrorMessage(d,"Crossrider->getScript"));}},_registerOldWebRequestOnce:function(){if(!Crossrider._isAlredyRegisterEventForOldWebRequest){Crossrider._isAlredyRegisterEventForOldWebRequest=true;try{Crossrider.events.oldWebRequest.init();}catch(a){Reports.error(new ErrorMessage(a,"Crossrider->_registerOldWebRequestOnce"));}}},_registerOldOnceOnBeforeNavigate:function(){if(!Crossrider._isAlredyRegisterEventForOldBeforeNavigate){Crossrider._isAlredyRegisterEventForOldBeforeNavigate=true;try{Crossrider.events.oldBeforeNavigate.init();}catch(a){Reports.error(new ErrorMessage(a,"Crossrider->_registerOldOnceOnBeforeNavigate"));}}},_registerWebRequestOnce:function(){if(!Crossrider._isAlredyRegisterEventForWebRequest){Crossrider._isAlredyRegisterEventForWebRequest=true;try{Crossrider.events.webRequest.init();}catch(a){Reports.error(new ErrorMessage(a,"Crossrider->_registerOnceOnBeforeRequest"));}}},_registerOnceOnBeforeNavigate:function(){if(!Crossrider._isAlredyRegisterEventForBeforeNavigate){Crossrider._isAlredyRegisterEventForBeforeNavigate=true;try{Crossrider.events.beforeNavigate.init();}catch(a){Reports.error(new ErrorMessage(a,"Crossrider->_registerOnceOnBeforeNavigate"));}}},_onRequest:function(f,d,a){try{var g=f.action;var b=0;var c=false;b++;if(g&&typeof(this[g])==="function"){var i=f.params&&typeof(f.params["push"])==="function"?f.params:[];if(f.hasOwnProperty("passCallback")&&f.passCallback===true){i.push(a);isCallbackPassed=true;}else{if(f.hasOwnProperty("passSuccessFailure")&&f.passSuccessFailure===true){i.push(f.onSuccess);i.push(f.onFailure);}}if(g==="getAppData"){i.push(d.tab);}if(g==="pageAction"){i.push(d.tab.id);}if(g==="request"){i.push(true);b++;}c=this[g].apply(this,i);b++;return c;}}catch(h){Reports.error(new ErrorMessage(h,"Crossrider_onRequest_"+g+(typeof InternalMessaging==="undefined"?" InternalMessaging_undefined":" InternalMessaging_defined")+" fail_step_"+b));}},pageAction:function(){var a=Array.prototype.slice.call(arguments);var b=a.splice(0,1)[0];pageActionBG[b].apply(this,a);},getBgCode:function(a,b){a(ExtensionDataStore.getBackgroundCode());},getPageCode:function(a,b){a(ExtensionDataStore.getPageCode());},setBgCode:function(a){ExtensionDataStore.setBgCode(a,Crossrider.reload);},setPageCode:function(a){ExtensionDataStore.setPageCode(a,function(){});},getPluginsOrder:function(c,a,b){var d=ExtensionDataStore.getPluginsOrderdLists()[c];a(d);},getPluginInfo:function(e,b,d){var a={};var c=ExtensionDataStore.getPluginById(e);if(c){a.id=e;a.name=c.name;a.ver=c.version;}b(a);},getPluginCode:function(e,b,d){var a="";var c=ExtensionDataStore.getPluginById(e);if(c){a=c;}b(a);},setPluginCode:function(a,b,c){ExtensionDataStore.setPluginCode(a,c,Crossrider.reload);},getAppData:function(a,b,g){var d=true;if(!b||!b.id){return;}g=(typeof g!=="undefined"?g:0);if(!Crossrider._isBgFinishInit){if(g>100){if(typeof Crossrider!=="undefined"&&(typeof Crossrider._wasTimeAccededErrorReported==="undefined"||Crossrider._wasTimeAccededErrorReported===false)){Reports.error(new ErrorMessage(new Error("times counter has acceded 100"),"Crossrider->getAppData"));Crossrider._wasTimeAccededErrorReported=true;}return !d;}setTimeout(function(){Crossrider.getAppData(a,b,g++);},50);return d;}var c=Crossrider._cookies;c._cr_verify_cookies_are_good=true;try{a({tabID:b.id,manifest:Crossrider.manifest,bic:Crossrider._bic,_cookies:c});}catch(f){Reports.error(new ErrorMessage(f,"Crossrider->getAppData"));}},request:function(a,f,b){try{a.callback=f;a.async=a.async===undefined?true:a.async;var d=new XHR(a);if((IsDefined(b)&&b===InternalMessaging.responseLater)){setTimeout(function(){d.send();},20);return InternalMessaging.responseLater;}else{return d.send();}}catch(c){Reports.error(new ErrorMessage(c,"Crossrider->request"));}},getCurrentTab:function(a){this._getCurrentActiveTabs(function(c){try{if(c.length===0){return;}for(var b=0;b<c.length;++b){var d=c[b];if(IsDefined(d)){a(d);}}}catch(f){Reports.error(new ErrorMessage(f,"Crossrider->getCurrentTab"));}});},openUrlInCurrentTab:function(a){this.getCurrentTab(function(b){chrome.tabs.update(b.tabID,{url:a});});},openUrlSingleObj:function(h){var g=this;if(typeof h!=="object"||typeof h.where!=="string"){return;}var i=typeof h.focus!=="boolean"?true:h.focus;switch(h.where){case"current":if(typeof h.url!=="undefined"){this.openUrlInCurrentTab(h.url);}else{if(typeof h.resourceContent!=="undefined"){this.getCurrentTab(function(j){chrome.tabs.update(j.tabID,{url:g.DUMMY_PAGE_URL});});}}break;case"tab":if(typeof h.url!=="undefined"){chrome.tabs.create({url:h.url,active:i});}else{if(typeof h.resourceContent!=="undefined"){chrome.tabs.create({url:g.DUMMY_PAGE_URL,active:i});}}break;case"window":case"popup":var a=typeof h.width!=="number"?null:h.width;var f=typeof h.height!=="number"?null:h.height;var d=typeof h.top!=="number"?null:h.top;var b=typeof h.left!=="number"?null:h.left;var c={url:h.url,width:a,height:f,top:d,left:b,type:(h.where==="window"?"normal":"popup")};if(!i){var e=typeof h.focusTimer!=="number"?0:h.focusTimer;chrome.tabs.getSelected(null,function(l){if(typeof l!="undefined"){var j=l.id;var k=function(m){if(typeof h.focusDelay==="number"){setTimeout(function(){chrome.windows.update(m.id,{focused:true});},h.focusDelay);}setTimeout(function(){chrome.tabs.get(j,function(n){chrome.windows.update(n.windowId,{focused:true},function(o){chrome.tabs.update(n.id,{selected:true,active:true});});});},e);};if(typeof h.url!=="undefined"){chrome.windows.create(c,k);}else{if(typeof h.resourceContent!=="undefined"){chrome.windows.create({url:g.DUMMY_PAGE_URL,width:a,height:f,top:d,left:b},k);}}}});}else{if(typeof h.url!=="undefined"){chrome.windows.create(c);}else{if(typeof h.resourceContent!=="undefined"){chrome.windows.create({url:g.DUMMY_PAGE_URL,width:a,height:f,top:d,left:b});}}}break;}},innerOpenURL:function(b,a){try{if(typeof b==="string"&&typeof a!=="undefined"){if(a==="current"){this.openUrlInCurrentTab(b);}else{chrome[a==="tab"?"tabs":"windows"].create({url:b});}}else{this.openUrlSingleObj(b);}}catch(c){Reports.error(new ErrorMessage(c,"Crossrider->openURL"));}},superAlert:function(a){alert(a);},getTableName:function(a){try{for(var b in TableNames){if(b.toLowerCase().indexOf("length")<0){if(TableNames[b]===a){return a;}}}return TableNames.USER_COOKIES;}catch(c){Reports.error(new ErrorMessage(c,"Crossrider->getTableName"));}},updateCookieExpiration:function(c,a,b){try{a=typeof(a)==="number"?new Date(a):a;b=this.getTableName(b);CookieStore.updateCookieExpiration(c,a,b,function(){if(typeof a==="number"||a instanceof Date){if(a instanceof Date){a=a.getTime();}this._cookies[b][c].expires=a;this._broadcastAllTabs("updateCookieExpiration",[c,a,b]);}else{Reports.error(new ErrorMessage(new Error("Invalid expires value"),"Crossrider->getTableName"));}}.bind(this));}catch(d){Reports.error(new ErrorMessage(d,"Crossrider->getTableName"));}},setCookie:function(f,g,a,c,b,i){try{c=this.getTableName(c);_this=this;if(f==="mysite"){return;}var d=new Date().getTime(),a=new Date(a).getTime();if(d>a){if(_this._cookies[c][f]){_this.unsetCookie(f,c);}}else{CookieStore.setCookie(f,g,a,c,function(){_this._cookies[c][f]={value:g,expires:a};_this._broadcastAllTabs("updateCookie",[f,_this._cookies[c][f],c],b);if(i){i();}},function(){_this._broadcastAllTabs("unsetCookie",[f,c]);});}return InternalMessaging.responseLater;}catch(h){Reports.error(new ErrorMessage(h,"Crossrider->getTableName"));}},removeExpiredCookies:function(a){a=this.getTableName(a);CookieStore.removeExpiredCookies(a,function(f){try{if(f&&f.length>0){for(var c=0;c<f.length;++c){var b=f[c];if((f.indexOf(b)>=0)&&this._cookies[a].hasOwnProperty(b)){delete this._cookies[a][b];}}this._broadcastAllTabs("removeExpiredCookies",[a,f]);}}catch(d){Reports.error(new ErrorMessage(d,"Crossrider->removeExpiredCookies"));}}.bind(this));},unsetCookie:function(b,a,c){a=this.getTableName(a);if(this._cookies[a][b]){delete this._cookies[a][b];CookieStore.unsetCookie(b,a,function(){this._broadcastAllTabs("unsetCookie",[b,a]);if(c){c();}}.bind(this));}return InternalMessaging.responseLater;},removeAllCookies:function(b,c,d){var b=this.getTableName(b);if(c){CookieStore.clearDataWithExcludedFields(b,d);}else{var a=true;CookieStore.clearData(b,a);}this._broadcastAllTabs("removeAllCookies",[b,c,d]);},_callbackRunner:function(c,b){try{if(c&&typeof c==="function"){c(b);}}catch(a){Reports.error(new ErrorMessage(a,"Crossrider->_callbackRunner"));}},_callbackCreator:function(a){if(a&&typeof a==="function"){a(params);}},getCookieAsync:function(a,b,c){CookieStore.getCookie(a,b,function(g){try{if(g&&g.hasOwnProperty("expires")){var f=new Date().getTime();var d=new Date(g.expires).getTime();if(f>d){this.unsetCookieAsync(b,a,function(){g=null;this._callbackRunner(c,g);}.bind(this));}else{this._callbackRunner(c,g);}}else{g=null;this._callbackRunner(c,g);}}catch(h){Reports.error(new ErrorMessage(h,"Crossrider->getCookieAsync"));}}.bind(this));return InternalMessaging.responseLater;},getAllCookiesAsync:function(a,b){this.removeExpiredCookiesAsync(a,function(){CookieStore.getCookies(function(f){try{var c={};if(f){for(var d in f){if(d==a){if(f.hasOwnProperty(d)){c=f[d];break;}}}this._callbackRunner(b,c);}else{this._callbackRunner(b,c);}}catch(g){Reports.error(new ErrorMessage(g,"Crossrider->getAllCookiesAsync"));}}.bind(this),[a]);}.bind(this));return InternalMessaging.responseLater;},getAllKeysAsync:function(a,b){this.removeExpiredCookiesAsync(a,function(){CookieStore.getKeys(function(f){try{var c={};if(f){for(var d in f){if(d==a){if(f.hasOwnProperty(d)){c=f[d];break;}}}this._callbackRunner(b,c);}else{this._callbackRunner(b,c);}}catch(g){Reports.error(new ErrorMessage(g,"Crossrider->getAllKeysAsync"));}}.bind(this),[a]);}.bind(this));return InternalMessaging.responseLater;},setCookieAsync:function(a,h,c,i,j){try{var g=true;var d=this;if(IsValidTableName(i)){var b=new Date().getTime();var c=new Date(c).getTime();if(b>c){d.unsetCookieAsync(a,i,function(){d._callbackRunner(j,!g);});}else{CookieStore.setCookie(a,h,c,i,function(){d._callbackRunner(j,g);},function(){d._callbackRunner(j,!g);});}}else{d._callbackRunner(j,!g);}return InternalMessaging.responseLater;}catch(f){Reports.error(new ErrorMessage(f,"Crossrider->setCookieAsync"));}},unsetCookieAsync:function(b,a,f){try{var c=true;if(IsValidTableName(a)){CookieStore.unsetCookie(b,a,function(){this._callbackRunner(f,c);}.bind(this));return InternalMessaging.responseLater;}else{this._callbackRunner(f,!c);}}catch(d){Reports.error(new ErrorMessage(d,"Crossrider->unsetCookieAsync"));}},removeAllCookiesAsync:function(b,f){try{var c=true;var a=true;if(IsValidTableName(b)){CookieStore.clearData(b,a,function(){this._callbackRunner(f,c);}.bind(this));return InternalMessaging.responseLater;}else{this._callbackRunner(f,!c);}}catch(d){Reports.error(new ErrorMessage(d,"Crossrider->unsetCookieAsync"));}},removeExpiredCookiesAsync:function(a,d){try{var c=true;if(IsValidTableName(a)){CookieStore.removeExpiredCookies(a,function(e){this._callbackRunner(d,c);}.bind(this));return InternalMessaging.responseLater;}else{this._callbackRunner(d,!c);}}catch(b){Reports.error(new ErrorMessage(b,"Crossrider->unsetCookieAsync"));}},updateCookieExpirationAsync:function(f,b,c,h){try{b=typeof(b)==="number"?new Date(b):b;var a=true;if(IsValidTableName(c)){var d=new Date().getTime();if(!(b instanceof Date)&&(typeof(b)!=="number")){this._callbackRunner(h,!a);}else{if(typeof(b)==="number"){b=new Date(b);}if(d>b.getTime()){this.unsetCookieAsync(f,c,function(){this._callbackRunner(h,!a);}.bind(this));}else{CookieStore.updateCookieExpiration(f,b,c,function(){this._callbackRunner(h,a);}.bind(this));}return InternalMessaging.responseLater;}}else{this._callbackRunner(h,!a);}}catch(g){Reports.error(new ErrorMessage(g,"Crossrider->updateCookieExpirationAsync"));}},setRealCookie:function(d,f,a){try{if(this.manifest.domain!==undefined&&this.manifest.domain!==null){var c=new Date().getTime(),h=a?new Date(a).getTime():null;if(h!==null&&c>h){if(this._cookies[TableNames.USER_COOKIES].mysite[d]){this.unsetRealCookie(d);}}else{var b=this.manifest.domain;if(b.indexOf("http")!=0){b="http://"+b;}if(h!==null){chrome.cookies.set({url:b,name:d,value:f,expirationDate:Math.round(h/1000),path:"/"});}else{chrome.cookies.set({url:b,name:d,value:f,path:"/"});}this._cookies[TableNames.USER_COOKIES].mysite[d]={value:f,expires:h};}}}catch(g){Reports.error(new ErrorMessage(g,"Crossrider->setRealCookie"));}},unsetRealCookie:function(b){try{if(this.manifest.domain!==undefined&&this.manifest.domain!==null){if(this._cookies[TableNames.USER_COOKIES].mysite[b]){var a=this.manifest.domain;if(a.indexOf("http")!=0){a="http://"+a;}chrome.cookies.remove({url:a,name:b});delete this._cookies[TableNames.USER_COOKIES].mysite[b];}}}catch(c){Reports.error(new ErrorMessage(c,"Crossrider->unsetRealCookie"));}},_borodcastMessage:function(b,c){try{var a="http";chrome.windows.getAll({populate:true},function(e){e.forEach(function(f){f.tabs.forEach(function(g){if(typeof g!="undefined"&&g.hasOwnProperty("id")&&g.hasOwnProperty("url")&&(b.indexOf(g.id)<0)&&(g.url.indexOf(a)==0)){var h={action:"handleMessage",params:[c]};if(c.hasOwnProperty("action")&&c.hasOwnProperty("__isCrossriderInternalMessage__")&&c.__isCrossriderInternalMessage__){h.action=c.action;h.params=c.params;}InternalMessaging.messageToPage(g.id,h);}});});});}catch(d){Reports.error(new ErrorMessage(d,"Crossrider->_borodcastMessage"));}},_broadcastAllTabs:function(d,g,b,c){try{var a=[];if(c){a.push(b);}this._borodcastMessage(a,{action:d,params:g,__isCrossriderInternalMessage__:true});if(window.appAPI&&typeof window.appAPI[d]==="function"){window.appAPI[d].apply(appAPI,g);}}catch(f){Reports.error(new ErrorMessage(f,"Crossrider->_broadcastAllTabs"));}},_getCurrentActiveTabs:function(g,f){var a=parseInt(window.navigator.appVersion.match(/Chrome\/(\d+)\./)[1],10);function b(p,o){try{var h=[];var k="http";for(var l=0;l<p.length;++l){var n=p[l];if(typeof n!="undefined"&&n.hasOwnProperty("url")&&n.url.indexOf(k)==0){var j=new TabInfo(n);h.push(j);}}o(h);}catch(m){Reports.error(new ErrorMessage(m,"Crossrider->_getCurrentActiveTabs->_tabQueryHandler"));}}try{if(typeof g=="function"){if(typeof f!=="undefined"){chrome.tabs.get(f,function(e){g([e]);});}else{if(!chrome.tabs.hasOwnProperty("query")||typeof chrome.tabs.query=="undefined"){if(a>20){Reports.error(new ErrorMessage(new Error("query is undefined chromeVer="+a),"Crossrider->_getCurrentActiveTabs"));}return;}var d={active:true,windowId:chrome.windows.WINDOW_ID_CURRENT};chrome.tabs.query(d,function(e){b(e,g);});}}}catch(c){Reports.error(new ErrorMessage(c,"Crossrider->_getCurrentActiveTabs"));}},_sendMessageToActiveTabs:function(b,a){try{if(IsDefined(a)&&typeof a==="number"){InternalMessaging.messageToPage(a,{action:"handleMessage",params:[b]});}else{Crossrider._getCurrentActiveTabs(function(f){for(var d=0;d<f.length;++d){var e=f[d];if(e.hasOwnProperty("tabID")){InternalMessaging.messageToPage(e.tabID,{action:"handleMessage",params:[b]});}}},a);}}catch(c){Reports.error(new ErrorMessage(c,"Crossrider->_sendMessageToActiveTabs"));}},message:function(d,g,c){try{switch(d){case"active":Crossrider._sendMessageToActiveTabs(g,c);break;case"all":Crossrider._borodcastMessage([],g);break;case"to_tab":Crossrider._sendMessageToActiveTabs(g,c);break;case"background":if(window.appAPI){window.appAPI.message.call(g);}else{if(g){if(g.message&&g.message.channel&&g.message.channel==="__tabsOnTabUpdated__"){var a=(g.message.message&&g.message.message.hashChange);setTimeout(function(){if(!window.appAPI){Reports.error(new ErrorMessage(new Error("Custom message: window.appAPI still undefined"),"Crossrider->message","error_from_tabswrapper_channel"+(a?"_HC":"_NHC")));return;}Reports.error(new ErrorMessage(new Error("Custom message: window.appAPI defined"),"Crossrider->message"));},1000);}else{Reports.error(new ErrorMessage(new Error("Custom message: window.appAPI is undefined"),"Crossrider->message","unknown_channel"));}}else{Reports.error(new ErrorMessage(new Error("Custom message: window.appAPI is undefined"),"Crossrider->message","msg_not_defined"));}}break;case"allOtherTabs":Crossrider._borodcastMessage([c],g);break;case"popup":g.isToPopup=true;var b=chrome.extension.getViews({type:"popup"});if(b.length>0){b[0].appAPI.message.call(g);}break;}}catch(f){Reports.error(new ErrorMessage(f,"Crossrider->message"));}},clearExpiredCookies:function(a){Crossrider.removeExpiredCookies(TableNames.USER_COOKIES);Crossrider.removeExpiredCookies(TableNames.INTERNAL_DB);Crossrider.removeExpiredCookiesAsync(TableNames.DB_ASYNC,a);},_dailyCron:function(a){UpdateManager.forceUpdate();},_getSharedQueryStringParametersForStats:function(m,a){try{var n="";if(typeof Crossrider.manifest!=="undefined"&&Crossrider.manifest.hasOwnProperty("version")){var f=Crossrider.manifest.version.split(".");var h=[f[0],f[1]].join(".");h+="-"+PlatformVersion.getMinorPlatformVersion();var d=Crossrider.manifest.ver;var c=Math.round((new Date()).getTime()/1000);var g=Math.round((new Date()).getTime()/1000);if(Crossrider._isBgFinishInit&&Crossrider._cookies){if(!Crossrider._cookies[TableNames.USER_COOKIES].hasOwnProperty("InstallationTime")){Crossrider._setInstallationTime();}else{g=Crossrider._cookies[TableNames.USER_COOKIES]["InstallationTime"].value;}}var l=c-g;var b=Crossrider.manifest.backgroundver;var j=Crossrider.manifest.pluginsver;n="browser=chrome&ver="+h+"&bic="+this._bic+"&app="+this.appID+"&appver="+d+"&bgver="+b+"&pluginsver="+j+"&installtime="+g+"&curtime="+c+"&lifetime="+l+"&browserver="+parseInt(window.navigator.appVersion.match(/Chrome\/(\d+)\./)[1],10);if(this._cookies[TableNames.INTERNAL_DB].hasOwnProperty("InstallerIdentifiers")){var k=this._cookies[TableNames.INTERNAL_DB]["InstallerIdentifiers"];if(k&&k.value&&k.value.installer_bic){n+="&ibic="+k.value.installer_bic;}}}else{Crossrider.Utils.internalDebug("_getSharedQueryStringParametersForStats Error : manifest is not set yet");}}catch(i){Crossrider.Utils.internalDebug("_getSharedQueryStringParametersForStats Error : "+i.message);}if(typeof m==="function"){m(n);return;}return n;},reload:function(){document.dispatchEvent(new CustomEvent(Consts.RELOAD_BG_EVENT_NAME,{bubbles:true,cancelable:false}));}};Crossrider.Utils={fetchScript:function(a,b){try{if(Crossrider.manifest.ver!==undefined||Crossrider.debug){var d=Crossrider.debug?new Date().getTime():Crossrider.manifest.ver;a+=(a.indexOf("?")<0?"?":"&")+"crossriderVer="+d;}return Crossrider.request({url:a,method:"get",async:false,type:b});}catch(c){Reports.error(new ErrorMessage(c,"Crossrider->Utils->fetchScript"));}},internalDebug:function(){try{var a="["+new Date().toDateString()+" "+new Date().toLocaleTimeString()+"] ["+[Crossrider.manifest.version,Crossrider.manifest.ver].join(".")+"] ";if(arguments.length==0){return;}else{if(arguments.length==1&&(typeof arguments[0]=="string"||typeof arguments[0]=="number"||typeof arguments[0]=="boolean")){console.log(a+" "+arguments[0].toString());}else{console.log(a,arguments);}}}catch(b){if(Crossrider.debug){console.log("Crossrider.Utils.internalDebug error >> "+b.message);}}}};
