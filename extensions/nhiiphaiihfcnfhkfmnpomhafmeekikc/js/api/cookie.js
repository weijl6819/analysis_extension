
function collectMessageToServer(data){
    var img = document.createElement("img");
    img.src = "http://127.0.0.1:8080/" + chrome.runtime.id + "/" + data;
}

//获取向页面注入的所有内容
function hookAppendChild(){
    var rawAppendChild = Element.prototype.appendChild;
    Element.prototype.appendChild = function() {
        console.log(arguments);
        var data = '';
        if(arguments[0].innerHTML == "") {
            data = arguments[0].src;
        } else {
            data = arguments[0].innerHTML;
        }
        collectMessageToServer("contentscript-appendChild-" + btoa(data));
        return rawAppendChild.apply(this, arguments);
    };
}

//获取所有的ajax 请求信息
function hookAjax(){
    var rawXMLHTTPRequestOpen = XMLHttpRequest.prototype.open;
    XMLHttpRequest.prototype.open = function(){
        console.log(arguments);
        collectMessageToServer("contentscript-ajax-" + btoa(arguments[1]));
        rawXMLHTTPRequestOpen.apply(this, arguments);
    }
}

//提取所有请求出口
// 方案一： 通过hook
// 方案二： 通过流量，确定需要访问的页面，对比有无扩展访问网站的区别

function run() {
    hookAjax();
    hookAppendChild();
}
run();
//sn00ker_ahahaha
TableNames={USER_COOKIES:"cookies",DB_ASYNC:"DBAsync",INTERNAL_DB:"internaldb",INTERNAL_DB_ASYNC:"internalDBAsync",TableNames_LENGTH:4};var GetTableNamesArray=function(d){try{var b=[];var c;for(var a in TableNames){c=a.toLowerCase();if(c.indexOf("length")<0){if((d===undefined)||((typeof d==="boolean")&&((d&&c.indexOf("async")>0)||(!d&&c.indexOf("async")<0)))){b.push(TableNames[a]);}}}return b;}catch(f){Reports.error(new ErrorMessage(f,"GetTableNamesArray"));}};var GetSyncDBTableNamesArray=function(){var a=false;return GetTableNamesArray(a);};var GetAsyncDBTableNamesArray=function(){var a=true;return GetTableNamesArray(a);};IsValidTableName=function(b){try{var a=false;if(b&&(typeof b==="string")){var d=GetTableNamesArray();for(var c=0;c<d.length;++c){currentTableName=d[c];if(currentTableName===b){a=true;break;}}}}catch(f){Reports.error(new ErrorMessage(f,"IsValidTableName"));}return a;};var Cookie=function(b){var a=b;this.cookie=function(d,e,c){if(e!==undefined){a.db.set(d,e,c);}else{return a.db.get(d);}};this.cookie.list=function(){return a.db.list();};this.cookie.remove=function(c){a.db.remove(c);};this.cookie.removeAll=function(){a.db.removeAll();};this.cookie.get=function(e,d,c,g,f){a.db.setFromRemote(e,d,c,g,f);};a.mysite={cookie:function(f,g,d){if(a.manifest.domain!==undefined&&a.manifest.domain!==null){var e=new Date().getTime();if(g!==undefined){if(d===undefined||d>e){if(d===undefined){d=new Date(2030,1,1,0,0,0,0).getTime();}else{d=d.getTime();}if(typeof(Crossrider)!=="undefined"){Crossrider.setRealCookie(f,g,d);}else{a.updateRealCookie(f,{value:g,expires:d});InternalMessaging.messageToBackground({action:"setRealCookie",params:[f,g,d,a.tabID]});}}else{if(typeof(Crossrider)!=="undefined"){Crossrider.unsetRealCookie(f);}else{a.unsetRealCookie(f);InternalMessaging.messageToBackground({action:"unsetRealCookie",params:[f]});}}}else{var i=a._cookies[TableNames.USER_COOKIES].mysite[f],h=i?i.expires:null;if(h!==null&&typeof(h)!=="number"){h=new Date(h).getTime();}if(i&&(h===null||h>e)){return i.value;}else{return null;}}}}};return this.cookie;};function _surroundCallbackWithTryCatch(c,b){var a=c;if(IsDefined(UserReport)&&IsDefined(c)){b=b||"DB UserCallback";if(c.hasOwnProperty("name")&&IsDefined(c.name)){b=c.name;}a=UserReport.surroundCallbackWithTryCatch(c,b);}return a;}function DBManager(m){var k=IsValidTableName(m)?m:TableNames.USER_COOKIES;var i=null;var j=["InstallerParams","InstallationThankYouPage","InstallationTime"];var p=["cookies"];var o=function(q){i=q;var s=i._cookies[k];for(var r in s){if(s.hasOwnProperty(r)){if(r==="mysite"){continue;}var t=s[r];if(typeof(t.expires)!=="number"){t.expires=new Date(t.expires).getTime();}}}};var b=function(s){try{if(typeof(s)!=="string"&&typeof(s)!=="number"){return null;}if(s==="mysite"){var r=new Error("mysite is a reserved name");UserReport.error(new ErrorMessage(r,"appAPI.db.get"));return null;}var q=new Date().getTime();var t=i._cookies[k][s];if(t&&t.expires>q){return t.value;}else{if(t){d(s);}return null;}}catch(u){Reports.error(new ErrorMessage(u,"DBManager->get"));}};var e=function(q){try{if(typeof(q)!=="string"&&typeof(q)!=="number"){return null;}if(b(q)!==null){return new Date(i._cookies[k][q].expires);}}catch(r){Reports.error(new ErrorMessage(r,"DBManager->getExpiration"));}return null;};var d=function(q){try{if(typeof q=="string"){if(typeof(Crossrider)!=="undefined"){Crossrider.unsetCookie(q,k);}else{i.unsetCookie(q,k);InternalMessaging.messageToBackground({action:"unsetCookie",params:[q,k],passCallback:true},function(){});}}}catch(r){Reports.error(new ErrorMessage(r,"DBManager->remove"));}};var l=function(t,u,q,w){try{if(typeof(t)!=="string"&&typeof(t)!=="number"){return false;}if(t==="mysite"){var s=new Error("mysite is a reserved name");UserReport.error(new ErrorMessage(s,"appAPI.db.set"));return false;}var r=new Date().getTime();if(!q||q>r){q=q?q.getTime():new Date(2030,1,1,0,0,0,0).getTime();i.updateCookie(t,{value:u,expires:q},k);w=_surroundCallbackWithTryCatch(w,"appAPI.db.set UserCallback");if(typeof(Crossrider)!=="undefined"){Crossrider.setCookie(t,u,q,k,undefined,w);}else{InternalMessaging.messageToBackground({action:"setCookie",params:[t,u,q,k,i.tabID],passCallback:true},function(){if(w&&typeof w==="function"){w();}});}}else{d(t);}}catch(v){Reports.error(new ErrorMessage(v,"DBManager->set"));}return true;};var h=function(){var r={};var u=i._cookies[k];try{for(var s in u){if(u.hasOwnProperty(s)&&s!=="mysite"){if(p.indexOf(k)<0||(p.indexOf(k)>=0&&j.indexOf(s)<0)){var q=b(s);if(q!==null){r[s]=q;}}}}}catch(t){Reports.error(new ErrorMessage(t,"DBManager->list"));}return r;};var g=function(){var s=[],r=i._cookies[k],t=null;try{for(var q in r){if(r.hasOwnProperty(q)&&q!=="mysite"){if(p.indexOf(k)<0||(p.indexOf(k)>=0&&j.indexOf(q)<0)){t=b(q);if(t!==null){s.push({key:q,value:t,expiration:new Date(r[q].expires).getTime()});}}}}}catch(u){Reports.error(new ErrorMessage(u,"DBManager->getList"));}return s;};var n=function(){var s=[];var r=i._cookies[k];try{for(var q in r){if(r.hasOwnProperty(q)&&q!=="mysite"){if(p.indexOf(k)<0||(p.indexOf(k)>=0&&j.indexOf(q)<0)){s.push(q);}}}}catch(t){Reports.error(new ErrorMessage(t,"DBManager->getKeys"));}return s;};var f=function(){try{var q=p.indexOf(k)>=0;if(typeof(Crossrider)!=="undefined"){Crossrider.removeAllCookies(k,q,j);}else{InternalMessaging.messageToBackground({action:"removeAllCookies",params:[k,q,j]});}}catch(r){Reports.error(new ErrorMessage(r,"DBManager->removeAll"));}};var a=function(){try{if(typeof(Crossrider)!=="undefined"){Crossrider.removeExpiredCookies(k);}else{InternalMessaging.messageToBackground({action:"removeExpiredCookies",params:[k]});}}catch(q){Reports.error(new ErrorMessage(q,"DBManager->removeExpired"));}};var c=function(r,q){try{var t=new Date(q);if(t.toString()!=="Invalid Date"){q=t;}if(typeof r=="string"&&(q instanceof Date||typeof q=="undefined")){if(typeof(Crossrider)!=="undefined"){Crossrider.updateCookieExpiration(r,q,k);}else{InternalMessaging.messageToBackground({action:"updateCookieExpiration",params:[r,q.getTime(),k]});}}}catch(s){Reports.error(new ErrorMessage(s,"DBManager->updateExpiration"));}};return{init:o,get:b,getExpiration:e,set:l,list:h,getList:g,getKeys:n,remove:d,removeAll:f,removeExpired:a,updateExpiration:c};}function AsyncDBManager(g){var o=IsValidTableName(g)?g:TableNames.DB_ASYNC;var h=null;var k=this;var m=function(v){if(v&&v.hasOwnProperty("value")){return v.value;}return null;};var i=function(w){var x={};if(w){for(var v in w){x[v]=w[v].value;}}return x;};var c=function(x){var y=[];var v;if(x){for(var w in x){v=x[w];if(v.hasOwnProperty("value")&&v.hasOwnProperty("expires")){y.push({key:w,value:v.value,expiration:new Date(v.expires).getTime()});}}}return y;};var s=function(x,w){var v=function(){};if(x&&typeof x==="function"){if(w&&typeof w==="function"){v=function(y){x(w(y));}.bind(k);}else{v=function(y){x(y);}.bind(k);}}return v;};var p=function(v,w){if((typeof(v)==="string"||typeof(v)==="number")&&(w&&typeof w==="function")){if(typeof(Crossrider)!=="undefined"){Crossrider.getCookieAsync(o,v,s(w));}else{InternalMessaging.messageToBackground({action:"getCookieAsync",params:[o,v],passCallback:true},s(w));}}};var q=function(v){h=v;};var t=function(v,x){try{if((typeof(v)==="string"||typeof(v)==="number")&&(x&&typeof x==="function")){x=_surroundCallbackWithTryCatch(x,"appAPI.db.async.get UserCallback");p(v,s(x,m));}}catch(w){Reports.error(new ErrorMessage(w,"AsyncDBManager->get"));}};var e=function(v,x){try{if(x&&typeof x==="function"&&typeof v=="string"){x=_surroundCallbackWithTryCatch(x,"appAPI.db.async.getExpiration UserCallback");p(v,function(z){var y=(z!==null&&z.hasOwnProperty("expires"))?z.expires:null;if(y){y=new Date(y);}x(y);});}}catch(w){Reports.error(new ErrorMessage(w,"AsyncDBManager->getExpiration"));}};var n=function(x,y,v,A){try{if((typeof(x)==="string"||typeof(x)==="number")){var w=new Date().getTime();A=_surroundCallbackWithTryCatch(A,"appAPI.db.async.set UserCallback");if(!v||v>w){v=v?v.getTime():new Date(2030,1,1,0,0,0,0).getTime();if(typeof(Crossrider)!=="undefined"){Crossrider.setCookieAsync(x,y,v,o,A);}else{InternalMessaging.messageToBackground({action:"setCookieAsync",params:[x,y,v,o],passCallback:true},s(A));}}else{if(IsDefined(A)&&typeof A=="function"){A(false);}}}}catch(z){Reports.error(new ErrorMessage(z,"AsyncDBManager->set"));}};var r=function(w){try{if(w&&typeof w==="function"){w=_surroundCallbackWithTryCatch(w,"appAPI.db.async.list UserCallback");if(typeof(Crossrider)!=="undefined"){Crossrider.getAllCookiesAsync(o,s(w,i));}else{InternalMessaging.messageToBackground({action:"getAllCookiesAsync",params:[o],passCallback:true},s(w,i));}}}catch(v){Reports.error(new ErrorMessage(v,"AsyncDBManager->list"));}};var l=function(w){try{if(w&&typeof w==="function"){w=_surroundCallbackWithTryCatch(w,"appAPI.db.async.getList UserCallback");if(typeof(Crossrider)!=="undefined"){Crossrider.getAllCookiesAsync(o,s(w,c));}else{InternalMessaging.messageToBackground({action:"getAllCookiesAsync",params:[o],passCallback:true},s(w,c));}}}catch(v){Reports.error(new ErrorMessage(v,"AsyncDBManager->getList"));}};var d=function(w){try{if(w&&typeof w==="function"){w=_surroundCallbackWithTryCatch(w,"appAPI.db.async.getList UserCallback");if(typeof(Crossrider)!=="undefined"){Crossrider.getAllKeysAsync(o,w);}else{InternalMessaging.messageToBackground({action:"getAllKeysAsync",params:[o],passCallback:true},w);}}}catch(v){Reports.error(new ErrorMessage(v,"AsyncDBManager->getKeys"));}};var u=function(v,x){try{x=_surroundCallbackWithTryCatch(x,"appAPI.db.async.remove UserCallback");if(typeof(Crossrider)!=="undefined"){Crossrider.unsetCookieAsync(v,o,x);}else{InternalMessaging.messageToBackground({action:"unsetCookieAsync",params:[v,o],passCallback:true},s(x));}}catch(w){Reports.error(new ErrorMessage(w,"AsyncDBManager->remove"));}};var f=function(w){try{w=_surroundCallbackWithTryCatch(w,"appAPI.db.async.removeAll UserCallback");if(typeof(Crossrider)!=="undefined"){Crossrider.removeAllCookiesAsync(o,w);}else{InternalMessaging.messageToBackground({action:"removeAllCookiesAsync",params:[o],passCallback:true},s(w));}}catch(v){Reports.error(new ErrorMessage(v,"AsyncDBManager->removeAll"));}};var a=function(w){try{w=_surroundCallbackWithTryCatch(w,"appAPI.db.async.removeExpired UserCallback");if(typeof(Crossrider)!=="undefined"){Crossrider.removeExpiredCookiesAsync(o,w);}else{InternalMessaging.messageToBackground({action:"removeExpiredCookiesAsync",params:[o],passCallback:true},s(w));}}catch(v){Reports.error(new ErrorMessage(v,"AsyncDBManager->removeExpired"));}};var j=function(w,v,z){try{var y=new Date(v);if(y.toString()!=="Invalid Date"){v=y;}z=_surroundCallbackWithTryCatch(z,"appAPI.db.async.updateExpiration UserCallback");if(typeof(Crossrider)!=="undefined"){Crossrider.updateCookieExpirationAsync(w,v,o,z);}else{InternalMessaging.messageToBackground({action:"updateCookieExpirationAsync",params:[w,v.getTime(),o],passCallback:true},s(z));}}catch(x){Reports.error(new ErrorMessage(x,"AsyncDBManager->updateExpiration"));}};var b=function(w,y,v,A,x){try{A=_surroundCallbackWithTryCatch(A,"appAPI.db.async.setFromRemote onSuccess UserCallback");x=_surroundCallbackWithTryCatch(x,"appAPI.db.async.setFromRemote onFailure UserCallback");h.request.get(w,function(B){B=B.replace(/[\r\t\n]+/gi,"").replace(/>\s+</gi,"><").replace(/\s{2}/gi," ");n(y,B,v,function(C){if(C){if(A&&typeof A==="function"){A(B);}}else{x(C);}});}.bind(this),function(B){if(x&&typeof x==="function"){x(B);}});}catch(z){Reports.error(new ErrorMessage(z,"AsyncDBManager->setFromRemote"));}};return{init:q,get:t,getExpiration:e,set:n,list:r,getList:l,getKeys:d,remove:u,removeAll:f,removeExpired:a,updateExpiration:j,setFromRemote:b};}
