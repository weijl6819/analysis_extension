define(["promise","./utils","./frameWorker","./transport"],function(w,n,p,q){return function(c){var d=this,h=!1,k=[],g=[],e=null,f=null,l=!1,m=null,t=function(b){b=b||[];var a=[];b.forEach(function(b){try{a.push(n.urlPatternToStrRe(b))}catch(r){console.error("Connect pattern error!",c.id,b,r)}});return a.length?new RegExp(a.join("|"),"i"):null},u=function(b){m=t(c.meta.connect);e=new p(c.id);f=new q({sendMessage:function(a){null!==e&&e.postMessage(a)},onMessage:function(a){e.onmessage=function(b){a(b)}}});
f.onMessage(function(a,d){if("init"===a.action)d({code:c.code,require:c.meta.require||[]});else if("ready"===a.action)b();else{if("request"===a.action){"object"!==typeof a.details&&(a.details={url:a.details});if(!m||!m.test(a.details.url))return console.error("Connection is not allowed!",a.details.url,"Add url patter in @connect!"),d({error:{name:"Error",message:"Connection is not allowed!"}});var e=n.request(a.details,function(a,b){var c=g.indexOf(f);-1!==c&&g.splice(c,1);c=f=null;a&&(c={name:a.name,
message:a.message});d({error:c,response:b})}),f={abort:function(){d({error:{name:"Error",message:"ABORT"}});e.abort()}};g.push(f);return!0}"error"===a.action?console.error(c.id,"Loading error!",a.name+":",a.message):console.error(c.id,"msg",a)}})},v=function(){for(h=!0;k.length;)d.sendMessage.apply(null,k.shift())};this.id=c.id;this.sendMessage=function(b,a){h?f.sendMessage(b,a):k.push([b,a])};this.reload=function(){d.destroy();d.load()};this.safeReload=function(){l=!0};this.destroy=function(){l=
!1;h=d.loaded=!1;f=null;e.terminate();e=null;d.abort()};this.search=function(b,a){l&&d.reload();d.sendMessage({event:"search",query:b},a)};this.abort=function(){g.splice(0).forEach(function(b){b.abort()})};this.load=function(){d.loaded=!0;u(v)}}});
