define(["jquery","baseApi"],function(){var l=function(){for(var a=arguments[0],b=1,d=arguments.length;b<d;b++){var c=arguments[b],e;for(e in c)void 0!==c[e]&&(a[e]=c[e])}return a},f={legacy:{varCache:{size_check:/[^0-9.,\u043a\u0431\u043c\u0433\u0442kmgtb]/g,size_kb:/\u043a\u0431|kb/,size_mb:/\u043c\u0431|mb/,size_gb:/\u0433\u0431|gb/,size_tb:/\u0442\u0431|tb/,today_now:/\u0441\u0435\u0439\u0447\u0430\u0441|now/,today_today:/\u0441\u0435\u0433\u043e\u0434\u043d\u044f|today/,today_yest:/\u0432\u0447\u0435\u0440\u0430|yesterday/,
ex_num:/[^0-9]/g,spaces:/\s+/g,timeFormat4:/([0-9]{1,2}d)?[^0-9]*([0-9]{1,2}h)?[^0-9]*([0-9]{1,2}m)?[^0-9]*([0-9]{1,2}s)?/},sizeFormat:function(a){a=a.toLowerCase().replace(this.varCache.size_check,"").replace(",",".");var b=a.replace(this.varCache.size_kb,""),d=a.length;if(b.length!==d)return b=parseFloat(b),Math.round(1024*b);b=a.replace(this.varCache.size_mb,"");if(b.length!==d)return b=parseFloat(b),Math.round(1048576*b);b=a.replace(this.varCache.size_gb,"");if(b.length!==d)return b=parseFloat(b),
Math.round(1073741824*b);b=a.replace(this.varCache.size_tb,"");return b.length!==d?(b=parseFloat(b),Math.round(1099511627776*b)):0},monthReplace:function(a){return a.toLowerCase().replace("\u044f\u043d\u0432","1").replace("\u0444\u0435\u0432","2").replace("\u043c\u0430\u0440","3").replace("\u0430\u043f\u0440","4").replace("\u043c\u0430\u044f","5").replace("\u043c\u0430\u0439","5").replace("\u0438\u044e\u043d","6").replace("\u0438\u044e\u043b","7").replace("\u0430\u0432\u0433","8").replace("\u0441\u0435\u043d",
"9").replace("\u043e\u043a\u0442","10").replace("\u043d\u043e\u044f","11").replace("\u0434\u0435\u043a","12").replace("jan","1").replace("feb","2").replace("mar","3").replace("apr","4").replace("may","5").replace("jun","6").replace("jul","7").replace("aug","8").replace("sep","9").replace("oct","10").replace("nov","11").replace("dec","12")},todayReplace:function(a,b){b=parseInt(b);a=a.toLowerCase();var d=new Date;this.varCache.today_now.test(a)&&(a="today "+d.getHours()+":"+d.getMinutes());var c=new Date(1E3*
(Math.round(d.getTime()/1E3)-86400));0===b?(b=d.getFullYear()+" "+(d.getMonth()+1)+" "+d.getDate()+" ",c=c.getFullYear()+" "+(c.getMonth()+1)+" "+c.getDate()+" "):3===b?(b=d.getMonth()+1+" "+d.getDate()+" "+d.getFullYear()+" ",c=c.getMonth()+1+" "+c.getDate()+" "+c.getFullYear()+" "):(b=d.getDate()+" "+(d.getMonth()+1)+" "+d.getFullYear()+" ",c=c.getDate()+" "+(c.getMonth()+1)+" "+c.getFullYear()+" ");return a=a.replace(this.varCache.today_today,b).replace(this.varCache.today_yest,c)},dateFormat:function(a,
b){if(void 0===a)return["2013-04-31[[[ 07]:03]:27]","31-04-2013[[[ 07]:03]:27]","n day ago","04-31-2013[[[ 07]:03]:27]","2d 1h 0m 0s ago"];a=parseInt(a);if(0===a){a=b.replace(this.varCache.ex_num," ").replace(this.varCache.spaces," ").trim().split(" ");for(b=0;6>b;b++)if(void 0===a[b])a[b]=0;else if(a[b]=parseInt(a[b]),isNaN(a[b])){if(3>b)return 0;a[b]=0}10>a[0]?a[0]="200"+a[0]:100>a[0]&&(a[0]="20"+a[0]);return Math.round((new Date(a[0],a[1]-1,a[2],a[3],a[4],a[5])).getTime()/1E3)}if(1===a){a=b.replace(this.varCache.ex_num,
" ").replace(this.varCache.spaces," ").trim().split(" ");for(b=0;6>b;b++)if(void 0===a[b])a[b]=0;else if(a[b]=parseInt(a[b]),isNaN(a[b])){if(3>b)return 0;a[b]=0}10>a[2]?a[2]="200"+a[2]:100>a[2]&&(a[2]="20"+a[2]);return Math.round((new Date(a[2],a[1]-1,a[0],a[3],a[4],a[5])).getTime()/1E3)}if(2===a)return a=86400*parseFloat(b.replace(this.varCache.ex_num,"")),Math.round(Date.now()/1E3)-a;if(3===a){a=b.replace(this.varCache.ex_num," ").replace(this.varCache.spaces," ").trim().split(" ");for(b=0;6>b;b++)if(void 0===
a[b])a[b]=0;else if(a[b]=parseInt(a[b]),isNaN(a[b])){if(3>b)return 0;a[b]=0}10>a[2]?a[2]="200"+a[2]:100>a[2]&&(a[2]="20"+a[2]);return Math.round((new Date(a[2],a[0]-1,a[1],a[3],a[4],a[5])).getTime()/1E3)}if(4===a){var d=b.match(this.varCache.timeFormat4);if(d){a=parseInt(d[1])||0;b=parseInt(d[2])||0;var c=parseInt(d[3])||0;d=parseInt(d[4])||0;a=86400*a+3600*b+60*c+d;return 0===a?0:parseInt(Date.now()/1E3)-a}return 0}}},prepareTrackerR:{hasEndSlash:/\/$/},funcList:{encodeCp1251:function(a){for(var b=
"",d,c,e=0,k=a.length;e<k;e++){c=a.charAt(e);var h=d=c.charCodeAt(0);1039<d&&1104>d?(h-=848,d="%"+h.toString(16)):1025===d?(h=168,d="%"+h.toString(16)):1105===d?(h=184,d="%"+h.toString(16)):32===d?(h=32,d="%"+h.toString(16)):d=10===d?"%0A":c;b+=d}return b},idInCategoryList:function(a,b){var d={serials:0,music:1,games:2,films:3,cartoon:4,books:5,soft:6,anime:7,doc:8,sport:9,xxx:10,humor:11},c;for(c in a.categoryList)if(-1!==a.categoryList[c].indexOf(b))return d[c];return-1},idInCategoryListInt:function(a,
b,d){b=(b=b.match(d))&&b[1];if(null===b)return-1;b=parseInt(b);return this.idInCategoryList(a,b)},idInCategoryListStr:function(a,b,d){b=(b=b.match(d))&&b[1];return null===b?-1:this.idInCategoryList(a,b)}},listToFunction:function(a,b){if(!Array.isArray(b))return null;var d=[];b.forEach(function(a){if("encode"===a.name)"cp1251"===a.type&&d.push(function(a){a.query=f.funcList.encodeCp1251(a.query)});else if("replaceRe"===a.name){var b=new RegExp(a.re,"ig");d.push(function(c,d){return d.replace(b,a.text)})}else"replaceToday"===
a?d.push(function(a,b){return f.funcList.todayReplace(b)}):"replaceMonth"===a?d.push(function(a,b){return f.funcList.monthReplace(b)}):"timeFormat"===a.name?d.push(function(b,c){return f.funcList.dateFormat(a.format,c)}):"convertSize"===a&&d.push(function(a,b){return f.funcList.sizeFormat(b)})});return d.length?function(a,b){for(var c=0,e;e=d[c];c++)try{b=e(a,b)}catch(g){b=null;console.error("listToFunction error!",g);break}return b}:null},convertV1ToV2:function(a){var b={version:2,type:"kit"};b.uid=
a.uid;b.icon=a.icon;b.title=a.name;b.desc=a.about;var d=b.search={},c=d.torrentSelector={},e=d.onGetValue={};d.searchUrl=a.search_path;a.root_url&&(d.baseUrl=a.root_url);a.auth&&(d.loginUrl=a.auth);a.post&&(d.requestType="POST",d.requestData=a.post);a.encode&&(d.onBeforeRequest=[{name:"encode",type:"cp1251"}]);d.listItemSelector=a.items;a.charset&&(d.requestMimeType="text/html; charset="+a.charset);a.cat_alt&&(a.cat_attr="alt",a.cat_alt=void 0);a.auth_f&&(d.loginFormSelector=a.auth_f);if(a.sf||a.sl)d.listItemSplice=
[a.sf||0,-(a.sl||0)];c.title=a.tr_name;c.url={selector:a.tr_link,attr:"href"};a.cat_name&&(c.categoryTitle=a.cat_name,a.cat_attr&&(c.categoryTitle={selector:c.categoryTitle,attr:a.cat_attr}),a.cat_link&&(c.categoryUrl={selector:a.cat_link,attr:"href"}));a.tr_size&&(c.size=a.tr_size,a.size_attr&&(c.size={selector:c.size,attr:a.size_attr}),d=[],a.size_r&&void 0!==a.size_rp&&d.push({name:"replaceRe",re:a.size_r,text:a.size_rp}),a.s_c&&d.push("convertSize"),d.length&&(e.size=d));a.tr_dl&&(c.downloadUrl=
{selector:a.tr_dl,attr:"href"});a.seed&&(c.seed=a.seed,a.seed_r&&(e.seed=[{name:"replaceRe",re:a.seed_r,text:a.seed_rp}]));a.peer&&(c.peer=a.peer,a.peer_r&&(e.peer=[{name:"replaceRe",re:a.peer_r,text:a.peer_rp}]));a.date&&(c.date=a.date,a.date_attr&&(c.date={selector:c.date,attr:a.date_attr}),c=[],a.t_r&&c.push({name:"replaceRe",re:a.t_r,text:a.t_r_r}),a.t_t_r&&c.push("replaceToday"),a.t_m_r&&c.push("replaceMonth"),void 0!==a.t_f&&"-1"!==a.t_f&&c.push({name:"timeFormat",format:a.t_f}),c.length&&(e.date=
c));return b},prepareCustomTracker:function(a){var b=this,d=null;1===a.version&&(a=this.convertV1ToV2(a));if(2===a.version){d=a;var c="";location.hash.substr(1).split("&").some(function(a){a=a.split("=");if("id"===a[0])return c=a[1],!0});d.id=c||"noTrackerId";d.search=d.search||{};["onBeforeRequest","onAfterRequest","onBeforeDomParse","onAfterDomParse","onGetListItem"].forEach(function(a){d.search[a]=b.listToFunction(a,d.search[a])});["onSelectorIsNotFound","onEmptySelectorValue","onGetValue"].forEach(function(a){var c=
d.search[a],e;for(e in c)c[e]=b.listToFunction(a,c[e])})}return a},prepareTracker:function(a){for(var b=["onGetValue","onSelectorIsNotFound","onEmptySelectorValue"],d=0,c;c=b[d];d++)a.search[c]||(a.search[c]={});a.search.requestType=a.search.requestType?a.search.requestType.toUpperCase():"GET";a.search.rootUrl&&!f.prepareTrackerR.hasEndSlash.test(a.search.rootUrl)&&(a.search.rootUrl+="/");a.search.baseUrl&&!f.prepareTrackerR.hasEndSlash.test(a.search.baseUrl)&&(a.search.baseUrl+="/");return a},parseHtml:function(a){return API_getDom(a)},
contentFilterR:{searchJs:/javascript/ig,blockHref:/\/\//,blockSrc:/src=(['"]?)/ig,blockSrcSet:/srcset=(['"]?)/ig,blockOnEvent:/on(\w+)=/ig},contentFilter:function(a){return a.replace(f.contentFilterR.searchJs,"tms-block-javascript").replace(f.contentFilterR.blockHref,"//about:blank#blockurl#").replace(f.contentFilterR.blockSrc,"src=$1data:image/gif,base64#blockurl#").replace(f.contentFilterR.blockSrcSet,"data-block-attr-srcset=$1").replace(f.contentFilterR.blockOnEvent,"data-block-event-$1=")},contentUnFilter:function(a){return a.replace(/data:image\/gif,base64#blockurl#/g,
"").replace(/about:blank#blockurl#/g,"").replace(/tms-block-javascript/g,"javascript")},intList:["categoryId","size","seed","peer","date"],isUrlList:["categoryUrl","url","downloadUrl","nextPageUrl"],unFilterKeyList:["categoryTitle","categoryUrl","title","url","downloadUrl"],urlCheck:function(a,b,d){return API_normalizeUrl(a.responseUrl,d,{origin:b.search.rootUrl,path:b.search.baseUrl})},matchSelector:function(a,b){var d=b.key,c=b.item,e=b.$dom,k=b.tracker,h=k.search;"string"===typeof c&&(c={selector:c});
e=e.find(c.selector).get(0);!e&&h.onSelectorIsNotFound[d]&&(e=h.onSelectorIsNotFound[d](b));if(void 0!==c.childNodeIndex&&e){var g=c.childNodeIndex;0>g&&(g=e.childNodes.length+c.childNodeIndex);e=e.childNodes[g]}e&&((c=c.attr?e.getAttribute(c.attr):c.html?e.innerHTML:e.textContent)&&(c=$.trim(c)),!c&&h.onEmptySelectorValue[d]&&(c=h.onEmptySelectorValue[d](b)),c||0===c)&&(h.onGetValue[d]&&(c=h.onGetValue[d](b,c)),-1!==f.intList.indexOf(d)?(b=parseInt(c),isNaN(b)&&(b=-1),c=b):(-1!==f.unFilterKeyList.indexOf(d)&&
(c=f.contentUnFilter(c)),-1!==f.isUrlList.indexOf(d)&&(c=f.urlCheck(b,k,c))),a[d]=c)},matchTorrentSelector:function(a,b){var d=b.key,c=b.item,e=b.$node,k=b.tracker,h=k.search;"string"===typeof c&&(c={selector:c});var g=a.cache[c.selector];g||(g=a.cache[c.selector]=e.find(c.selector).get(0));!g&&h.onSelectorIsNotFound[d]&&(g=h.onSelectorIsNotFound[d](b));void 0!==c.childNodeIndex&&g&&(e=c.childNodeIndex,0>e&&(e=g.childNodes.length+c.childNodeIndex),g=g.childNodes[e]);if(g){(g=c.attr?g.getAttribute(c.attr):
c.html?g.innerHTML:g.textContent)&&(g=$.trim(g.replace(/\r?\n/g," ")));!g&&h.onEmptySelectorValue[d]&&(g=h.onEmptySelectorValue[d](b));if(g||0===g)return h.onGetValue[d]&&(g=h.onGetValue[d](b,g)),-1!==f.intList.indexOf(d)?(b=parseInt(g),isNaN(b)&&(b=-1,a.error[d]=g,a.error[d+"!"]="isNaN"),g=b):(-1!==f.unFilterKeyList.indexOf(d)&&(g=f.contentUnFilter(g)),-1!==f.isUrlList.indexOf(d)&&(g=f.urlCheck(b,k,g))),a.column[d]=g;a.error[d]=g;a.error[d+"!"]=c.attr?"Attribute is not found!":c.html?"Html content is empty!":
"Text content is empty!"}else a.error[d]=g,a.error[d+"!"]="Selector is not found!",a.error[d+"Selector"]=c.selector},isEmptyObject:function(a){for(var b in a)return!1;return!0},matchTorrentItem:function(a,b){b.$node=a;a=b.tracker;var d=a.search;if(d.onGetListItem)d.onGetListItem(b);var c=Object.create({cache:{}});c.column={};c.error={};for(var e in d.torrentSelector){var f=Object.create(b);f.item=d.torrentSelector[e];f.key=e;this.matchTorrentSelector(c,f)}if(c.column.title&&c.column.url)return c.column.categoryId||
0===c.column.categoryId||(c.column.categoryId=-1),c.column.date||(c.column.date=-1),this.isEmptyObject(c.error)||console.debug("["+a.id+"]","Torrent has problems:",c),c.column;console.debug("["+a.id+"]","Skip torrent:",c)},parseDom:function(a){var b=a.tracker.search;if(b.onBeforeDomParse)b.onBeforeDomParse(a);if(a.result)return a.result;var d=f.parseHtml(a.data);d=a.$dom=$(d);if(b.onAfterDomParse&&(b.onAfterDomParse(a),a.result))return a.result;if(b.loginFormSelector&&d.find(b.loginFormSelector).length)return{requireAuth:1};
var c=d.find(b.listItemSelector);b.listItemSplice&&(0!==b.listItemSplice[0]&&c.splice(0,b.listItemSplice[0]),0!==b.listItemSplice[1]&&c.splice(b.listItemSplice[1]));d={};for(var e=d.torrentList=[],k,h=0,g=c.length;h<g;h++)(k=this.matchTorrentItem(c.eq(h),Object.create(a)))&&e.push(k);b.nextPageSelector&&(a=Object.create(a),a.item=b.nextPageSelector,a.key="nextPageUrl",this.matchSelector(d,a));return d},search:function(a,b){var d=this,c={tracker:a,query:b.query};if(a.search.onBeforeRequest)a.search.onBeforeRequest(c);
else c.query=encodeURIComponent(c.query);var e={mimeType:a.search.requestMimeType};/json/i.test(a.search.requestDataType)&&(e.json=!0);b.url?l(e,{type:"GET",url:b.url}):l(e,{type:a.search.requestType,url:a.search.searchUrl.replace("%search%",c.query),data:(a.search.requestData||"").replace("%search%",c.query)});return API_request(e).then(function(a){c.data=d.contentFilter(a.body);c.responseUrl=a.url;c.requestUrl=e.url}).then(function(){return a.search.onAfterRequest&&(a.search.onAfterRequest(c),c.result)?
c.result:d.parseDom(c)}).then(function(b){b.requireAuth&&(b.requireAuth=a.search.loginUrl);return b})},getTrackerIconUrl:function(a){a=a||"#ccc";return"#"!==a[0]?a:"data:image/svg+xml;base64,"+btoa("#skull"===a?'<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" enable-background="new 0 0 48 48" version="1.1" viewBox="0 0 48 48" height="20px" width="20px"><g><g><path d="M33,46c-0.553,0-1-0.447-1-1V34h1c4.963,0,9-4.037,9-9v-5c0-9.925-8.075-18-18-18S6,10.075,6,20v5c0,4.963,4.037,9,9,9h1     v11c0,0.553-0.447,1-1,1s-1-0.447-1-1v-9.045C8.401,35.448,4,30.729,4,25v-5C4,8.972,12.972,0,24,0s20,8.972,20,20v5     c0,5.729-4.401,10.448-10,10.955V45C34,45.553,33.553,46,33,46z"/></g><g><path d="M21,46c-0.553,0-1-0.447-1-1V35c0-0.553,0.447-1,1-1s1,0.447,1,1v10C22,45.553,21.553,46,21,46z"/></g><g><path d="M27,46c-0.553,0-1-0.447-1-1V35c0-0.553,0.447-1,1-1s1,0.447,1,1v10C28,45.553,27.553,46,27,46z"/></g><g><path d="M33,32c-3.859,0-7-3.141-7-7s3.141-7,7-7s7,3.141,7,7S36.859,32,33,32z M33,20c-2.757,0-5,2.243-5,5s2.243,5,5,5     s5-2.243,5-5S35.757,20,33,20z"/></g><g><path d="M15,32c-3.859,0-7-3.141-7-7s3.141-7,7-7s7,3.141,7,7S18.859,32,15,32z M15,20c-2.757,0-5,2.243-5,5s2.243,5,5,5     s5-2.243,5-5S17.757,20,15,20z"/></g><g><path d="M5.236,18c-0.553,0-1-0.447-1-1s0.447-1,1-1C7.955,16,12,14.136,12,9c0-0.553,0.447-1,1-1s1,0.447,1,1     C14,14.908,9.592,18,5.236,18z"/></g><g><path d="M42.764,18C38.408,18,34,14.908,34,9c0-0.553,0.447-1,1-1s1,0.447,1,1c0,5.136,4.045,7,6.764,7c0.553,0,1,0.447,1,1     S43.316,18,42.764,18z"/></g><g><path d="M25.02,32c-0.005,0.001-0.012,0.001-0.02,0h-2c-0.347,0-0.668-0.18-0.851-0.475s-0.199-0.663-0.044-0.973l1-2     c0.34-0.678,1.449-0.678,1.789,0l0.92,1.84c0.129,0.168,0.205,0.379,0.205,0.607C26.02,31.553,25.572,32,25.02,32z"/></g></g></svg>':
'<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" enable-background="new 0 0 48 48" version="1.1" viewBox="0 0 48 48" height="20px" width="20px"><circle cx="24" cy="24" r="20" stroke="black" fill="'+a+'" /></svg>')}};f.funcList.dateFormat=f.legacy.dateFormat.bind(f.legacy);f.funcList.monthReplace=f.legacy.monthReplace.bind(f.legacy);f.funcList.sizeFormat=f.legacy.sizeFormat.bind(f.legacy);f.funcList.todayReplace=f.legacy.todayReplace.bind(f.legacy);window.exKit=f;
window.API_exKit=function(a){var b=f.prepareCustomTracker(a);f.prepareTracker(b);var d=function(a,d){return f.search(b,{query:a,url:d}).then(function(b){return b.requireAuth?{success:!1,error:"AUTH",message:"requireAuth",url:b.requireAuth}:{success:!0,results:b.torrentList,nextPageRequest:b.nextPageUrl&&{event:"getNextPage",url:b.nextPageUrl,query:a}}})};API_event("getNextPage",function(a){return d(a.query,a.url)});API_event("search",function(a){return d(a.query)})};return f});
